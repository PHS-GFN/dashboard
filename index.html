<!DOCTYPE html>

<!--
========================================
PHS DASHBOARD v8.0 (CONFIG-DRIVEN ARCHITECTURE)
Date: December 10, 2024

MAJOR ARCHITECTURAL TRANSFORMATION - Complete rebuild for data-driven configuration

ðŸš€ V8.0 FEATURES:
âœ… Config-Driven System - All configuration from Google Sheets (PHS_Dashboard_Config)
âœ… Advanced Advisor Mapping - Bulk corrections + individual overrides + special categories
âœ… Data Source Management - All URLs configurable (no more hardcoding!)
âœ… Student Goals - Custom unit targets (part-time, IEP, dual-credit)
âœ… Program Tracking - CTE/WorkTexas/Gallery filtering and reporting
âœ… Staff Configuration - Dynamic display names and roles
âœ… Tier Thresholds - Configurable boundaries (future enhancement)
âœ… Student Tags - Context flags (first-gen, housing-insecure, teen-parent, ELL)

Previous v7.6.1: Advisor Cards Cross-Reference Fix
Previous v7.6: 72-Unit Fix + Advisor Table Search/Sort
========================================
-->
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Premier High School - Gallery North Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;family=Poppins:wght@600;700&amp;display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #fafbfc; /* V8.2 FIX 6: Subtle off-white */
            color: var(--text);
            line-height: 1.6;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
        }
        
        h1 { font-size: 2.25rem; line-height: 1.2; }
        h2 { font-size: 1.75rem; line-height: 1.3; }
        h3 { font-size: 1.35rem; line-height: 1.4; }
        h4 { font-size: 1.15rem; line-height: 1.5; }
        
        .header {
            background: linear-gradient(135deg, var(--brand-accent) 0%, #7d2528 100%);
            color: white;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .header .subtitle {
            color: rgba(255, 255, 255, 0.95) !important;
            font-size: 1.1rem;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .header select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='white' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            padding-right: 2rem;
        }
        
        .header select option {
            background: var(--brand-accent);
            color: white;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        
        /* Print styles for PDF export */
        @media print {
            body {
                background: white;
            }
            
            .header {
                background: linear-gradient(180deg, var(--surface) 0%, var(--surface-2) 100%) !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            /* Hide all interactive elements */
            .no-print,
            .back-button,
            .action-buttons,
            .controls,
            button,
            select {
                display: none !important;
            }
            
            /* Optimize page margins for print */
            @page {
                margin: 0.5in;
            }
            
            /* Use full width in print */
            .container {
                max-width: 100% !important;
                padding: 0.5rem !important;
            }
            
            /* Control page breaks for major sections */
            .dashboard-gauges,
            .wins-banner,
            .metrics-split,
            .advisor-spotlight,
            .highlights-section,
            .advisor-grid,
            .momentum-tracker-section,
            .waterfall-section,
            .table-wrapper,
            .student-section,
            .student-metrics-grid,
            .student-view-header,
            .perfect-week-card,
            .perfect-week-student-card,
            .perfect-week-description,
            .perfect-week-banner,
            .new-students-section,
            .chart-container,
            .student-chart-container {
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            /* Ensure grid items don't break */
            .perfect-week-students-grid > div,
            .advisor-grid > div,
            .highlights-grid > div {
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            /* Prevent headers from being orphaned */
            h2, h3, .section-header, .student-section-title {
                page-break-after: avoid;
            }
            
            /* Prevent orphans and widows */
            p, li {
                orphans: 3;
                widows: 3;
            }
            
            /* If Perfect Week section would start near bottom, push to next page */
            .student-section:last-of-type {
                page-break-before: auto;
            }
            
            /* Optimize grid layouts for print */
            .perfect-week-students-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 1rem !important;
                margin-top: 1rem !important;
            }
            
            .perfect-week-student-card {
                margin-top: 0.5rem !important;
            }
            
            .student-metrics-grid {
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 0.75rem !important;
            }
            
            .advisor-grid {
                grid-template-columns: repeat(3, 1fr) !important;
            }
            
            /* FIX 18: Optimize charts for print - prevent overflow */
            .chart-container {
                max-width: 100% !important;
                overflow: hidden !important;
                page-break-inside: avoid;
            }
            
            .chart-container canvas {
                max-width: 100% !important;
                height: auto !important;
            }
            
            /* Better footer for print */
            .footer {
                position: relative !important;
                page-break-before: avoid;
                margin-top: 2rem;
                padding: 1rem;
            }
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            font-size: 1.2rem;
            color: var(--muted);
        }
        
        .main-view, .advisor-view, .student-view, .filtered-list-view {
            display: none;
        }
        
        .main-view.active, .advisor-view.active, .student-view.active, .filtered-list-view.active {
            display: block;
        }
        
        .back-button {
            background: white;
            color: var(--brand-accent);
            border: 2px solid var(--brand-accent);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            transition: all 0.2s;
        }
        
        .back-button:hover {
            background: var(--brand-accent);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(97,23,24,0.15);
        }
        
        /* Action buttons container */
        .action-buttons {
            display: flex;
            gap: 1rem;
            margin: 1.5rem 0;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .action-buttons button {
            padding: 0.75rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            border: none;
        }
        
        .action-buttons button:hover {
            transform: translateY(-2px);
        }
        
        .btn-recommendations {
            background: linear-gradient(135deg, var(--brand-accent) 0%, #7d2528 100%);
            color: white;
        }
        
        .btn-export-pdf {
            background: var(--teal);
            color: white;
        }
        
        .btn-achievements {
            background: #6366f1;
            color: white;
        }
        
        .btn-log-note {
            background: linear-gradient(135deg, var(--teal) 0%, var(--success) 100%);
            color: white;
        }
        
        .wins-banner {
            background: linear-gradient(135deg, #0d4d3d 0%, #1a6b55 50%, #0f5e4a 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 25px rgba(13, 77, 61, 0.4);
            border: 1px solid rgba(26, 107, 85, 0.3);
        }
        
        .wins-banner h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .wins-list {
            display: grid;
            gap: 0.5rem;
            font-size: 1rem;
        }
        
        .win-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.75rem;
            border-radius: 6px;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .win-item:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateX(5px);
        }
        
        .metrics-split {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .metrics-section {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.06);
        }
        
        .celebrations {
            border: 2px solid var(--success);
        }
        
        .challenges {
            border: 2px solid var(--brand-accent);
        }
        
        .metrics-section h3 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .challenges h3 { color: var(--brand-accent); }
        .celebrations h3 { color: var(--teal); }
        
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .metric-row:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            font-size: 0.95rem;
            color: var(--muted);
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .status-good { color: var(--teal); }
        .status-warning { color: var(--brand-brass); }
        .status-danger { color: var(--brand-accent); }
        
        .advisor-spotlight {
            background: transparent; /* V8.2.1: Remove overwhelming purple */
            padding: 0;
            margin-bottom: 2rem;
        }
        
        .advisor-spotlight h2 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }
        
        .spotlight-reason {
            font-size: 1rem;
            color: white;
            opacity: 0.9;
            margin-bottom: 1rem;
            font-style: italic;
        }
        
        .advisor-spotlight-name {
            font-size: 2.5rem;
            font-weight: bold;
            color: white;
            margin-bottom: 1rem;
        }
        
        .spotlight-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .spotlight-stat {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.06);
        }
        
        .spotlight-stat:hover {
            background: var(--surface);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.12);
        }
        
        .spotlight-stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
            color: var(--brand-accent);
        }
        
        .spotlight-stat-label {
            font-size: 0.9rem;
            color: var(--muted);
        }
        
        .highlights-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .highlights-section h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .highlights-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }
        
        .highlight-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            border: 1px solid rgba(0,0,0,0.08);
            transition: all 0.3s;
        }
        
        .highlight-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.18);
        }
        
        .highlight-card.blue { 
            border-left: 6px solid var(--info); 
            background: linear-gradient(135deg, rgba(37,99,235,0.05) 0%, #dbeafe 100%);
        }
        .highlight-card.teal { 
            border-left: 6px solid var(--teal); 
            background: linear-gradient(135deg, rgba(47,143,124,0.05) 0%, rgba(47,143,124,0.1) 100%);
        }
        .highlight-card.yellow { 
            border-left: 6px solid var(--brand-brass); 
            background: linear-gradient(135deg, rgba(162,129,80,0.05) 0%, rgba(162,129,80,0.1) 100%);
        }
        
        .highlight-card h4 {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--ink);
        }
        
        .highlight-students {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .highlight-student {
            padding: 0.5rem;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            color: var(--brand-accent);
        }
        
        .highlight-student:hover {
            background: var(--surface);
            transform: translateX(5px);
        }
        
        .highlight-student-meta {
            font-size: 0.85rem;
            color: var(--muted);
            font-weight: normal;
        }
        
        .momentum-tracker-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .momentum-tracker-section h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--text);
        }
        
        .momentum-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }
        
        .momentum-btn {
            background: white;
            border: 2px solid var(--surface);
            padding: 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            position: relative;
        }
        
        .momentum-btn:hover {
            border-color: rgba(147,26,29,.85);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(97,23,24,0.22);
        }
        
        .momentum-btn-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .momentum-btn-label {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.5rem;
        }
        
        .momentum-btn-count {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--muted);
            opacity: 0.8;
        }
        
        .momentum-btn-change {
            font-size: 1.8rem;
            margin-top: 0.5rem;
            font-weight: 700;
        }
        
        .momentum-btn-change.positive { color: var(--teal); }
        .momentum-btn-change.negative { color: var(--brand-accent); }
        
        .chart-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .chart-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .section-header {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid var(--brand-accent);
        }
        
        .advisor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .advisor-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            overflow: hidden;
            position: relative;
        }
        
        .advisor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .advisor-card-border {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
        }
        
        .advisor-card-border.grade-a { background: var(--teal); }
        .advisor-card-border.grade-b { background: var(--info); }
        .advisor-card-border.grade-c { background: var(--brand-brass); }
        .advisor-card-border.grade-d { background: var(--brand-accent); }
        .advisor-card-border.grade-f { background: var(--brand-accent-2); }
        
        .advisor-card-content {
            padding: 1.5rem;
            padding-left: 2rem;
        }
        
        .advisor-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .advisor-card-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--text);
        }
        
        .advisor-card-grade {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
        }
        
        .advisor-card-grade.grade-a { background: var(--teal); }
        .advisor-card-grade.grade-b { background: var(--info); }
        .advisor-card-grade.grade-c { background: var(--brand-brass); }
        .advisor-card-grade.grade-d { background: var(--brand-accent); }
        .advisor-card-grade.grade-f { background: var(--brand-accent-2); }
        
        .advisor-card-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }
        
        .advisor-stat-item {
            padding: 0.5rem;
            border-radius: 6px;
            background: #f8f9fa;
            text-align: center;
        }
        
        .advisor-stat-label {
            font-size: 0.75rem;
            color: var(--muted);
            margin-bottom: 0.25rem;
        }
        
        .advisor-stat-value {
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        .heatmap-very-good { background: #d1fae5 !important; color: #065f46; }
        .heatmap-good { background: #a7f3d0 !important; color: #047857; }
        .heatmap-neutral { background: var(--surface) !important; color: var(--ink); }
        .heatmap-warning { background: #fef3c7 !important; color: #92400e; }
        .heatmap-bad { background: #fecaca !important; color: #991b1b; }
        
        /* Subtle table-specific heatmap for attendance column */
        .table-heatmap-good { background: #ecfdf5 !important; }
        .table-heatmap-warning { background: #fffbeb !important; }
        .table-heatmap-bad { background: #fef2f2 !important; }
        .heatmap-very-bad { background: #fca5a5 !important; color: #ffffff; }
        
        .controls {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.06);
            margin-bottom: 2rem;
        }
        
        .controls-row {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .controls-row:last-child {
            margin-bottom: 0;
        }
        
        .search-box {
            padding: 0.75rem;
            border: 2px solid var(--surface);
            border-radius: 8px;
            font-size: 1rem;
            flex: 1;
            min-width: 250px;
        }
        
        .search-box:focus {
            outline: none;
            border-color: rgba(147,26,29,.85);
        }
        
        .filter-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--surface);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .filter-btn:hover {
            border-color: rgba(147,26,29,.85);
            background: #f8f9ff;
        }
        
        .filter-btn.active {
            background: linear-gradient(135deg, var(--brand-accent) 0%, #7d2528 100%);
            color: white;
            border-color: rgba(147,26,29,.85);
            box-shadow: 0 4px 12px rgba(97,23,24,0.22);
        }
        
        .student-table {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.06);
        }
        
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1050px;
        }
        
        thead {
            background: #f8f9fa;
        }
        
        th {
            padding: 1rem 0.75rem;
            text-align: left;
            font-weight: 600;
            color: var(--muted);
            border-bottom: 2px solid var(--brand-accent);
            white-space: nowrap;
            font-size: 0.9rem;
        }
        
        th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }
        
        th.sortable:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        td {
            padding: 1rem 0.75rem;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.9rem;
        }
        
        /* Specific column widths for better fit */
        th:nth-child(1), td:nth-child(1) { 
            width: 160px; 
            max-width: 160px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        } /* Student Name */
        th:nth-child(2), td:nth-child(2) { width: 95px; text-align: center; } /* Risk Tier */
        th:nth-child(3), td:nth-child(3) { width: 75px; } /* Velocity */
        th:nth-child(4), td:nth-child(4) { width: 110px; } /* Trajectory */
        th:nth-child(5), td:nth-child(5) { width: 85px; } /* Acceleration */
        th:nth-child(6), td:nth-child(6) { width: 140px; text-align: center; } /* Pattern */
        th:nth-child(7), td:nth-child(7) { width: 60px; text-align: center; } /* Badges */
        th:nth-child(8), td:nth-child(8) { width: 80px; text-align: center; } /* Units */
        th:nth-child(9), td:nth-child(9) { width: 95px; text-align: center; } /* Ahead/Behind */
        th:nth-child(10), td:nth-child(10) { width: 90px; } /* Last Activity */
        th:nth-child(11), td:nth-child(11) { width: 85px; text-align: center; } /* Attendance */
        
        tbody tr {
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        
        tbody tr:nth-child(odd) {
            background: rgba(102, 126, 234, 0.02);
        }
        
        tbody tr:hover {
            background: linear-gradient(90deg, 
                rgba(102, 126, 234, 0.08) 0%, 
                rgba(102, 126, 234, 0.05) 100%);
            border-left-color: var(--brand-accent);
            transform: translateX(2px);
        }
        
        .student-name-link {
            color: var(--brand-accent);
            cursor: pointer;
            font-weight: 500;
            font-family: 'Inter', sans-serif;
            letter-spacing: 0.3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: inline-block;
            max-width: 100%;
        }
        
        .student-name-link:hover {
            text-decoration: underline;
        }
        
        .advisor-spotlight-name,
        .advisor-card-name,
        .student-view-name {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        
        .tier-badge {
            display: inline-block;
            padding: 0.4rem 0.9rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-width: 100px;
            text-align: center;
        }
        
        .tier-badge.tier-1 {
            background: linear-gradient(135deg, var(--brand-accent) 0%, #7d2528 100%);
            color: white;
        }
        .tier-badge.tier-2 { 
            background: linear-gradient(135deg, #fb923c 0%, var(--brand-brass) 100%);
            color: white;
        }
        .tier-badge.tier-3 { 
            background: linear-gradient(135deg, var(--warning) 0%, var(--brand-brass) 100%);
            color: #78350f;
        }
        .tier-badge.tier-4 { 
            background: linear-gradient(135deg, var(--teal) 0%, var(--success) 100%);
            color: white;
        }
        .tier-badge.tier-5 { 
            background: linear-gradient(135deg, var(--brand-brass) 0%, #7b5c33 100%);
            color: white;
            border: 3px solid #5a4525;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .trajectory-breakthrough { color: var(--teal); font-weight: bold; }
        .trajectory-building { color: var(--success); font-weight: 600; }
        .trajectory-stable { color: var(--info); }
        .trajectory-declining { color: var(--brand-brass); font-weight: 600; }
        .trajectory-rapid_decline { color: var(--brand-accent); font-weight: bold; }
        
        .consistency-dots {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: center;
        }
        
        .dots-row {
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }
        
        .consistency-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--text);
        }
        
        .consistency-dot.filled {
            background: var(--text);
        }
        
        .consistency-dot.empty {
            background: white;
        }
        
        /* Smart Calendar-Aware Pattern Dots */
        .pattern-dots-container {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            align-items: center;
            position: relative;
        }
        
        .pattern-dots-row {
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }
        
        .pattern-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--text);
            cursor: pointer;
            position: relative;
            transition: transform 0.2s;
        }
        
        .pattern-dot:hover {
            transform: scale(1.3);
            z-index: 10;
        }
        
        /* Green: Met standard goal (â‰¥2.0 units) */
        .pattern-dot.strong {
            background: var(--teal);
            border-color: var(--success);
        }
        
        /* Blue: Met adjusted goal on short week */
        .pattern-dot.adjusted {
            background: var(--info);
            border-color: var(--info);
        }
        
        /* Hollow: Below goal */
        .pattern-dot.below {
            background: white;
            border-color: var(--text);
        }
        
        /* Black: Break week */
        .pattern-dot.break {
            background: var(--ink);
            border-color: var(--text);
            opacity: 0.6;
        }
        
        /* Gray: Missing data on school week (historical only) */
        .pattern-dot.missing {
            background: #d1d5db;
            border-color: #9ca3af;
            opacity: 0.5;
        }
        
        /* Tooltip for pattern dots */
        .pattern-dot-tooltip {
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            line-height: 1.4;
        }
        
        .pattern-dot:hover .pattern-dot-tooltip {
            opacity: 1;
        }
        
        .pattern-dot-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
        }
        
        .pattern-legend {
            display: flex;
            gap: 1rem;
            font-size: 0.7rem;
            color: var(--muted);
            margin-top: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .pattern-legend-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .pattern-legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid var(--text);
        }
        
        .pattern-legend-dot.strong {
            background: var(--teal);
            border-color: var(--success);
        }
        
        .pattern-legend-dot.adjusted {
            background: var(--info);
            border-color: var(--info);
        }
        
        .pattern-legend-dot.below {
            background: white;
            border-color: var(--text);
        }
        
        .pattern-legend-dot.break {
            background: var(--ink);
            border-color: var(--text);
            opacity: 0.6;
        }
        
        .pattern-legend-dot.missing {
            background: #d1d5db;
            border-color: #9ca3af;
            opacity: 0.5;
        }
        
        .consistency-label {
            display: block;
            margin-top: 0.35rem;
            font-size: 0.7rem;
            color: var(--muted);
            text-align: center;
            white-space: nowrap;
        }
        
        /* Pattern Header Tooltip */
        .pattern-header-wrapper {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            justify-content: center;
        }
        
        .pattern-info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            font-size: 0.65rem;
            cursor: help;
            transition: all 0.2s;
        }
        
        .pattern-info-icon:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .pattern-header-tooltip {
            position: absolute;
            top: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.75rem;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .pattern-header-wrapper:hover .pattern-header-tooltip {
            opacity: 1;
        }
        
        .pattern-header-tooltip::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-bottom-color: rgba(0, 0, 0, 0.95);
        }
        
        .pattern-legend-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.3rem;
        }
        
        .pattern-legend-row:last-child {
            margin-bottom: 0;
        }
        
        .pattern-legend-dot-inline {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid var(--text);
            flex-shrink: 0;
        }
        
        .pattern-legend-dot-inline.strong {
            background: var(--teal);
            border-color: var(--success);
        }
        
        .pattern-legend-dot-inline.adjusted {
            background: var(--info);
            border-color: var(--info);
        }
        
        .pattern-legend-dot-inline.below {
            background: white;
            border-color: var(--text);
        }
        
        .pattern-legend-dot-inline.break {
            background: var(--ink);
            border-color: var(--text);
            opacity: 0.6;
        }
        
        .pattern-legend-dot-inline.missing {
            background: #d1d5db;
            border-color: #9ca3af;
            opacity: 0.5;
        }
        
        /* Pattern Descriptor Label */
        .pattern-descriptor {
            display: block;
            margin-top: 0.4rem;
            font-size: 0.7rem;
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
        }
        
        .pattern-descriptor.steady {
            color: var(--teal);
        }
        
        .pattern-descriptor.bursty {
            color: var(--brand-brass);
        }
        
        .pattern-descriptor.inconsistent {
            color: var(--brand-accent);
        }
        
        .student-view-header {
            background: linear-gradient(135deg, var(--brand-accent) 0%, #7d2528 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }
        
        .student-view-name {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .student-view-meta {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .deadline-countdown-box {
            background: linear-gradient(135deg, var(--brand-accent) 0%, #7d2528 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .deadline-countdown-box.on-track {
            background: linear-gradient(135deg, var(--teal) 0%, var(--success) 100%);
        }
        
        .deadline-countdown-box.needs-attention {
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
        }
        
        .deadline-countdown-box.urgent {
            background: linear-gradient(135deg, var(--brand-accent) 0%, var(--brand-accent) 100%);
        }
        
        .deadline-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .deadline-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .deadline-stat {
            text-align: center;
        }
        
        .deadline-stat-value {
            font-size: 1.75rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        
        .deadline-stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .deadline-message {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255,255,255,0.3);
            font-size: 0.95rem;
        }
        
        .week-indicator-banner {
            display: none; /* Hidden by default, shown by JS */
            background: linear-gradient(135deg, var(--info) 0%, var(--info) 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            text-align: center;
            font-size: 0.95rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .week-indicator-banner strong {
            font-weight: 600;
        }
        
        .student-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .student-metric-card {
            background: white;
            padding: 1.25rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 120px;
        }
        
        .student-metric-label {
            font-size: 0.85rem;
            color: var(--muted);
            margin-bottom: 0.75rem;
            font-weight: 500;
        }
        
        .student-metric-value {
            font-size: 1.75rem;
            font-weight: bold;
            color: var(--text);
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            line-height: 1.2;
        }
        
        .student-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .student-section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--surface);
        }
        
        .semester-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .semester-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--surface);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .semester-btn:hover {
            border-color: rgba(147,26,29,.85);
            background: #f8f9ff;
        }
        
        .semester-btn.active {
            background: var(--brand-accent);
            color: white;
            border-color: rgba(147,26,29,.85);
        }
        
        .achievement-list, .concern-list {
            list-style: none;
            padding: 0;
        }
        
        .achievement-list li, .concern-list li {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            background: #f8f9ff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .achievement-list li {
            border-left: 4px solid var(--teal);
        }
        
        .concern-list li {
            border-left: 4px solid var(--brand-accent);
        }
        
        .badge-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .badge-icon {
            font-size: 1.5rem !important;
            line-height: 1 !important;
            display: inline-block;
            vertical-align: middle;
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif !important;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }
        
        .badge-text {
            font-size: 0.9rem;
            color: var(--muted);
        }
        
        .footer {
            text-align: center;
            padding: 2rem;
            color: var(--muted);
            font-size: 0.9rem;
        }
        
        /* Click-and-Hold Grade Reveal */
        .grade-reveal-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }
        
        .grade-reveal-label {
            font-size: 0.7rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        
        .grade-reveal-btn {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--brand-accent) 0%, #7d2528 100%);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            box-shadow: 0 2px 8px rgba(97,23,24,0.22);
        }
        
        .grade-reveal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .grade-reveal-btn:active {
            transform: translateY(0px);
        }
        
        .grade-reveal-btn.revealing {
            background: linear-gradient(135deg, #764ba2 0%, var(--brand-accent) 100%);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.6);
        }
        
        .grade-hidden {
            display: none;
        }
        
        .grade-visible {
            display: block;
            font-size: 1.3rem;
            font-weight: bold;
        }
        
        /* New Student Alert Banner */
        .new-students-alert {
            background: linear-gradient(135deg, var(--teal) 0%, var(--sage) 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(20, 184, 166, 0.3);
            border: 2px solid var(--teal);
        }
        
        .new-students-alert h3 {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .new-students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .new-student-card {
            background: rgba(255, 255, 255, 0.15);
            padding: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.2);
        
        }
        
        .new-student-card:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }
        
        .new-student-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        
        .new-student-meta {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        /* Perfect Week Printable Page */
        .perfect-week-printable {
            display: none;
            padding: 2rem;
            background: white;
        }
        
        .perfect-week-printable.active {
            display: block;
        }
        
        .perfect-week-banner {
            background: linear-gradient(135deg, var(--brand-brass) 0%, var(--warning) 100%);
            color: white;
            padding: 3rem 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }
        
        .perfect-week-banner h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .perfect-week-banner .subtitle {
            font-size: 1.3rem;
            opacity: 0.95;
        }
        
        .perfect-week-description {
            background: var(--surface-2);
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 4px solid var(--brand-brass);
            margin-bottom: 2rem;
            color: #78350f;
            font-size: 1.1rem;
            line-height: 1.8;
        }
        
        .perfect-week-students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        
        .perfect-week-student-card {
            background: white;
            border: 3px solid var(--brand-brass);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .perfect-week-student-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--brand-brass) 0%, var(--warning) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            margin: 0 auto 1rem;
            border: 3px solid var(--warning);
        }
        
        .perfect-week-student-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
        }
        
        .perfect-week-student-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid var(--surface);
        }
        
        .perfect-week-stat {
            text-align: center;
        }
        
        .perfect-week-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--brand-brass);
            margin-bottom: 0.25rem;
        }
        
        .perfect-week-stat-label {
            font-size: 0.65rem;
            color: var(--muted);
            text-transform: uppercase;
            line-height: 1.3;
            display: block;
        }
        
        /* ========== PRINT OPTIMIZATION ========== */
        /* =========================
           PHS HERO SECTION STYLES
           ========================= */
        .phs-hero {
            background: white;
            padding: 0;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            margin-bottom: 2rem;
        }

        .phs-hero__header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 1.5rem 2rem 1rem;
            border-bottom: 1px solid var(--border);
        }

        .phs-hero__title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .phs-hero__grid {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 16px;
        }

        /* Wins Panel */
        .phs-wins {
            background: transparent;
            padding: 1.5rem 2rem;
        }

        .phs-wins__top {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 1rem;
        }

        .phs-wins__top h3 {
            margin: 0;
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text);
        }

        .phs-wins__cards {
            position: relative;
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }

        .phs-winCard {
            border-radius: 8px;
            border: 1px solid var(--border);
            background: white;
            padding: 1rem;
            display: flex;
            gap: 12px;
            align-items: flex-start;
            min-height: 85px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 4px solid var(--border);
        }

        .phs-winCard:hover {
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }
        
        .phs-winCard[data-accent="teal"] { border-left-color: var(--teal); }
        .phs-winCard[data-accent="sage"] { border-left-color: var(--sage); }
        .phs-winCard[data-accent="brass"] { border-left-color: var(--brand-brass); }
        .phs-winCard[data-accent="accent"] { border-left-color: var(--brand-accent); }
        .phs-winCard[data-accent="info"] { border-left-color: var(--info); }

        .phs-winIcon {
            width: 34px;
            height: 34px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            border: 1px solid rgba(147,26,29,0.18);
            background: rgba(147,26,29,0.07);
            flex: 0 0 auto;
        }

        .phs-winBody {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .phs-winTitle {
            font-weight: 800;
            font-size: 13px;
            color: var(--text);
            line-height: 1.2;
        }

        .phs-winValue {
            font-size: 18px;
            font-weight: 900;
            letter-spacing: -0.02em;
            color: var(--brand-accent);
            line-height: 1.1;
        }

        .phs-winDesc {
            font-size: 12px;
            color: var(--muted);
        }

        /* Spotlight Panel */
        .phs-spotlight {
            background: transparent;
            overflow: hidden;
            position: relative;
        }

        .phs-spotlight__cap {
            position: relative;
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 14px 14px 12px;
            background: linear-gradient(135deg, var(--brand-accent) 0%, #611718 100%);
            color: #fff;
        }

        .phs-spotlight__capIcon {
            width: 34px;
            height: 34px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.28);
            font-size: 18px;
        }

        .phs-spotlight__label {
            font-weight: 900;
            letter-spacing: -0.02em;
        }

        .phs-spotlight__hint {
            font-size: 11px;
            opacity: 0.8;
            font-weight: 400;
        }

        .phs-spotlight__body {
            position: relative;
            padding: 14px;
        }

        .phs-spotlight__identity {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 10px;
        }

        .phs-avatar {
            width: 44px;
            height: 44px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            color: #fff;
            font-size: 20px;
            background: linear-gradient(135deg, var(--brand-brass) 0%, #8B6B3E 100%);
            border: 1px solid rgba(31,41,55,0.12);
        }

        .phs-spotlight__name {
            font-size: 16px;
            font-weight: 900;
            color: var(--text);
            line-height: 1.1;
        }

        .phs-spotlight__tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 6px;
        }

        .phs-chip {
            font-size: 11px;
            font-weight: 800;
            padding: 6px 8px;
            border-radius: 999px;
            background: rgba(255,255,255,0.85);
            border: 1px solid rgba(31,41,55,0.12);
            color: var(--text);
        }

        .phs-chip--soft {
            background: rgba(46,125,110,0.10);
            border-color: rgba(46,125,110,0.22);
            color: #0f3d37;
        }

        .phs-spotlight__why {
            border-radius: 14px;
            background: rgba(255,255,255,0.88);
            border: 1px solid rgba(31,41,55,0.10);
            padding: 12px;
            font-size: 13px;
            line-height: 1.5;
            color: var(--text);
            margin-bottom: 10px;
        }

        .phs-spotlight__stats {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8px;
            margin-bottom: 12px;
        }

        .phs-stat {
            background: rgba(255,255,255,0.88);
            border: 1px solid rgba(31,41,55,0.10);
            border-radius: 14px;
            padding: 10px;
        }

        .phs-stat__label {
            font-size: 11px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }

        .phs-stat__value {
            font-size: 16px;
            font-weight: 900;
            color: var(--brand-accent);
            margin-top: 2px;
        }

        /* Responsive */
        @media (max-width: 980px) {
            .phs-hero__grid {
                grid-template-columns: 1fr;
            }
            .phs-wins__cards {
                grid-template-columns: 1fr;
            }
        }
        
        @media print {
            /* Hide UI elements */
            .no-print,
            .back-button,
            .action-buttons,
            .controls,
            .filter-group,
            .search-box,
            button,
            .footer {
                display: none !important;
            }
            
            /* Optimize layout */
            body {
                background: white !important;
                color: black !important;
            }
            
            .main-container {
                padding: 0 !important;
                max-width: 100% !important;
            }
            
            /* Ensure tables print properly */
            table {
                page-break-inside: avoid;
            }
            
            tr {
                page-break-inside: avoid;
            }
            
            /* Print-friendly colors */
            .student-view-header,
            .advisor-spotlight,
            .new-students-alert {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* Page breaks */
            .section-header {
                page-break-before: always;
            }
            
            .section-header:first-of-type {
                page-break-before: avoid;
            }
        }
        
        @media print {
            .perfect-week-printable.active {
                display: block !important;
            }
            
            .perfect-week-printable:not(.active) {
                display: none !important;
            }
            
            .back-button {
                display: none;
            }
        }
        
        /* Responsive Design for Chromebooks and Mobile */
        @media screen and (max-width: 1366px) {
            /* Chromebook optimization */
            .container {
                padding: 1.5rem;
            }
            
            table {
                min-width: 950px;
                font-size: 0.85rem;
            }
            
            th, td {
                padding: 0.75rem 0.5rem;
            }
            
            .tier-badge {
                padding: 0.3rem 0.7rem;
                font-size: 0.7rem;
            }
        }
        
        @media screen and (max-width: 1024px) {
            /* Tablet landscape */
            .header h1 {
                font-size: 1.5rem;
            }
            
            .metrics-split {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .advisor-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
            
            table {
                font-size: 0.8rem;
            }
            
            .highlights-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons button {
                width: 100%;
            }
        }
        
        @media screen and (max-width: 768px) {
            /* Mobile - Stack everything */
            .header {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 1.25rem;
            }
            
            .container {
                padding: 1rem;
            }
            
            .table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 800px;
                font-size: 0.75rem;
            }
            
            th, td {
                padding: 0.5rem 0.35rem;
            }
            
            .wins-banner {
                padding: 1rem;
            }
            
            .wins-banner h2 {
                font-size: 1.25rem;
            }
            
            .advisor-grid {
                grid-template-columns: 1fr;
            }
            
            .back-button {
                padding: 0.75rem 1.5rem;
                font-size: 0.9rem;
                width: 100%;
            }
            
            .student-view-name {
                font-size: 1.75rem;
            }
            
            .student-metrics-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .student-metric-card {
                min-height: 100px;
                padding: 1rem;
            }
            
            .student-metric-value {
                font-size: 1.5rem;
            }
            
            .advisor-spotlight-name {
                font-size: 2rem;
            }
        }
        
        @media screen and (max-width: 480px) {
            /* Small mobile */
            .header h1 {
                font-size: 1.1rem;
            }
            
            table {
                font-size: 0.7rem;
            }
            
            .tier-badge {
                font-size: 0.65rem;
                padding: 0.25rem 0.5rem;
            }
            
            .consistency-dot {
                width: 8px;
                height: 8px;
            }
            
            .student-metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .student-metric-card {
                min-height: 90px;
            }
        }
    

/* ==========================================================
   V9.0 DESIGN REFRESH (Brand-first, metric-forward)
   - Keeps existing layout/JS intact
   - Re-skins UI with Nectar core + neutral system palette
   - Preserves semantic red/green for performance indicators
   ========================================================== */

:root{
  /* Tag palette (portable theme defaults) */
  --tag-info: #2563eb;
  --tag-success: #16a34a;
  --tag-warning: #b45309;
  --tag-danger: #931a1d;
  --tag-brass: #a28150;
  --tag-sage: #7E8F7A;
  --tag-sage-2: #5f7360;
  --tag-neutral: #6f6a61;
  --tag-neutral-2: #374151;

  /* Core brand (given) */
  --brand-accent: #931a1d;      /* Nectar Accent (Red) */
  --brand-accent-2: #7d2528;    /* Deeper red for gradients */
  --brand-brass: #a28150;       /* Nectar Extra 1 (Brass) */

  /* Neutrals (warm, dashboard-friendly) */
  --bg: #F2EEE6;                /* Warm parchment */
  --bg-alt: #EFE9DD;            /* Warm parchment alt */
  --surface: #FFFFFF;           /* Card */
  --surface-2: #FBFAF7;         /* Subtle card tint */
  --text: #2a2a2a;              /* Near-black */
  --muted: #6f6a61;             /* Warm gray text */
  --border: rgba(42,42,42,.12);

  /* Support accents (quiet, non-brand) */
  --sage: #7E8F7A;              /* Muted Sage */
  --sage-2: #5F7360;            /* Dark sage */
  --ink: #1f2937;               /* Deep neutral for outlines */
  --teal: #2f8f7c;              /* Teal accent */
  --steel: #4b5563;             /* Steel gray */
  
  /* Parchment variations (for Program Tracking card) */
  --parchment: #efe9dd;         /* Warm Parchment (Recommended) */
  --parchment-2: #f5f1e8;       /* Warm Parchment Alt */

  /* Semantic status (must remain clear) */
  --success: #16a34a;
  --warning: var(--brand-brass);
  --danger: var(--brand-accent);
  --info: #2563eb;

  /* Elevation */
  --shadow-sm: 0 2px 8px rgba(0,0,0,.08);
  --shadow-md: 0 10px 26px rgba(0,0,0,.14);
  --radius: 14px;
}

/* Global */
body{
  background: radial-gradient(1200px 600px at 20% 0%, rgba(162,129,80,.10), transparent 55%),
              radial-gradient(900px 480px at 90% 10%, rgba(126,143,122,.10), transparent 55%),
              var(--bg) !important;
  color: var(--text) !important;
}

.container{ max-width: 1480px !important; }

h1,h2,h3,h4,h5,h6{ letter-spacing: .2px; }
.loading{ color: var(--muted) !important; }

/* Global emoji styling - consistent size/rendering */
.emoji-icon,
.achievement-icon,
.status-icon {
  font-size: 1.5rem !important;
  line-height: 1 !important;
  display: inline-block;
  vertical-align: middle;
}

.emoji-large {
  font-size: 2rem !important;
  line-height: 1 !important;
}

/* Header */
.header{
  background: linear-gradient(135deg, var(--brand-accent) 0%, #7d2528 100%) !important;
  box-shadow: 0 10px 28px rgba(97,23,24,.25) !important;
}

/* Header visibility management for overlay views */
.header-hidden {
    display: none !important;
}

/* Ensure smooth transition */
.header {
    transition: opacity 0.2s ease;
}

.header .subtitle{ opacity: .92 !important; }
.header select option{ background: var(--ink) !important; }

/* Buttons */
.back-button{
  background: linear-gradient(135deg, var(--surface) 0%, var(--surface-2) 100%) !important;
  color: var(--brand-accent) !important;
  border: 2px solid rgba(147,26,29,.35) !important;
  box-shadow: var(--shadow-sm) !important;
}
.back-button:hover{
  transform: translateY(-2px) !important;
  box-shadow: var(--shadow-md) !important;
  border-color: rgba(147,26,29,.55) !important;
}

.action-buttons button{
  border-radius: 12px !important;
  box-shadow: var(--shadow-sm) !important;
}
.action-buttons button:hover{ box-shadow: var(--shadow-md) !important; }

.btn-recommendations{
  background: linear-gradient(135deg, var(--brand-accent) 0%, #7d2528 100%) !important;
}
.btn-export-pdf{
  background: linear-gradient(135deg, var(--sage) 0%, var(--sage-2) 100%) !important;
}
.btn-achievements{
  background: linear-gradient(135deg, var(--brand-brass) 0%, #7b5c33 100%) !important;
}
.btn-log-note{
  background: linear-gradient(135deg, var(--sage) 0%, #2f6b50 100%) !important;
}

/* Cards & Sections */
.metrics-section,
.highlights-section,
.momentum-tracker-section,
.chart-container,
.controls,
.student-table,
.advisor-card,
.spotlight-stat{
  border-radius: var(--radius) !important;
  border: 1px solid var(--border) !important;
  box-shadow: var(--shadow-sm) !important;
}

.metrics-section h3,
.section-header,
.chart-title,
.highlights-section h2,
.momentum-tracker-section h2{
  color: var(--text) !important;
}

.section-header{
  border-bottom: 3px solid rgba(162,129,80,.9) !important;
}

/* Wins banner: keep celebratory green but calmer */
.wins-banner{
  background: white !important;
  border-left: 8px solid var(--success) !important;
  border-radius: var(--radius) !important;
  box-shadow: var(--shadow-sm) !important;
  padding: 1.5rem 2rem !important;
  margin-bottom: 2rem !important;
}
.wins-banner h2{
  color: var(--text) !important;
  margin-bottom: 1rem !important;
}
.wins-list,
.wins-list div,
.wins-list span{
  color: var(--text) !important;
}

/* Status colors (preserve clarity) */
.status-good{ color: var(--success) !important; }
.status-warning{ color: var(--warning) !important; }
.status-danger{ color: var(--danger) !important; }

/* Links & clickable labels */
.student-name-link,
.highlight-student{
  color: var(--sage-2) !important;
}
.student-name-link:hover,
.highlight-student:hover{
  color: var(--brand-accent) !important;
}

/* Filters */
.filter-btn:hover{
  border-color: rgba(162,129,80,.85) !important;
  background: rgba(162,129,80,.10) !important;
}
.filter-btn.active{
  background: linear-gradient(135deg, var(--brand-accent) 0%, #7d2528 100%) !important;
  border-color: rgba(147,26,29,.8) !important;
  box-shadow: 0 8px 20px rgba(147,26,29,.22) !important;
}

/* Table */
thead{ background: rgba(162,129,80,.08) !important; }
th{ color: var(--muted) !important; border-bottom: 2px solid rgba(162,129,80,.9) !important; }
th.sortable:hover{ background: rgba(147,26,29,.06) !important; }
tbody tr:nth-child(odd){ background: rgba(126,143,122,.05) !important; }
tbody tr:hover{
  background: linear-gradient(90deg, rgba(147,26,29,.08) 0%, rgba(162,129,80,.06) 100%) !important;
  border-left-color: rgba(147,26,29,.7) !important;
}

/* Advisor grades: keep semantic but align reds to brand */
.advisor-card-border.grade-d,
.advisor-card-grade.grade-d{ background: var(--brand-accent) !important; }
.advisor-card-border.grade-f,
.advisor-card-grade.grade-f{ background: var(--brand-accent-2) !important; }

/* Highlights: soften the "blue/teal/yellow" blocks to be less candy-coated */
.highlight-card{
  background: linear-gradient(180deg, var(--surface) 0%, var(--surface-2) 100%) !important;
}
.highlight-card.blue{
  border-left-color: var(--sage-2) !important;
  background: linear-gradient(135deg, rgba(126,143,122,.12) 0%, rgba(126,143,122,.06) 100%) !important;
}
.highlight-card.teal{
  border-left-color: rgba(162,129,80,.95) !important;
  background: linear-gradient(135deg, rgba(162,129,80,.14) 0%, rgba(162,129,80,.06) 100%) !important;
}
.highlight-card.yellow{
  border-left-color: rgba(147,26,29,.85) !important;
  background: linear-gradient(135deg, rgba(147,26,29,.12) 0%, rgba(147,26,29,.05) 100%) !important;
}

/* Small "stat pills" */
.tier-badge.tier-1{
  background: linear-gradient(135deg, var(--brand-accent) 0%, #7d2528 100%) !important;
  border-color: rgba(162,129,80,.65) !important;
}
.tier-badge.tier-4{
  background: linear-gradient(135deg, var(--sage) 0%, var(--sage-2) 100%) !important;
}

/* Dots: keep legible, slightly warmer outline */
.consistency-dot,
.pattern-dot,
.pattern-legend-dot{
  border-color: rgba(42,42,42,.7) !important;
}

/* Print: keep brand red instead of old purple */
@media print{
  .header{
    background: var(--brand-accent) !important;
  }
  th{ border-bottom-color: var(--brand-brass) !important; }
}



/* ==========================================================
   V9.1 PATCH (Kill stray purple + unify subpages/overlays)
   ========================================================== */

/* Advisor Spotlight numbers (fix purple) */
.spotlight-stat-value{
  color: var(--brand-accent) !important;
}

/* Advisor Performance: Grade reveal "Hold" button (no purple) */
.grade-reveal-btn{
  background: linear-gradient(135deg, var(--sage) 0%, var(--sage-2) 100%) !important;
  box-shadow: 0 2px 10px rgba(95,115,96,.28) !important;
}
.grade-reveal-btn:hover{
  box-shadow: 0 6px 18px rgba(95,115,96,.38) !important;
}
.grade-reveal-btn.revealing{
  background: linear-gradient(135deg, var(--sage-2) 0%, var(--sage) 100%) !important;
  box-shadow: 0 8px 22px rgba(95,115,96,.45) !important;
}

/* Advisor Performance: Grade color system (A/B/C/D/F) */
.advisor-card-border.grade-a,
.advisor-card-grade.grade-a{ background: var(--success) !important; }

.advisor-card-border.grade-b,
.advisor-card-grade.grade-b{ background: var(--sage-2) !important; }

.advisor-card-border.grade-c,
.advisor-card-grade.grade-c{ background: var(--warning) !important; }

.advisor-card-border.grade-d,
.advisor-card-grade.grade-d{ background: var(--brand-accent) !important; }

.advisor-card-border.grade-f,
.advisor-card-grade.grade-f{ background: var(--brand-accent-2) !important; }

/* Student scorecard: semester toggles */
.semester-btn:hover{
  border-color: rgba(162,129,80,.85) !important;
  background: rgba(162,129,80,.10) !important;
}
.semester-btn.active{
  background: linear-gradient(135deg, var(--brand-brass) 0%, #7b5c33 100%) !important;
  border-color: rgba(162,129,80,.85) !important;
  color: white !important;
}

/* Student scorecard: keep label muted color only */
.deadline-countdown-box .deadline-label{ color: var(--muted) !important; }

/* Program Tracking overlay: base skin (works even if inline styles remain) */
#programTrackingOverlay{
  background: radial-gradient(1200px 600px at 20% 0%, rgba(162,129,80,.10), transparent 55%),
              radial-gradient(900px 480px at 90% 10%, rgba(126,143,122,.10), transparent 55%),
              var(--bg) !important;
}
#programTrackingOverlay h1{ color: var(--brand-accent) !important; }
#programTrackingOverlay button{
  box-shadow: var(--shadow-sm) !important;
}



/* ==========================================================
   V9.2 PATCH (Program Tracking view polish + restore branding)
   ========================================================== */

/* Generic view container */
.page-view{
  padding-top: 12px;
}

/* When Program Tracking is active, give it consistent top rhythm */
#programTrackingView .container{
  padding-top: 12px !important;
}

/* Prevent accidental extra top whitespace from injected content */
#programTrackingContent > *:first-child{
  margin-top: 10px !important;
}

/* Remove any stray purple buttons/tabs across pages */
/* Removed duplicate :root */

/* Common tab/button classes observed in the UI */
.tab.active, .tab-button.active, .course-tab.active, .program-tab.active,
.pill.active, .chip.active, .segmented button.active{
  background: linear-gradient(135deg, var(--brand-accent) 0%, #7d2528 100%) !important;
  color: #fff !important;
  border-color: rgba(147,26,29,.85) !important;
}

/* If an element still uses purple via inline styles, soften it */

/* Program Tracking top cards: keep consistent brand look (no candy red) */
#programTrackingView .program-card,
#programTrackingView .summary-card,
#programTrackingView .metric-card{
  border-radius: var(--radius) !important;
  box-shadow: var(--shadow-sm) !important;
}

/* Specifically tame the Distribution card background if it was hard-coded bright red */
#programTrackingView .distribution-card,
#programTrackingView [data-card="distribution"]{
  background: linear-gradient(135deg, rgba(147,26,29,.95) 0%, rgba(97,23,24,.95) 100%) !important;
}

/* Ensure chart legends are visible on dark cards */
#programTrackingView .chart-legend,
#programTrackingView .legend,
#programTrackingView .distribution-legend{
  display: flex !important;
  flex-wrap: wrap !important;
  gap: 10px 14px !important;
  justify-content: center !important;
  color: rgba(255,255,255,.92) !important;
  margin-top: 10px !important;
  padding: 6px 10px !important;
}
#programTrackingView .chart-legend span,
#programTrackingView .legend span,
#programTrackingView .distribution-legend span{
  white-space: nowrap !important;
  font-size: 12.5px !important;
}
#programTrackingView .legend-color,
#programTrackingView .legend-swatch{
  width: 10px !important;
  height: 10px !important;
  border-radius: 3px !important;
  margin-right: 6px !important;
  display: inline-block !important;
}

/* Fix "Back to Dashboard" duplicate styling if any generic button appears */
#programTrackingView .back-to-dashboard,
#programTrackingView .btn-back-dashboard{
  display: none !important;
}



/* ==========================================================
   V9.3 PATCH (Student Scorecard facelift + kill purple crumbs)
   Portable rules only: tokens/classes, no data assumptions.
   ========================================================== */

/* Program Tracking: Distribution card should be neutral (chart provides color) */
#programTrackingView .distribution-card,
#programTrackingView [data-card="distribution"]{
  background: linear-gradient(180deg, var(--surface) 0%, var(--surface-2) 100%) !important;
  color: var(--text) !important;
  border: 1px solid var(--border) !important;
}
#programTrackingView .distribution-card h3,
#programTrackingView [data-card="distribution"] h3{
  color: var(--brand-accent) !important;
}
#programTrackingView .chart-legend,
#programTrackingView .legend,
#programTrackingView .distribution-legend{
  color: var(--muted) !important;
}

/* Student Scorecard: remove legacy purple header gradients */
.student-header,
.scorecard-header,
.student-banner,
.student-title-bar,
#studentPage .header,
#studentView .header{
  background: linear-gradient(135deg, var(--brand-accent) 0%, #7d2528 100%) !important;
  color: #fff !important;
  box-shadow: 0 10px 28px rgba(97,23,24,.22) !important;
}

/* Student Scorecard: action button row inherits modern button styling */
#studentPage .action-buttons button,
#studentView .action-buttons button{
  border-radius: 12px !important;
  box-shadow: var(--shadow-sm) !important;
}
#studentPage .action-buttons button:hover,
#studentView .action-buttons button:hover{
  box-shadow: var(--shadow-md) !important;
}

/* Student Scorecard: old blue/green variant tiles -> semantic system */
.tile.blue, .metric-tile.blue, .stat-box.blue{
  background: rgba(37, 99, 235, .10) !important;
  border-color: rgba(37, 99, 235, .18) !important;
}
.tile.green, .metric-tile.green, .stat-box.green{
  background: rgba(22, 163, 74, .12) !important;
  border-color: rgba(22, 163, 74, .18) !important;
}
.tile.red, .metric-tile.red, .stat-box.red{
  background: rgba(220, 38, 38, .10) !important;
  border-color: rgba(220, 38, 38, .18) !important;
}
.tile.yellow, .metric-tile.yellow, .stat-box.yellow{
  background: rgba(245, 158, 11, .12) !important;
  border-color: rgba(245, 158, 11, .20) !important;
}

/* SUPERSTAR badge/tag: replace purple with brass-forward accent */
.superstar,
.superstar-badge,
.badge-superstar,
.tag-superstar{
  background: linear-gradient(135deg, var(--brand-brass) 0%, #7b5c33 100%) !important;
  color: #fff !important;
  border: 1px solid rgba(162,129,80,.55) !important;
}

/* Global purple breadcrumb kill-switch: map common purple gradients to brand */



/* =======================
   V9.0 Student View polish
   ======================= */
.student-tag{
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: var(--tag-bg, var(--tag-neutral));
  color: #fff;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 650;
  line-height: 1;
  box-shadow: 0 2px 10px rgba(17,24,39,.10);
  border: 1px solid rgba(255,255,255,.22);
  margin: 2px;
  white-space: nowrap;
}

/* Student header: remove purple gradient remnants */
.student-view-header, .student-header, .scorecard-header{
  background: linear-gradient(135deg, var(--brand-accent) 0%, #7d2528 100%) !important;
  color: #fff !important;
}

/* Back button across views */
/* Removed duplicate red .back-button - using white/border style from line 229 */



/* ==========================================================
   V10 THEME POLISH PASS (portable, no data assumptions)
   ========================================================== */
/* Removed duplicate :root - colors already defined above */

/* Big "Back to Dashboard" button: readable + consistent */
.back-to-dashboard,
button.back-to-dashboard,
a.back-to-dashboard,
#backToDashboardBtn{
  background: linear-gradient(135deg, var(--brand-accent) 0%, #7d2528 100%) !important;
  color: #fff !important;
  border: 1px solid rgba(255,255,255,.22) !important;
  text-shadow: 0 1px 0 rgba(0,0,0,.22) !important;
}
.back-to-dashboard:hover,
#backToDashboardBtn:hover{ filter: brightness(1.03); }

/* Program Tracking: distribution card should be neutral/parchment */
#programTrackingView .distribution-card,
#programTrackingView [data-card="distribution"]{
  background: linear-gradient(180deg, var(--parchment) 0%, var(--parchment-2) 100%) !important;
  color: var(--text) !important;
  border: 1px solid var(--border) !important;
}
#programTrackingView .distribution-card h3,
#programTrackingView [data-card="distribution"] h3{
  text-align: center !important;
  width: 100%;
}

/* Stat headings a touch larger */
#programTrackingView .top-card h3,
#programTrackingView .top-metric-card h3,
#programTrackingView .metric-card h3{
  font-size: 1.05rem !important;
  letter-spacing: .2px;
}

/* Program pills unified */
.pill.program,
.program-pill,
.program-tag,
.student-program-tag,
.course-pill,
.filter-pill{
  border-radius: 999px !important;
  padding: 6px 12px !important;
  font-weight: 700 !important;
  font-size: 12px !important;
  line-height: 1 !important;
  border: 1px solid rgba(255,255,255,.22) !important;
  box-shadow: var(--shadow-sm) !important;
  color: #fff !important;
}
.program--welding{ background: linear-gradient(135deg, var(--brand-accent) 0%, #7d2528 100%) !important; }
.program--electrical{ background: linear-gradient(135deg, var(--brand-brass) 0%, #7b5c33 100%) !important; }
.program--medical{ background: linear-gradient(135deg, var(--teal) 0%, #206a5d 100%) !important; }
.program--acad{ background: linear-gradient(135deg, var(--sage) 0%, #5f6f5c 100%) !important; }
.program--auto{ background: linear-gradient(135deg, var(--info) 0%, #1f5fb8 100%) !important; }
.program--construction{ background: linear-gradient(135deg, #8b5a2b 0%, #6b4420 100%) !important; }
.program--edtrain{ background: linear-gradient(135deg, var(--steel) 0%, var(--ink) 100%) !important; }

.filter-pill.active, .program-filter.active, .course-filter.active{
  outline: 2px solid rgba(162,129,80,.28);
  outline-offset: 1px;
}

/* Week banner */
.week-banner{
  border-radius: 12px;
  padding: 10px 14px;
  font-weight: 700;
  box-shadow: var(--shadow-sm);
  border: 1px solid rgba(0,0,0,.06);
}
.week-banner.banner--current{
  background: linear-gradient(180deg, var(--parchment) 0%, var(--parchment-2) 100%);
  color: var(--text);
  border-left: 6px solid rgba(162,129,80,.85);
}
.week-banner.banner--historical{
  background: linear-gradient(180deg, #fff3c4 0%, #f7e59a 100%);
  color: var(--text);
  border-left: 6px solid rgba(162,129,80,.95);
}

/* This Period's Wins: normalize */
#winsCard, .wins-card, .this-period-wins, .period-wins{
  background: linear-gradient(180deg, var(--surface) 0%, var(--surface-2) 100%) !important;
  border: 1px solid var(--border) !important;
  color: var(--text) !important;
}
#winsCard h2, .wins-card h2, .this-period-wins h2{ color: var(--brand-accent) !important; }
.wins-item, .wins-card .item, .this-period-wins .item{
  background: rgba(147,26,29,.06) !important;
  border: 1px solid rgba(147,26,29,.10) !important;
  border-left: 6px solid rgba(162,129,80,.85) !important;
  color: var(--text) !important;
}

/* SUPERSTAR badge border thickness */
.tier-badge.tier-5, .badge-superstar, .superstar-badge{
  border-width: 2px !important;
  box-shadow: 0 10px 26px rgba(0,0,0,.12) !important;
}

/* Progress Over Time buttons */
.timeframe-btn.sytd, .chart-btn.sytd, #sytdBtn{
  background: linear-gradient(135deg, var(--brand-brass) 0%, #7b5c33 100%) !important;
  color: #fff !important;
  border-color: rgba(162,129,80,.55) !important;
}
.timeframe-btn.semester, .chart-btn.semester{
  background: linear-gradient(180deg, var(--surface) 0%, var(--surface-2) 100%) !important;
  color: var(--text) !important;
  border: 1px solid var(--border) !important;
}
.timeframe-btn.semester.active, .chart-btn.semester.active{
  outline: 2px solid rgba(147,26,29,.18);
  outline-offset: 1px;
}

/* Achievement + Momentum: reuse legend-ish styling */
.achievement-item, .momentum-item, .legend-item-like{
  background: rgba(15,23,42,.03) !important;
  border: 1px solid rgba(15,23,42,.06) !important;
  border-left: 6px solid rgba(162,129,80,.85) !important;
  border-radius: 12px !important;
}

/* Calm steel tint for "Most Stable Team" style mini card */
.most-stable-team, .stable-team-card{
  background: linear-gradient(180deg, rgba(75,85,99,.12) 0%, rgba(75,85,99,.06) 100%) !important;
}


/* =========================================================
   Premier cousin-vibes polish (CSS-only: no functional logic)
   ========================================================= */

/* Global surfaces: warm parchment, less stark white */
:root{
  --surface-0: var(--parchment-2);
  --surface-1: #ffffff;
  --surface-2: #fbf7f0;
  --surface-3: #f3ede2;

  --ink-0: #1f2328;
  --ink-1: #2e2a25;
  --ink-muted: rgba(31,35,40,.72);

  --maroon-0: var(--brand-accent);
  --maroon-1: var(--brand-accent-2);
  --brass-0: var(--brand-brass);
  --brass-1: #b6925f;

  --stroke-soft: rgba(32,23,18,.10);
  --stroke-mid: rgba(32,23,18,.16);
}

/* Background: subtle Premier parchment (keeps contrast clean) */
body{
  background:
    radial-gradient(1200px 700px at 20% -10%, rgba(162,129,80,.14), transparent 60%),
    radial-gradient(900px 600px at 92% 0%, rgba(147,26,29,.12), transparent 62%),
    linear-gradient(180deg, var(--surface-0) 0%, var(--surface-1) 45%, var(--surface-0) 100%) !important;
  color: var(--ink-0);
}

/* Header: richer, website-adjacent, with a brass hairline */
.header{
  background: linear-gradient(135deg, rgba(147,26,29,.98) 0%, rgba(125,37,40,.98) 45%, rgba(97,23,24,.98) 100%) !important;
  box-shadow: 0 10px 28px rgba(0,0,0,.18) !important;
  border-bottom: 1px solid rgba(162,129,80,.38) !important;
}

/* New brand lockup */
.phs-brand{
  display: flex;
  align-items: center;
  gap: 14px;
  margin: 0;
}
.phs-brand__logoWrap{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 10px 20px;
  border-radius: 12px;
  background: linear-gradient(135deg, rgba(162, 129, 80, 0.15) 0%, rgba(147, 26, 29, 0.12) 100%);
  border: 1px solid rgba(162, 129, 80, 0.25);
  box-shadow: 0 4px 12px rgba(0,0,0,.12), inset 0 1px 0 rgba(255,255,255,0.1);
}
.phs-brand__logo{
  height: 28px;
  width: auto;
  display: block;
  filter: drop-shadow(0 6px 14px rgba(0,0,0,.25));
}
.phs-brand__campus{
  font-family: Poppins, Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  font-weight: 700;
  letter-spacing: .2px;
  color: rgba(255,255,255,.96);
  font-size: 1.65rem;
  line-height: 1.1;
}

/* Version badge: smaller, more "app" than "website" */
.version-badge{
  display: inline-flex !important;
  align-items: center !important;
  gap: 8px !important;
  padding: 6px 10px !important;
  border-radius: 999px !important;
  background: rgba(255,255,255,.10) !important;
  border: 1px solid rgba(255,255,255,.18) !important;
  color: rgba(255,255,255,.92) !important;
  font-weight: 700 !important;
  font-size: .82rem !important;
}
.version-badge__dot{
  width: 8px;
  height: 8px;
  border-radius: 99px;
  background: linear-gradient(180deg, #d4af37, var(--brass-0));
  box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.3), 0 0 10px rgba(212, 175, 55, 0.4);
  animation: pulse-glow 2s ease-in-out infinite;
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.3), 0 0 10px rgba(212, 175, 55, 0.4); }
  50% { box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.5), 0 0 15px rgba(212, 175, 55, 0.6); }
}

/* Reduce "everything is the same card": subtle families */
.top-card, .metric-card, .summary-card, .program-card, .distribution-card, .highlight-card,
.wins-card, .advisor-card, .student-metric-card, .stable-team-card{
  background: var(--surface-1);
  border: 1px solid var(--stroke-soft);
  box-shadow: var(--shadow-sm);
}

/* Give certain 'hero' blocks a Premier-tinted skin without becoming loud */
.top-card,
#programTrackingView .summary-card,
#programTrackingView .program-card{
  background:
    linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.98)) !important;
}

/* Brass accent rail (reads like "official", not flashy) */
.top-card::before,
.metric-card::before,
.summary-card::before,
.program-card::before,
.wins-card::before,
.highlight-card::before{
  content: "";
  display: block;
  height: 6px;
  border-radius: calc(var(--radius) - 2px) calc(var(--radius) - 2px) 0 0;
  background: linear-gradient(90deg, rgba(162,129,80,.88), rgba(147,26,29,.22));
}

/* Alternate some cards automatically so views feel connected but not cloned */
.dashboard-grid > *:nth-child(3n+2) .metric-card::before,
.dashboard-grid > *:nth-child(3n+2) .summary-card::before{
  background: linear-gradient(90deg, rgba(147,26,29,.58), rgba(162,129,80,.30));
}

/* Section headers: app-like 'ribbon' */
.section-title, h2.section-title, .section h2{
  position: relative;
  padding-left: 14px;
}
.section-title::before, .section h2::before{
  content: "";
  position: absolute;
  left: 0;
  top: .25em;
  bottom: .25em;
  width: 4px;
  border-radius: 99px;
  background: linear-gradient(180deg, rgba(162,129,80,.95), rgba(147,26,29,.55));
}

/* Tables & lists: reduce the starkness; keep readability */
table{
  background: var(--surface-1);
}
thead th{
  background: var(--surface-2) !important;
  border-bottom: 1px solid var(--stroke-mid) !important;
}
tbody tr:nth-child(even){
  background: rgba(245,241,232,.58) !important;
}
tbody tr:hover{
  background: rgba(162,129,80,.10) !important;
}

/* Buttons: slightly less 'flat', more Premier */
button, .btn{
  box-shadow: 0 8px 18px rgba(0,0,0,.10);
}
button:hover, .btn:hover{
  box-shadow: 0 12px 26px rgba(0,0,0,.14);
}

/* Search bar + controls: look like part of the same system */
.header input[type="text"], .header input[type="search"]{
  border: 1px solid rgba(255,255,255,.18) !important;
  background: rgba(255,255,255,.10) !important;
  color: rgba(255,255,255,.95) !important;
}
.header input::placeholder{
  color: rgba(255,255,255,.70) !important;
}

/* View cohesion: consistent top spacing + soft divider */
.view, [id$="View"]{
  scroll-margin-top: 90px;
}



/* =========================================================
   Premier Cousin Polish v2
   - Logo: give it intentional space (logo-only lockup)
   - Typography: normalize headings/labels across cards/sections
   - Cards: introduce subtle modern depth without changing layout
   ========================================================= */

/* Typography scale (single source of truth) */
:root{
  --phs-font-sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
  --phs-h1: 1.65rem;
  --phs-h2: 1.35rem;
  --phs-h3: 1.10rem;
  --phs-label: 0.80rem;
  --phs-label-strong: 0.84rem;

  --phs-title-weight: 800;
  --phs-label-weight: 700;
  --phs-body-weight: 500;

  --phs-title-letter: -0.01em;
  --phs-label-letter: 0.06em;

  --phs-card-radius: 16px;
  --phs-card-border: rgba(31,41,55,0.10);
  --phs-card-shadow: 0 10px 28px rgba(17,24,39,0.10);
  --phs-card-shadow-soft: 0 6px 18px rgba(17,24,39,0.08);
}

/* Apply a consistent font family everywhere */
html, body{
  font-family: var(--phs-font-sans);
}

/* Header brand lockup */
.phs-brand--logoOnly{
  display: inline-flex;
  align-items: center;
  gap: 12px;
  line-height: 1;
  margin: 0;
}

.phs-brand__logoWrap--wide{
  display: inline-flex;
  align-items: center;
  padding: 10px 14px;
  border-radius: 14px;
  background: linear-gradient(135deg, rgba(255,255,255,0.90) 0%, rgba(147,26,29,0.06) 60%, rgba(176,141,87,0.06) 100%);
  border: 1px solid rgba(147,26,29,0.14);
  box-shadow: 0 6px 18px rgba(17,24,39,0.08);
}

.phs-brand__logo{
  height: 40px;
  width: auto;
  display: block;
  transform: translateY(1px);
  filter: drop-shadow(0 2px 10px rgba(0,0,0,0.16));
}

/* Ensure subtitle looks like a consistent subhead */
.subtitle{
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--muted);
  margin-top: 0.35rem;
  letter-spacing: 0.01em;
}

/* =========================
   Heading normalization
   ========================= */

/* Primary section headers */
.section-header,
.student-section-title,
.chart-title{
  font-size: var(--phs-h2) !important;
  font-weight: var(--phs-title-weight) !important;
  letter-spacing: var(--phs-title-letter) !important;
  text-transform: none !important;
}

/* Card titles and â€œpanelâ€ headers that behave like titles */
.deadline-title,
.advisor-card-name{
  font-size: var(--phs-h3) !important;
  font-weight: var(--phs-title-weight) !important;
  letter-spacing: var(--phs-title-letter) !important;
  text-transform: none !important;
}

/* Labels inside metric cards */
.metric-label,
.student-metric-label{
  font-size: var(--phs-label-strong) !important;
  font-weight: var(--phs-label-weight) !important;
  text-transform: uppercase !important;
  letter-spacing: var(--phs-label-letter) !important;
  color: var(--muted) !important;
}

/* Ensure any ad-hoc headings donâ€™t randomly shout */
h1, h2, h3{
  text-transform: none;
  letter-spacing: var(--phs-title-letter);
}

/* =========================
   Modern card feel (without layout changes)
   ========================= */
.metric-card,
.student-metric-card,
.advisor-card,
.highlight-card,
.perfect-week-student-card,
.program-student-card{
  border-radius: var(--phs-card-radius) !important;
  border: 1px solid var(--phs-card-border) !important;
  box-shadow: var(--phs-card-shadow-soft) !important;
  background: linear-gradient(180deg, rgba(255,255,255,0.96) 0%, rgba(255,255,255,0.90) 100%) !important;
  backdrop-filter: blur(2px);
}

/* Subtle lift on hover for â€œinteractiveâ€ feel */
.metric-card:hover,
.student-metric-card:hover,
.advisor-card:hover,
.highlight-card:hover,
.perfect-week-student-card:hover,
.program-student-card:hover{
  transform: translateY(-2px);
  box-shadow: var(--phs-card-shadow) !important;
  transition: transform 160ms ease, box-shadow 160ms ease;
}

/* Give different sections slight visual identity via borders, not chaos */
.section-header{
  border-bottom-width: 2px !important;
  border-bottom-color: rgba(147,26,29,0.50) !important;
}

.student-section-title{
  border-bottom-color: rgba(176,141,87,0.55) !important;
}

/* Charts: tighten title spacing to feel like a dashboard, not a document */
.chart-title{
  margin-bottom: 1.0rem !important;
}

/* Chips/badges: normalize caps + weight so they read as system UI */
.category-badge,
.version-badge,
.phs-chip{
  font-weight: 800 !important;
  letter-spacing: 0.04em;
}

/* ============================================================================
   DEVICE-SPECIFIC OPTIMIZATIONS
   ============================================================================ */

/* Mobile phones (320px - 767px) */
@media (max-width: 767px) {
    .header {
        padding: 1rem !important;
    }
    
    .phs-brand__campus {
        font-size: 1.2rem !important;
    }
    
    .phs-brand__logo {
        height: 20px !important;
    }
    
    #globalSearch {
        min-width: 100% !important;
        font-size: 0.8rem !important;
    }
    
    .phs-hero__grid {
        grid-template-columns: 1fr !important;
    }
    
    .phs-wins__grid {
        grid-template-columns: 1fr !important;
    }
    
    .highlights-grid {
        grid-template-columns: 1fr !important;
    }
    
    /* Make tables scrollable on mobile */
    .student-table {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    /* Larger touch targets */
    button, .btn {
        min-height: 44px !important;
        padding: 0.75rem 1.25rem !important;
    }
}

/* Override inline styles for program tracking cards on mobile */
@media (max-width: 767px) {
    #programTrackingOverlay > div > div[style*="grid-template-columns: repeat(3, 1fr)"] {
        display: grid !important;
        grid-template-columns: 1fr !important;
        gap: 1rem !important;
    }
}

@media (min-width: 768px) and (max-width: 1024px) {
    #programTrackingOverlay > div > div[style*="grid-template-columns: repeat(3, 1fr)"] {
        display: grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 1.25rem !important;
    }
}


/* Tablets (768px - 1024px) */
@media (min-width: 768px) and (max-width: 1024px) {
    .container {
        max-width: 100% !important;
        padding: 1.5rem !important;
    }
    
    .phs-hero__grid {
        grid-template-columns: 1.2fr 1fr !important;
    }
    
    .phs-wins__grid {
        grid-template-columns: repeat(2, 1fr) !important;
    }
    
    .highlights-grid {
        grid-template-columns: repeat(2, 1fr) !important;
    }
    
    /* Optimize program tracking for tablet */
    #programTrackingView .program-card {
        grid-template-columns: repeat(2, 1fr) !important;
    }
}

/* Chromebooks / Small Laptops (1024px - 1366px) */
@media (min-width: 1024px) and (max-width: 1366px) {
    .container {
        max-width: 1280px !important;
    }
    
    .phs-hero__grid {
        grid-template-columns: 1.5fr 1fr !important;
    }
    
    /* Ensure charts are visible */
    canvas {
        max-width: 100% !important;
        height: auto !important;
    }
}

/* Large displays / TV (1920px+) */
@media (min-width: 1920px) {
    .container {
        max-width: 1800px !important;
    }
    
    .header {
        padding: 2rem !important;
    }
    
    .phs-brand__campus {
        font-size: 2rem !important;
    }
    
    .phs-hero__grid {
        grid-template-columns: 1.8fr 1fr !important;
    }
    
    /* Larger text for readability on big screens */
    body {
        font-size: 18px !important;
    }
    
    h2 {
        font-size: 2rem !important;
    }
    
    /* Make program tracking cards bigger */
    #programTrackingView .program-student-card {
        font-size: 1.1rem !important;
    }
}

/* 4K displays (2560px+) */
@media (min-width: 2560px) {
    .container {
        max-width: 2400px !important;
    }
    
    body {
        font-size: 20px !important;
    }
    
    .phs-brand__campus {
        font-size: 2.5rem !important;
    }
    
    .phs-hero__grid {
        grid-template-columns: 2fr 1fr !important;
    }
}

/* Landscape orientation specific */
@media (orientation: landscape) and (max-height: 600px) {
    .header {
        padding: 0.75rem 1.5rem !important;
    }
    
    .phs-brand__logo {
        height: 22px !important;
    }
}

/* Print optimization */
@media print {
    .header {
        display: block !important;
        background: white !important;
        color: black !important;
        border-bottom: 2px solid #931a1d !important;
    }
    
    #globalSearch,
    #weekSelector,
    .version-badge,
    button {
        display: none !important;
    }
    
    .phs-hero {
        page-break-inside: avoid;
    }
}

/* Force search bar to stay white */
#globalSearch {
    background: rgba(255, 255, 255, 0.95) !important;
    color: var(--text) !important;
}

#globalSearch::placeholder {
    color: rgba(0, 0, 0, 0.5) !important;
}



/* Ensure certification borders show properly */
.program-student-card[style*="4px solid var(--brand-brass)"] {
    border-color: #a28150 !important;
    border-width: 4px !important;
    box-shadow: 0 2px 8px rgba(162, 129, 80, 0.3) !important;
}


/* ============================================================================
   GAUGE COMPONENTS - Student Scorecard
   ============================================================================ */

.gauge-card {
    background: linear-gradient(135deg, rgba(250,250,250,1) 0%, rgba(245,245,245,1) 100%);
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 12px;
    padding: 1rem 1rem 1.25rem 1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    transition: all 0.2s;
    min-height: 180px;
}

.gauge-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.gauge-label {
    font-size: 0.75rem;
    font-weight: 700;
    color: rgba(42,42,42,0.85);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    text-align: center;
    line-height: 1.2;
    margin-bottom: 0;
    padding-bottom: 0.4rem;
    border-bottom: 2px solid rgba(0,0,0,0.1);
    width: 100%;
}

.gauge-canvas-container {
    position: relative;
    width: 130px;
    height: 85px;
    flex-shrink: 0;
}

.gauge-canvas {
    width: 100%;
    height: 100%;
}

.gauge-value {
    font-size: 1.35rem;
    font-weight: 700;
    color: var(--ink-0, #1f2328);
    text-align: center;
    margin-top: 0;
}

.gauge-tooltip {
    position: absolute;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    font-size: 0.75rem;
    pointer-events: none;
    z-index: 1000;
    white-space: nowrap;
    opacity: 0;
    transition: opacity 0.2s;
}

.gauge-tooltip.show {
    opacity: 1;
}

/* Grid layout for gauges */
#studentMetricsGrid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

@media (max-width: 768px) {
    #studentMetricsGrid {
        grid-template-columns: repeat(2, 1fr);
    }
}


/* Premier Logo Pulsing Animation */
@keyframes phs-pulse {
    0%, 100% {
        opacity: 0.6;
        transform: scale(1);
    }
    50% {
        opacity: 1;
        transform: scale(1.05);
    }
}

.loading-logo {
    animation: phs-pulse 2s ease-in-out infinite;
    max-width: 200px;
    margin: 0 auto 1rem;
}

.loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 50vh;
    text-align: center;
}

.loading-text {
    font-size: 1.1rem;
    color: var(--ink-muted, rgba(31,35,40,0.72));
    font-weight: 500;
}


/* Feedback Link in Footer */
.feedback-link-container {
    text-align: center;
    padding: 1.5rem 0 1rem 0;
    border-top: 1px solid rgba(0,0,0,0.1);
    margin-top: 2rem;
}

.feedback-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--brand-accent, #931a1d);
    text-decoration: none;
    font-size: 0.95rem;
    font-weight: 600;
    padding: 0.75rem 1.5rem;
    border: 2px solid var(--brand-accent, #931a1d);
    border-radius: 8px;
    transition: all 0.2s;
    background: white;
}

.feedback-link:hover {
    background: var(--brand-accent, #931a1d);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(147, 26, 29, 0.3);
}

.feedback-link-icon {
    font-size: 1.2rem;
}


/* Admin Hold / Special Category Chips - Standardized */
.category-badge {
    display: inline-block;
    background: var(--muted);
    color: white;
    padding: 0.4rem 0.75rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    text-align: center;
    line-height: 1.3;
    min-width: 120px;
    max-width: 160px;
    white-space: normal;
    word-wrap: break-word;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Admin Hold Chip Colors */
.category-badge.suspended {
    background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
}

.category-badge.medical {
    background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
}

.category-badge.counseling {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
}

.category-badge.transitioning {
    background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
}

.category-badge.district-transfer {
    background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);
}

.category-badge.academic-probation {
    background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%);
}

.category-badge.ofsdp {
    background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
}

.category-badge.texas-works {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
}

.category-badge.enm-hold {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}

.category-badge.withdrawn {
    background: linear-gradient(135deg, #64748b 0%, #475569 100%);
}

.category-badge.graduation-pending {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.category-badge.extended-absence {
    background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
}

.category-badge.other {
    background: linear-gradient(135deg, #71717a 0%, #52525b 100%);
}

</style>
</head>
<body>
<div class="header">
<div style="display: flex; justify-content: space-between; align-items: flex-start;">
<div>
<h1 class="phs-brand phs-brand--logoOnly">
<span aria-hidden="true" class="phs-brand__logoWrap phs-brand__logoWrap--wide">
<img alt="Premier High School" class="phs-brand__logo" src="https://premierhighschools.com/wp-content/uploads/2022/07/Premier_Light-Transparent.webp"/>
</span>

<span class="version-badge" title="Dashboard build/version"><span aria-hidden="true" class="version-badge__dot"></span><span class="version-badge__text">v9.0</span></span>
</h1>
<div class="subtitle">Student Progress Dashboard</div>
</div>
<div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end; margin-top: 0.5rem;">
<!-- Global Search Bar (Top Row) -->
<input id="globalSearch" onkeyup="handleGlobalSearch(event)" placeholder="ðŸ” Search students, IDs, programs, certs..." style="padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); font-size: 0.85rem; background: rgba(255,255,255,0.95); color: var(--text); min-width: 300px; font-weight: 500;" type="text"/>
<!-- Selectors Row (Bottom) -->
<div style="display: flex; gap: 1rem; align-items: center;">
<span style="font-size: 0.75rem; color: rgba(255,255,255,0.9); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Select Upload:</span>
<select id="weekSelector" onchange="switchWeek()" style="padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); font-size: 0.85rem; cursor: pointer; background: rgba(255,255,255,0.2); color: white; font-weight: 500;">
<!-- Populated dynamically -->
</select>
<div id="dateRange" style="background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.75rem; color: rgba(255,255,255,0.8); white-space: nowrap;"></div>
</div>
</div>
</div>
</div>
<div class="container">
<div class="loading" id="loadingMessage">
            <img src="https://premierhighschools.com/wp-content/uploads/2022/07/Premier_Light-Transparent.webp" 
                 alt="Premier High School" 
                 class="loading-logo">
            <div class="loading-text">Preparing your dashboard...</div>
        </div>
<!-- Main Dashboard View -->
<div class="main-view" id="mainView">
<!-- Week Indicator Banner -->
<div class="week-indicator-banner" id="weekIndicatorBanner"></div>
<!-- =========================
                 PHS HERO: Wins + Student Spotlight
                 ========================= -->
<section class="phs-hero" id="phsHero">
<div class="phs-hero__header">
<h2 class="phs-hero__title">
<span>ðŸ†</span> This Week's Wins
                    </h2>
</div>
<div class="phs-hero__grid">
<!-- LEFT: Wins -->
<div class="phs-wins">
<div class="phs-wins__top">
<h3>Wins &amp; Momentum</h3>
</div>
<div class="phs-wins__cards" id="phsWinsCards"></div>
</div>
<!-- RIGHT: Student Spotlight -->
<aside class="phs-spotlight" id="phsSpotlight">
<div class="phs-spotlight__cap">
<span class="phs-spotlight__capIcon">ðŸŽ¯</span>
<div>
<div class="phs-spotlight__label">Student Spotlight</div>
</div>
</div>
<div class="phs-spotlight__body">
<div class="phs-spotlight__identity">
<div class="phs-avatar" id="phsSpotlightAvatar">S</div>
<div class="phs-spotlight__who">
<div class="phs-spotlight__name" id="phsSpotlightName">Loadingâ€¦</div>
<div class="phs-spotlight__tags" id="phsSpotlightTags">
<span class="phs-chip" id="phsSpotlightProgram">Loading...</span>
</div>
</div>
</div>
<div class="phs-spotlight__why" id="phsSpotlightWhy">
                                Finding something awesomeâ€¦
                            </div>
<div class="phs-spotlight__stats" id="phsSpotlightStats"></div>
</div>
</aside>
</div>
</section>
<!-- This Week's Stars -->
<div class="highlights-section">
<h2>â­ This Week's Stars</h2>
<div class="highlights-grid" id="highlightsGrid"></div>
</div>
<!-- Quick Student Filters -->
<div style="background: white; border-radius: var(--radius); padding: 1.5rem 2rem; margin-bottom: 2rem; box-shadow: var(--shadow-sm); border: 1px solid var(--border);">
<h3 style="font-weight: 700; font-size: 1.5rem; margin-bottom: 1rem; color: var(--text); display: flex; align-items: center; gap: 0.5rem;">
<span style="font-size: 1.5rem;">ðŸ“‹</span> Student Directory
                    <button onclick="resetMainPageFilters()" style="margin-left: auto; padding: 0.5rem 1rem; background: var(--sage); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.85rem; box-shadow: var(--shadow-sm);">
                        ðŸ”„ Reset Filters
                    </button>
<button onclick="showAllStudentsDirectory()" style="padding: 0.5rem 1rem; background: linear-gradient(135deg, var(--brand-accent) 0%, #7d2528 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.85rem; box-shadow: var(--shadow-sm);">
                        View All â†’
                    </button>
</h3>
<div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 1.5rem;">
<!-- Search -->
<div>
<label style="font-size: 0.75rem; font-weight: 600; color: var(--muted); margin-bottom: 0.5rem; display: block;">SEARCH STUDENTS</label>
<input id="mainPageSearch" onkeyup="applyMainPageFilters()" placeholder="Type name or ID..." style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 2px solid var(--border); font-size: 0.9rem; background: var(--surface-2);" type="text"/>
</div>
<!-- Risk Tier -->
<div>
<label style="font-size: 0.75rem; font-weight: 600; color: var(--muted); margin-bottom: 0.5rem; display: block;">RISK TIER</label>
<select id="mainPageTierFilter" onchange="applyMainPageFilters()" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 2px solid var(--border); font-size: 0.9rem; background: var(--surface-2); cursor: pointer;">
<option value="all">All Tiers</option>
<option value="5">â­ Superstar</option>
<option value="4">âœ… On Track</option>
<option value="3">ðŸ‘€ Watch</option>
<option value="2">âš ï¸ High Risk</option>
<option value="1">ðŸš¨ Crisis</option>
</select>
</div>
<!-- Trajectory -->
<div>
<label style="font-size: 0.75rem; font-weight: 600; color: var(--muted); margin-bottom: 0.5rem; display: block;">TRAJECTORY</label>
<select id="mainPageTrajectoryFilter" onchange="applyMainPageFilters()" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 2px solid var(--border); font-size: 0.9rem; background: var(--surface-2); cursor: pointer;">
<option value="all">All Students</option>
<option value="breakthrough">ðŸš€ Breakthrough</option>
<option value="building">â¬†ï¸ Building</option>
<option value="stable">âž¡ï¸ Stable</option>
<option value="declining">â¬‡ï¸ Declining</option>
<option value="crisis">ðŸ“‰ Crisis</option>
</select>
</div>
</div>
<div id="mainPageFilterResults" style="margin-top: 1rem; padding: 0.75rem; background: var(--surface-2); border-radius: 6px; font-size: 0.85rem; color: var(--muted); display: none;"></div>
</div>
<!-- New Students Alert -->
<div class="new-students-alert" id="newStudentsAlert" style="display: none;">
<h3 style="font-weight: 700; font-size: 1.5rem; margin-bottom: 1rem; color: var(--text);">ðŸŽ‰ Welcome New Students!</h3>
<div class="new-students-grid" id="newStudentsGrid"></div>
</div>
<!-- Celebrations & Challenges -->
<div class="metrics-split">
<div class="metrics-section celebrations">
<h3 style="font-weight: 700; font-size: 1.5rem; margin-bottom: 1rem; color: var(--text);">âœ¨ Celebrations</h3>
<div id="celebrationsContent"></div>
</div>
<div class="metrics-section challenges">
<h3 style="font-weight: 700; font-size: 1.5rem; margin-bottom: 1rem; color: var(--text);">âš ï¸ Challenges</h3>
<div id="challengesContent"></div>
</div>
</div>
<!-- Main Dashboard Action Buttons -->
<div class="action-buttons no-print" style="margin: 2rem 0;">
<button class="btn-recommendations" onclick="generateCampusRecommendations()">
                    ðŸŽ¯ Get Recommendations
                </button>
<button class="btn-export-pdf" onclick="exportToPDF()">
                    ðŸ“„ Export to PDF
                </button>
<button class="btn-achievements" onclick="showAchievementsLegend()">
                    ðŸ† Achievement Legend
                </button>
</div>
<!-- Advisor Spotlight -->
<div class="advisor-spotlight" id="advisorSpotlight"></div>
<!-- Advisor Performance -->
<div class="section-header">ðŸ‘¥ Advisor Performance (Click to View Students)</div>
<div class="advisor-grid" id="advisorGrid"></div>
<!-- Waterfall Chart / Campus Health Check -->
<div class="chart-container">
<div class="chart-title">
<span>ðŸ“Š Campus Health Check</span>
<small style="display: block; font-size: 0.75rem; color: var(--muted); margin-top: 0.25rem;">On-track (green) vs. struggling (red) students over time</small>
</div>
<canvas height="100" id="waterfallChart"></canvas>
</div>
</div>
<!-- Advisor View -->
<div class="advisor-view" id="advisorView">
<button class="back-button" onclick="backToMain()">â† Back to Dashboard</button>
<div class="advisor-view-header" id="advisorViewHeader"></div>
<!-- Action Buttons for Advisor View (populated dynamically) -->
<div class="action-buttons no-print" id="advisorActionButtons"></div>
<div class="controls">
<div class="controls-row">
<input class="search-box" id="advisorSearchBox" placeholder="ðŸ” Search students by name..." type="text"/>
</div>
<div class="controls-row">
<strong>Risk Tiers:</strong>
<div class="filter-group" id="advisorTierFilters">
<button class="filter-btn active" data-filter="all" data-type="tier">All Students</button>
<button class="filter-btn" data-filter="5" data-type="tier">â­ Superstars</button>
<button class="filter-btn" data-filter="4" data-type="tier">ðŸŸ¢ On Track</button>
<button class="filter-btn" data-filter="3" data-type="tier">ðŸŸ¡ Watch</button>
<button class="filter-btn" data-filter="2" data-type="tier">ðŸŸ  High Risk</button>
<button class="filter-btn" data-filter="1" data-type="tier">ðŸ”´ Crisis</button>
</div>
</div>
<div class="controls-row">
<strong>Trajectory:</strong>
<div class="filter-group" id="advisorTrajectoryFilters">
<button class="filter-btn active" data-filter="all" data-type="trajectory">All</button>
<button class="filter-btn" data-filter="breakthrough" data-type="trajectory">ðŸš€ Breakthrough</button>
<button class="filter-btn" data-filter="building" data-type="trajectory">ðŸ“ˆ Building</button>
<button class="filter-btn" data-filter="stable" data-type="trajectory">ðŸŸ¢ Stable</button>
<button class="filter-btn" data-filter="declining" data-type="trajectory">ðŸ“‰ Declining</button>
<button class="filter-btn" data-filter="rapid_decline" data-type="trajectory">ðŸ”» Rapid Decline</button>
</div>
</div>
</div>
<div class="student-table">
<div class="table-wrapper">
<table id="advisorStudentTable">
<thead>
<tr>
<th class="sortable" data-sort="name">Student Name</th>
<th class="sortable" data-sort="tier">Risk Tier</th>
<th class="sortable" data-sort="velocity">Velocity</th>
<th class="sortable" data-sort="trajectory">Trajectory</th>
<th style="text-align: center;">
<div class="pattern-header-wrapper">
<span>Pattern</span>
<span class="pattern-info-icon">â“˜</span>
<div class="pattern-header-tooltip">
<div class="pattern-legend-row">
<div class="pattern-legend-dot-inline strong"></div>
<span>ðŸŸ¢ Met Minimum (â‰¥2.0 u/wk)</span>
</div>
<div class="pattern-legend-row">
<div class="pattern-legend-dot-inline adjusted"></div>
<span>ðŸ”µ Met Adjusted Goal (short week)</span>
</div>
<div class="pattern-legend-row">
<div class="pattern-legend-dot-inline below"></div>
<span>âšª Below Goal</span>
</div>
<div class="pattern-legend-row">
<div class="pattern-legend-dot-inline break"></div>
<span>âš« Break Week (no school)</span>
</div>
<div class="pattern-legend-row">
<div class="pattern-legend-dot-inline missing"></div>
<span>âš« No Data (no update that week)</span>
</div>
</div>
</div>
</th>
<th class="sortable" data-sort="badges">Badges</th>
<th class="sortable" data-sort="behind">Ahead/Behind</th>
<th class="sortable" data-sort="days_since">Last Activity</th>
<th class="sortable" data-sort="attendance">Attendance</th>
</tr>
</thead>
<tbody id="advisorStudentTableBody"></tbody>
</table>
</div>
</div>
<!-- Bottom Back Button -->
<button class="back-button" onclick="backToMain()" style="margin-top: 2rem;">â† Back to Dashboard</button>
</div>
<!-- Student Directory View (NEW) -->
<div class="student-view" id="studentDirectoryView">
<button class="back-button" onclick="backToMain()">â† Back to Dashboard</button>
<!-- Directory Header -->
<div class="section-header">ðŸ‘¨â€ðŸŽ“ All Students Dashboard</div>
<!-- Search and Filters -->
<div class="controls">
<div class="controls-row">
<input class="search-box" id="directorySearchBox" placeholder="ðŸ” Search students by name..." type="text"/>
</div>
<div class="controls-row">
<strong>Risk Tiers:</strong>
<div class="filter-group" id="directoryTierFilters">
<button class="filter-btn active" data-filter="all" data-type="tier">All Students</button>
<button class="filter-btn" data-filter="5" data-type="tier">â­ Superstars</button>
<button class="filter-btn" data-filter="4" data-type="tier">ðŸŸ¢ On Track</button>
<button class="filter-btn" data-filter="3" data-type="tier">ðŸŸ¡ Watch</button>
<button class="filter-btn" data-filter="2" data-type="tier">ðŸŸ  High Risk</button>
<button class="filter-btn" data-filter="1" data-type="tier">ðŸ”´ Crisis</button>
</div>
</div>
<div class="controls-row">
<strong>Trajectory:</strong>
<div class="filter-group" id="directoryTrajectoryFilters">
<button class="filter-btn active" data-filter="all" data-type="trajectory">All</button>
<button class="filter-btn" data-filter="breakthrough" data-type="trajectory">ðŸš€ Breakthrough</button>
<button class="filter-btn" data-filter="building" data-type="trajectory">ðŸ“ˆ Building</button>
<button class="filter-btn" data-filter="stable" data-type="trajectory">ðŸŸ¢ Stable</button>
<button class="filter-btn" data-filter="declining" data-type="trajectory">ðŸ“‰ Declining</button>
<button class="filter-btn" data-filter="rapid_decline" data-type="trajectory">ðŸ”» Rapid Decline</button>
</div>
</div>
</div>
<!-- Action Buttons -->
<div class="action-buttons no-print">
<button class="btn-recommendations" onclick="generateAIRecommendations()">
                    ðŸŽ¯ Get Smart Recommendations
                </button>
<button class="btn-export-pdf" onclick="exportToPDF()">
                    ðŸ“„ Export to PDF
                </button>
<button class="btn-achievements" onclick="showAchievementsLegend()">
                    ðŸ† Achievement Legend
                </button>
</div>
<!-- Student Table -->
<div class="student-table">
<div class="table-wrapper">
<table id="directoryStudentTable">
<thead>
<tr>
<th class="sortable" data-sort="name">Student Name</th>
<th class="sortable" data-sort="tier">Risk Tier</th>
<th class="sortable" data-sort="velocity">Velocity</th>
<th class="sortable" data-sort="trajectory">Trajectory</th>
<th style="text-align: center;">
<div class="pattern-header-wrapper">
<span>Pattern</span>
<span class="pattern-info-icon">â“˜</span>
<div class="pattern-header-tooltip">
<div class="pattern-legend-row">
<div class="pattern-legend-dot-inline strong"></div>
<span>ðŸŸ¢ Met Minimum (â‰¥2.0 u/wk)</span>
</div>
<div class="pattern-legend-row">
<div class="pattern-legend-dot-inline adjusted"></div>
<span>ðŸ”µ Met Adjusted Goal (short week)</span>
</div>
<div class="pattern-legend-row">
<div class="pattern-legend-dot-inline below"></div>
<span>âšª Below Goal</span>
</div>
<div class="pattern-legend-row">
<div class="pattern-legend-dot-inline break"></div>
<span>âš« Break Week (no school)</span>
</div>
<div class="pattern-legend-row">
<div class="pattern-legend-dot-inline missing"></div>
<span>âš« No Data (no update that week)</span>
</div>
</div>
</div>
</th>
<th class="sortable" data-sort="badges">Badges</th>
<th class="sortable" data-sort="behind">Ahead/Behind</th>
<th class="sortable" data-sort="days_since">Last Activity</th>
<th class="sortable" data-sort="attendance">Attendance</th>
</tr>
</thead>
<tbody id="directoryStudentTableBody"></tbody>
</table>
</div>
</div>
<!-- Bottom Back Button -->
<button class="back-button" onclick="backToMain()" style="margin-top: 2rem;">â† Back to Dashboard</button>
</div>
<!-- Student View -->
<div class="student-view" id="studentView">
<button class="back-button" onclick="backToMain()">â† Back to Dashboard</button>
<div class="student-view-header" id="studentViewHeader"></div>
<!-- Action Buttons for Student View -->
<div class="action-buttons no-print">
<button class="btn-staff-info" onclick="showPINPrompt(function(verified) { if (verified &amp;&amp; currentStudent) { showStudentView(currentStudent.name); setTimeout(() =&gt; window.scrollTo(0, 0), 100); } })" style="background: linear-gradient(135deg, var(--danger) 0%, var(--brand-accent) 100%); color: white;">
                    ðŸ”’ Staff Info
                </button>
<button class="btn-recommendations" onclick="generateStudentRecommendations()">
                    ðŸŽ¯ Student Action Plan
                </button>
<button class="btn-export-pdf" onclick="exportToPDF()">
                    ðŸ“„ Export to PDF
                </button>
<button class="btn-achievements" onclick="showAchievementsLegend()">
                    ðŸ† Achievement Legend
                </button>
</div>
<!-- Deadline Countdown Box -->
<div id="deadlineCountdownBox"></div>
<div class="student-metrics-grid" id="studentMetricsGrid"></div>
<div class="student-section">
<div class="student-section-title">ðŸ“ˆ Progress Over Time</div>
<div class="semester-filters">
<button class="semester-btn active" data-semester="ytd">School Year to Date</button>
<button class="semester-btn" data-semester="fall">Fall Semester</button>
<button class="semester-btn" data-semester="spring">Spring Semester</button>
</div>
<div class="student-chart-container">
<canvas id="studentProgressChart"></canvas>
</div>
</div>
<div class="student-section">
<div class="student-section-title">ðŸŽ¯ Consistency Pattern</div>
<div id="studentPatternDetail"></div>
</div>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem;">
<div class="student-section">
<div class="student-section-title">ðŸ† Achievements</div>
<ul class="achievement-list" id="studentAchievements"></ul>
</div>
<div class="student-section">
<div class="student-section-title">âš ï¸ Concerns &amp; Recommendations</div>
<ul class="concern-list" id="studentConcerns"></ul>
</div>
</div>
<!-- Advisor Notes Section -->
<div class="student-section">
<div class="student-section-title" style="display: flex; justify-content: space-between; align-items: center;">
<span>ðŸ“ Advisor Notes &amp; Interactions</span>
<button class="btn-log-note no-print" onclick="openNoteLogger()" style="background: linear-gradient(135deg, var(--teal) 0%, var(--success) 100%); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer; font-size: 0.95rem; font-weight: 600; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3); transition: all 0.2s;">
                        ðŸ“ Log Note
                    </button>
</div>
<div id="studentNotesDisplay"></div>
</div>
<!-- Bottom Back Button -->
<button class="back-button" onclick="backToMain()" style="margin-top: 2rem;">â† Back to Dashboard</button>
</div>
<!-- Filtered List View -->
<div class="filtered-list-view" id="filteredListView">
<button class="back-button" onclick="backToMain()">â† Back to Dashboard</button>
<div class="student-view-header" id="filteredListHeader"></div>
<div class="student-table">
<div class="table-wrapper">
<table id="filteredTable">
<thead>
<tr>
<th>Student Name</th>
<th>Risk Tier</th>
<th>Trajectory</th>
<th>Completed Units</th>
<th>Velocity</th>
<th>Acceleration</th>
<th>Ahead/Behind</th>
<th>Attendance</th>
<th>Badges</th>
</tr>
</thead>
<tbody id="filteredTableBody"></tbody>
</table>
</div>
</div>
<!-- Bottom Back Button -->
<button class="back-button" onclick="backToMain()" style="margin-top: 2rem;">â† Back to Dashboard</button>
</div>
<!-- Perfect Week Printable -->
<div class="perfect-week-printable" id="perfectWeekPrintable">
<div class="no-print" style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
<button class="back-button" onclick="backToMain()">â† Back to Dashboard</button>
<button class="back-button" onclick="exportPerfectWeekToPDF()" style="background: linear-gradient(135deg, var(--brand-brass) 0%, var(--warning) 100%);">
                    ðŸ“„ Export to PDF
                </button>
</div>
<div class="perfect-week-banner">
<h1>ðŸ† Perfect Week Club</h1>
<div class="subtitle" id="perfectWeekDate"></div>
</div>
<div class="perfect-week-description">
<strong>ðŸŒŸ What is the Perfect Week Club?</strong><br/>
                Students who achieve 95%+ attendance AND complete 2+ units in the week earn this elite recognition. 
                These students demonstrate the winning combination of showing up and doing the work!
            </div>
<div class="perfect-week-students-grid" id="perfectWeekStudentsGrid"></div>
</div>
</div>
<div class="feedback-link-container">
    <a href="https://docs.google.com/forms/d/e/1FAIpQLSdd84CUGfVjmu7eCanQV-Ws98nv0HyrGTgSeaSjaUX654fZEg/viewform" 
       target="_blank" 
       class="feedback-link"
       title="Report bugs, suggest improvements, or ask questions">
        <span class="feedback-link-icon">ðŸ’¬</span>
        <span>Found a bug or have an idea? <strong>Submit Feedback</strong></span>
    </a>
</div>
<div class="footer" id="lastUpdate">
        Last Updated: -<br/>
<small style="opacity: 0.7; font-size: 0.85rem;">Created by Tim Keener for Premier HS Gallery North - November 2025</small>
</div>
<script>
        // V8.0 DEBUG MODE: Set to true for development, false for production
        const DEBUG = true;
        
        // ================== V8.0 CONFIG SYSTEM ==================
        
        // Global config object - loaded at startup from PHS_Dashboard_Config Google Sheet
        const CONFIG = {
            advisorMappings: [],
            dataSources: {},
            studentGoals: new Map(),
            programTracking: new Map(),
            staffConfig: new Map(),
            tierThresholds: {},
            studentTags: new Map(),
            loaded: false,
            studentRoster: new Map(), // Student_Number -> student record
            rosterByName: new Map(), // 'LASTNAME, FIRSTNAME' -> student record
            settings: { campusID: '', campusName: '', pageTitle: '' },
            employmentPlacements: [],
            studentCertifications: []
        };
        
        // Config sheet URLs - only place where URLs need to be hardcoded
        const CONFIG_URLS = {
            advisorMappings: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRsl5jTp-3kG4YNj5d-ftmSRk0sKx2QscKHkKXScCErwK-i3-zEtjmnqLyW-ImNfw/pub?gid=2005887780&single=true&output=csv',
            dataSources: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRsl5jTp-3kG4YNj5d-ftmSRk0sKx2QscKHkKXScCErwK-i3-zEtjmnqLyW-ImNfw/pub?gid=1925424688&single=true&output=csv',
            studentGoals: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRsl5jTp-3kG4YNj5d-ftmSRk0sKx2QscKHkKXScCErwK-i3-zEtjmnqLyW-ImNfw/pub?gid=1121300328&single=true&output=csv',
            programTracking: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRsl5jTp-3kG4YNj5d-ftmSRk0sKx2QscKHkKXScCErwK-i3-zEtjmnqLyW-ImNfw/pub?gid=1228352888&single=true&output=csv',
            staffConfig: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRsl5jTp-3kG4YNj5d-ftmSRk0sKx2QscKHkKXScCErwK-i3-zEtjmnqLyW-ImNfw/pub?gid=812390050&single=true&output=csv',
            tierThresholds: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRsl5jTp-3kG4YNj5d-ftmSRk0sKx2QscKHkKXScCErwK-i3-zEtjmnqLyW-ImNfw/pub?gid=1395358924&single=true&output=csv',
            studentTags: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRsl5jTp-3kG4YNj5d-ftmSRk0sKx2QscKHkKXScCErwK-i3-zEtjmnqLyW-ImNfw/pub?gid=370645529&single=true&output=csv',
            studentRoster: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRsl5jTp-3kG4YNj5d-ftmSRk0sKx2QscKHkKXScCErwK-i3-zEtjmnqLyW-ImNfw/pub?gid=2039665337&single=true&output=csv',
            employmentPlacements: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRsl5jTp-3kG4YNj5d-ftmSRk0sKx2QscKHkKXScCErwK-i3-zEtjmnqLyW-ImNfw/pub?gid=1428012299&single=true&output=csv',
            studentCertifications: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRsl5jTp-3kG4YNj5d-ftmSRk0sKx2QscKHkKXScCErwK-i3-zEtjmnqLyW-ImNfw/pub?gid=1291046681&single=true&output=csv'
        };
        
        // Data source URLs - will be loaded from config
        let DATA_URL = '';
        let NOTES_URL = '';
        let FORM_BASE_URL = '';
        let FORM_ENTRIES = {};
        let CALENDAR_URL = '';
        
        
        // ================== GLOBAL STATE ==================
        let dashboardData = null;
        let schoolCalendar = null;
        let previousData = null;
        let currentAdvisor = null;
        let currentStudent = null;
        let advisorNotes = [];
        let currentSemester = 'ytd';
        let currentFilters = {
            tier: 'all',
            trajectory: 'all',
            search: ''
        };
        let currentSort = {
            column: 'velocity',
            direction: 'desc'
        };
        let waterfallChart = null;
        let studentProgressChart = null;
        
        // ================== ACHIEVEMENT DEFINITIONS ==================
        const ACHIEVEMENTS = [
            { id: 'first_10', icon: 'ðŸŽ¯', name: 'First 10 Units', check: s => s.currentUnits >= 10 },
            { id: '25_club', icon: 'ðŸ”¥', name: '25 Units Club', check: s => s.currentUnits >= 25 },
            { id: '50_club', icon: 'â­', name: '50 Units Club', check: s => s.currentUnits >= 50 },
            { id: '75_club', icon: 'ðŸ’Ž', name: '75 Units Club', check: s => s.currentUnits >= 75 },
            { id: '100_club', icon: 'ðŸ‘‘', name: '100 Units Club', check: s => s.currentUnits >= 100 },
            { id: 'speed_demon', icon: 'ðŸš€', name: 'Speed Demon', check: s => s.velocity >= 3 },
            { id: 'consistent_climber', icon: 'ðŸ“ˆ', name: 'Consistent Climber', check: s => s.acceleration > 0.5 && s.consistencyRatio > 0.75 },
            { id: 'sprint_finish', icon: 'âš¡', name: 'Sprint Finish', check: s => s.records.some((r, i) => i > 0 && (r.completed - s.records[i-1].completed) >= 5) },
            { id: 'perfect_attendance', icon: 'ðŸ’¯', name: 'Perfect Attendance', check: s => s.avgAttendance >= 99.5 },
            { id: 'excellent_attendance', icon: 'â­', name: 'Excellent Attendance', check: s => s.avgAttendance >= 95 },
            { id: 'strong_attendance', icon: 'ðŸŽ¯', name: 'Strong Attendance', check: s => s.avgAttendance >= 90 },
            { id: 'rock_solid', icon: 'ðŸŸ¢', name: 'Rock Solid', check: s => s.consistencyRatio >= 0.9 },
            { id: 'steady_progress', icon: 'â­', name: 'Steady Progress', check: s => s.consistencyRatio >= 0.75 },
            { id: 'tier_promotion', icon: 'ðŸ†', name: 'Tier Promotion', check: s => s.tierChange > 0 },
            { id: 'comeback_kid', icon: 'ðŸ’ª', name: 'Comeback Kid', check: s => s.trajectory === 'breakthrough' && s.tierChange > 0 },
            { id: 'on_target', icon: 'ðŸŽ¯', name: 'On Target', check: s => Math.abs(s.tracking) <= 2 },
            { id: 'ahead_of_pace', icon: 'ðŸ”¥', name: 'Ahead of Pace', check: s => s.tracking >= 5 },
            { id: 'sustained_improvement', icon: 'ðŸ“ˆ', name: 'Sustained Improvement', check: s => s.acceleration > 0 && s.velocity > 2 }
        ];
        
        // ================== ACHIEVEMENT LEGEND ==================
        function showAchievementsLegend() {
            const modal = document.createElement('div');
            modal.id = 'achievementLegendModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            // Group achievements by category
            const categories = {
                'Unit Milestones': [
                    { icon: 'ðŸŽ¯', name: 'First 10 Units', desc: 'Complete 10 units' },
                    { icon: 'ðŸ”¥', name: '25 Units Club', desc: 'Complete 25 units' },
                    { icon: 'â­', name: '50 Units Club', desc: 'Complete 50 units' },
                    { icon: 'ðŸ’Ž', name: '75 Units Club', desc: 'Complete 75 units' },
                    { icon: 'ðŸ‘‘', name: '100 Units Club', desc: 'Complete 100 units' }
                ],
                'Attendance Excellence': [
                    { icon: 'ðŸ’¯', name: 'Perfect Attendance', desc: '99.5%+ attendance rate' },
                    { icon: 'â­', name: 'Excellent Attendance', desc: '95%+ attendance rate' },
                    { icon: 'ðŸŽ¯', name: 'Strong Attendance', desc: '90%+ attendance rate' }
                ],
                'Performance Achievements': [
                    { icon: 'ðŸš€', name: 'Speed Demon', desc: '3+ units per week velocity' },
                    { icon: 'ðŸ“ˆ', name: 'Consistent Climber', desc: 'Steady improvement + high consistency' },
                    { icon: 'âš¡', name: 'Sprint Finish', desc: 'Complete 5+ units in one week' },
                    { icon: 'ðŸ”¥', name: 'Ahead of Pace', desc: '5+ units ahead of schedule' },
                    { icon: 'ðŸŽ¯', name: 'On Target', desc: 'Within 2 units of expected pace' }
                ],
                'Progress & Growth': [
                    { icon: 'ðŸ†', name: 'Tier Promotion', desc: 'Move up to better risk tier' },
                    { icon: 'ðŸ’ª', name: 'Comeback Kid', desc: 'Breakthrough trajectory + tier promotion' },
                    { icon: 'ðŸ“ˆ', name: 'Sustained Improvement', desc: 'Positive acceleration + 2+ u/wk velocity' }
                ],
                'Consistency Awards': [
                    { icon: 'ðŸŸ¢', name: 'Rock Solid', desc: '90%+ consistency ratio' },
                    { icon: 'â­', name: 'Steady Progress', desc: '75%+ consistency ratio' }
                ]
            };
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 1000px; width: 90%; max-height: 80vh; overflow: auto;" onclick="event.stopPropagation()">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid rgba(42,42,42,0.12); padding-bottom: 1rem;">
                        <h2 style="margin: 0;">ðŸ† Achievement Legend</h2>
                        <button onclick="document.getElementById('achievementLegendModal').remove()" style="background: var(--brand-accent); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 1rem;">Close</button>
                    </div>
                    
                    <div style="display: grid; gap: 2rem;">
                        ${Object.entries(categories).map(([category, achievements]) => `
                            <div>
                                <h3 style="color: var(--brand-accent); margin-bottom: 1rem; font-size: 1.2rem; border-left: 4px solid var(--brand-accent); padding-left: 1rem;">${category}</h3>
                                <div style="display: grid; gap: 0.75rem;">
                                    ${achievements.map(a => `
                                        <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--surface); border-radius: 8px; border-left: 3px solid var(--brand-accent);">
                                            <div class="emoji-large" style="min-width: 40px; text-align: center;">${a.icon}</div>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; color: var(--ink); margin-bottom: 0.25rem;">${a.name}</div>
                                                <div style="font-size: 0.85rem; color: var(--muted);">${a.desc}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="margin-top: 2rem; padding: 1rem; background: rgba(37,99,235,0.05); border-radius: 8px; border-left: 4px solid var(--info);">
                        <strong style="color: #1e40af;">ðŸ“Œ Note:</strong>
                        <span style="color: #1e3a8a; font-size: 0.9rem;"> Achievements shown reflect your current performance. Keep pushing towards new milestones!</span>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        

        // ================== PIN PROTECTION SYSTEM ==================
        // V8.0: Session-based PIN protection for student tags
        
        let isPINVerified = false;
        
        // Check if PIN was verified in this session
        function checkPINStatus() {
            const sessionPIN = sessionStorage.getItem('phs_staff_pin_verified');
            if (sessionPIN === 'true') {
                isPINVerified = true;
            }
            return isPINVerified;
        }
        
        // Show PIN entry modal
        function showPINPrompt(callback) {
            // Check if already verified this session
            if (checkPINStatus()) {
                callback(true);
                return;
            }
            
            // Check if PIN is configured
            if (!CONFIG.dataSources.tag_access_pin) {
                // No PIN configured, allow access
                callback(true);
                return;
            }
            
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            // Create PIN modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                max-width: 400px;
                text-align: center;
            `;
            
            modal.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 20px;">ðŸ”’</div>
                <h2 style="margin: 0 0 10px 0; color: var(--danger);">Staff Information Access</h2>
                <p style="color: var(--muted); margin: 0 0 20px 0;">Enter staff PIN to view student tags</p>
                <input type="password" id="pinInput" 
                    style="width: 100%; padding: 12px; font-size: 24px; 
                           text-align: center; border: 2px solid #ddd; 
                           border-radius: 6px; letter-spacing: 8px;"
                    maxlength="4" placeholder="â€¢â€¢â€¢â€¢" />
                <div id="pinError" style="color: var(--danger); margin: 10px 0; min-height: 20px;"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button id="pinCancel" style="flex: 1; padding: 12px; background: var(--muted); 
                                                  color: white; border: none; border-radius: 6px; 
                                                  cursor: pointer; font-size: 16px;">Cancel</button>
                    <button id="pinSubmit" style="flex: 1; padding: 12px; background: var(--danger); 
                                                  color: white; border: none; border-radius: 6px; 
                                                  cursor: pointer; font-size: 16px;">Unlock</button>
                </div>
                <p style="color: var(--muted); font-size: 12px; margin-top: 15px;">
                    PIN required once per session<br>
                    Closes when browser closes
                </p>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            const pinInput = document.getElementById('pinInput');
            const pinError = document.getElementById('pinError');
            const submitBtn = document.getElementById('pinSubmit');
            const cancelBtn = document.getElementById('pinCancel');
            
            // Focus input
            setTimeout(() => pinInput.focus(), 100);
            
            // Auto-submit on 4 digits
            pinInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
                if (e.target.value.length === 4) {
                    verifyPIN(e.target.value);
                }
            });
            
            // Submit button
            submitBtn.addEventListener('click', () => {
                verifyPIN(pinInput.value);
            });
            
            // Enter key
            pinInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    verifyPIN(pinInput.value);
                }
            });
            
            // Cancel button
            cancelBtn.addEventListener('click', () => {
                document.body.removeChild(overlay);
                callback(false);
            });
            
            function verifyPIN(enteredPIN) {
                const correctPIN = CONFIG.dataSources.tag_access_pin.toString();
                
                if (enteredPIN === correctPIN) {
                    // Correct PIN
                    sessionStorage.setItem('phs_staff_pin_verified', 'true');
                    isPINVerified = true;
                    document.body.removeChild(overlay);
                    callback(true);
                } else {
                    // Incorrect PIN
                    pinError.textContent = 'âŒ Incorrect PIN';
                    pinInput.value = '';
                    pinInput.style.borderColor = 'var(--danger)';
                    setTimeout(() => {
                        pinInput.style.borderColor = '#ddd';
                        pinError.textContent = '';
                    }, 2000);
                }
            }
        }
        
        // Get filtered tags based on PIN status
        function getVisibleTags(studentName) {
            // CRITICAL: Tags are stored with UPPERCASE names in the Map
            const normalizedName = studentName.toUpperCase().trim();
            
            // Try exact match first
            if (CONFIG.studentTags.has(normalizedName)) {
                const allTags = CONFIG.studentTags.get(normalizedName);
                if (checkPINStatus()) {
                    return allTags;
                } else {
                    return [];
                }
            }
            
            // Fuzzy match strategy (handles multiple formats):
            // 1. "LASTNAME, FIRSTNAME MIDDLENAME" â†’ "LASTNAME, FIRSTNAME"
            // 2. "LASTNAME, FIRSTNAME, III" â†’ "LASTNAME, FIRSTNAME"
            // 3. "LASTNAME, FIRSTNAME MIDDLENAME, JR" â†’ "LASTNAME, FIRSTNAME"
            
            // Split on commas to handle suffixes (III, JR, SR, IV, etc.)
            const commaParts = normalizedName.split(',').map(p => p.trim());
            
            if (commaParts.length >= 2) {
                const lastName = commaParts[0];
                const firstNamePart = commaParts[1].split(' ')[0]; // Take first word (removes middle names)
                const fuzzyKey = `${lastName}, ${firstNamePart}`;
                
                if (CONFIG.studentTags.has(fuzzyKey)) {
                    const allTags = CONFIG.studentTags.get(fuzzyKey);
                    if (checkPINStatus()) {
                        return allTags;
                    } else {
                        return [];
                    }
                }
            }
            
            // No match found
            return [];
        }
        
        // Format tag badge
        function formatTagBadge(tag, notes = '') {
            // Color scheme for different tag types
            const tagColors = {
                'P-TECH': 'var(--tag-info)',
                'Pathways in Technology': 'var(--tag-info)',
                'Special Education': 'var(--tag-sage)',
                'Section 504': 'var(--tag-warning)',
                'Emergent Bilingual': 'var(--tag-success)',
                'Former EB': 'var(--tag-success)',
                'Monitored EB': 'var(--tag-success)',
                'Homeless': 'var(--tag-warning)',
                'Health': 'var(--tag-danger)',
                'Dyslexia': 'var(--tag-sage-2)',
                'College Career Military Readiness': 'var(--tag-neutral-2)',
                'Accelerated Instruction': 'var(--tag-brass)',
                'Discipline Note': 'var(--tag-danger)'
            };
            
            const color = tagColors[tag] || 'var(--tag-neutral)';
            const title = notes ? `${tag}: ${notes}` : tag;
            
            return `<span class="student-tag" style="--tag-bg:${color};" title="${title}">${tag}</span>`;
        }
        
        // V8.2: Show missing enrollment date warning badge
        function getMissingEnrollmentDateBadge(student) {
            if (!student || !student.missingEnrollmentDate) return '';
            
            return `<span class="student-tag" style="--tag-bg:var(--tag-warning);" title="No enrollment date in data - using first appearance as fallback">âš ï¸ No Enrollment Date</span>`;
        }
        
        // Show "Tags Protected" indicator
        function showTagsProtectedIndicator() {
            return `<div style="
                display: inline-flex;
                align-items: center;
                gap: 6px;
                background: linear-gradient(135deg, var(--muted), var(--muted));
                color: white;
                padding: 4px 10px;
                border-radius: 4px;
                font-size: 11px;
                font-weight: 600;
                cursor: pointer;
                margin: 2px;
            " onclick="showPINPrompt((verified) => { if(verified) location.reload(); })" title="Click to unlock staff information">
                ðŸ”’ Staff Info
            </div>`;
        }
        
        // V8.1: Validate student mappings and show warnings
        function validateStudentMappings() {
            if (!CONFIG.loaded || CONFIG.advisorMappings.length === 0) return;
            
            const studentMappings = CONFIG.advisorMappings.filter(m => m.type === 'student');
            if (studentMappings.length === 0) return;
            
            const warnings = [];
            const allStudentNames = dashboardData.students.map(s => s.name.toUpperCase().trim());
            
            studentMappings.forEach(mapping => {
                const configName = mapping.studentName.toUpperCase().trim();
                
                // Check for exact match
                const exactMatch = allStudentNames.includes(configName);
                
                // Check for fuzzy match (student name starts with config name)
                const fuzzyMatch = allStudentNames.find(name => 
                    name.startsWith(configName + ' ')
                );
                
                if (!exactMatch && !fuzzyMatch) {
                    // No match found - this mapping is orphaned
                    const similar = allStudentNames.filter(name => 
                        name.includes(configName.split(',')[0]) // Same last name
                    );
                    
                    warnings.push({
                        config: mapping.studentName,
                        target: mapping.to,
                        similar: similar
                    });
                }
            });
            
            if (warnings.length > 0) {
                console.warn('âš ï¸ CONFIG VALIDATION WARNINGS');
                console.warn('â•'.repeat(60));
                warnings.forEach(w => {
                    console.warn(`Student mapping not found: "${w.config}" â†’ ${w.target}`);
                    if (w.similar.length > 0) {
                        console.warn(`   Similar students in data: ${w.similar.join(', ')}`);
                    } else {
                        console.warn('   No similar students found');
                    }
                });
                console.warn('â•'.repeat(60));
                console.warn('ðŸ’¡ TIP: Update Student_Name in Advisor_Mappings config to match exactly');
            }
        }
        
                // ================== DATA LOADING ==================
        // V8.0 FIX #6: Error banner system for critical failures
        function showErrorBanner(title, message, impact, actionRequired, url = null) {
            const banner = document.createElement('div');
            banner.id = 'errorBanner';
            banner.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: linear-gradient(135deg, var(--brand-accent) 0%, #991b1b 100%);
                color: white;
                padding: 1.5rem 2rem;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                font-family: 'Inter', sans-serif;
            `;
            
            banner.innerHTML = `
                <div style="max-width: 1200px; margin: 0 auto;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem;">
                                ðŸš¨ ${title}
                            </div>
                            <div style="margin-bottom: 0.75rem; opacity: 0.95;">
                                ${message}
                                ${url ? `<br><code style="background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem;">${url}</code>` : ''}
                            </div>
                            <div style="background: rgba(255,255,255,0.15); padding: 0.75rem; border-radius: 6px; margin-bottom: 0.75rem;">
                                <strong>âš ï¸ Impact:</strong> ${impact}
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 0.75rem; border-radius: 6px;">
                                <strong>ðŸ‘‰ Action Required:</strong> ${actionRequired}
                            </div>
                        </div>
                        <button onclick="dismissErrorBanner()" style="margin-left: 1rem; background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.2s;">
                            Acknowledge & Continue
                        </button>
                    </div>
                </div>
            `;
            
            // Remove any existing banner
            const existing = document.getElementById('errorBanner');
            if (existing) existing.remove();
            
            document.body.insertBefore(banner, document.body.firstChild);
            
            // Shift content down
            document.body.style.paddingTop = (banner.offsetHeight + 20) + 'px';
        }
        
        function dismissErrorBanner() {
            const banner = document.getElementById('errorBanner');
            if (banner) {
                banner.remove();
                document.body.style.paddingTop = '0';
            }
        }
        
        // ================== CALENDAR FUNCTIONS ==================
        async function loadCalendar() {
            try {
                if (!CALENDAR_URL) {
                    throw new Error('Calendar URL not configured in config sheet');
                }
                
                const response = await fetch(CALENDAR_URL);
                if (!response.ok) {
                    const errorMsg = `Calendar file returned ${response.status} ${response.statusText}`;
                    console.error('ðŸ“… Calendar loading failed:', errorMsg);
                    
                    // Calendar loads successfully on published site - no error banner needed
                    
                    return null;
                }
                schoolCalendar = await response.json();
                if (DEBUG) console.log(`âœ… Calendar loaded successfully for ${schoolCalendar.schoolYear}`);
                return schoolCalendar;
            } catch (error) {
                console.error('ðŸ“… Calendar loading error:', error.message);
                
                // Calendar loads successfully on published site - no error banner needed
                
                return null;
            }
        }
        
        function getWeekInfo(date) {
            if (!schoolCalendar) return { schoolDays: 5, goal: 2.0, isBreak: false };
            
            const dateStr = date.toISOString().split('T')[0];
            
            // Check breaks
            for (const breakPeriod of schoolCalendar.breaks) {
                if (dateStr >= breakPeriod.start && dateStr <= breakPeriod.end) {
                    return { schoolDays: 0, goal: 0, isBreak: true, name: breakPeriod.name };
                }
            }
            
            // Find week
            const week = schoolCalendar.weeks.find(w => dateStr >= w.start && dateStr <= w.end);
            if (week) {
                return { 
                    schoolDays: week.schoolDays, 
                    goal: week.schoolDays * 0.4,
                    isBreak: false,
                    weekNum: week.weekNum,
                    semester: week.semester
                };
            }
            
            return { schoolDays: 5, goal: 2.0, isBreak: false };
        }
        
        function getDeadlineInfo(student) {
            // V8.0: Get student's custom goal (default 60)
            const studentGoal = getStudentGoal(student.name);
            
            if (!schoolCalendar) {
                return {
                    deadline: 'May 27, 2026',
                    weeksRemaining: 17,
                    unitsRequired: studentGoal,
                    unitsCompleted: student.currentUnits,
                    unitsNeeded: Math.max(0, studentGoal - student.currentUnits),
                    paceNeeded: 2.0,
                    currentPace: student.velocity,
                    projectedUnits: student.currentUnits + (student.velocity * 17),
                    onTrack: true
                };
            }
            
            const now = new Date();
            const deadline = new Date(schoolCalendar.unitDeadline);
            const weeksRemaining = schoolCalendar.weeks.filter(w => {
                const weekStart = new Date(w.start);
                return weekStart > now && weekStart <= deadline;
            }).length;
            
            // V8.0: Use custom goal from config, or default from calendar
            let unitsRequired = studentGoal || schoolCalendar.totalUnitsRequired;
            let enrollmentNote = '';
            
            if (student.records && student.records.length > 0) {
                const firstWeek = new Date(student.records[0].week);
                const schoolStart = new Date(schoolCalendar.yearStart);
                
                // If student enrolled mid-year, calculate prorated goal
                // MUST exclude break weeks and use schoolDays calculation
                if (firstWeek > schoolStart) {
                    let calculatedUnits = 0;
                    let instructionalWeeks = 0;
                    
                    // Iterate through calendar weeks from enrollment to deadline
                    schoolCalendar.weeks.forEach(calWeek => {
                        const weekStart = new Date(calWeek.start);
                        
                        // Skip weeks before enrollment or after deadline
                        if (weekStart < firstWeek || weekStart > deadline) {
                            return;
                        }
                        
                        // Check if this is a break week
                        let isBreak = false;
                        for (const breakPeriod of schoolCalendar.breaks) {
                            if (calWeek.start >= breakPeriod.start && calWeek.start <= breakPeriod.end) {
                                isBreak = true;
                                break;
                            }
                        }
                        
                        // Add goal for this week (0 if break, otherwise schoolDays Ã— 0.4)
                        if (!isBreak) {
                            calculatedUnits += (calWeek.schoolDays * 0.4);
                            instructionalWeeks++;
                        }
                    });
                    
                    unitsRequired = Math.round(calculatedUnits);
                    const enrollDate = firstWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    enrollmentNote = ` (enrolled ${enrollDate}, ${instructionalWeeks} instructional weeks)`;
                }
            }
            
            const unitsCompleted = student.currentUnits;
            const unitsNeeded = Math.max(0, unitsRequired - unitsCompleted);
            const paceNeeded = weeksRemaining > 0 ? unitsNeeded / weeksRemaining : 0;
            const projectedUnits = unitsCompleted + (student.velocity * weeksRemaining);
            
            return {
                deadline: deadline.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }),
                weeksRemaining,
                unitsRequired,
                unitsCompleted,
                unitsNeeded,
                paceNeeded: Math.max(0, paceNeeded),
                currentPace: student.velocity,
                projectedUnits: Math.round(projectedUnits),
                onTrack: projectedUnits >= unitsRequired,
                enrollmentNote
            };
        }
        
        // V8.1: Validate student mappings and show warnings
        
                // ================== DATA LOADING ==================
        // Helper function to normalize dates to YYYY-MM-DD format for consistent comparison
        function normalizeDate(dateInput) {
            if (!dateInput) return null;
            
            // If already a Date object, format it
            if (dateInput instanceof Date) {
                if (isNaN(dateInput.getTime())) return null;
                const year = dateInput.getFullYear();
                const month = String(dateInput.getMonth() + 1).padStart(2, '0');
                const day = String(dateInput.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            // Handle string input
            if (typeof dateInput === 'string') {
                const trimmed = dateInput.trim();
                
                // Check if already in YYYY-MM-DD format (e.g., "2025-09-15")
                if (/^\d{4}-\d{2}-\d{2}$/.test(trimmed)) {
                    return trimmed;
                }
                
                // Check if in MM-DD-YYYY format (e.g., "09-15-2025")
                const mmddyyyyMatch = trimmed.match(/^(\d{2})-(\d{2})-(\d{4})$/);
                if (mmddyyyyMatch) {
                    const [, month, day, year] = mmddyyyyMatch;
                    return `${year}-${month}-${day}`;
                }
                
                // Check if in MM/DD/YYYY format (e.g., "09/15/2025")
                const mmddyyyySlashMatch = trimmed.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
                if (mmddyyyySlashMatch) {
                    const [, month, day, year] = mmddyyyySlashMatch;
                    const paddedMonth = month.padStart(2, '0');
                    const paddedDay = day.padStart(2, '0');
                    return `${year}-${paddedMonth}-${paddedDay}`;
                }
                
                // Try parsing as Date object
                const date = new Date(trimmed);
                if (!isNaN(date.getTime())) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
            }
            
            return null;
        }
        
        // ================== V8.0 CONFIG LOADERS ==================
        
        async function loadAllConfig() {
            if (DEBUG) console.log('ðŸš€ V8.0: Loading configuration from Google Sheets...');
            
            try {
                // Load all config tabs in parallel for speed
                await Promise.all([
                    loadAdvisorMappings(),
                    loadDataSources(),
                    loadStudentGoals(),
                    loadProgramTracking(),
                    loadStaffConfig(),
                    loadTierThresholds(),
                    loadStudentTags(),
                    loadStudentRoster(),
                    loadEmploymentPlacements(),
                    loadStudentCertifications()
                ]);
                
                CONFIG.loaded = true;
                if (DEBUG) console.log('âœ… V8.0: All config loaded successfully!', CONFIG);
                
                // After config loaded, set data source URLs from config
                DATA_URL = CONFIG.dataSources.dashboard_url || DATA_URL;
                
                // V8.0 FIX: Load notes from explicit URL first, then construct from GID
                if (CONFIG.dataSources.notes_url) {
                    // Use explicit notes_url if provided (separate file)
                    NOTES_URL = CONFIG.dataSources.notes_url;
                    if (DEBUG) console.log(`âœ… Using explicit notes_url: ${NOTES_URL}`);
                } else if (CONFIG.dataSources.notes_gid && CONFIG.dataSources.dashboard_url) {
                    // Fall back to constructing from notes_gid (same file, different tab)
                    const baseUrl = CONFIG.dataSources.dashboard_url.split('/pub?')[0];
                    NOTES_URL = `${baseUrl}/pub?gid=${CONFIG.dataSources.notes_gid}&single=true&output=csv`;
                    if (DEBUG) console.log(`âœ… Constructed notes URL from gid: ${CONFIG.dataSources.notes_gid}`);
                }
                
                FORM_BASE_URL = CONFIG.dataSources.noteFormUrl || CONFIG.dataSources.note_form_url || CONFIG.dataSources['note_form-url'] || CONFIG.dataSources.note_logger_base || FORM_BASE_URL;
                CALENDAR_URL = CONFIG.dataSources.calendar_json_url || CONFIG.dataSources.json_url || CALENDAR_URL;
                
                // Parse form entries if provided
                if (CONFIG.dataSources.entry_student_id) {
                    FORM_ENTRIES = {
                        studentId: CONFIG.dataSources.entry_student_id,
                        studentName: CONFIG.dataSources.entry_student_name,
                        advisor: CONFIG.dataSources.entry_advisor,
                        date: CONFIG.dataSources.entry_date
                    };
                }
                
            } catch (error) {
                console.error('âŒ V8.0 Config loading error:', error);
                // Continue with defaults if config fails
                CONFIG.loaded = false;
            }
        }
        
        async function loadAdvisorMappings() {
            try {
                const csv = await fetch(CONFIG_URLS.advisorMappings).then(r => r.text());
                const data = parseCSV(csv);
                CONFIG.advisorMappings = data.map(row => ({
                    type: row.Type,
                    from: row.From,
                    to: row.To,
                    studentNumber: row.Student_Number || '',
                    studentName: row.Student_Name || '',
                    notes: row.Notes || ''
                }));
                if (DEBUG) console.log(`âœ… Loaded ${CONFIG.advisorMappings.length} advisor mappings`);
            } catch (error) {
                console.warn('âš ï¸ Could not load advisor mappings:', error);
                CONFIG.advisorMappings = [];
            }
        }
        
        async function loadDataSources() {
            try {
                const csv = await fetch(CONFIG_URLS.dataSources).then(r => r.text());
                const data = parseCSV(csv);
                data.forEach(row => {
                    CONFIG.dataSources[row.Key] = row.Value;
                });
                
                // Load settings from config
                if (CONFIG.dataSources.campus_id) {
                    CONFIG.settings.campusID = CONFIG.dataSources.campus_id;
                }
                if (CONFIG.dataSources.campus_name) {
                    CONFIG.settings.campusName = CONFIG.dataSources.campus_name;
                }
                if (CONFIG.dataSources.page_title) {
                    CONFIG.settings.pageTitle = CONFIG.dataSources.page_title;
                    document.title = CONFIG.settings.pageTitle;
                }
                
                if (DEBUG) console.log(`âœ… Loaded ${Object.keys(CONFIG.dataSources).length} data sources`);
            } catch (error) {
                console.warn('âš ï¸ Could not load data sources:', error);
                CONFIG.dataSources = {};
            }
        }
        
        async function loadStudentGoals() {
            try {
                const csv = await fetch(CONFIG_URLS.studentGoals).then(r => r.text());
                const data = parseCSV(csv);
                data.forEach(row => {
                    if (row.Student_Name && row.Custom_Goal) {
                        CONFIG.studentGoals.set(row.Student_Name.toUpperCase().trim(), {
                            goal: parseInt(row.Custom_Goal),
                            reason: row.Reason || '',
                            effectiveDate: row.Effective_Date || ''
                        });
                    }
                });
                if (DEBUG) console.log(`âœ… Loaded ${CONFIG.studentGoals.size} custom student goals`);
            } catch (error) {
                console.warn('âš ï¸ Could not load student goals:', error);
                CONFIG.studentGoals = new Map();
            }
        }
        
        async function loadProgramTracking() {
            try {
                const csv = await fetch(CONFIG_URLS.programTracking).then(r => r.text());

                const data = parseCSV(csv);
                console.log(`ðŸ“‹ Parsed ${data.length} rows from program tracking`);
                
                if (data.length > 0) {
    
    
                }
                
                data.forEach(row => {
                    if (row.Student_Number && row.Program) {
                        const studentNum = String(row.Student_Number).trim();
                        // Allow multiple programs per student by using compound key
                        const key = `${studentNum}_${row.Program}_${row.Course || ''}`;
                        CONFIG.programTracking.set(key, {
                            studentNumber: studentNum,
                            studentName: row.Student_Name || '',
                            program: row.Program,
                            subcategory: row.Course || '',  // Load from Course column
                            cohort: row.Cohort || '',
                            startDate: row.Start_Date || ''
                        });
                    }
                });
                console.log(`âœ… Loaded ${CONFIG.programTracking.size} program assignments`);
            } catch (error) {
                console.error('âŒ Error loading program tracking:', error);
                CONFIG.programTracking = new Map();
            }
        }
        
        async function loadStaffConfig() {
            try {
                const csv = await fetch(CONFIG_URLS.staffConfig).then(r => r.text());
                const data = parseCSV(csv);
                data.forEach(row => {
                    if (row.Staff_Name) {
                        CONFIG.staffConfig.set(row.Staff_Name.toUpperCase().trim(), {
                            displayName: row.Display_Name || row.Staff_Name,
                            role: row.Role || '',
                            active: row.Active === 'TRUE' || row.Active === 'true' || row.Active === '1'
                        });
                    }
                });
                if (DEBUG) console.log(`âœ… Loaded ${CONFIG.staffConfig.size} staff members`);
            } catch (error) {
                console.warn('âš ï¸ Could not load staff config:', error);
                CONFIG.staffConfig = new Map();
            }
        }
        
        async function loadTierThresholds() {
            try {
                const csv = await fetch(CONFIG_URLS.tierThresholds).then(r => r.text());
                const data = parseCSV(csv);
                CONFIG.tierThresholds = {
                    loaded: true,
                    data: data
                };
                if (DEBUG) console.log('âœ… Loaded tier thresholds configuration');
            } catch (error) {
                console.warn('âš ï¸ Could not load tier thresholds:', error);
                CONFIG.tierThresholds = { loaded: false };
            }
        }
        
        async function loadStudentTags() {
            try {
                const csv = await fetch(CONFIG_URLS.studentTags).then(r => r.text());
                const data = parseCSV(csv);
                data.forEach(row => {
                    if (row.Student_Name && row.Tag) {
                        const studentName = row.Student_Name.toUpperCase().trim();
                        if (!CONFIG.studentTags.has(studentName)) {
                            CONFIG.studentTags.set(studentName, []);
                        }
                        CONFIG.studentTags.get(studentName).push({
                            tag: row.Tag,
                            notes: row.Notes || ''
                        });
                    }
                });
                if (DEBUG) console.log(`âœ… Loaded tags for ${CONFIG.studentTags.size} students`);
            } catch (error) {
                console.warn('âš ï¸ Could not load student tags:', error);
                CONFIG.studentTags = new Map();
            }
        }
        
        
        // V8R1: Load Student Roster (all active students with contact info)
        async function loadStudentRoster() {
            if (!CONFIG_URLS.studentRoster) {
                console.warn('âš ï¸ Student roster URL not configured');
                return;
            }
            
            try {
                const csv = await fetch(CONFIG_URLS.studentRoster).then(r => r.text());
                const data = parseCSV(csv);
                
                data.forEach(row => {
                    if (row.Student_Number) {
                        const studentNumber = row.Student_Number.trim();
                        
                        // Store by Student_Number (primary key)
                        CONFIG.studentRoster.set(studentNumber, {
                            studentNumber: studentNumber,
                            lastName: (row.Last_Name || '').toUpperCase().trim(),
                            firstName: (row.First_Name || '').toUpperCase().trim(),
                            middleName: (row.Middle_Name || '').toUpperCase().trim(),
                            grade: row.Grade || '',
                            active: row.Active || 'Y',
                            campusID: row.Campus_ID || '',
                            studentEmail: row.Student_Email || '',
                            studentPhone: row.Student_Phone || '',
                            guardian1Name: row.Guardian_1_Name || '',
                            guardian1Phone: row.Guardian_1_Phone || '',
                            guardian1Cell: row.Guardian_1_Cell || '',
                            guardian1Email: row.Guardian_1_Email || '',
                            guardian2Name: row.Guardian_2_Name || '',
                            guardian2Phone: row.Guardian_2_Phone || '',
                            guardian2Cell: row.Guardian_2_Cell || '',
                            guardian2Email: row.Guardian_2_Email || '',
                            emergencyContactName: row.Emergency_Contact_Name || '',
                            emergencyContactPhone: row.Emergency_Contact_Phone || '',
                            emergencyContactRelationship: row.Emergency_Contact_Relationship || ''
                        });
                        
                        // Also store by name for fallback matching
                        const fullName = `${row.Last_Name || ''}, ${row.First_Name || ''}`.toUpperCase().trim();
                        if (fullName !== ',') {
                            CONFIG.rosterByName.set(fullName, studentNumber);
                        }
                    }
                });
                
                // Log statistics
                const campusStudents = Array.from(CONFIG.studentRoster.values())
                    .filter(s => s.campusID === CONFIG.settings.campusID);
                    
                console.log(`âœ… Loaded ${CONFIG.studentRoster.size} students from roster`);
                console.log(`ðŸŽ“ Campus ${CONFIG.settings.campusID}: ${campusStudents.length} students`);
                
            } catch (error) {
                console.warn('âš ï¸ Could not load student roster:', error);
                CONFIG.studentRoster = new Map();
                CONFIG.rosterByName = new Map();
            }
        }

        async function loadEmploymentPlacements() {
            if (!CONFIG_URLS.employmentPlacements) {
                console.warn('âš ï¸ Employment placements URL not configured');
                return;
            }
            
            try {
                const csv = await fetch(CONFIG_URLS.employmentPlacements).then(r => r.text());
                const data = parseCSV(csv);
                
                CONFIG.employmentPlacements = data.map(row => ({
                    studentName: row.Student_Name || '',
                    program: row.Program || '',
                    employer: row.Employer || '',
                    hireDate: row.Hire_Date || '',
                    status: row.Status || '',
                    hourlyRate: row.Hourly_Rate || ''
                })).filter(p => p.studentName);
                
                console.log(`âœ… Loaded ${CONFIG.employmentPlacements.length} employment placements`);
                
            } catch (error) {
                console.warn('âš ï¸ Could not load employment placements:', error);
                CONFIG.employmentPlacements = [];
            }
        }
        async function loadStudentCertifications() {
            if (!CONFIG_URLS.studentCertifications) {
                console.warn('âš ï¸ Student certifications URL not configured');
                return;
            }
            
            try {
                const csv = await fetch(CONFIG_URLS.studentCertifications).then(r => r.text());
                const data = parseCSV(csv);
                
                CONFIG.studentCertifications = data.map(row => ({
                    studentNumber: row.Student_Number || '',
                    studentName: row.Student_Name || '',
                    issuingAuthority: row.Issuing_Authority || '',
                    certName: row.Cert_Name || '',
                    certDate: row.Cert_Date || '',
                    program: row.Program || ''
                })).filter(cert => cert.studentNumber && cert.certName);
                
                console.log(`âœ… Loaded ${CONFIG.studentCertifications.length} student certifications`);
                
            } catch (error) {
                console.warn('âš ï¸ Could not load student certifications:', error);
                CONFIG.studentCertifications = [];
            }
        }


        
        // V8R1: Get student info with 3-tier matching
        function getStudentFromRoster(studentNumber, studentName) {
            // Tier 1: Student_Number exact match (most accurate)
            if (studentNumber && CONFIG.studentRoster.has(studentNumber)) {
                return CONFIG.studentRoster.get(studentNumber);
            }
            
            // Tier 2: Name match from roster (good fallback)
            if (studentName) {
                const normalizedName = studentName.toUpperCase().trim();
                
                // Try exact name match
                if (CONFIG.rosterByName.has(normalizedName)) {
                    const foundNumber = CONFIG.rosterByName.get(normalizedName);
                    return CONFIG.studentRoster.get(foundNumber);
                }
                
                // Try without middle name (LASTNAME, FIRSTNAME)
                const nameWithoutMiddle = normalizedName.split(' ').slice(0, 2).join(' ');
                if (CONFIG.rosterByName.has(nameWithoutMiddle)) {
                    const foundNumber = CONFIG.rosterByName.get(nameWithoutMiddle);
                    return CONFIG.studentRoster.get(foundNumber);
                }
            }
            
            // Tier 3: Not found - return null (caller will handle)
            return null;
        }
        
        // V8.0 CONFIG UTILITIES
        
        // Apply advisor mapping with precedence: student override > advisor mapping > original
        function applyAdvisorMapping(advisorName, studentName, studentNumber = null) {
            if (!CONFIG.loaded || CONFIG.advisorMappings.length === 0) {
                return normalizeAdvisorName(advisorName);
            }
            
            const normalizedAdvisor = normalizeAdvisorName(advisorName);
            const normalizedStudent = studentName.toUpperCase().trim();
            
            // V8.2: Check for student-specific override first (highest precedence)
            // PRIMARY: Match by Student_Number (if available in student object)
            // FALLBACK: Match by Student_Name with fuzzy matching
            const studentOverride = CONFIG.advisorMappings.find(m => {
                if (m.type !== 'student') return false;
                
                // Handle "all", "any", or blank in FROM (means: any advisor)
                const fromMatches = !m.from || 
                                   m.from.toLowerCase() === 'all' || 
                                   m.from.toLowerCase() === 'any' || 
                                   m.from === normalizedAdvisor;
                if (!fromMatches) return false;
                
                // PRIMARY MATCH: By Student_Number (most reliable)
                if (m.studentNumber && studentNumber) {
                    if (m.studentNumber.toString() === studentNumber.toString()) {
                        if (DEBUG) console.log(`âœ… Matched by Student_Number: ${m.studentNumber}`);
                        return true;
                    }
                }
                
                // FALLBACK MATCH: By Student_Name (less reliable, handles typos)
                if (m.studentName) {
                    const configName = m.studentName.toUpperCase().trim();
                    
                    // Exact match
                    if (configName === normalizedStudent) {
                        if (DEBUG) console.log(`âœ… Matched by name (exact): ${m.studentName}`);
                        return true;
                    }
                    
                    // Fuzzy match: student name starts with config name
                    if (normalizedStudent.startsWith(configName + ' ')) {
                        if (DEBUG) console.log(`âœ… Matched by name (fuzzy): ${m.studentName}`);
                        return true;
                    }
                }
                
                return false;
            });
            
            if (studentOverride) {
                return studentOverride.to;
            }
            
            // Check for advisor-level mapping
            const advisorMapping = CONFIG.advisorMappings.find(m =>
                m.type === 'advisor' &&
                m.from === normalizedAdvisor
            );
            
            if (advisorMapping) {
                return advisorMapping.to;
            }
            
            // Return original if no mapping found
            return normalizedAdvisor;
        }
        

        // Format special category name for display
        function formatSpecialCategoryName(name) {
            return name
                .replace(/_/g, ' ')  // Replace underscores with spaces
                .toLowerCase()
                .replace(/\b\w/g, l => l.toUpperCase());  // Title case
        }
        
        // V8.0: Known special categories (Option C - Hybrid validation)
        const KNOWN_SPECIAL_CATEGORIES = [
            'MEDICAL_LEAVE',
            'MEDICAL LEAVE',  // Accept both formats
            'SUSPENDED',
            'TRANSITIONING',
            'INACTIVE',
            'COUNSELING',
            'ADMINISTRATIVE',
            'DISTRICT TRANSFER',
            'ACADEMIC PROBATION',
            'OFSDP',
            'TEXAS WORKS TRANSFER',
            'ENM HOLD',
            'WITHDRAWN',
            'GRADUATION PENDING',
            'OTHER',
            'EXTENDED ABSENCE'
        ];
        
        // Check if advisor is a special category (not counted in advisor performance)
        function isSpecialCategory(advisorName) {
            const normalized = advisorName.toUpperCase().trim();
            
            // Check against known categories
            if (KNOWN_SPECIAL_CATEGORIES.includes(normalized)) {
                return true;
            }
            
            // V8.0 OPTION C: Warn about unknown categories but still treat as special
            // This allows flexibility while alerting you to potential typos
            if (normalized !== 'DUCKWORTH, EDEN' && 
                normalized !== 'ORTIZ, AMMIE N' &&
                normalized !== 'BERRANGER, CARLOTTA' &&
                normalized !== 'BERRANGER, CARLOTTA HENNIG' &&
                normalized !== 'DOKYI, MAHOGANY JADE' &&
                normalized !== 'KUIMI, LARRY CHRIS' &&
                normalized !== 'KEENER, TIM' &&
                normalized !== 'WRIGHT, JILL' &&
                normalized !== 'ARRAMBIDE' &&
                !normalized.includes('@') && // Not an email
                normalized.length > 0 &&
                normalized.split(',').length === 1) { // Not a name format "LAST, FIRST"
                
                console.warn(`âš ï¸ Unknown special category detected: "${advisorName}"`);
                console.warn(`   This will be grouped under "Other Administrative Holds"`);
                console.warn(`   Known categories: ${KNOWN_SPECIAL_CATEGORIES.join(', ')}`);
                return true;
            }
            
            return false;
        }
        
        // Get special category type (for filtering in Administrative Hold card)
        function getSpecialCategoryType(advisorName) {
            const normalized = advisorName.toUpperCase().trim();
            if (KNOWN_SPECIAL_CATEGORIES.includes(normalized)) {
                return normalized;
            }
            return 'OTHER';
        }
        
        // Get student's custom goal or default 60
        function getStudentGoal(studentName) {
            const normalized = studentName.toUpperCase().trim();
            if (CONFIG.studentGoals.has(normalized)) {
                return CONFIG.studentGoals.get(normalized).goal;
            }
            return 60; // Default goal
        }
        
        // Get staff display name from config
        function getStaffDisplayName(staffName) {
            const normalized = staffName.toUpperCase().trim();
            if (CONFIG.staffConfig.has(normalized)) {
                return CONFIG.staffConfig.get(normalized).displayName;
            }
            return formatStudentName(staffName); // Fallback
        }
        
        // V8.1: Validate student mappings and show warnings
        
                // ================== DATA LOADING ==================
        
        async function loadData() {
            try {
                // Load calendar first (optional - non-blocking)
                if (!schoolCalendar) {
                    try {
                        await loadCalendar();
                    } catch (calError) {
                        if (DEBUG) console.log('Calendar not available, continuing without it');
                    }
                }
                
                // Fetch Google Sheets data
                const response = await fetch(DATA_URL);
                
                // Check if fetch was successful
                if (!response.ok) {
                    throw new Error(`Google Sheets returned ${response.status}: Check sharing settings`);
                }
                
                const csvText = await response.text();
                const csvData = parseCSV(csvText);
                
                // Validate we got data
                if (!csvData || csvData.length === 0) {
                    throw new Error('No data received from Google Sheets');
                }
                
                if (DEBUG) console.log(`âœ… Loaded ${csvData.length} rows from Google Sheets`);
                
                // Store raw CSV data globally for week switching
                window.rawCSVData = csvData;
                
                // Store previous week's data for comparison
                if (dashboardData) {
                    previousData = JSON.parse(JSON.stringify(dashboardData));
                }
                
                dashboardData = processData(csvData);
                
                // CRITICAL: Store original full dataset dates for week comparison
                // This never changes - it's our source of truth for "what is current?"
                if (!window.originalSortedDates) {
                    window.originalSortedDates = [...dashboardData.sortedDates];
                    if (DEBUG) console.log(`ðŸ“… Original dates stored: ${window.originalSortedDates[0]} to ${window.originalSortedDates[window.originalSortedDates.length-1]}`);
                }
                
                // Store processed raw data for week switching
                rawData = {};
                csvData.forEach(row => {
                    const name = row['Student Name'];
                    if (!name) return;
                    if (!rawData[name]) rawData[name] = [];
                    
                    // V8.0: Apply advisor mapping (supports bulk + individual overrides + special categories)
                    const correctedAdvisor = applyAdvisorMapping(row.Advisor, name, row.Student_Number);
                    
                    rawData[name].push({
                        date: new Date(row.Week_Date),
                        week: row.Week_Date,
                        advisor: correctedAdvisor,
                        attendance: parseFloat(row['% Present']) || 0,
                        expected: parseFloat(row['Units Expected']) || 0,
                        completed: parseInt(row['# Units Completed']) || 0,
                        enrollmentDate: row['Enrollment_Date'] || null  // V8.2: Enrollment date
                    });
                });
                
                // Load advisor notes
                await loadNotes();
                
                initializeDashboard();
            } catch (error) {
                console.error('Error loading data:', error);
                let errorMsg = 'âŒ Error loading data: ' + error.message;
                
                if (error.message.includes('No data received')) {
                    errorMsg = 'âŒ No student data found in Google Sheets.<br><small>Please check that your Dashboard_Data tab has student records.</small>';
                } else if (error.message.includes('Google Sheets returned')) {
                    errorMsg = 'âŒ Cannot access Google Sheets. Please check sharing settings.<br><small>Make sure "Anyone with the link can view" is enabled.</small>';
                }
                
                document.getElementById('loadingMessage').innerHTML = errorMsg;
            }
        }
        
        function parseCSV(csv) {
            const lines = csv.split('\n');
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] ? values[index].replace(/"/g, '').trim() : '';
                });
                data.push(row);
            }
            
            return data;
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                if (line[i] === '"') {
                    inQuotes = !inQuotes;
                } else if (line[i] === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += line[i];
                }
            }
            result.push(current);
            return result;
        }
        
        // ================== ADVISOR NOTES LOADING ==================
        async function loadNotes() {
            try {
                // Check if NOTES_URL has been configured with actual GID
                if (NOTES_URL.includes('ADVISOR_LOGS_GID')) {
                    if (DEBUG) console.log('âš ï¸ Advisor notes not configured - replace ADVISOR_LOGS_GID in NOTES_URL');
                    return;
                }
                
                const response = await fetch(NOTES_URL);
                
                if (!response.ok) {
                    if (DEBUG) console.log('âš ï¸ Could not load advisor notes - check sheet sharing settings');
                    return;
                }
                
                const csvText = await response.text();
                const csvData = parseCSV(csvText);
                
                if (!csvData || csvData.length === 0) {
                    if (DEBUG) console.log('ðŸ“ No advisor notes found yet');
                    return;
                }
                
                // V8.0 FIX: Parse notes with flexible column name matching (handles "Student ID " with trailing space)
                advisorNotes = csvData.map(row => {
                    // Find column names flexibly (trim whitespace)
                    const getColumn = (name) => {
                        // Try exact match first
                        if (row[name]) return row[name];
                        // Try with trailing space
                        if (row[name + ' ']) return row[name + ' '];
                        // Try trimmed keys
                        for (let key in row) {
                            if (key.trim() === name) return row[key];
                        }
                        return '';
                    };
                    
                    return {
                        timestamp: getColumn('Timestamp'),
                        studentId: getColumn('Student ID'),
                        studentName: getColumn('Student Name'),
                        advisor: getColumn('Advisor/Teacher Name'),
                        noteType: getColumn('Note Type'),
                        noteDetails: getColumn('Note Details'),
                        date: getColumn('Date'),
                        email: getColumn('Email Address')
                    };
                }).filter(note => {
                    // Filter out empty rows (all fields empty or whitespace)
                    return note.studentId && note.studentId.trim() && 
                           note.studentName && note.studentName.trim() &&
                           note.timestamp && note.timestamp.trim();
                });
                
                if (DEBUG) console.log(`âœ… Loaded ${advisorNotes.length} advisor notes`);
            } catch (error) {
                if (DEBUG) console.log('âš ï¸ Error loading advisor notes:', error.message);
            }
        }
        
        // ================== NAME FORMATTING SYSTEM ==================
        // V8.0: Advisor display names now loaded from Staff_Config in CONFIG
        
        // Normalize advisor names to canonical form (uses config)
        function normalizeAdvisorName(name) {
            if (!name) return '';
            
            const upperName = name.toUpperCase().trim();
            
            // Check if already canonical in staff config
            if (CONFIG.staffConfig.has(upperName)) {
                return upperName;
            }
            
            // Check for partial matches (last name only)
            for (const [canonicalName, config] of CONFIG.staffConfig) {
                const lastName = canonicalName.split(',')[0].trim();
                if (upperName === lastName || upperName.includes(lastName)) {
                    return canonicalName;
                }
            }
            
            // Check advisor mappings for legacy/variant names
            if (CONFIG.advisorMappings && CONFIG.advisorMappings.length > 0) {
                const mapping = CONFIG.advisorMappings.find(m => 
                    m.type === 'advisor' && m.from && m.from.toUpperCase().trim() === upperName
                );
                if (mapping && mapping.to) {
                    return mapping.to.toUpperCase().trim();
                }
            }
            
            return name;
        }
        
        // Format student name: "LAST, FIRST" â†’ "First Last" (drops middle names)
        function formatStudentName(name) {
            if (!name) return '';
            
            // Handle "LAST, FIRST" or "LAST, FIRST MIDDLE" format
            if (name.includes(',')) {
                const [last, firstPart] = name.split(',').map(s => s.trim());
                // Only take the FIRST word from the first part (drop middle names)
                const firstName = firstPart.split(' ')[0];
                return titleCase(firstName) + ' ' + titleCase(last);
            }
            
            // Already in correct format, just title case it
            return titleCase(name);
        }
        
        // Format advisor name with custom mappings
        // Format advisor name with custom mappings (V8.0: uses CONFIG)
        function formatAdvisorName(name) {
            if (!name) return '';
            return getStaffDisplayName(name);
        }
        
        // Convert "JOHN SMITH" â†’ "John Smith"
        function titleCase(str) {
            if (!str) return '';
            return str.toLowerCase().replace(/\b\w/g, l => l.toUpperCase());
        }
        
        // ================== DATA PROCESSING ==================
        // ================== WEEK SELECTOR ==================
        let isViewingHistoricalData = false;
        let currentSelectedWeek = null;
        
        function switchWeek() {
            const selector = document.getElementById('weekSelector');
            const selectedDate = selector.value;
            currentSelectedWeek = selectedDate;
            
            // V8.1 FIX: Use ORIGINAL dates for comparison (not filtered dates!)
            // dashboardData.sortedDates changes when we filter - we need the original list
            const allDates = window.originalSortedDates || dashboardData.sortedDates;
            const latestDate = allDates[allDates.length - 1];
            const isLatest = selectedDate === latestDate;
            
            // CRITICAL: Set this BEFORE rendering so banner uses correct state
            isViewingHistoricalData = !isLatest;
            
            if (DEBUG) {
                console.log(`ðŸ“… Week Switch Debug:`);
                console.log(`   Selected: ${selectedDate}`);
                console.log(`   Latest: ${latestDate}`);
                console.log(`   Match: ${isLatest}`);
                console.log(`   Historical: ${isViewingHistoricalData}`);
            }
            
            // Filter data up to selected week
            const maxDate = new Date(selectedDate);
            const filteredData = window.rawCSVData.filter(row => {
                const rowDate = new Date(row.Week_Date);
                return rowDate <= maxDate;
            });
            
            if (DEBUG) console.log(`Switched to ${selectedDate}: ${filteredData.length} rows`);
            dashboardData = processData(filteredData);
            
            // Re-render dashboard content (but don't reinitialize everything)
            renderDashboardContent();
            
            // Show/hide historical data warning
            updateHistoricalWarning();
        }
        
        function updateHistoricalWarning() {
            // V8.1: Historical context now shown in week banner - no need for separate warning
            // Keeping function for backward compatibility but it does nothing
            const warningDiv = document.getElementById('historicalWarning');
            if (warningDiv) {
                warningDiv.remove();
            }
        }
        
        function updateWeekIndicatorBanner() {
            try {
                // Defensive checks
                const banner = document.getElementById('weekIndicatorBanner');
                if (!banner) {
                    console.warn('Week indicator banner element not found');
                    return;
                }
                
                if (!dashboardData || !dashboardData.sortedDates || dashboardData.sortedDates.length === 0) {
                    console.warn('Dashboard data not ready for banner update');
                    return;
                }
                
                // Determine if viewing historical data
                const isHistorical = typeof isViewingHistoricalData !== 'undefined' && isViewingHistoricalData === true;
                
                // KEY LOGIC: Banner date depends on current vs historical
                let bannerDate;
                if (isHistorical) {
                    // Historical: Show the week from that data
                    bannerDate = new Date(dashboardData.sortedDates[dashboardData.sortedDates.length - 1]);
                } else {
                    // Current: Show TODAY's week (what week are we in NOW?)
                    bannerDate = new Date();
                }
                
                const weekStr = bannerDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                
                // Get week info from calendar for THIS specific date
                const weekInfo = schoolCalendar ? getWeekInfo(bannerDate) : null;
                
                // Build day label and goal text based on week type
                let dayLabel, goalText;
                if (weekInfo) {
                    if (weekInfo.isBreak) {
                        // Break week
                        dayLabel = weekInfo.name || 'Break';
                        goalText = ' â€¢ <strong>0 school days</strong>';
                    } else {
                        // Regular school week
                        dayLabel = weekInfo.schoolDays === 5 ? 'Full week' : `${weekInfo.schoolDays}-day week`;
                        goalText = ` â€¢ <strong>Goal:</strong> ${weekInfo.goal.toFixed(1)} units`;
                    }
                } else {
                    // No calendar info - use defaults
                    dayLabel = 'Full week';
                    goalText = ' â€¢ <strong>Goal:</strong> 2.0 units';
                }
                
                if (DEBUG) {
                    console.log(`ðŸ“Š Banner Update:`);
                    console.log(`   Historical: ${isHistorical}`);
                    console.log(`   Date shown: ${weekStr}`);
                    console.log(`   Today: ${new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`);
                    console.log(`   Data week: ${new Date(dashboardData.sortedDates[dashboardData.sortedDates.length - 1]).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`);
                }
                
                if (isHistorical) {
                    // Historical week - WARNING yellow/brass banner
                    banner.style.background = 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)';
                    banner.style.borderLeft = '6px solid #d97706';
                    banner.style.color = '#78350f';
                    banner.style.fontWeight = '600';
                    banner.innerHTML = `ðŸ” Viewing Historical Data: Week of ${weekStr} â€¢ ${dayLabel}${goalText}`;
                } else {
                    // Current week - Sage green banner
                    banner.style.background = 'linear-gradient(135deg, #f0f4f3 0%, #e8f0ed 100%)';
                    banner.style.borderLeft = '6px solid var(--sage)';
                    banner.style.color = 'var(--text)';
                    banner.style.fontWeight = '600';
                    banner.style.boxShadow = 'var(--shadow-sm)';
                    banner.innerHTML = `ðŸ“… Current Week: ${weekStr} â€¢ ${dayLabel}${goalText}`;
                }
                
                banner.style.display = 'block';
                
            } catch (error) {
                console.error('Error updating week indicator banner:', error);
                // Don't let banner errors break the dashboard
            }
        }
        
        function renderDashboardContent() {
            // Update date range in header (compact format)
            const firstDate = new Date(dashboardData.sortedDates[0]).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const lastDate = new Date(dashboardData.sortedDates[dashboardData.sortedDates.length - 1]).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            document.getElementById('dateRange').textContent = `${firstDate} - ${lastDate}`;
            
            // Update week indicator banner
            updateWeekIndicatorBanner();
            
            // V8.1: Validate student mappings - warn about missing students
            validateStudentMappings();
            
            // Re-render all content
            renderChallengesCelebrations();
            renderAdvisorSpotlight();
            
            // Initialize PHS Hero Section
            initPHSHero();
            renderHighlights();
            renderNewStudentsAlert();
            renderAdvisorCards();
            // renderMomentumTracker(); // Removed - momentum tracker moved to Student Directory
            createWaterfallChart();
            // renderStudentTable(); // Table moved to Student Directory, not on main page
            
            // Update footer
            document.getElementById('lastUpdate').innerHTML = 
                `Last Updated: ${dashboardData.generated}<br><small style="opacity: 0.7; font-size: 0.85rem;">Created by Tim Keener for Premier HS Gallery North - November 2025</small>`;
        }
        
        function populateWeekSelector() {
            const selector = document.getElementById('weekSelector');
            // Use original dates for selector (shows all available weeks)
            const dates = window.originalSortedDates || dashboardData.sortedDates;
            
            // Create options (newest first)
            const options = dates.map((date, idx) => {
                const dateObj = new Date(date);
                const formatted = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const isLatest = idx === dates.length - 1;
                return `<option value="${date}" ${isLatest ? 'selected' : ''}>${formatted}${isLatest ? ' (Current)' : ''}</option>`;
            }).reverse(); // Reverse so newest is first in dropdown
            
            selector.innerHTML = options.join('');
        }
        
        function processData(data) {
            // Group data by student
            const studentMap = new Map();
            const allDates = new Set();
            
            data.forEach(row => {
                const name = row['Student Name'];
                if (!name) return;
                
                const weekDate = row.Week_Date;
                const dateObj = new Date(weekDate);
                if (isNaN(dateObj.getTime())) {
                    console.warn(`Invalid date skipped: ${weekDate} for student ${name}`);
                    return;
                }
                allDates.add(weekDate);
                
                if (!studentMap.has(name)) {
                    studentMap.set(name, []);
                }
                
                studentMap.get(name).push({
                    date: dateObj,
                    week: weekDate,
                    advisor: applyAdvisorMapping(row.Advisor, name, row.Student_Number),
                    attendance: parseFloat(row['% Present']) || 0,
                    expected: parseFloat(row['Units Expected']) || 0,
                    completed: parseInt(row['# Units Completed']) || 0,
                    enrollmentDate: row['Enrollment_Date'] || null  // V8.2: Add enrollment date
                });
            });
            
            // V8.0 FIX: Sort dates chronologically, not alphabetically
            const sortedDates = Array.from(allDates).filter(d => !isNaN(new Date(d).getTime())).sort((a, b) => {
                return new Date(a) - new Date(b);
            });
            const weekNumber = sortedDates.length;
            const spotlightWeek = ((weekNumber - 1) % 5) + 1;
            
            // Identify new and dropped students
            const recentDates = sortedDates.slice(-2); // Last 2 uploads
            const activeStudents = new Set();
            const newStudents = new Set();
            
            // Find students in recent data
            data.forEach(row => {
                const name = row['Student Name'];
                const weekDate = row.Week_Date;
                if (name && recentDates.includes(weekDate)) {
                    activeStudents.add(name);
                }
            });
            
            // Mark new students (enrolled within last 4 weeks)
            studentMap.forEach((records, name) => {
                // V8.2: Use enrollment date if available, otherwise fall back to first appearance
                let enrollmentDate;
                let missingEnrollmentDate = false;
                
                if (records[0].enrollmentDate) {
                    enrollmentDate = new Date(records[0].enrollmentDate);
                } else {
                    // Fallback: use first appearance in data
                    enrollmentDate = new Date(records[0].week);
                    missingEnrollmentDate = true;
                }
                
                // Calculate weeks since enrollment
                const now = new Date(sortedDates[sortedDates.length - 1]); // Use latest data date
                const weeksEnrolled = Math.floor((now - enrollmentDate) / (7 * 24 * 60 * 60 * 1000));
                
                // New if enrolled within last 4 weeks
                if (weeksEnrolled <= 4) {
                    newStudents.add(name);
                }
                
                // Store for use in student processing
                records.enrollmentInfo = {
                    enrollmentDate: enrollmentDate,
                    weeksEnrolled: weeksEnrolled,
                    missingEnrollmentDate: missingEnrollmentDate
                };
            });
            
            // Calculate metrics for each student
            const students = [];
            let studentProcessingIndex = 0; // Track which student we're processing
            
            studentMap.forEach((records, name) => {
                records.sort((a, b) => a.date - b.date);
                
                if (records.length === 0) return;
                
                // Skip dropped students (not in last 2 uploads)
                if (!activeStudents.has(name)) return;
                
                const latest = records[records.length - 1];
                const earliest = records[0];
                const firstRecord = records[0];
                
                // Mark if this is a new student
                const isNew = newStudents.has(name);
                const enrollmentInfo = records.enrollmentInfo || {};
                const missingEnrollmentDate = enrollmentInfo.missingEnrollmentDate || false;
                
                // Calculate calendar-aware expected units
                // Must iterate through CALENDAR WEEKS, not upload records
                let adjustedExpected = 0;
                
                if (!schoolCalendar) {
                    // Fallback: use flat 2.0/week if no calendar
                    adjustedExpected = (records.length - 1) * 2.0;
                } else {
                    // V8.2: Use actual enrollment date, not first data appearance
                    const enrollmentDate = enrollmentInfo.enrollmentDate || new Date(records[0].week);
                    const latestDate = new Date(latest.week);
                    
                    // Iterate through calendar weeks from enrollment to latest record
                    schoolCalendar.weeks.forEach(calWeek => {
                        const weekStart = new Date(calWeek.start);
                        const weekEnd = new Date(calWeek.end);
                        
                        // Skip weeks before enrollment or after latest record
                        if (weekStart < enrollmentDate || weekStart > latestDate) {
                            return;
                        }
                        
                        // Check if this is a break week
                        let isBreak = false;
                        for (const breakPeriod of schoolCalendar.breaks) {
                            if (calWeek.start >= breakPeriod.start && calWeek.start <= breakPeriod.end) {
                                isBreak = true;
                                break;
                            }
                        }
                        
                        // Add goal for this week (0 if break, otherwise schoolDays * 0.4)
                        if (!isBreak) {
                            adjustedExpected += (calWeek.schoolDays * 0.4);
                        }
                    });
                }
                
                // Calculate velocity
                const weeks = records.length > 1 ? records.length - 1 : 1;
                const unitsGained = latest.completed - earliest.completed;
                const velocity = weeks > 0 ? unitsGained / weeks : 0;
                
                // Calculate acceleration
                let acceleration = 0;
                let earlyVelocity = 0;
                let recentVelocity = 0;
                
                if (records.length >= 3) {
                    const midPoint = Math.floor(records.length / 2);
                    const firstHalf = records.slice(0, midPoint);
                    const secondHalf = records.slice(midPoint);
                    
                    earlyVelocity = firstHalf.length > 1 ? 
                        (firstHalf[firstHalf.length - 1].completed - firstHalf[0].completed) / (firstHalf.length - 1) : 0;
                    recentVelocity = secondHalf.length > 1 ?
                        (secondHalf[secondHalf.length - 1].completed - secondHalf[0].completed) / (secondHalf.length - 1) : 0;
                    
                    acceleration = recentVelocity - earlyVelocity;
                }
                
                // Calculate tracking (ahead/behind using calendar-aware expected)
                const tracking = Math.round(latest.completed - adjustedExpected);
                
                // Average attendance - MUST calculate before tier determination
                const avgAttendance = records.reduce((sum, r) => sum + r.attendance, 0) / records.length;
                
                // Determine tier (5 levels now)
                let tier = 4; // On Track (default)
                let tierLabel = 'On Track';
                
                // Check for Superstar first (highest tier)
                if (velocity >= 2.5 && tracking >= 3 && avgAttendance >= 90) {
                    tier = 5;
                    tierLabel = 'Superstar';
                }
                // On Track
                else if (tracking >= -1 && avgAttendance >= 80) {
                    tier = 4;
                    tierLabel = 'On Track';
                }
                // Watch - slightly behind OR inconsistent attendance
                else if (tracking >= -4 || (tracking < -1 && avgAttendance >= 80)) {
                    tier = 3;
                    tierLabel = 'Watch';
                }
                // High Risk - moderately behind OR rapid decline
                else if (tracking >= -9 || (acceleration < -1.5 && tracking < 0)) {
                    tier = 2;
                    tierLabel = 'High Risk';
                }
                // Crisis - severely behind
                else {
                    tier = 1;
                    tierLabel = 'Crisis';
                }
                
                // Determine first tier for comparison
                const firstTracking = firstRecord.completed - firstRecord.expected;
                const firstAttendance = records[0].attendance;
                let firstTier = 4;
                
                if (velocity >= 2.5 && firstTracking >= 3 && firstAttendance >= 90) {
                    firstTier = 5;
                } else if (firstTracking >= -1 && firstAttendance >= 80) {
                    firstTier = 4;
                } else if (firstTracking >= -4) {
                    firstTier = 3;
                } else if (firstTracking >= -9) {
                    firstTier = 2;
                } else {
                    firstTier = 1;
                }
                
                const tierChange = tier - firstTier;
                
                // Determine trajectory - consider both acceleration AND current position
                let trajectory = 'stable';
                let trajectoryLabel = 'Stable';
                let trajectoryIcon = 'âž¡ï¸';
                
                // Strong positive trajectory
                if (acceleration > 1.5 && velocity >= 1.5) {
                    trajectory = 'breakthrough';
                    trajectoryLabel = 'BLAST OFF!';
                    trajectoryIcon = 'ðŸš€';
                } 
                // Building momentum
                else if (acceleration > 0.5) {
                    trajectory = 'building';
                    trajectoryLabel = 'Building';
                    trajectoryIcon = 'ðŸ“ˆ';
                } 
                // Critical decline - only if behind or losing ground fast
                else if (acceleration < -1.5 && (tracking < -3 || velocity < 1.5)) {
                    trajectory = 'rapid_decline';
                    trajectoryLabel = 'URGENT!';
                    trajectoryIcon = 'âš ï¸';
                } 
                // Regular decline
                else if (acceleration < -0.5) {
                    trajectory = 'declining';
                    trajectoryLabel = 'Declining';
                    trajectoryIcon = 'ðŸ“‰';
                }
                // Otherwise stable
                
                // Days since last activity
                let daysSince = Math.floor((new Date() - latest.date) / (1000 * 60 * 60 * 24));
                
                // Check for last activity (when units actually changed)
                for (let i = records.length - 1; i > 0; i--) {
                    if (records[i].completed !== records[i - 1].completed) {
                        daysSince = Math.floor((new Date() - records[i].date) / (1000 * 60 * 60 * 24));
                        break;
                    }
                }
                
                // Consistency pattern (2+ units = goal hit)
                const consistencyPattern = records.map(r => {
                    const weeklyGain = r.completed - (records[records.indexOf(r) - 1]?.completed || 0);
                    return weeklyGain >= 2;
                });
                const activeWeeks = consistencyPattern.filter(Boolean).length;
                const consistencyRatio = activeWeeks / records.length;
                
                let consistencyLabel = 'Steady';
                let consistencyIcon = 'ðŸŸ¢';
                if (consistencyRatio < 0.5) {
                    consistencyLabel = 'Inconsistent';
                    consistencyIcon = 'ðŸ”´';
                } else if (consistencyRatio < 0.75) {
                    consistencyLabel = 'Bursty';
                    consistencyIcon = 'ðŸŸ¡';
                }
                
                // Pattern display (dots) - show current semester or last 12 weeks
                const now = new Date();
                const currentYear = now.getFullYear();
                
                // Determine current semester
                const fallStart = new Date(currentYear, 7, 12); // Aug 12
                const fallEnd = new Date(currentYear, 11, 19); // Dec 19
                const springStart = new Date(currentYear, 0, 6); // Jan 6
                const springEnd = new Date(currentYear, 5, 4); // Jun 4
                
                let semesterRecords = records;
                if (now >= fallStart && now <= fallEnd) {
                    // Fall semester
                    semesterRecords = records.filter(r => r.date >= fallStart && r.date <= fallEnd);
                } else if (now >= springStart && now <= springEnd) {
                    // Spring semester
                    semesterRecords = records.filter(r => r.date >= springStart && r.date <= springEnd);
                }
                
                // Generate calendar-based pattern dots (ALL weeks from enrollment to present)
                const patternDisplay = (() => {
                    const enrollmentDate = new Date(records[0].week);
                    const presentDate = new Date(records[records.length - 1].week);
                    const patterns = [];
                    
                    // If no calendar, fall back to records-based (legacy behavior)
                    if (!schoolCalendar) {
                        return records.map((r, i) => {
                            const weeklyGain = i === 0 ? r.completed : r.completed - records[i - 1].completed;
                            return {
                                type: weeklyGain >= 2.0 ? 'strong' : 'below',
                                week: r.week,
                                units: weeklyGain,
                                weekType: '5-day',
                                goal: 2.0
                            };
                        });
                    }
                    
                    // Iterate through ALL calendar weeks from enrollment to present
                    let previousUnits = 0;
                    let isFirstRecord = true; // Track if this is the first week with data
                    
                    schoolCalendar.weeks.forEach(calWeek => {
                        const weekStart = new Date(calWeek.start);
                        const weekEnd = new Date(calWeek.end);
                        
                        // Skip weeks before enrollment or after present
                        if (weekStart < enrollmentDate || weekStart > presentDate) {
                            return;
                        }
                        
                        const weekInfo = {
                            schoolDays: calWeek.schoolDays,
                            goal: calWeek.schoolDays * 0.4,
                            isBreak: false,
                            weekNum: calWeek.weekNum,
                            semester: calWeek.semester
                        };
                        
                        // Check if this week is in a break period
                        const weekDateStr = calWeek.start;
                        for (const breakPeriod of schoolCalendar.breaks) {
                            if (weekDateStr >= breakPeriod.start && weekDateStr <= breakPeriod.end) {
                                weekInfo.isBreak = true;
                                weekInfo.name = breakPeriod.name;
                                break;
                            }
                        }
                        
                        // Find ALL uploads that fall within this calendar week's date range
                        const uploadsThisWeek = records.filter(r => {
                            const uploadDate = new Date(r.week);
                            return uploadDate >= weekStart && uploadDate <= weekEnd;
                        });
                        
                        // Use the LATEST upload from this week (if multiple uploads)
                        const studentRecord = uploadsThisWeek.length > 0 ? 
                            uploadsThisWeek[uploadsThisWeek.length - 1] : null;
                        
                        if (!studentRecord) {
                            // No data for this week
                            if (weekInfo.isBreak) {
                                // Break week with no data - show black dot
                                patterns.push({
                                    type: 'break',
                                    week: calWeek.start,
                                    units: 0,
                                    weekType: weekInfo.name || 'break',
                                    goal: 0
                                });
                            } else {
                                // School week with no data - show gray dot (rare, historical only)
                                patterns.push({
                                    type: 'missing',
                                    week: calWeek.start,
                                    units: 0,
                                    weekType: `${weekInfo.schoolDays}-day`,
                                    goal: weekInfo.goal
                                });
                            }
                            // Don't update previousUnits since no progress was made
                            return;
                        }
                        
                        // Student has data for this week
                        let weeklyGain;
                        
                        if (isFirstRecord) {
                            // First week: use actual completed value or assume 2.0 if reasonable
                            // This handles students who start with existing units
                            weeklyGain = studentRecord.completed > 0 ? 
                                Math.min(studentRecord.completed, 10) : 0; // Cap at 10 for first week display
                            isFirstRecord = false;
                        } else {
                            weeklyGain = studentRecord.completed - previousUnits;
                        }
                        
                        previousUnits = studentRecord.completed;
                        
                        let dotType;
                        let weekType;
                        let goal;
                        
                        if (weekInfo.isBreak) {
                            // Break week with data (student worked during break)
                            dotType = 'break';
                            weekType = weekInfo.name || 'break';
                            goal = 0;
                        } else {
                            weekType = `${weekInfo.schoolDays}-day`;
                            goal = weekInfo.goal;
                            
                            // Check short weeks FIRST before checking 2.0
                            if (weekInfo.schoolDays < 5 && weeklyGain >= weekInfo.goal) {
                                // Met adjusted goal on short week (e.g., 1.6 on 4-day, 1.2 on 3-day)
                                dotType = 'adjusted';
                            } else if (weeklyGain >= 2.0) {
                                // Met standard goal (2.0 units on 5-day week)
                                dotType = 'strong';
                            } else {
                                // Below goal
                                dotType = 'below';
                            }
                        }
                        
                        patterns.push({
                            type: dotType,
                            week: calWeek.start,
                            units: weeklyGain,
                            weekType,
                            goal
                        });
                    });
                    
                    return patterns;
                })();
                
                // DIAGNOSTIC: Log pattern generation details for first student only
                if (studentProcessingIndex === 0) {
                    if (DEBUG) console.log('=== PATTERN DOT DIAGNOSTIC (First Student) ===');
                    if (DEBUG) console.log('Student:', name);
                    if (DEBUG) console.log('Calendar loaded:', !!schoolCalendar);
                    if (DEBUG) console.log('Total patterns generated:', patternDisplay.length);
                    if (DEBUG) console.log('Pattern types:', {
                        strong: patternDisplay.filter(p => p.type === 'strong').length,
                        adjusted: patternDisplay.filter(p => p.type === 'adjusted').length,
                        below: patternDisplay.filter(p => p.type === 'below').length,
                        break: patternDisplay.filter(p => p.type === 'break').length,
                        missing: patternDisplay.filter(p => p.type === 'missing').length
                    });
                    if (DEBUG) console.log('First 3 patterns:', patternDisplay.slice(0, 3));
                    if (DEBUG) console.log('Last 3 patterns:', patternDisplay.slice(-3));
                }
                
                // V8.1 FIX #8: Perfect Week calculation
                // Based on attendance DELTA (did attendance drop?) + 2+ units this period
                let unitsPeriod = 0; // Units gained this period (latest upload)
                let attendanceMaintained = false;
                let isPerfectWeek = false;
                
                if (records.length >= 2) {
                    const previous = records[records.length - 2];
                    unitsPeriod = latest.completed - previous.completed;
                    // Attendance maintained = current attendance >= previous attendance
                    attendanceMaintained = latest.attendance >= previous.attendance;
                    isPerfectWeek = unitsPeriod >= 2 && attendanceMaintained;
                } else if (records.length === 1) {
                    // First upload - can qualify if they have 2+ units
                    unitsPeriod = latest.completed;
                    attendanceMaintained = latest.attendance >= 95; // First upload needs 95%+
                    isPerfectWeek = unitsPeriod >= 2 && attendanceMaintained;
                }
                
                // Calculate superstars (high performers) - matches tier 5 criteria
                const isSuperstar = velocity >= 2.5 && tracking >= 3 && avgAttendance >= 90;
                
                // V8R2: Look up Student_Number from roster
                const rosterMatch = getStudentFromRoster(null, name);
                const studentNumber = rosterMatch?.studentNumber || null;  // FIXED: lowercase!
                

                const student = {
                    name,
                    studentNumber,
                    advisor: applyAdvisorMapping(latest.advisor, name, studentNumber),
                    records,
                    latest,
                    velocity,
                    earlyVelocity,
                    recentVelocity,
                    acceleration,
                    tracking,
                    tier,
                    tierLabel,
                    firstTier,
                    tierChange,
                    trajectory,
                    trajectoryLabel,
                    trajectoryIcon,
                    avgAttendance,
                    unitsGained,
                    unitsPeriod,              // V8.1: Units THIS period
                    attendanceMaintained,     // V8.1: Did attendance stay same or improve?
                    isPerfectWeek,            // V8.1: Perfect Week eligibility
                    currentUnits: latest.completed,
                    currentBehind: tracking,
                    daysSince,
                    consistencyLabel,
                    consistencyIcon,
                    consistencyRatio,
                    patternDisplay,
                    isSuperstar,
                    isNew,
                    enrollmentDate: enrollmentInfo.enrollmentDate,           // V8.2: Actual enrollment date
                    weeksEnrolled: enrollmentInfo.weeksEnrolled,             // V8.2: Weeks since enrollment
                    missingEnrollmentDate: missingEnrollmentDate             // V8.2: Flag if no enrollment date
                };
                
                // Calculate badges/achievements
                student.badges = ACHIEVEMENTS.filter(a => a.check(student));
                
                students.push(student);
                studentProcessingIndex++; // Increment for next student
            });
            
            // Calculate summary stats
            const summary = {
                totalStudents: students.length,
                avgVelocity: students.length > 0 ? students.reduce((sum, s) => sum + s.velocity, 0) / students.length : 0,
                avgAttendance: students.length > 0 ? students.reduce((sum, s) => sum + s.avgAttendance, 0) / students.length : 0,
                superstars: students.filter(s => s.tier === 5).length,
                onTrack: students.filter(s => s.tier === 4).length,
                watch: students.filter(s => s.tier === 3).length,
                highRisk: students.filter(s => s.tier === 2).length,
                crisis: students.filter(s => s.tier === 1).length,
                improving: students.filter(s => s.acceleration > 0).length,
                declining: students.filter(s => s.acceleration < 0).length,
                stable: students.filter(s => s.acceleration === 0).length,
                tierPromotions: students.filter(s => s.tierChange > 0).length,
                breakthrough: students.filter(s => s.trajectory === 'breakthrough').length,
                building: students.filter(s => s.trajectory === 'building').length,
                stableTrajectory: students.filter(s => s.trajectory === 'stable').length,
                decliningTrajectory: students.filter(s => s.trajectory === 'declining').length,
                rapidDecline: students.filter(s => s.trajectory === 'rapid_decline').length
            };
            
            // Find highlights
            const topGainers = [...students].sort((a, b) => b.unitsGained - a.unitsGained).slice(0, 3);
            const topAccel = [...students].filter(s => s.acceleration > 0).sort((a, b) => b.acceleration - a.acceleration).slice(0, 3);
            // V8.1 FIX: Perfect Week uses new attendance-delta logic
            const perfectWeek = students.filter(s => s.isPerfectWeek);
            const tierPromotions = students.filter(s => s.tierChange > 0);
            
            // Advisor stats with grading
            const advisorMap = new Map();
            students.forEach(s => {
                if (!advisorMap.has(s.advisor)) {
                    advisorMap.set(s.advisor, []);
                }
                advisorMap.get(s.advisor).push(s);
            });
            
            // Calculate advisor grades
            const advisorStats = [];
            advisorMap.forEach((students, name) => {
                // V8.0: Skip special categories (students in limbo don't count against advisors)
                if (isSpecialCategory(name)) {
                    if (DEBUG) console.log(`Skipping special category: ${name} (${students.length} students)`);
                    return;
                }
                
                const totalStudents = students.length;
                const avgVel = totalStudents > 0 ? students.reduce((sum, s) => sum + s.velocity, 0) / totalStudents : 0;
                const improving = students.filter(s => s.acceleration > 0).length;
                const crisis = students.filter(s => s.tier === 1).length;
                const highRisk = students.filter(s => s.tier === 2).length;
                const superstars = students.filter(s => s.isSuperstar).length;
                const avgAccel = totalStudents > 0 ? students.reduce((sum, s) => sum + s.acceleration, 0) / totalStudents : 0;
                const avgAtt = totalStudents > 0 ? students.reduce((sum, s) => sum + s.avgAttendance, 0) / totalStudents : 0;
                
                const crisisRatio = crisis / totalStudents;
                const superstarRatio = superstars / totalStudents;
                
                // Calculate score (0-100)
                let score = 0;
                score += (1 - Math.min(crisisRatio, 0.3) / 0.3) * 30; // 30% weight on low crisis
                score += Math.min(avgVel / 3, 1) * 25; // 25% weight on velocity (cap at 3)
                score += superstarRatio * 20; // 20% weight on superstars
                score += (avgAccel > 0 ? Math.min(avgAccel / 2, 1) : 0) * 15; // 15% weight on positive accel
                score += Math.min(avgAtt / 100, 1) * 10; // 10% weight on attendance
                
                advisorStats.push({
                    name,
                    students,
                    totalStudents,
                    avgVelocity: avgVel,
                    improving,
                    improvingPercent: (improving / totalStudents * 100),
                    crisis,
                    highRisk,
                    superstars,
                    avgAcceleration: avgAccel,
                    avgAttendance: avgAtt,
                    score
                });
            });
            
            // Assign grades based on percentile
            advisorStats.sort((a, b) => b.score - a.score);
            advisorStats.forEach((advisor, index) => {
                const percentile = advisorStats.length > 0 ? index / advisorStats.length : 0;
                if (percentile < 0.2) advisor.grade = 'A';
                else if (percentile < 0.5) advisor.grade = 'B';
                else if (percentile < 0.8) advisor.grade = 'C';
                else if (percentile < 0.95) advisor.grade = 'D';
                else advisor.grade = 'F';
            });
            
            // Rotating spotlight
            const spotlightCriteria = [
                { name: 'Fastest Progress Team', sort: (a, b) => b.avgVelocity - a.avgVelocity, reason: 'Highest average velocity' },
                { name: 'Most Stable Team', sort: (a, b) => (a.crisis / a.totalStudents) - (b.crisis / b.totalStudents), reason: 'Lowest crisis percentage' },
                { name: 'Most Improving Team', sort: (a, b) => b.avgAcceleration - a.avgAcceleration, reason: 'Best acceleration' },
                { name: 'Excellence Champion', sort: (a, b) => (b.superstars / b.totalStudents) - (a.superstars / a.totalStudents), reason: 'Highest percentage of high performers' },
                { name: 'Momentum Leader', sort: (a, b) => (b.improving / b.totalStudents) - (a.improving / a.totalStudents), reason: 'Most students improving' }
            ];
            
            const criterion = spotlightCriteria[spotlightWeek - 1];
            const sortedAdvisors = [...advisorStats].sort(criterion.sort);
            const topAdvisor = sortedAdvisors[0];
            topAdvisor.spotlightReason = criterion.reason;
            topAdvisor.spotlightTitle = criterion.name;
            
            // V8.0 FIX #5: Create "Administrative Hold" card for all special category students
            const specialCategoryStudents = [];
            advisorMap.forEach((students, name) => {
                if (isSpecialCategory(name)) {
                    students.forEach(s => {
                        specialCategoryStudents.push({
                            ...s,
                            specialCategoryType: getSpecialCategoryType(name),
                            specialCategoryName: name
                        });
                    });
                }
            });
            
            // Create Administrative Hold card if there are any special category students
            let administrativeHoldCard = null;
            if (specialCategoryStudents.length > 0) {
                // Count by category type
                const categoryBreakdown = {};
                specialCategoryStudents.forEach(s => {
                    const type = s.specialCategoryType;
                    if (!categoryBreakdown[type]) {
                        categoryBreakdown[type] = 0;
                    }
                    categoryBreakdown[type]++;
                });
                
                const avgVel = specialCategoryStudents.length > 0 ? specialCategoryStudents.reduce((sum, s) => sum + s.velocity, 0) / specialCategoryStudents.length : 0;
                const avgAccel = specialCategoryStudents.length > 0 ? specialCategoryStudents.reduce((sum, s) => sum + s.acceleration, 0) / specialCategoryStudents.length : 0;
                const avgAtt = specialCategoryStudents.length > 0 ? specialCategoryStudents.reduce((sum, s) => sum + s.avgAttendance, 0) / specialCategoryStudents.length : 0;
                
                administrativeHoldCard = {
                    name: 'ADMINISTRATIVE_HOLD',
                    displayName: 'Administrative Hold',
                    isSpecialCategory: true,
                    students: specialCategoryStudents,
                    categoryBreakdown,
                    totalStudents: specialCategoryStudents.length,
                    avgVelocity: avgVel,
                    avgAcceleration: avgAccel,
                    avgAttendance: avgAtt,
                    grade: 'N/A', // No grading for special categories
                    score: 0
                };
            }
            
            return {
                students,
                summary,
                highlights: {
                    topGainers,
                    topAccel,
                    perfectWeek,
                    tierPromotions
                },
                advisorSpotlight: topAdvisor,
                advisorStats,
                administrativeHoldCard, // V8.0: New special category card
                advisorMap,
                weekNumber,
                sortedDates,
                generated: new Date().toLocaleString()
            };
        }
        
        // ================== NEW FEATURES ==================
        
        // Click-and-Hold Grade Reveal
        let gradeRevealTimer = null;
        
        function revealGrade(event, index) {
            event.stopPropagation();
            const gradeElement = document.getElementById(`grade-${index}`);
            const iconElement = document.getElementById(`grade-icon-${index}`);
            const btn = event.currentTarget;
            
            btn.classList.add('revealing');
            
            gradeRevealTimer = setTimeout(() => {
                gradeElement.classList.remove('grade-hidden');
                gradeElement.classList.add('grade-visible');
                iconElement.classList.add('grade-hidden');
            }, 2000); // 2 second delay
        }
        
        function hideGrade(event, index) {
            event.stopPropagation();
            const gradeElement = document.getElementById(`grade-${index}`);
            const iconElement = document.getElementById(`grade-icon-${index}`);
            const btn = event.currentTarget;
            
            btn.classList.remove('revealing');
            
            if (gradeRevealTimer) {
                clearTimeout(gradeRevealTimer);
                gradeRevealTimer = null;
            }
            
            gradeElement.classList.remove('grade-visible');
            gradeElement.classList.add('grade-hidden');
            iconElement.classList.remove('grade-hidden');
        }
        
        // New Students Alert (4 weeks)
        function renderNewStudentsAlert() {
            // V8.2: Use isNew flag (based on enrollment date, not first appearance)
            const newStudents = dashboardData.students.filter(s => s.isNew);
            
            if (newStudents.length === 0) {
                document.getElementById('newStudentsAlert').style.display = 'none';
                return;
            }
            
            document.getElementById('newStudentsAlert').style.display = 'block';
            document.getElementById('newStudentsGrid').innerHTML = newStudents.map(s => {
                const weeksHere = s.weeksEnrolled || s.records.length; // V8.2: Use actual weeks enrolled
                const enrollmentDate = s.enrollmentDate || new Date(s.records[0].week);
                const firstDate = enrollmentDate.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
                
                // Use student name directly - more reliable than index
                const escapedName = s.name.replace(/'/g, "\\'");
                
                // Tier color mapping
                const tierColors = {
                    1: 'var(--brand-accent)', 2: 'var(--brand-brass)', 3: 'var(--warning)', 4: 'var(--teal)', 5: 'var(--brand-brass)'
                };
                const tierColor = tierColors[s.tier] || 'var(--brand-brass)';
                
                return `
                    <div class="new-student-card" onclick="showStudentByName('${escapedName}')" style="border: 3px solid ${tierColor};">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <div style="
                                width: 60px; 
                                height: 60px; 
                                border-radius: 50%; 
                                background: linear-gradient(135deg, ${tierColor} 0%, var(--brand-brass) 100%);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 1.8rem;
                                border: 3px solid rgba(255, 255, 255, 0.3);
                            ">ðŸŽ“</div>
                            <div style="flex: 1;">
                                <div class="new-student-name" style="font-size: 1.1rem; margin-bottom: 0.25rem;">${formatStudentName(s.name)}</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">Started ${firstDate}</div>
                            </div>
                        </div>
                        <div class="new-student-meta" style="
                            background: rgba(255, 255, 255, 0.25);
                            padding: 0.75rem;
                            border-radius: 6px;
                            line-height: 1.6;
                            text-align: center;
                        ">
                            <div style="margin-bottom: 0.4rem;"><strong>${s.tierLabel}</strong></div>
                            <div style="margin-bottom: 0.4rem;">Week ${weeksHere}</div>
                            <div style="margin-bottom: 0.4rem;">${s.velocity.toFixed(2)} u/wk velocity</div>
                            <div style="margin-bottom: 0.4rem;">${s.avgAttendance.toFixed(0)}% attendance</div>
                            <div style="font-size: 0.85rem; opacity: 0.9;">ðŸ… ${s.badges.length} badge${s.badges.length !== 1 ? 's' : ''} earned</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Dynamic Wins Banner
        // Perfect Week Club Printable Page
        function showPerfectWeekPrintable() {
            const perfectWeekStudents = dashboardData.highlights.perfectWeek;
            
            if (perfectWeekStudents.length === 0) {
                alert('No students in Perfect Week Club this period!');
                return;
            }
            
            // Hide all other views
            document.getElementById('mainView').classList.remove('active');
            document.getElementById('advisorView').classList.remove('active');
            document.getElementById('studentView').classList.remove('active');
            document.getElementById('filteredListView').classList.remove('active');
            document.getElementById('studentDirectoryView').classList.remove('active');
            
            // Show perfect week printable
            document.getElementById('perfectWeekPrintable').classList.add('active');
            
            // Set date
            const lastDate = new Date(dashboardData.sortedDates[dashboardData.sortedDates.length - 1]);
            document.getElementById('perfectWeekDate').textContent = 
                `Week of ${lastDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`;
            
            // V8.2 FIX 4: Render students WITHOUT orange cards mixed in
            const studentsPerPage = 6;
            let html = '';
            
            // Sort: Attendance DESC, then Units DESC, then Badges DESC
            const sortedStudents = [...perfectWeekStudents].sort((a, b) => {
                // First by attendance (highest first)
                if (b.latest.attendance !== a.latest.attendance) {
                    return b.latest.attendance - a.latest.attendance;
                }
                // Then by units (highest first)
                const aUnits = a.unitsPeriod || a.velocity;
                const bUnits = b.unitsPeriod || b.velocity;
                if (bUnits !== aUnits) {
                    return bUnits - aUnits;
                }
                // Finally by badges (highest first)
                return b.badges.length - a.badges.length;
            });
            
            sortedStudents.forEach((s, index) => {
                html += `
                    <div class="perfect-week-student-card" onclick="showStudentFromPerfectWeek('${s.name}')" style="cursor: pointer;">
                        <div class="perfect-week-student-avatar">â­</div>
                        <div class="perfect-week-student-name">${formatStudentName(s.name)}</div>
                        <div class="perfect-week-student-stats">
                            <div class="perfect-week-stat">
                                <div class="perfect-week-stat-value">${s.unitsPeriod || s.velocity.toFixed(1)}</div>
                                <div class="perfect-week-stat-label">Units This<br>Period</div>
                            </div>
                            <div class="perfect-week-stat">
                                <div class="perfect-week-stat-value">${s.latest.attendance.toFixed(0)}%</div>
                                <div class="perfect-week-stat-label">Attendance</div>
                            </div>
                            <div class="perfect-week-stat">
                                <div class="perfect-week-stat-value">${s.badges.length}</div>
                                <div class="perfect-week-stat-label">Badges</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('perfectWeekStudentsGrid').innerHTML = html;
        }
        
        // FIX 10: Navigate from Perfect Week Club to student detail
        function showStudentFromPerfectWeek(studentName) {
            // Hide Perfect Week view
            document.getElementById('perfectWeekPrintable').classList.remove('active');
            // Show student detail
            showStudentView(studentName);
        }
        
        // ================== UI INITIALIZATION ==================
        function initializeDashboard() {
            // Explicitly set as viewing current data on initial load
            isViewingHistoricalData = false;
            
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('mainView').classList.add('active');
            
            // Update date range in header (compact format)
            const firstDate = new Date(dashboardData.sortedDates[0]).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const lastDate = new Date(dashboardData.sortedDates[dashboardData.sortedDates.length - 1]).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            document.getElementById('dateRange').textContent = `${firstDate} - ${lastDate}`;
            
            // Populate week selector dropdown
            populateWeekSelector();
            
            // Initialize week indicator banner (fixes blue bar on load)
            updateWeekIndicatorBanner();
            
            // Initialize PHS Hero Section
            initPHSHero();
            renderChallengesCelebrations();
            renderAdvisorSpotlight();
            renderHighlights();
            renderNewStudentsAlert();
            renderAdvisorCards();
            // renderMomentumTracker(); // Moved to Student Directory
            createWaterfallChart();
            // renderStudentTable(); // Table moved to Student Directory
            setupEventListeners();
            
            // Check if we should restore a student view after refresh
            const savedStudentName = sessionStorage.getItem('currentStudentName');
            if (savedStudentName) {
                // Give the dashboard a moment to fully render, then restore student view
                setTimeout(() => {
                    showStudentByName(savedStudentName);
                }, 100);
            }
            
            document.getElementById('lastUpdate').innerHTML = 
                `Last Updated: ${dashboardData.generated}<br><small style="opacity: 0.7; font-size: 0.85rem;">Created by Tim Keener for Premier HS Gallery North - November 2025</small>`;
        }
        
        function showWinsList(index) {
            const win = window.winsData[index];
            const showTierChanges = win.filter === 'tierPromotions';
            showFilteredList(win.students, win.text, showTierChanges);
        }
        
        function initPHSHero() {
            const summary = dashboardData.summary;
            const students = dashboardData.students;
            
            // Get next calendar event or fun day
            const upcomingEvent = getUpcomingEvent();
            
            // Build large pool of possible wins (15+ metrics)
            const winPool = [
                {
                    icon: "âœ…",
                    title: "On track or ahead",
                    value: summary.onTrack,
                    desc: "students meeting pace",
                    students: students.filter(s => s.tier === 4).map(s => s.name),
                    accent: "teal"
                },
                {
                    icon: "ðŸŽ¯",
                    title: "Ahead of pace",
                    value: students.filter(s => s.tracking >= 5).length,
                    desc: "students 5+ units ahead",
                    students: students.filter(s => s.tracking >= 5).map(s => s.name),
                    accent: "sage"
                },
                {
                    icon: "ðŸ’¯",
                    title: "Perfect Week",
                    value: students.filter(s => s.isPerfectWeek).length,
                    desc: "students achieved it",
                    students: students.filter(s => s.isPerfectWeek).map(s => s.name),
                    accent: "accent"
                },
                {
                    icon: "ðŸ…",
                    title: "Badge Earners",
                    value: students.filter(s => s.badges && s.badges.length >= 3).length,
                    desc: "3+ badges earned",
                    students: students.filter(s => s.badges && s.badges.length >= 3).map(s => s.name),
                    accent: "brass"
                },
                {
                    icon: "ðŸš€",
                    title: "Breakthrough",
                    value: students.filter(s => s.trajectory === 'breakthrough').length,
                    desc: "rapid velocity gain",
                    students: students.filter(s => s.trajectory === 'breakthrough').map(s => s.name),
                    accent: "info"
                },
                {
                    icon: "ðŸ“ˆ",
                    title: "Building Momentum",
                    value: students.filter(s => s.trajectory === 'building').length,
                    desc: "steady improvement",
                    students: students.filter(s => s.trajectory === 'building').map(s => s.name),
                    accent: "teal"
                },
                {
                    icon: "â­",
                    title: "Superstars",
                    value: summary.superstars,
                    desc: "top performers",
                    students: students.filter(s => s.tier === 5).map(s => s.name),
                    accent: "brass"
                },
                {
                    icon: "ðŸŽ“",
                    title: "High Velocity",
                    value: students.filter(s => s.velocity >= 3.0).length,
                    desc: "3+ units per week",
                    students: students.filter(s => s.velocity >= 3.0).map(s => s.name),
                    accent: "sage"
                },
                {
                    icon: "ðŸ“Š",
                    title: "Campus Attendance",
                    value: summary.avgAttendance.toFixed(1) + "%",
                    desc: "average this period",
                    accent: summary.avgAttendance >= 85 ? "teal" : "info"
                },
                {
                    icon: "ðŸŽ¯",
                    title: "Tier Promotions",
                    value: summary.tierPromotions,
                    desc: "students moved up",
                    students: students.filter(s => s.tierChange > 0).map(s => s.name),
                    accent: "accent"
                },
                {
                    icon: "ðŸ’ª",
                    title: "Improving Students",
                    value: summary.improving,
                    desc: "positive acceleration",
                    students: students.filter(s => s.acceleration > 0).map(s => s.name),
                    accent: "sage"
                },
                {
                    icon: "ðŸ“…",
                    title: "Strong Attendance",
                    value: students.filter(s => s.avgAttendance >= 90).length,
                    desc: "90%+ this period",
                    students: students.filter(s => s.avgAttendance >= 90).map(s => s.name),
                    accent: "teal"
                },
                {
                    icon: "ðŸ”¥",
                    title: "Active Students",
                    value: students.filter(s => s.daysSince <= 3).length,
                    desc: "recent activity",
                    students: students.filter(s => s.daysSince <= 3).map(s => s.name),
                    accent: "brass"
                },
                {
                    icon: "ðŸŒŸ",
                    title: "Consistent Progress",
                    value: students.filter(s => s.trajectory === 'stable' && s.tier >= 4).length,
                    desc: "steady performers",
                    students: students.filter(s => s.trajectory === 'stable' && s.tier >= 4).map(s => s.name),
                    accent: "info"
                },
                {
                    icon: "ðŸŽ–ï¸",
                    title: "Multiple Badges",
                    value: students.filter(s => s.badges && s.badges.length >= 5).length,
                    desc: "5+ achievements",
                    students: students.filter(s => s.badges && s.badges.length >= 5).map(s => s.name),
                    accent: "accent"
                }
            ];
            
            // Filter to wins with value > 0
            const validWins = winPool.filter(w => {
                if (typeof w.value === 'string') return true; // Attendance percentage
                return w.value > 0;
            });
            
            // Randomly shuffle and pick 5
            const shuffled = validWins.sort(() => Math.random() - 0.5);
            const selectedWins = shuffled.slice(0, 5);
            
            // Always include upcoming event first
            const wins = [upcomingEvent, ...selectedWins];
            
            // Mark students with tier changes for spotlight priority
            const studentsWithPriority = students.map(s => ({
                ...s,
                hasNewCertification: false, // Not tracking certs yet
                newBadges: 0 // Not tracking new badges, just total
            }));
            
            PHS_HERO.init({
                wins: wins,
                students: studentsWithPriority
            });
        }
        
        function getUpcomingEvent() {
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            
            // Fun national days calendar
            const funDays = [
                { month: 1, day: 1, name: "New Year's Day", icon: "ðŸŽ†" },
                { month: 1, day: 20, name: "MLK Jr. Day", icon: "âœŠ" },
                { month: 2, day: 2, name: "Groundhog Day", icon: "ðŸ¦«" },
                { month: 2, day: 14, name: "Valentine's Day", icon: "ðŸ’" },
                { month: 3, day: 14, name: "Pi Day", icon: "ðŸ¥§" },
                { month: 3, day: 17, name: "St. Patrick's Day", icon: "â˜˜ï¸" },
                { month: 4, day: 1, name: "April Fools' Day", icon: "ðŸ¤¡" },
                { month: 4, day: 22, name: "Earth Day", icon: "ðŸŒ" },
                { month: 5, day: 4, name: "Star Wars Day", icon: "âš”ï¸" },
                { month: 5, day: 5, name: "Cinco de Mayo", icon: "ðŸŒ®" },
                { month: 6, day: 19, name: "Juneteenth", icon: "ðŸŽ‰" },
                { month: 7, day: 4, name: "Independence Day", icon: "ðŸ‡ºðŸ‡¸" },
                { month: 7, day: 30, name: "Friendship Day", icon: "ðŸ¤" },
                { month: 9, day: 18, name: "Cheeseburger Day", icon: "ðŸ”" },
                { month: 10, day: 31, name: "Halloween", icon: "ðŸŽƒ" },
                { month: 11, day: 27, name: "Thanksgiving", icon: "ðŸ¦ƒ" },
                { month: 12, day: 25, name: "Christmas", icon: "ðŸŽ„" }
            ];
            
            // Check school calendar for events within 7 days
            if (schoolCalendar && schoolCalendar.breaks) {
                for (const breakPeriod of schoolCalendar.breaks) {
                    const breakStart = new Date(breakPeriod.start);
                    const daysUntil = Math.ceil((breakStart - today) / (1000 * 60 * 60 * 24));
                    
                    if (daysUntil >= 0 && daysUntil <= 7) {
                        return {
                            icon: "ðŸ“£",
                            title: "Upcoming",
                            value: breakPeriod.type || breakPeriod.name || "School Event",
                            desc: `in ${daysUntil} day${daysUntil === 1 ? '' : 's'}`
                        };
                    }
                }
            }
            
            // Check for fun day today
            const todayFun = funDays.find(d => d.month === (today.getMonth() + 1) && d.day === today.getDate());
            if (todayFun) {
                return {
                    icon: todayFun.icon,
                    title: "Today",
                    value: todayFun.name,
                    desc: "celebrate with students"
                };
            }
            
            // Find next fun day
            for (let i = 1; i < 60; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(checkDate.getDate() + i);
                const funDay = funDays.find(d => d.month === (checkDate.getMonth() + 1) && d.day === checkDate.getDate());
                
                if (funDay) {
                    return {
                        icon: funDay.icon,
                        title: "Upcoming",
                        value: funDay.name,
                        desc: `in ${i} day${i === 1 ? '' : 's'}`
                    };
                }
            }
            
            // Fallback to next school calendar event
            if (schoolCalendar && schoolCalendar.breaks && schoolCalendar.breaks.length > 0) {
                const nextBreak = schoolCalendar.breaks
                    .map(b => ({ ...b, start: new Date(b.start) }))
                    .filter(b => b.start > today)
                    .sort((a, b) => a.start - b.start)[0];
                
                if (nextBreak) {
                    const daysUntil = Math.ceil((nextBreak.start - today) / (1000 * 60 * 60 * 24));
                    return {
                        icon: "ðŸ“…",
                        title: "Next break",
                        value: nextBreak.type || nextBreak.name || "School Break",
                        desc: `in ${daysUntil} days`
                    };
                }
            }
            
            // Ultimate fallback
            return {
                icon: "ðŸ“£",
                title: "This week",
                value: "Focus time",
                desc: "build momentum"
            };
        }
        
        /* =========================
           PHS_HERO MODULE - Integrated Version
           ========================= */
        const PHS_HERO = (() => {
            const LS_KEY = "phs_spotlight_seen_v1";
            const LS_MAX_RECENT = 40;
            let _data = { wins: [], students: [] };

            function init({ wins = [], students = [] } = {}) {
                _data.wins = Array.isArray(wins) ? wins : [];
                _data.students = Array.isArray(students) ? students : [];
                renderWins();
                renderSpotlight();
            }

            function renderWins() {
                const el = document.getElementById("phsWinsCards");
                if (!el) return;

                const wins = _data.wins.length ? _data.wins : [];
                // Store globally for click handlers
                window.phsWinsData = wins;
                el.innerHTML = wins.slice(0, 6).map((w, idx) => winCardHTML(w, idx)).join("");
            }

            function winCardHTML(w, index) {
                const icon = w.icon ?? "âœ…";
                const title = escapeHtml(w.title ?? "Win");
                const value = escapeHtml(String(w.value ?? ""));
                const desc = escapeHtml(w.desc ?? "");
                const accent = w.accent || "info";
                const clickable = w.students && w.students.length > 0;
                const clickHandler = clickable ? `onclick="PHS_HERO.showWinDetail(${index})"` : '';
                const cursorStyle = clickable ? 'cursor: pointer;' : '';
                
                return `
                    <div class="phs-winCard" data-accent="${accent}" ${clickHandler} style="${cursorStyle}">
                        <div class="phs-winIcon">${icon}</div>
                        <div class="phs-winBody">
                            <div class="phs-winTitle">${title}</div>
                            <div class="phs-winValue">${value}</div>
                            <div class="phs-winDesc">${desc}</div>
                        </div>
                    </div>
                `;
            }

            function showWinDetail(index) {
                const win = window.phsWinsData[index];
                if (win && win.students && win.students.length > 0) {
                    showFilteredList(win.students, win.title);
                }
            }

            function renderSpotlight(forceNew = false) {
                const students = _data.students || [];
                if (!students.length) {
                    setSpotlightFallback("Dashboard loading...");
                    return;
                }

                const chosen = pickSpotlightStudent(students, forceNew);
                if (!chosen) {
                    setSpotlightFallback("No students available for spotlight.");
                    return;
                }

                const name = formatStudentName(chosen.name);
                const program = chosen.primaryProgram || chosen.program || "Academic Program";
                const tier = chosen.tierLabel || chosen.tier || "";
                const tierNum = chosen.tier || 0;

                // Avatar initial (first letter of first name)
                const firstName = name.split(' ')[0] || 'S';
                const initial = firstName[0].toUpperCase();
                document.getElementById("phsSpotlightAvatar").textContent = initial;
                document.getElementById("phsSpotlightName").textContent = name;
                document.getElementById("phsSpotlightProgram").textContent = program;

                // Tier chip - only show if tier >= 4 (On Track or Superstar)
                const tagsContainer = document.getElementById("phsSpotlightTags");
                if (tierNum >= 4) {
                    tagsContainer.innerHTML = `
                        <span class="phs-chip" id="phsSpotlightProgram">${escapeHtml(program)}</span>
                        <span class="phs-chip phs-chip--soft" id="phsSpotlightTier">${escapeHtml(tier)}</span>
                    `;
                } else {
                    tagsContainer.innerHTML = `
                        <span class="phs-chip" id="phsSpotlightProgram">${escapeHtml(program)}</span>
                    `;
                }

                // Positive narrative
                const why = buildPositiveWhy(chosen, firstName);
                document.getElementById("phsSpotlightWhy").textContent = why;

                // Stats
                const stats = buildSpotlightStats(chosen);
                document.getElementById("phsSpotlightStats").innerHTML = stats.map(statHTML).join("");
            }

            function statHTML(s) {
                return `
                    <div class="phs-stat">
                        <div class="phs-stat__label">${escapeHtml(s.label)}</div>
                        <div class="phs-stat__value">${escapeHtml(s.value)}</div>
                    </div>
                `;
            }

            function buildSpotlightStats(stu) {
                const stats = [];
                if (isNumber(stu.tracking)) stats.push({ label: "Ahead/Behind", value: formatSigned(stu.tracking) });
                if (isNumber(stu.velocity)) stats.push({ label: "Velocity", value: `${round1(stu.velocity)} u/wk` });
                if (isNumber(stu.avgAttendance)) stats.push({ label: "Attendance", value: `${round1(stu.avgAttendance)}%` });
                if (isNumber(stu.badges) && stu.badges > 0) stats.push({ label: "Badges", value: String(stu.badges) });
                if (isNumber(stu.daysSince)) stats.push({ label: "Last Activity", value: `${stu.daysSince} days` });
                return stats.slice(0, 4).length ? stats.slice(0, 4) : [
                    { label: "Status", value: "Active" },
                    { label: "Focus", value: "This week" }
                ];
            }

            function pickSpotlightStudent(students, forceNew) {
                const seen = loadSeen();
                const ids = students.map(s => stableId(s));
                const uniqueCount = new Set(ids).size;

                if (seen.length > Math.max(uniqueCount, LS_MAX_RECENT)) {
                    saveSeen(seen.slice(-Math.min(uniqueCount, LS_MAX_RECENT)));
                }

                let eligible = students.filter(s => !seen.includes(stableId(s)));
                if (!eligible.length) {
                    saveSeen([]);
                    eligible = students.slice();
                }

                eligible.sort((a, b) => scoreStudent(b) - scoreStudent(a));
                const chosen = eligible[0] || students[0];

                const chosenId = stableId(chosen);
                const nextSeen = [...seen, chosenId].slice(-LS_MAX_RECENT);
                saveSeen(nextSeen);

                return chosen;
            }

            function scoreStudent(s) {
                let score = 0;

                // Tim's priorities - big boosts for achievements
                if (s.hasNewCertification) score += 100;
                if (s.newBadges && s.newBadges > 0) score += 80;
                if (isNumber(s.tierChange) && s.tierChange > 0) score += 60;

                // Core metrics
                if (isNumber(s.tracking)) score += clamp(s.tracking, -10, 50) * 0.8;
                if (isNumber(s.velocity)) score += clamp(s.velocity, 0, 10) * 2.0;
                if (isNumber(s.avgAttendance)) score += clamp((s.avgAttendance - 75), -20, 25) * 0.5;
                if (isNumber(s.badges)) score += clamp(s.badges, 0, 20) * 1.5;
                if (isNumber(s.daysSince)) score += clamp((20 - s.daysSince), -10, 20) * 0.8;

                // Trajectory boost
                if (typeof s.trajectory === "string") {
                    const t = s.trajectory.toLowerCase();
                    if (t.includes("breakthrough")) score += 12;
                    if (t.includes("building")) score += 10;
                    if (t.includes("stable")) score += 6;
                }

                score += Math.random() * 0.1;
                return score;
            }

            function buildPositiveWhy(s, firstName) {
                const narratives = [];
                
                // Tier promotion (highest priority)
                if (isNumber(s.tierChange) && s.tierChange > 0) {
                    narratives.push(`${firstName} just moved up a tier! That's real progress, happening because of consistent effort. Worth celebrating.`);
                    narratives.push(`${firstName} leveled up this period. That kind of forward movement doesn't happen by accidentâ€”it's the result of showing up.`);
                }
                
                // Strong ahead position
                if (isNumber(s.tracking) && s.tracking >= 8) {
                    narratives.push(`${firstName} is ${s.tracking} units ahead of pace. That cushion creates breathing room and options down the road.`);
                } else if (isNumber(s.tracking) && s.tracking >= 5) {
                    narratives.push(`${firstName} is pulling ahead (${formatSigned(s.tracking)} units). This is the kind of quiet win that compounds into real options.`);
                }
                
                // Trajectory-based
                if (typeof s.trajectory === "string") {
                    if (s.trajectory.includes("breakthrough")) {
                        narratives.push(`${firstName} hit breakthrough velocity. That's not luckâ€”it's showing up and doing the work.`);
                        narratives.push(`${firstName} is on a breakthrough run right now. This is the moment to reinforce what's working.`);
                    } else if (s.trajectory.includes("building")) {
                        narratives.push(`${firstName} is in a building phase. That's the moment to reinforce routines and lock in the next win.`);
                        narratives.push(`${firstName} is building momentum steadily. Consistency like this is what separates progress from potential.`);
                    } else if (s.trajectory.includes("stable") && s.tier >= 4) {
                        narratives.push(`${firstName} is holding a steady pace. That kind of reliability is underratedâ€”it's what gets students to the finish line.`);
                    }
                }
                
                // High velocity
                if (isNumber(s.velocity)) {
                    if (s.velocity >= 3.5) {
                        narratives.push(`${firstName} is moving at ${round1(s.velocity)} units/week. That's elite paceâ€”worth protecting and celebrating.`);
                    } else if (s.velocity >= 2.5) {
                        narratives.push(`${firstName} is moving at ${round1(s.velocity)} units/week. That pace creates options, especially if we protect focus.`);
                    }
                }
                
                // Attendance strength
                if (isNumber(s.avgAttendance)) {
                    if (s.avgAttendance >= 95) {
                        narratives.push(`${firstName} has ${round1(s.avgAttendance)}% attendance. That kind of consistency is the foundation everything else builds on.`);
                    } else if (s.avgAttendance >= 90) {
                        narratives.push(`${firstName} is showing up (${round1(s.avgAttendance)}% attendance). Consistency matters more than talent.`);
                    }
                }
                
                // Recent activity
                if (isNumber(s.daysSince) && s.daysSince === 0) {
                    narratives.push(`${firstName} was active today. Engagement is freshâ€”perfect timing for a quick shout-out.`);
                } else if (isNumber(s.daysSince) && s.daysSince <= 2) {
                    narratives.push(`${firstName} has recent activity (${s.daysSince} days ago). Engagement is still warmâ€”good moment for a check-in.`);
                }
                
                // Multiple badges
                if (s.badges && s.badges.length >= 5) {
                    narratives.push(`${firstName} has earned ${s.badges.length} badges. That's proof of consistent effort turning into tangible wins.`);
                } else if (s.badges && s.badges.length >= 3) {
                    narratives.push(`${firstName} has ${s.badges.length} badges under their belt. Recognition mattersâ€”this is evidence of real work.`);
                }
                
                // Perfect Week
                if (s.isPerfectWeek) {
                    narratives.push(`${firstName} hit a Perfect Week. That's rareâ€”worth calling out and celebrating publicly.`);
                }
                
                // Struggling but positive frame
                if (isNumber(s.avgAttendance) && s.avgAttendance < 80 && narratives.length === 0) {
                    narratives.push(`${firstName} is still building consistency. Spotlighting now creates a chance to "catch them doing something right."`);
                    narratives.push(`${firstName} is on the radar today. Sometimes visibility alone can shift a student's trajectory.`);
                }
                
                // Default positive
                if (narratives.length === 0) {
                    narratives.push(`${firstName} is getting featured to keep visibility across the whole roster. Teachers don't just track dataâ€”they shape the story.`);
                    narratives.push(`${firstName} is in today's spotlight. Every student deserves to be seen, not just the ones at the extremes.`);
                    narratives.push(`${firstName} is on deck. Sometimes the act of being noticed is enough to create forward momentum.`);
                }
                
                // Randomly pick one narrative to avoid repeating same message
                return narratives[Math.floor(Math.random() * narratives.length)];
            }

            function setSpotlightFallback(msg) {
                document.getElementById("phsSpotlightName").textContent = "Student Spotlight";
                document.getElementById("phsSpotlightTags").innerHTML = `<span class="phs-chip">Waiting on data</span>`;
                document.getElementById("phsSpotlightWhy").textContent = msg;
                document.getElementById("phsSpotlightStats").innerHTML = `
                    <div class="phs-stat"><div class="phs-stat__label">Status</div><div class="phs-stat__value">Pending</div></div>
                    <div class="phs-stat"><div class="phs-stat__label">Next Step</div><div class="phs-stat__value">Upload data</div></div>
                `;
            }

            // Utilities
            function stableId(s) {
                if (s.Student_Number != null) return String(s.Student_Number);
                if (s.id != null) return String(s.id);
                return `${(s.name || "").trim().toLowerCase()}`;
            }

            function loadSeen() {
                try {
                    const raw = localStorage.getItem(LS_KEY);
                    const arr = raw ? JSON.parse(raw) : [];
                    return Array.isArray(arr) ? arr : [];
                } catch { return []; }
            }

            function saveSeen(arr) {
                try { localStorage.setItem(LS_KEY, JSON.stringify(arr)); } catch {}
            }

            function escapeHtml(s) {
                return String(s).replace(/[&<>"']/g, (m) => ({
                    "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
                }[m]));
            }

            function isNumber(x) { return typeof x === "number" && Number.isFinite(x); }
            function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }
            function round1(n) { return Math.round(n * 10) / 10; }
            function formatSigned(n) {
                const v = round1(n);
                return (v > 0 ? `+${v}` : `${v}`);
            }

            return { init, renderWins, renderSpotlight, showWinDetail };
        })();
        
        function renderChallengesCelebrations() {
            const summary = dashboardData.summary;
            const students = dashboardData.students;
            const avgVel = summary.avgVelocity;
            const avgAtt = summary.avgAttendance;
            const crisisPercent = (summary.crisis / summary.totalStudents * 100);
            const highRiskPercent = (summary.highRisk / summary.totalStudents * 100);
            const onTrackPercent = (summary.onTrack / summary.totalStudents * 100);
            const improvingPercent = (summary.improving / summary.totalStudents * 100);
            
            // Build challenge candidates with significance scores
            const challengeCandidates = [
                { 
                    label: 'Crisis Students', 
                    value: summary.crisis + ` (${crisisPercent.toFixed(0)}%)`,
                    score: crisisPercent * 2,
                    students: students.filter(s => s.tier === 1).map(s => s.name)
                },
                { 
                    label: 'High Risk Students', 
                    value: summary.highRisk + ` (${highRiskPercent.toFixed(0)}%)`,
                    score: highRiskPercent * 1.5,
                    students: students.filter(s => s.tier === 2).map(s => s.name)
                },
                { 
                    label: 'Students Below Target', 
                    value: summary.watch + summary.highRisk + summary.crisis,
                    score: ((summary.watch + summary.highRisk + summary.crisis) / summary.totalStudents) * 100,
                    students: students.filter(s => s.tier <= 3).map(s => s.name)
                },
                { 
                    label: 'Class Average Velocity', 
                    value: avgVel.toFixed(2) + ' u/wk',
                    score: avgVel < 1.6 ? (2.0 - avgVel) * 50 : 0,
                    students: students.filter(s => s.velocity < 1.6).map(s => s.name)
                },
                { 
                    label: 'Average Attendance', 
                    value: avgAtt.toFixed(1) + '%',
                    score: avgAtt < 80 ? (85 - avgAtt) * 3 : 0,
                    students: students.filter(s => s.avgAttendance < 80).map(s => s.name)
                },
                { 
                    label: 'Students Declining', 
                    value: summary.declining + summary.rapidDecline,
                    score: ((summary.declining + summary.rapidDecline) / summary.totalStudents) * 80,
                    students: students.filter(s => s.acceleration < -0.5).map(s => s.name)
                },
                { 
                    label: 'Rapid Decline Students', 
                    value: summary.rapidDecline,
                    score: (summary.rapidDecline / summary.totalStudents) * 120,
                    students: students.filter(s => s.trajectory === 'rapid_decline').map(s => s.name)
                }
            ];
            
            // Build celebration candidates with significance scores
            const celebrationCandidates = [
                { 
                    label: 'Students On Track or Ahead', 
                    value: summary.onTrack,
                    score: onTrackPercent,
                    students: students.filter(s => s.tier === 4).map(s => s.name)
                },
                { 
                    label: 'Students Improving', 
                    value: summary.improving + ` (${improvingPercent.toFixed(0)}%)`,
                    score: improvingPercent * 1.5,
                    students: students.filter(s => s.acceleration > 0).map(s => s.name)
                },
                { 
                    label: 'Tier Promotions', 
                    value: summary.tierPromotions,
                    score: (summary.tierPromotions / summary.totalStudents) * 150,
                    students: students.filter(s => s.tierChange > 0).map(s => s.name)
                },
                { 
                    label: 'Class Average Velocity', 
                    value: avgVel.toFixed(2) + ' u/wk',
                    score: avgVel >= 2.0 ? (avgVel - 1.5) * 80 : 0,
                    students: students.filter(s => s.velocity >= 2.0).map(s => s.name)
                },
                { 
                    label: 'Average Attendance', 
                    value: avgAtt.toFixed(1) + '%',
                    score: avgAtt >= 85 ? (avgAtt - 80) * 3 : 0,
                    students: students.filter(s => s.avgAttendance >= 85).map(s => s.name)
                },
                { 
                    label: 'High Performers', 
                    value: summary.superstars + ` (${(summary.superstars/summary.totalStudents*100).toFixed(0)}%)`,
                    score: (summary.superstars / summary.totalStudents) * 120,
                    students: students.filter(s => s.isSuperstar).map(s => s.name)
                },
                { 
                    label: 'Breakthrough Students', 
                    value: summary.breakthrough,
                    score: (summary.breakthrough / summary.totalStudents) * 100,
                    students: students.filter(s => s.trajectory === 'breakthrough').map(s => s.name)
                }
            ];
            
            // Sort and pick top 4 with score > 0
            const topChallenges = challengeCandidates
                .filter(c => c.score > 0 && c.students.length > 0)
                .sort((a, b) => b.score - a.score)
                .slice(0, 4);
            
            const topCelebrations = celebrationCandidates
                .filter(c => c.score > 0 && c.students.length > 0)
                .sort((a, b) => b.score - a.score)
                .slice(0, 4);
            
            // Store for click handling
            window.challengesData = topChallenges;
            window.celebrationsData = topCelebrations;
            
            document.getElementById('challengesContent').innerHTML = topChallenges.map((c, idx) => `
                <div class="metric-row" style="cursor: pointer;" onclick="showChallengeDetail(${idx})">
                    <span class="metric-label">${c.label}</span>
                    <span class="metric-value status-danger">${c.value}</span>
                </div>
            `).join('');
            
            document.getElementById('celebrationsContent').innerHTML = topCelebrations.map((c, idx) => `
                <div class="metric-row" style="cursor: pointer;" onclick="showCelebrationDetail(${idx})">
                    <span class="metric-label">${c.label}</span>
                    <span class="metric-value status-good">${c.value}</span>
                </div>
            `).join('');
        }
        
        function showChallengeDetail(index) {
            const item = window.challengesData[index];
            if (item.students.length > 0) {
                showFilteredList(item.students, item.label);
            }
        }
        
        function showCelebrationDetail(index) {
            const item = window.celebrationsData[index];
            if (item.students.length > 0) {
                const showTierChanges = item.label.includes('Tier Promotions');
                showFilteredList(item.students, item.label, showTierChanges);
            }
        }
        
        function renderAdvisorSpotlight() {
            const spotlight = dashboardData.advisorSpotlight;
            if (!spotlight) return;
            
            // Determine featured stat based on spotlight type
            let featuredStat = '';
            let featuredValue = '';
            
            if (spotlight.spotlightTitle.includes('Fastest Progress')) {
                featuredStat = 'Avg Velocity';
                featuredValue = spotlight.avgVelocity.toFixed(2) + ' u/wk';
            } else if (spotlight.spotlightTitle.includes('Most Stable')) {
                featuredStat = 'Crisis Rate';
                featuredValue = ((spotlight.crisis / spotlight.totalStudents) * 100).toFixed(1) + '%';
            } else if (spotlight.spotlightTitle.includes('Most Improving')) {
                featuredStat = 'Avg Acceleration';
                featuredValue = (spotlight.avgAcceleration > 0 ? '+' : '') + spotlight.avgAcceleration.toFixed(2);
            } else if (spotlight.spotlightTitle.includes('Excellence')) {
                featuredStat = 'High Performers';
                featuredValue = spotlight.superstars + ' (' + ((spotlight.superstars / spotlight.totalStudents) * 100).toFixed(0) + '%)';
            } else if (spotlight.spotlightTitle.includes('Momentum')) {
                featuredStat = 'Students Improving';
                featuredValue = spotlight.improving + ' (' + spotlight.improvingPercent.toFixed(0) + '%)';
            }
            
            // Store spotlight data globally
            window.spotlightData = {
                improvingStudents: spotlight.students.filter(s => s.acceleration > 0).map(s => s.name),
                crisisStudents: spotlight.students.filter(s => s.tier === 1).map(s => s.name)
            };
            
            document.getElementById('advisorSpotlight').innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: var(--text);"><span class="emoji-large">ðŸŒŸ</span> Advisor Spotlight</h2>
                </div>
                <div style="position: relative; background: linear-gradient(135deg, var(--brand-brass) 0%, #7b5c33 100%); padding: 2rem; border-radius: 12px; margin-bottom: 1rem; box-shadow: 0 4px 15px rgba(97, 23, 24, 0.18); color: white; min-height: 200px;">
                    <!-- Top Right: "Most Stable Team" badge with stat (like envelope stamp) -->
                    <div style="position: absolute; top: 1rem; right: 1rem; background: linear-gradient(135deg, #4b5563 0%, #374151 100%); color: white; padding: 0.75rem 1.25rem; border-radius: 8px; font-weight: 700; font-size: 0.875rem; box-shadow: 0 2px 8px rgba(0,0,0,0.2); text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.25rem;">${((spotlight.crisis / spotlight.totalStudents) * 100).toFixed(1)}%</div>
                        <div style="font-size: 0.75rem; opacity: 0.9;">${spotlight.spotlightTitle}</div>
                    </div>
                    
                    <!-- Top Left: Advisor name (like return address) -->
                    <div style="margin-bottom: 1rem;">
                        <div style="font-size: 2rem; font-weight: 700; color: white;">${formatAdvisorName(spotlight.name)}</div>
                    </div>
                    
                    <!-- Top Center: Reason message (CELEBRATION - large font) -->
                    <div style="text-align: center; margin: 0.5rem auto 3rem; max-width: 70%;">
                        <div style="font-size: 2rem; font-weight: 800; color: white; line-height: 1.3; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">${spotlight.spotlightReason}</div>
                    </div>
                    
                    <!-- Bottom: 4 metric chips INSIDE the card -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; margin-top: 2rem;">
                        <div onclick="showSpotlightImproving()" style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 1rem; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                            <div style="font-size: 1.75rem; font-weight: 700; color: white;">${spotlight.improving}/${spotlight.totalStudents}</div>
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.9); margin-top: 0.25rem;">Students Improving</div>
                        </div>
                        <div onclick="showSpotlightCrisis()" style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 1rem; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                            <div style="font-size: 1.75rem; font-weight: 700; color: white;">${spotlight.crisis}</div>
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.9); margin-top: 0.25rem;">Crisis Students</div>
                        </div>
                        <div onclick="showVelocityTrend()" style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 1rem; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                            <div style="font-size: 1.75rem; font-weight: 700; color: white;">${spotlight.avgVelocity.toFixed(2)}</div>
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.9); margin-top: 0.25rem;">Avg Velocity (u/wk)</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 1rem; border-radius: 8px; text-align: center; transition: all 0.2s;">
                            <div style="font-size: 1.75rem; font-weight: 700; color: white;">${spotlight.avgAcceleration > 0 ? '+' : ''}${spotlight.avgAcceleration.toFixed(2)}</div>
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.9); margin-top: 0.25rem;">Avg Acceleration</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function showSpotlightImproving() {
            showFilteredList(window.spotlightData.improvingStudents, dashboardData.advisorSpotlight.improving + " Students Improving");
        }
        
        function showSpotlightCrisis() {
            showFilteredList(window.spotlightData.crisisStudents, "Crisis Students");
        }
        
        function renderHighlights() {
            const highlights = dashboardData.highlights;
            
            // Store highlights data globally
            window.highlightsData = {
                topGainers: highlights.topGainers,
                topAccel: highlights.topAccel,
                perfectWeek: highlights.perfectWeek
            };
            
            document.getElementById('highlightsGrid').innerHTML = `
                <div class="highlight-card blue">
                    <h4><span class="emoji-icon">ðŸ…</span> Biggest Gains</h4>
                    <div class="highlight-students">
                        ${highlights.topGainers.map((s, idx) => `
                            <div class="highlight-student" data-category="topGainers" data-index="${idx}">
                                ${formatStudentName(s.name)}<br>
                                <span class="highlight-student-meta">${s.unitsGained} units this period!</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="highlight-card teal">
                    <h4><span class="emoji-icon">ðŸš€</span> Most Improved</h4>
                    <div class="highlight-students">
                        ${highlights.topAccel.map((s, idx) => `
                            <div class="highlight-student" data-category="topAccel" data-index="${idx}">
                                ${formatStudentName(s.name)}<br>
                                <span class="highlight-student-meta">${s.earlyVelocity.toFixed(1)} â†’ ${s.recentVelocity.toFixed(1)} u/wk (+${s.acceleration.toFixed(1)})</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="highlight-card yellow">
                    <h4><span class="emoji-icon">ðŸ’¯</span> Perfect Week Club</h4>
                    <div class="highlight-students">
                        <div style="padding: 1rem; text-align: center; background: white; border-radius: 6px; border: 2px solid var(--brand-brass); cursor: pointer; transition: all 0.2s;" 
                             onclick="showPerfectWeekPrintable()"
                             onmouseover="this.style.background='rgba(162,129,80,0.05)'"
                             onmouseout="this.style.background='white'">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--brand-brass);">${highlights.perfectWeek.length}</div>
                            <div style="font-size: 0.85rem; color: var(--muted);">students with great<br>units + perfect attendance!<br><small style="color: var(--brand-brass); font-weight: 600;">Click to view printable</small></div>
                        </div>
                        ${highlights.perfectWeek.slice(0, 3).map((s, idx) => `
                            <div class="highlight-student" data-category="perfectWeek" data-index="${idx}">
                                ${formatStudentName(s.name)}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // Add event listeners using delegation
            document.getElementById('highlightsGrid').addEventListener('click', function(e) {
                const highlightStudent = e.target.closest('.highlight-student');
                if (highlightStudent) {
                    const category = highlightStudent.dataset.category;
                    const index = parseInt(highlightStudent.dataset.index);
                    if (category && !isNaN(index)) {
                        showStudentFromHighlight(category, index);
                    }
                }
            });
        }
        
        function showStudentFromHighlight(category, index) {
            const student = window.highlightsData[category][index];
            showStudentView(student.name);
        }
        
        // V8R1: Calculate CTE & Workforce Programs metrics
        function calculateCTEMetrics() {

            if (!dashboardData || !CONFIG.programTracking || CONFIG.programTracking.size === 0) {
                console.log('âŒ Missing data:', {
                    dashboardData: !!dashboardData,
                    programTracking: !!CONFIG.programTracking,
                    programTrackingSize: CONFIG.programTracking?.size
                });
                return null;
            }
            
            const allStudents = dashboardData.students;

            const programStudentIds = new Set();
            const programNames = new Set();
            
            // Extract unique student numbers from program tracking
            for (const [key, programData] of CONFIG.programTracking.entries()) {
                programStudentIds.add(programData.studentNumber);
                programNames.add(programData.program);
            }
            

            // Find students in dashboard data who have programs
            const programStudents = allStudents.filter(s => 
                s.studentNumber && programStudentIds.has(String(s.studentNumber))
            );
            

            if (programStudents.length === 0) {
                console.log('âŒ No program students matched!');
                return null;
            }
            
            // Calculate program metrics
            const programAvgVelocity = programStudents.reduce((sum, s) => sum + s.velocity, 0) / programStudents.length;
            const programAvgAttendance = programStudents.reduce((sum, s) => sum + s.avgAttendance, 0) / programStudents.length;
            

            // FIX: Match on tier NUMBER (4 and 5 are on-track), not string labels
            const programOnTrack = programStudents.filter(s => s.tier >= 4).length;
            
            // Calculate campus averages for comparison
            const campusAvgVelocity = allStudents.reduce((sum, s) => sum + s.velocity, 0) / allStudents.length;
            const campusAvgAttendance = allStudents.reduce((sum, s) => sum + s.avgAttendance, 0) / allStudents.length;
            const campusOnTrack = allStudents.filter(s => s.tier >= 4).length;
            
            // Calculate certification metrics
            const certifications = CONFIG.studentCertifications || [];
            const certifiedStudentNumbers = new Set(certifications.map(c => c.studentNumber));
            const certifiedStudents = certifiedStudentNumbers.size;  // Count unique students with certs
            const totalCerts = certifications.length;
            const certificationRate = programStudents.length > 0 ? 
                (certifiedStudents / programStudents.length) * 100 : 0;
            
            return {
                totalEnrollments: CONFIG.programTracking.size,
                uniqueStudents: programStudents.length,
                programCount: programNames.size,
                participationRate: (programStudents.length / allStudents.length) * 100,
                program: {
                    avgVelocity: programAvgVelocity,
                    avgAttendance: programAvgAttendance,
                    onTrack: programOnTrack,
                    onTrackPercent: (programOnTrack / programStudents.length) * 100
                },
                campus: {
                    avgVelocity: campusAvgVelocity,
                    avgAttendance: campusAvgAttendance,
                    onTrack: campusOnTrack,
                    onTrackPercent: (campusOnTrack / allStudents.length) * 100
                },
                certifiedStudents: certifiedStudents,
                totalCerts: totalCerts,
                certificationRate: certificationRate
            };
        }

        // ===================================================================
        // PROGRAM TRACKING PAGE
        // ===================================================================
        
        
        // Helper: Convert "LAST, FIRST MIDDLE" to "First Last"

        function showProgramTrackingPage() {
    hideHeader();  // Hide header for overlay view

            // Hide body scrolling to prevent double scrollbar
            document.body.style.overflow = 'hidden';
            
            const programMetrics = calculateDetailedProgramMetrics();
            if (!programMetrics) {
                alert('Unable to load program data');
                return;
            }
            
            const pageHtml = `
                <div id="programTrackingOverlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); overflow-y: auto; z-index: 10000; padding: 2rem;">
                    <div style="max-width: 1400px; margin: 0 auto;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
                            <button onclick="closeProgramTrackingPage()" style="padding: 0.75rem 1.5rem; background: white; border: 2px solid var(--brand-accent); border-radius: 8px; color: var(--brand-accent); font-weight: 600; cursor: pointer;">
                                â† Back
                            </button>
                            <h1 style="font-size: 2rem; font-weight: 700; color: var(--brand-accent); margin: 0;">
                                ðŸŽ“ Program Tracking
                            </h1>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
                            <!-- Card 1: Enrollments + Students (Maroon, CENTERED) -->
                            <div style="background: linear-gradient(135deg, var(--brand-accent) 0%, #7d2528 100%); padding: 2rem; border-radius: 12px; color: white; box-shadow: 0 4px 6px rgba(97, 23, 24, 0.25); text-align: center;">
                                <div style="margin-bottom: 1.5rem;">
                                    <div style="font-size: 1.1rem; font-weight: 600; opacity: 0.9; margin-bottom: 0.5rem;">Total Enrollments</div>
                                    <div style="font-size: 2.5rem; font-weight: 700;">${programMetrics.totalEnrollments}</div>
                                    <div style="font-size: 0.9rem; opacity: 0.8;">${programMetrics.programCount} programs</div>
                                </div>
                                <div style="border-top: 1px solid rgba(255, 255, 255, 0.2); padding-top: 1.5rem;">
                                    <div style="font-size: 1.1rem; font-weight: 600; opacity: 0.9; margin-bottom: 0.5rem;">Active Students</div>
                                    <div style="font-size: 2.5rem; font-weight: 700;">${programMetrics.uniqueStudents}</div>
                                    <div style="font-size: 0.9rem; opacity: 0.8;">${programMetrics.participationRate.toFixed(0)}% of campus</div>
                                </div>
                            </div>
                            
                            <!-- Card 2: Program Distribution (CENTERED) -->
                            <div style="background: linear-gradient(135deg, #f9fafb 0%, #e5e7eb 100%); padding: 2rem; border-radius: 12px; color: var(--text); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.10); border: 1px solid var(--border); text-align: center;">
                                <div style="font-size: 1.1rem; font-weight: 600; opacity: 0.9; margin-bottom: 1rem;">ðŸ“Š Program Distribution</div>
                                <canvas id="programDonutChart" width="200" height="200" style="display: block; margin: 0 auto;"></canvas>
                                <div id="donutLegend" style="margin-top: 1rem; font-size: 0.75rem; color: var(--muted);"></div>
                            </div>
                            
                            <!-- Card 3: Certifications + Employment (Gold, CENTERED) -->
                            <div style="background: linear-gradient(135deg, var(--brand-brass) 0%, #8b6f3f 100%); padding: 2rem; border-radius: 12px; color: white; box-shadow: 0 4px 6px rgba(162, 129, 80, 0.3); text-align: center;">
                                <div onclick="showCertificationsPopup()" style="cursor: pointer; margin-bottom: 1.5rem; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                                    <div style="font-size: 1.1rem; font-weight: 600; opacity: 0.9; margin-bottom: 0.5rem;">ðŸ“œ Certifications Earned</div>
                                    <div style="font-size: 2.5rem; font-weight: 700;">${programMetrics.totalCerts}</div>
                                    <div style="font-size: 0.9rem; opacity: 0.8;">${programMetrics.certifiedStudents} unique students</div>
                                </div>
                                <div onclick="showPlacementsPopup()" style="cursor: pointer; border-top: 1px solid rgba(255, 255, 255, 0.2); padding-top: 1.5rem; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                                    <div style="font-size: 1.1rem; font-weight: 600; opacity: 0.9; margin-bottom: 0.5rem;">ðŸ’¼ Employment Placements</div>
                                    <div style="font-size: 2.5rem; font-weight: 700;">${programMetrics.totalPlacements}</div>
                                    <div style="font-size: 0.9rem; opacity: 0.8;">${programMetrics.totalPlacements} total placements</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); margin-bottom: 1.5rem;">
                            <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text); margin: 0 0 1rem 0;">ðŸ“Š Programs</h2>
                            <div id="programFilters" style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                                ${generateProgramFilterButtons(programMetrics)}
                            </div>
                        </div>
                        
                        <div id="subcategorySection" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); margin-bottom: 1.5rem; display: none;">
                            <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text); margin: 0 0 1rem 0;">ðŸ“‹ Courses</h2>
                            <div id="subcategoryFilters" style="display: flex; flex-wrap: wrap; gap: 0.75rem;"></div>
                        </div>
                        
                        <div id="programStudentCards" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 1.5rem;">
                            ${generateProgramStudentCards(programMetrics)}
                        </div>
                    </div>
                </div>
            `;
            
            const pageContainer = document.createElement('div');
            pageContainer.id = 'programTrackingPage';
            pageContainer.innerHTML = pageHtml;
            document.body.appendChild(pageContainer);
            
            setTimeout(() => drawProgramDonutChart(programMetrics), 100);
            window.currentProgramFilter = 'all';
        }
        
        function closeProgramTrackingPage() {
    showHeader();  // Show header when returning to main

            const page = document.getElementById('programTrackingPage');
            if (page) page.remove();
            // Restore body scrolling
            document.body.style.overflow = 'auto';
        }
        
        function calculateDetailedProgramMetrics() {
            if (!dashboardData || !CONFIG.programTracking || CONFIG.programTracking.size === 0) return null;
            
            const allStudents = dashboardData.students;
            const programStudentIds = new Set();
            const programsByName = new Map();
            const subcategoriesByProgram = new Map();
            
            for (const [key, programData] of CONFIG.programTracking.entries()) {
                const studentId = programData.studentNumber;
                // Remap Education & Training to Academic Enrichment
                let program = programData.program;
                if (program === 'CTE - Education & Training') {
                    program = 'Academic Enrichment';
                }
                const subcategory = programData.subcategory || 'General';
                
                programStudentIds.add(studentId);
                
                if (!programsByName.has(program)) programsByName.set(program, []);
                programsByName.get(program).push({...programData, program, studentId});
                
                if (!subcategoriesByProgram.has(program)) subcategoriesByProgram.set(program, new Set());
                subcategoriesByProgram.get(program).add(subcategory);
            }
            
            const programStudents = allStudents.filter(s => s.studentNumber && programStudentIds.has(String(s.studentNumber)));
            const campusAvgVelocity = allStudents.reduce((sum, s) => sum + s.velocity, 0) / allStudents.length;
            const programAvgVelocity = programStudents.reduce((sum, s) => sum + s.velocity, 0) / programStudents.length;
            
            // Calculate active placements (with fallback if not loaded)
            const activePlacements = (CONFIG.employmentPlacements || []).filter(p => 
                p.status && p.status.toLowerCase() === 'active'
            ).length;
            
            // Calculate certification metrics for Program Tracking page
            const certifications = CONFIG.studentCertifications || [];
            const certifiedStudentNumbers = new Set(certifications.map(c => c.studentNumber));
            const certifiedStudents = certifiedStudentNumbers.size;  // Count unique students with certs
            const totalCerts = certifications.length;
            
            // Calculate total placements (not just active)
            const allPlacements = CONFIG.employmentPlacements || [];
            const totalPlacements = allPlacements.length;
            
            return {
                totalEnrollments: CONFIG.programTracking.size,
                uniqueStudents: programStudents.length,
                programCount: programsByName.size,
                participationRate: (programStudents.length / allStudents.length) * 100,
                velocityImpact: programAvgVelocity - campusAvgVelocity,
                programsByName,
                subcategoriesByProgram,
                programStudents,
                activePlacements,
                certifiedStudents: certifiedStudents,
                totalCerts: totalCerts,
                totalPlacements: totalPlacements
            };
        }
        
        function generateProgramFilterButtons(metrics) {
            let html = `<button onclick="filterByProgram('all')" id="filter-all" style="padding: 0.625rem 1.25rem; background: linear-gradient(135deg, var(--brand-accent) 0%, #7d2528 100%); color: white; border: none; border-radius: 8px; font-size: 0.875rem; font-weight: 600; cursor: pointer;">All Programs <span style="background: rgba(255,255,255,0.2); padding: 0.125rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">${metrics.uniqueStudents}</span></button>`;
            
            for (const [program, enrollments] of metrics.programsByName.entries()) {
                const id = program.replace(/[^a-zA-Z0-9]/g, '_');
                const shortName = program.substring(0, 35);
                const escapedName = program.replace(/'/g, "\\'");
                // Count unique students in this program
                const uniqueStudentNumbers = new Set(enrollments.map(e => e.studentNumber));
                const studentCount = uniqueStudentNumbers.size;
                html += `<button onclick="filterByProgram('${id}', '${escapedName}')" id="filter-${id}" class="program-filter-btn" style="padding: 0.625rem 1.25rem; background: white; color: var(--ink); border: 2px solid rgba(42,42,42,0.12); border-radius: 8px; font-size: 0.875rem; font-weight: 500; cursor: pointer;">${shortName} <span style="background: var(--surface); padding: 0.125rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">${studentCount}</span></button>`;
            }
            
            return html;
        }
        
        function generateProgramStudentCards(metrics) {
            let cards = '';
            
            for (let i = 0; i < metrics.programStudents.length; i++) {
                const student = metrics.programStudents[i];
                
                // Find this student's index in the main dashboardData.students array
                const mainStudentIndex = dashboardData.students.findIndex(s => s.name === student.name);
                student.index = mainStudentIndex;
                const studentPrograms = [];
                for (const [key, programData] of CONFIG.programTracking.entries()) {
                    if (programData.studentNumber === String(student.studentNumber)) {
                        studentPrograms.push(programData);
                    }
                }
                
                if (studentPrograms.length === 0) continue;
                
                // Deduplicate programs (only show each program once)
                const uniquePrograms = [...new Set(studentPrograms.map(p => p.program))];
                const programBadges = uniquePrograms.map(program => {
                    const color = getProgramColor(program);
                    const programId = program.replace(/[^a-zA-Z0-9]/g, '_');
                    return `<div onclick="filterByProgram('${programId}', '${program.replace(/'/g, "\\'")}')" style="display: inline-block; padding: 0.375rem 0.75rem; background: ${color}; color: white; border-radius: 6px; font-size: 0.75rem; font-weight: 600; margin-right: 0.5rem; margin-bottom: 0.5rem; cursor: pointer; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'" title="Click to filter">${program}</div>`;
                }).join('');
                
                const subcategories = studentPrograms.map(p => p.subcategory).filter(s => s).join(' â€¢ ');
                const trajColor = student.trajectory === 'breakthrough' ? 'var(--teal)' : student.trajectory === 'building' ? 'var(--info)' : student.trajectory === 'declining' ? 'var(--brand-brass)' : student.trajectory === 'rapid_decline' ? 'var(--brand-accent)' : 'var(--muted)';
                
                // Check if student is certified
                const certifications = CONFIG.studentCertifications || [];
                const isCertified = certifications.some(c => c.studentNumber === String(student.studentNumber));
                
                // Get subcategories for filtering
                const studentSubcategories = studentPrograms.map(p => p.subcategory).filter(s => s).map(s => s.replace(/[^a-zA-Z0-9]/g, '_')).join(' ');
                
                cards += `<div class="program-student-card" data-programs="${studentPrograms.map(p => p.program.replace(/[^a-zA-Z0-9]/g, '_')).join(' ')}" data-subcategories="${studentSubcategories}" style="background: white; border-radius: 12px; border: ${isCertified ? '4px' : '2px'} solid ${isCertified ? 'var(--brand-brass)' : 'rgba(42,42,42,0.12)'}; padding: 1.25rem; ${isCertified ? 'box-shadow: 0 2px 8px rgba(162, 129, 80, 0.3);' : ''}">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                        <div>
                            <h3 style="font-size: 1.125rem; font-weight: 700; color: var(--text); margin: 0 0 0.5rem 0;">
                                <span class="student-name-link" onclick="closeProgramTrackingPage(); setTimeout(() => showStudentByIndex(${student.index}), 100)" style="cursor: pointer; color: var(--brand-accent); text-decoration: none; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">
                                    ${formatStudentName(student.name)}
                                </span>
                            </h3>
                            ${programBadges}
                        </div>
                        <div style="text-align: center; display: flex; flex-direction: column; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                ${isCertified ? '<div onclick="event.stopPropagation(); showStudentCertificationsPopup(\''+student.studentNumber+'\', \''+student.name.replace(/'/g, "\\'")+'\');" style="font-size: 1.25rem; filter: drop-shadow(0 2px 4px rgba(162, 129, 80, 0.4)); cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform=\'scale(1.2)\'" onmouseout="this.style.transform=\'scale(1)\'" title="Click to view certifications">ðŸ“œ</div>' : ''}
                                <div style="font-size: 1.5rem; color: ${trajColor};">${student.trajectoryIcon}</div>
                            </div>
                            <div style="font-size: 0.625rem; color: var(--muted); margin-top: 0.25rem;">
                                ${student.velocity.toFixed(1)} u/wk
                            </div>
                        </div>
                    </div>
                    ${subcategories ? `<div style="font-size: 0.8125rem; color: var(--muted); margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(42,42,42,0.12);">${subcategories}</div>` : ''}
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem;">
                        <div style="text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--muted);">Velocity</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--text);">${student.velocity.toFixed(2)}</div>
                            <div style="font-size: 0.625rem; color: var(--muted);">u/wk</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--muted);">Units</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--text);">${student.currentUnits}</div>
                            <div style="font-size: 0.625rem; color: var(--muted);">completed</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--muted);">Attendance</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--text);">${student.avgAttendance.toFixed(0)}%</div>
                        </div>
                    </div>
                </div>`;
            }
            
            return cards;
        }
        
        function getProgramColor(programName) {
            // Canvas requires actual color values, not CSS variables
            if (programName.includes('Welding')) return '#931a1d';  // Brand accent
            if (programName.includes('Medical') || programName.includes('Health')) return '#2f8f7c';  // Teal
            if (programName.includes('Electrical')) return '#a28150';  // Brand brass
            if (programName.includes('Automotive')) return '#3b82f6';  // Blue (distinct from Medical teal)
            if (programName.includes('Construction')) return '#8b5a2b';  // Construction brown
            if (programName.includes('Academic') || programName.includes('Professional')) return '#7E8F7A';  // Sage
            if (programName.includes('Education')) return '#4b5563';  // Steel
            return '#6f6a61';  // Muted
        }
        
        function filterByProgram(filterId, programName) {
            window.currentProgramFilter = filterId;
            window.currentProgramName = programName || null;
            document.querySelectorAll('.program-filter-btn, #filter-all').forEach(btn => {
                btn.style.background = 'white';
                btn.style.color = 'var(--ink)';
                btn.style.border = '2px solid rgba(42,42,42,0.12)';
            });
            
            const activeBtn = document.getElementById(`filter-${filterId}`);
            if (activeBtn) {
                // Use program-specific color when selected!
                const programColor = programName ? getProgramColor(programName) : '#931a1d';
                activeBtn.style.background = programColor;
                activeBtn.style.color = 'white';
                activeBtn.style.border = 'none';
                
                // Make sure the count span is visible
                const span = activeBtn.querySelector('span');
                if (span) {
                    span.style.background = 'rgba(255,255,255,0.25)';
                    span.style.color = 'white';
                }
            }
            
            const cards = document.querySelectorAll('.program-student-card');
            let visibleCount = 0;
            cards.forEach(card => {
                if (filterId === 'all' || (card.dataset.programs || '').includes(filterId)) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Show/hide subcategory section
            const subcategorySection = document.getElementById('subcategorySection');
            if (filterId !== 'all' && programName) {
                const metrics = calculateDetailedProgramMetrics();
                const subcategories = metrics.subcategoriesByProgram.get(programName);
                
                if (subcategories && subcategories.size > 1) {
                    subcategorySection.style.display = 'block';
                    const subcategoryFilters = document.getElementById('subcategoryFilters');
                    
                    let buttons = `
                        <button onclick="filterByCourse('all')" 
                            id="coursefilter-all"
                            style="padding: 0.5rem 1rem; background: var(--brand-accent); color: white; border: none; border-radius: 6px; font-size: 0.8125rem; font-weight: 500; cursor: pointer;">
                            All Courses
                            <span style="background: rgba(255,255,255,0.2); padding: 0.125rem 0.375rem; border-radius: 10px; font-size: 0.7rem; margin-left: 0.375rem;">${visibleCount}</span>
                        </button>
                    `;
                    
                    for (const subcategory of subcategories) {
                        const subId = subcategory.replace(/[^a-zA-Z0-9]/g, '_');
                        const count = Array.from(cards).filter(c => 
                            c.style.display !== 'none' && 
                            (c.dataset.subcategories || '').includes(subId)
                        ).length;
                        
                        buttons += `
                            <button onclick="filterByCourse('${subId}')" 
                                id="subfilter-${subId}"
                                class="course-filter-btn"
                                style="padding: 0.5rem 1rem; background: white; color: var(--ink); border: 2px solid rgba(42,42,42,0.12); border-radius: 6px; font-size: 0.8125rem; font-weight: 500; cursor: pointer;">
                                ${subcategory}
                                <span style="background: var(--surface); padding: 0.125rem 0.375rem; border-radius: 10px; font-size: 0.7rem; margin-left: 0.375rem;">${count}</span>
                            </button>
                        `;
                    }
                    
                    subcategoryFilters.innerHTML = buttons;
                } else {
                    subcategorySection.style.display = 'none';
                }
            } else {
                subcategorySection.style.display = 'none';
            }
        }
        
        
        function filterByCourse(subId) {
            window.currentCourseFilter = subId;
            
            // Update button states
            document.querySelectorAll('.course-filter-btn, #coursefilter-all').forEach(btn => {
                btn.style.background = 'white';
                btn.style.color = 'var(--ink)';
                btn.style.border = '2px solid rgba(42,42,42,0.12)';
            });
            
            const activeBtn = document.getElementById(`subfilter-${subId}`);
            if (activeBtn) {
                activeBtn.style.background = 'var(--brand-accent)';
                activeBtn.style.color = 'white';
                activeBtn.style.border = 'none';
            }
            
            // Filter cards
            const cards = document.querySelectorAll('.program-student-card');
            cards.forEach(card => {
                const programs = card.dataset.programs || '';
                const passesProgram = window.currentProgramFilter === 'all' || programs.includes(window.currentProgramFilter);
                
                if (!passesProgram) {
                    card.style.display = 'none';
                    return;
                }
                
                if (subId === 'all') {
                    card.style.display = 'block';
                } else {
                    const subcategories = card.dataset.subcategories || '';
                    card.style.display = subcategories.includes(subId) ? 'block' : 'none';
                }
            });
        }

        
        function showPlacementsPopup() {
            const placements = CONFIG.employmentPlacements || [];
            
            if (placements.length === 0) {
                // Show empty state instead of alert
                const emptyHtml = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 20000; display: flex; align-items: center; justify-content: center; padding: 2rem;" onclick="closePlacementsPopup()">
                        <div style="background: white; border-radius: 16px; max-width: 500px; padding: 3rem; text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ“­</div>
                            <h2 style="font-size: 1.5rem; color: var(--text); margin-bottom: 0.5rem;">No Placements Yet</h2>
                            <p style="color: var(--muted);">Employment placement data will appear here once students are placed.</p>
                            <button onclick="closePlacementsPopup()" style="margin-top: 1.5rem; padding: 0.75rem 1.5rem; background: var(--brand-accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Close</button>
                        </div>
                    </div>
                `;
                const popupContainer = document.createElement('div');
                popupContainer.id = 'placementsPopup';
                popupContainer.innerHTML = emptyHtml;
                document.body.appendChild(popupContainer);
                return;
            }
            
            // Calculate summary stats
            const activePlacements = placements.filter(p => p.status && p.status.toLowerCase() === 'active');
            const totalPlacements = placements.length;
            const avgRate = placements.reduce((sum, p) => {
                const rate = parseFloat(String(p.hourlyRate).replace(/[^0-9.]/g, ''));
                return sum + (isNaN(rate) ? 0 : rate);
            }, 0) / placements.filter(p => p.hourlyRate).length;
            
            const uniquePrograms = new Set(placements.map(p => p.program).filter(p => p));
            
            // Build placement cards
            let placementCards = '';
            placements.forEach(placement => {
                const statusColor = placement.status && placement.status.toLowerCase() === 'active' ? 'var(--teal)' : 'var(--brand-accent)';
                const statusIcon = placement.status && placement.status.toLowerCase() === 'active' ? 'âœ…' : 'âš ï¸';
                const rate = placement.hourlyRate ? `$${placement.hourlyRate}/hr` : 'Rate not specified';
                
                placementCards += `
                    <div style="background: white; border-radius: 8px; border: 2px solid rgba(42,42,42,0.12); padding: 1.25rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                            <div>
                                <h3 style="font-size: 1.125rem; font-weight: 700; color: var(--text); margin: 0 0 0.5rem 0;">
                                    ${formatStudentName(placement.studentName)}
                                </h3>
                                <div style="display: inline-block; padding: 0.25rem 0.75rem; background: ${getProgramColor(placement.program)}; color: white; border-radius: 6px; font-size: 0.75rem; font-weight: 600;">
                                    ${placement.program}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.25rem; color: ${statusColor};">${statusIcon}</div>
                                <div style="font-size: 0.75rem; color: ${statusColor}; font-weight: 600;">${placement.status}</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(42,42,42,0.12);">
                            <div>
                                <div style="font-size: 0.75rem; color: var(--muted); margin-bottom: 0.25rem;">ðŸ“ Employer</div>
                                <div style="font-size: 0.875rem; font-weight: 600; color: var(--text);">${placement.employer || 'Not specified'}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: var(--muted); margin-bottom: 0.25rem;">ðŸ’° Rate</div>
                                <div style="font-size: 0.875rem; font-weight: 600; color: var(--text);">${rate}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: var(--muted); margin-bottom: 0.25rem;">ðŸ“… Hire Date</div>
                                <div style="font-size: 0.875rem; font-weight: 600; color: var(--text);">${placement.hireDate || 'Not specified'}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            const popupHtml = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 20000; display: flex; align-items: center; justify-content: center; padding: 2rem;" onclick="if(event.target === this) closePlacementsPopup()">
                    <div style="background: white; border-radius: 16px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);" onclick="event.stopPropagation()">
                        <!-- Header -->
                        <div style="background: linear-gradient(135deg, var(--brand-accent) 0%, #7d2528 100%); padding: 2rem; border-radius: 16px 16px 0 0; color: white; position: sticky; top: 0; z-index: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <h2 style="font-size: 1.75rem; font-weight: 700; margin: 0;">ðŸ’¼ Employment Placements</h2>
                                <button onclick="closePlacementsPopup()" style="background: rgba(255, 255, 255, 0.2); border: none; color: white; font-size: 1.5rem; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">Ã—</button>
                            </div>
                            
                            <!-- Summary Stats -->
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                                <div style="background: rgba(255, 255, 255, 0.15); padding: 1rem; border-radius: 8px;">
                                    <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Active Placements</div>
                                    <div style="font-size: 2rem; font-weight: 700;">${activePlacements.length}</div>
                                    <div style="font-size: 0.75rem; opacity: 0.8;">of ${totalPlacements} total</div>
                                </div>
                                <div style="background: rgba(255, 255, 255, 0.15); padding: 1rem; border-radius: 8px;">
                                    <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Avg Hourly Rate</div>
                                    <div style="font-size: 2rem; font-weight: 700;">$${avgRate.toFixed(2)}</div>
                                    <div style="font-size: 0.75rem; opacity: 0.8;">per hour</div>
                                </div>
                                <div style="background: rgba(255, 255, 255, 0.15); padding: 1rem; border-radius: 8px;">
                                    <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Programs</div>
                                    <div style="font-size: 2rem; font-weight: 700;">${uniquePrograms.size}</div>
                                    <div style="font-size: 0.75rem; opacity: 0.8;">with placements</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Placement Cards -->
                        <div style="padding: 2rem;">
                            ${placementCards}
                        </div>
                    </div>
                </div>
            `;
            
            const popupContainer = document.createElement('div');
            popupContainer.id = 'placementsPopup';
            popupContainer.innerHTML = popupHtml;
            document.body.appendChild(popupContainer);
        }
        
        function closePlacementsPopup() {
            const popup = document.getElementById('placementsPopup');
            if (popup) popup.remove();
        }
        function showCertificationsPopup() {
            const certifications = CONFIG.studentCertifications || [];
            
            if (certifications.length === 0) {
                const emptyHtml = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 20000; display: flex; align-items: center; justify-content: center; padding: 2rem;" onclick="closeCertificationsPopup()">
                        <div style="background: white; border-radius: 16px; max-width: 500px; padding: 3rem; text-align: center;" onclick="event.stopPropagation()">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ“œ</div>
                            <h2 style="font-size: 1.5rem; color: var(--text); margin-bottom: 0.5rem;">No Certifications Yet</h2>
                            <p style="color: var(--muted);">Student certifications will appear here once earned.</p>
                            <button onclick="closeCertificationsPopup()" style="margin-top: 1.5rem; padding: 0.75rem 1.5rem; background: var(--brand-accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Close</button>
                        </div>
                    </div>
                `;
                const popupContainer = document.createElement('div');
                popupContainer.id = 'certificationsPopup';
                popupContainer.innerHTML = emptyHtml;
                document.body.appendChild(popupContainer);
                return;
            }
            
            // Group by issuing authority
            const byAuthority = {};
            certifications.forEach(cert => {
                const auth = cert.issuingAuthority || 'Other';
                if (!byAuthority[auth]) byAuthority[auth] = [];
                byAuthority[auth].push(cert);
            });
            
            // Build sections
            let authoritySections = '';
            for (const [authority, certs] of Object.entries(byAuthority)) {
                const byCertName = {};
                certs.forEach(cert => {
                    const name = cert.certName;
                    if (!byCertName[name]) byCertName[name] = [];
                    byCertName[name].push(cert);
                });
                
                let certItems = '';
                for (const [certName, students] of Object.entries(byCertName)) {
                    const studentNames = students.map(c => formatStudentName(c.studentName)).join(', ');
                    certItems += `
                        <div style="background: var(--surface); padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem;">
                            <div style="font-weight: 600; color: var(--text); margin-bottom: 0.5rem;">${certName}</div>
                            <div style="font-size: 0.875rem; color: var(--muted);">
                                <strong>${students.length} student${students.length !== 1 ? 's' : ''}:</strong> ${studentNames}
                            </div>
                        </div>
                    `;
                }
                
                authoritySections += `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="font-size: 1.125rem; font-weight: 700; color: var(--text); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid rgba(42,42,42,0.12);">
                            ${authority} (${certs.length} cert${certs.length !== 1 ? 's' : ''})
                        </h3>
                        ${certItems}
                    </div>
                `;
            }
            
            const uniqueStudents = new Set(certifications.map(c => c.studentNumber)).size;
            const totalCerts = certifications.length;
            
            const popupHtml = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 20000; display: flex; align-items: center; justify-content: center; padding: 2rem;" onclick="if(event.target === this) closeCertificationsPopup()">
                    <div style="background: white; border-radius: 16px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);" onclick="event.stopPropagation()">
                        <div style="background: linear-gradient(135deg, var(--brand-brass) 0%, #8b6f3f 100%); padding: 2rem; border-radius: 16px 16px 0 0; color: white; position: sticky; top: 0; z-index: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <h2 style="font-size: 1.75rem; font-weight: 700; margin: 0;">ðŸ“œ Student Certifications</h2>
                                <button onclick="closeCertificationsPopup()" style="background: rgba(255, 255, 255, 0.2); border: none; color: white; font-size: 1.5rem; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">Ã—</button>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                                <div style="background: rgba(255, 255, 255, 0.15); padding: 1rem; border-radius: 8px;">
                                    <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Total Certifications</div>
                                    <div style="font-size: 2rem; font-weight: 700;">${totalCerts}</div>
                                </div>
                                <div style="background: rgba(255, 255, 255, 0.15); padding: 1rem; border-radius: 8px;">
                                    <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Certified Students</div>
                                    <div style="font-size: 2rem; font-weight: 700;">${uniqueStudents}</div>
                                </div>
                            </div>
                        </div>
                        <div style="padding: 2rem;">
                            ${authoritySections}
                        </div>
                    </div>
                </div>
            `;
            
            const popupContainer = document.createElement('div');
            popupContainer.id = 'certificationsPopup';
            popupContainer.innerHTML = popupHtml;
            document.body.appendChild(popupContainer);
        }
        
        function closeCertificationsPopup() {
            const popup = document.getElementById('certificationsPopup');
            if (popup) popup.remove();
        }
        function showStudentCertificationsPopup(studentNumber, studentName) {
            const certifications = CONFIG.studentCertifications || [];
            const studentCerts = certifications.filter(c => c.studentNumber === String(studentNumber));
            
            if (studentCerts.length === 0) {
                return; // Shouldn't happen since we only show diploma if certified
            }
            
            let certsList = '';
            studentCerts.forEach(cert => {
                certsList += `
                    <div style="background: var(--surface); padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem; border-left: 4px solid var(--brand-brass);">
                        <div style="font-weight: 600; color: var(--text); margin-bottom: 0.5rem;">ðŸ“œ ${cert.certName}</div>
                        <div style="font-size: 0.875rem; color: var(--muted);">
                            <strong>Issuing Authority:</strong> ${cert.issuingAuthority}<br>
                            ${cert.certDate ? `<strong>Date:</strong> ${cert.certDate}<br>` : ''}
                            ${cert.program ? `<strong>Program:</strong> ${cert.program}` : ''}
                        </div>
                    </div>
                `;
            });
            
            const popupHtml = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 30000; display: flex; align-items: center; justify-content: center; padding: 2rem;" onclick="closeStudentCertificationsPopup()">
                    <div style="background: white; border-radius: 16px; max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);" onclick="event.stopPropagation()">
                        <div style="background: linear-gradient(135deg, var(--brand-brass) 0%, #8b6f3f 100%); padding: 1.5rem; border-radius: 16px 16px 0 0; color: white; position: sticky; top: 0; z-index: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h2 style="font-size: 1.5rem; font-weight: 700; margin: 0;">ðŸ“œ ${formatStudentName(studentName)}'s Certifications</h2>
                                <button onclick="closeStudentCertificationsPopup()" style="background: rgba(255, 255, 255, 0.2); border: none; color: white; font-size: 1.5rem; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">Ã—</button>
                            </div>
                            <div style="font-size: 0.875rem; opacity: 0.9; margin-top: 0.5rem;">
                                ${studentCerts.length} certification${studentCerts.length !== 1 ? 's' : ''}
                            </div>
                        </div>
                        <div style="padding: 1.5rem;">
                            ${certsList}
                        </div>
                    </div>
                </div>
            `;
            
            const popupContainer = document.createElement('div');
            popupContainer.id = 'studentCertificationsPopup';
            popupContainer.innerHTML = popupHtml;
            document.body.appendChild(popupContainer);
        }
        
        function closeStudentCertificationsPopup() {
            const popup = document.getElementById('studentCertificationsPopup');
            if (popup) popup.remove();
        }

        function drawProgramDonutChart(metrics) {
            const canvas = document.getElementById('programDonutChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 80;
            const holeRadius = 50;
            
            const programData = [];
            for (const [program, enrollments] of metrics.programsByName.entries()) {
                programData.push({
                    name: program.replace('CTE - ', '').substring(0, 25),
                    count: enrollments.length,
                    color: getProgramColor(program)
                });
            }
            
            const total = programData.reduce((sum, p) => sum + p.count, 0);
            let currentAngle = -Math.PI / 2;
            
            programData.forEach(program => {
                const sliceAngle = (program.count / total) * 2 * Math.PI;
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.arc(centerX, centerY, holeRadius, currentAngle + sliceAngle, currentAngle, true);
                ctx.closePath();
                ctx.fillStyle = program.color;
                ctx.fill();
                currentAngle += sliceAngle;
            });
            
            ctx.beginPath();
            ctx.arc(centerX, centerY, holeRadius, 0, 2 * Math.PI);
            ctx.fillStyle = 'white';
            ctx.fill();
            
            ctx.fillStyle = '#931a1d';  // Brand accent
            ctx.font = 'bold 24px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(metrics.programCount, centerX, centerY - 10);
            ctx.fillStyle = '#6f6a61';  // Muted
            ctx.font = '11px sans-serif';
            ctx.fillText('Programs', centerX, centerY + 10);
            
            // Build 3-column legend (name + color only)
            const legendEl = document.getElementById('donutLegend');
            if (legendEl) {
                let legendHtml = '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.375rem;">';
                programData.forEach(program => {
                    legendHtml += `
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 12px; height: 12px; border-radius: 2px; background: ${program.color}; flex-shrink: 0;"></div>
                            <div style="color: var(--ink); font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${program.name}</div>
                        </div>
                    `;
                });
                legendHtml += '</div>';
                legendEl.innerHTML = legendHtml;
            }
            
            // Add hover tooltips
            let tooltip = document.getElementById('donutTooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'donutTooltip';
                tooltip.style.cssText = 'position: fixed; background: rgba(0, 0, 0, 0.9); color: white; padding: 0.5rem 0.75rem; border-radius: 6px; font-size: 0.875rem; pointer-events: none; opacity: 0; transition: opacity 0.2s; z-index: 30000; white-space: nowrap;';
                document.body.appendChild(tooltip);
            }
            
            // Store slice data for click detection
            window.donutSliceData = programData.map((program, idx) => {
                let cumAngle = 0;
                for (let i = 0; i < idx; i++) {
                    cumAngle += (programData[i].count / total) * 2 * Math.PI;
                }
                const sliceAngle = (program.count / total) * 2 * Math.PI;
                return {
                    program: program.name,
                    fullName: metrics.programsByName.keys[idx], // Full program name for filtering
                    startAngle: cumAngle,
                    endAngle: cumAngle + sliceAngle
                };
            });
            
            canvas.onclick = function(e) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const dx = x - centerX;
                const dy = y - centerY;
                const dist = Math.sqrt(dx * dx + dy * dy);
                
                if (dist > holeRadius && dist < radius) {
                    let angle = Math.atan2(dy, dx);
                    if (angle < -Math.PI / 2) angle += 2 * Math.PI;
                    angle += Math.PI / 2;
                    if (angle < 0) angle += 2 * Math.PI;
                    
                    let cumAngle = 0;
                    let idx = 0;
                    for (const program of programData) {
                        const sliceAngle = (program.count / total) * 2 * Math.PI;
                        if (angle >= cumAngle && angle < cumAngle + sliceAngle) {
                            // Get full program name from metrics
                            const fullProgram = Array.from(metrics.programsByName.keys())[idx];
                            const programId = fullProgram.replace(/[^a-zA-Z0-9]/g, '_');
                            filterByProgram(programId, fullProgram);
                            return;
                        }
                        cumAngle += sliceAngle;
                        idx++;
                    }
                }
            };
            
            canvas.onmousemove = function(e) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const dx = x - centerX;
                const dy = y - centerY;
                const dist = Math.sqrt(dx * dx + dy * dy);
                
                if (dist > holeRadius && dist < radius) {
                    let angle = Math.atan2(dy, dx);
                    if (angle < -Math.PI / 2) angle += 2 * Math.PI;
                    angle += Math.PI / 2;
                    if (angle < 0) angle += 2 * Math.PI;
                    
                    let cumAngle = 0;
                    for (const program of programData) {
                        const sliceAngle = (program.count / total) * 2 * Math.PI;
                        if (angle >= cumAngle && angle < cumAngle + sliceAngle) {
                            const percent = ((program.count / total) * 100).toFixed(1);
                            tooltip.innerHTML = `<strong>${program.name}</strong><br>${program.count} students (${percent}%)<br><em style="font-size: 0.75rem; opacity: 0.8;">Click to filter</em>`;
                            tooltip.style.left = (e.clientX + 15) + 'px';
                            tooltip.style.top = (e.clientY - 15) + 'px';
                            tooltip.style.opacity = '1';
                            canvas.style.cursor = 'pointer';
                            return;
                        }
                        cumAngle += sliceAngle;
                    }
                }
                tooltip.style.opacity = '0';
                canvas.style.cursor = 'default';
            };
            
            canvas.onmouseleave = function() {
                tooltip.style.opacity = '0';
                canvas.style.cursor = 'default';
            };
        }


        
        function renderAdvisorCards() {
            const advisorStats = dashboardData.advisorStats;
            
            let cardsHtml = advisorStats.map((advisor, idx) => `
                <div class="advisor-card"> 
                    <div class="advisor-card-border grade-${advisor.grade.toLowerCase()}"></div>
                    <div class="advisor-card-content" onclick="showAdvisorByIndex(${idx})">
                        <div class="advisor-card-header">
                            <div class="advisor-card-name">${formatAdvisorName(advisor.name)}</div>
                            <div class="grade-reveal-container">
                                <div class="grade-reveal-label">Grade</div>
                                <div class="grade-reveal-btn" 
                                     onmousedown="revealGrade(event, ${idx})" 
                                     onmouseup="hideGrade(event, ${idx})" 
                                     onmouseleave="hideGrade(event, ${idx})"
                                     onclick="event.stopPropagation()"
                                     id="grade-btn-${idx}">
                                    <span class="grade-hidden" id="grade-${idx}">${advisor.grade}</span>
                                    <span class="grade-icon" id="grade-icon-${idx}">Hold</span>
                                </div>
                            </div>
                        </div>
                        <div class="advisor-card-stats">
                            <div class="advisor-stat-item">
                                <div class="advisor-stat-label">Students</div>
                                <div class="advisor-stat-value">${advisor.totalStudents}</div>
                            </div>
                            <div class="advisor-stat-item ${getHeatmapClass(advisor.avgVelocity, 'velocity')}">
                                <div class="advisor-stat-label">Avg Velocity</div>
                                <div class="advisor-stat-value">${advisor.avgVelocity.toFixed(2)}</div>
                            </div>
                            <div class="advisor-stat-item ${getHeatmapClass(advisor.crisis, 'crisis', advisor.totalStudents)}">
                                <div class="advisor-stat-label">Crisis Students</div>
                                <div class="advisor-stat-value">${advisor.crisis} (${(advisor.crisis/advisor.totalStudents*100).toFixed(0)}%)</div>
                            </div>
                            <div class="advisor-stat-item ${getHeatmapClass(advisor.superstars / advisor.totalStudents, 'superstars')}">
                                <div class="advisor-stat-label">High Performers</div>
                                <div class="advisor-stat-value">${advisor.superstars} (${(advisor.superstars/advisor.totalStudents*100).toFixed(0)}%)</div>
                            </div>
                            <div class="advisor-stat-item ${getHeatmapClass(advisor.avgAcceleration, 'acceleration')}">
                                <div class="advisor-stat-label">Avg Acceleration</div>
                                <div class="advisor-stat-value">${advisor.avgAcceleration > 0 ? '+' : ''}${advisor.avgAcceleration.toFixed(2)}</div>
                            </div>
                            <div class="advisor-stat-item ${getHeatmapClass(advisor.avgAttendance, 'attendance')}">
                                <div class="advisor-stat-label">Avg Attendance</div>
                                <div class="advisor-stat-value">${advisor.avgAttendance.toFixed(1)}%</div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // V8.0 FIX #5: Add Administrative Hold card if there are special category students
            if (dashboardData.administrativeHoldCard) {
                const card = dashboardData.administrativeHoldCard;
                // V8.2.1: Title case for category display
                const categoryList = Object.entries(card.categoryBreakdown)
                    .map(([type, count]) => {
                        const displayName = formatSpecialCategoryName(type);
                        return `${displayName}: ${count}`;
                    })
                    .join(', ');
                
                cardsHtml += `
                    <div class="advisor-card" style="border: 2px solid var(--brand-brass);"> 
                        <div class="advisor-card-border" style="background: var(--brand-brass);"></div>
                        <div class="advisor-card-content" onclick="showAdministrativeHold()">
                            <div class="advisor-card-header">
                                <div class="advisor-card-name">
                                    âš ï¸ ${card.displayName}
                                    <div style="font-size: 0.75rem; color: var(--brand-brass); margin-top: 0.25rem;">Review Required</div>
                                </div>
                                <div class="grade-reveal-container">
                                    <div class="grade-reveal-label" style="opacity: 0.5;">N/A</div>
                                </div>
                            </div>
                            <div class="advisor-card-stats">
                                <div class="advisor-stat-item heatmap-warning">
                                    <div class="advisor-stat-label">Total Students</div>
                                    <div class="advisor-stat-value">${card.totalStudents}</div>
                                </div>
                                <div class="advisor-stat-item">
                                    <div class="advisor-stat-label">Categories</div>
                                    <div class="advisor-stat-value" style="font-size: 0.8rem;">${categoryList}</div>
                                </div>
                                <div class="advisor-stat-item ${getHeatmapClass(card.avgVelocity, 'velocity')}">
                                    <div class="advisor-stat-label">Avg Velocity</div>
                                    <div class="advisor-stat-value">${card.avgVelocity.toFixed(2)}</div>
                                </div>
                                <div class="advisor-stat-item ${getHeatmapClass(card.avgAcceleration, 'acceleration')}">
                                    <div class="advisor-stat-label">Avg Acceleration</div>
                                    <div class="advisor-stat-value">${card.avgAcceleration > 0 ? '+' : ''}${card.avgAcceleration.toFixed(2)}</div>
                                </div>
                                <div class="advisor-stat-item ${getHeatmapClass(card.avgAttendance, 'attendance')}">
                                    <div class="advisor-stat-label">Avg Attendance</div>
                                    <div class="advisor-stat-value">${card.avgAttendance.toFixed(1)}%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            
            // V8R1: Add CTE & Workforce Programs card
            const cteMetrics = calculateCTEMetrics();
            if (cteMetrics) {
                const velocityDiff = cteMetrics.program.avgVelocity - cteMetrics.campus.avgVelocity;
                const attendanceDiff = cteMetrics.program.avgAttendance - cteMetrics.campus.avgAttendance;
                const onTrackDiff = cteMetrics.program.onTrackPercent - cteMetrics.campus.onTrackPercent;
                
                const velocityArrow = velocityDiff > 0.05 ? 'â†‘' : (velocityDiff < -0.05 ? 'â†“' : 'â†’');
                const attendanceArrow = attendanceDiff > 1 ? 'â†‘' : (attendanceDiff < -1 ? 'â†“' : 'â†’');
                const onTrackArrow = onTrackDiff > 2 ? 'â†‘' : (onTrackDiff < -2 ? 'â†“' : 'â†’');
                
                const velocityColor = velocityDiff > 0.05 ? 'var(--teal)' : (velocityDiff < -0.05 ? 'var(--brand-accent)' : 'var(--muted)');
                const attendanceColor = attendanceDiff > 1 ? 'var(--teal)' : (attendanceDiff < -1 ? 'var(--brand-accent)' : 'var(--muted)');
                const onTrackColor = onTrackDiff > 2 ? 'var(--teal)' : (onTrackDiff < -2 ? 'var(--brand-accent)' : 'var(--muted)');
                
                cardsHtml += `
                    <div class="advisor-card" style="border: 3px solid var(--brand-accent);">
                        <div class="advisor-card-border" style="background: linear-gradient(135deg, var(--brand-accent) 0%, #7d2528 100%);"></div>
                        <div class="advisor-card-content">
                            <div class="advisor-card-header">
                                <div class="advisor-card-name">
                                    ðŸŽ“ CTE & Workforce Programs
                                </div>
                            </div>
                            
                            <div class="advisor-card-stats" style="grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
                                <!-- Position 1: Active Students (top left, blue) -->
                                <div class="advisor-stat-item heatmap-very-good">
                                    <div class="advisor-stat-label">Active Students</div>
                                    <div class="advisor-stat-value">${cteMetrics.uniqueStudents}</div>
                                    <div style="font-size: 0.7rem; color: var(--muted); margin-top: 0.25rem;">
                                        ${cteMetrics.participationRate.toFixed(0)}% of campus
                                    </div>
                                </div>
                                
                                <!-- Position 2: Total Enrollments -->
                                <div class="advisor-stat-item">
                                    <div class="advisor-stat-label">Total Enrollments</div>
                                    <div class="advisor-stat-value">${cteMetrics.totalEnrollments}</div>
                                    <div style="font-size: 0.7rem; color: var(--muted); margin-top: 0.25rem;">
                                        ${cteMetrics.programCount} programs
                                    </div>
                                </div>
                                
                                <!-- Position 3: Velocity Comparison -->
                                <div class="advisor-stat-item">
                                    <div class="advisor-stat-label">Velocity vs Campus</div>
                                    <div class="advisor-stat-value" style="line-height: 1.4;">
                                        <span style="font-weight: 700;">${cteMetrics.program.avgVelocity.toFixed(2)}</span> 
                                        <span style="color: ${velocityColor}; font-size: 1.2rem; margin: 0 0.25rem;">${velocityArrow}</span>
                                        <span style="font-weight: 400; opacity: 0.7;">${cteMetrics.campus.avgVelocity.toFixed(2)}</span>
                                    </div>
                                    <div style="font-size: 0.75rem; color: ${velocityColor}; margin-top: 0.25rem; font-weight: 600;">
                                        ${velocityDiff > 0 ? '+' : ''}${velocityDiff.toFixed(2)} u/wk
                                    </div>
                                </div>
                                
                                <!-- Position 4: Attendance Comparison -->
                                <div class="advisor-stat-item">
                                    <div class="advisor-stat-label">Attend. vs Campus</div>
                                    <div class="advisor-stat-value" style="line-height: 1.4;">
                                        <span style="font-weight: 700;">${cteMetrics.program.avgAttendance.toFixed(0)}%</span> 
                                        <span style="color: ${attendanceColor}; font-size: 1.2rem; margin: 0 0.25rem;">${attendanceArrow}</span>
                                        <span style="font-weight: 400; opacity: 0.7;">${cteMetrics.campus.avgAttendance.toFixed(0)}%</span>
                                    </div>
                                    <div style="font-size: 0.75rem; color: ${attendanceColor}; margin-top: 0.25rem; font-weight: 600;">
                                        ${attendanceDiff > 0 ? '+' : ''}${attendanceDiff.toFixed(1)}%
                                    </div>
                                </div>
                                
                                <!-- Position 5: On-Track Comparison -->
                                <div class="advisor-stat-item">
                                    <div class="advisor-stat-label">On-Track vs Campus</div>
                                    <div class="advisor-stat-value" style="line-height: 1.4;">
                                        <span style="font-weight: 700;">${cteMetrics.program.onTrackPercent.toFixed(0)}%</span> 
                                        <span style="color: ${onTrackColor}; font-size: 1.2rem; margin: 0 0.25rem;">${onTrackArrow}</span>
                                        <span style="font-weight: 400; opacity: 0.7;">${cteMetrics.campus.onTrackPercent.toFixed(0)}%</span>
                                    </div>
                                    <div style="font-size: 0.75rem; color: var(--muted); margin-top: 0.25rem;">
                                        ${cteMetrics.program.onTrack} of ${cteMetrics.uniqueStudents}
                                    </div>
                                </div>
                                
                                <!-- Position 6: Certifications (gold, clickable) -->
                                <div class="advisor-stat-item heatmap-warning" onclick="showCertificationsPopup()" style="cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(162, 129, 80, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                    <div class="advisor-stat-label">ðŸ“œ Certifications</div>
                                    <div class="advisor-stat-value">${cteMetrics.totalCerts}</div>
                                    <div style="font-size: 0.7rem; color: var(--muted); margin-top: 0.25rem;">
                                        ${cteMetrics.certifiedStudents} students<br>
                                        ${cteMetrics.certificationRate.toFixed(0)}% certified
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Button to Program Tracking Page -->
                            <div style="margin-top: 1rem;">
                                <button onclick="showProgramTrackingPage()" style="
                                    width: 100%;
                                    padding: 0.875rem;
                                    background: linear-gradient(135deg, var(--brand-accent) 0%, #7d2528 100%);
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    font-size: 0.95rem;
                                    font-weight: 600;
                                    cursor: pointer;
                                    transition: all 0.2s;
                                    box-shadow: var(--shadow-sm);
                                ">
                                    View Full Program Dashboard â†’
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('advisorGrid').innerHTML = cardsHtml;
        }
        
        function showAdvisorByIndex(index) {
            const advisor = dashboardData.advisorStats[index];
            showAdvisorView(advisor.name);
        }
        
        function getHeatmapClass(value, metric, total = null) {
            switch(metric) {
                case 'velocity':
                    if (value >= 2.5) return 'heatmap-very-good';
                    if (value >= 2.0) return 'heatmap-good';
                    if (value >= 1.5) return 'heatmap-neutral';
                    if (value >= 1.0) return 'heatmap-warning';
                    if (value >= 0.5) return 'heatmap-bad';
                    return 'heatmap-very-bad';
                    
                case 'crisis':
                    const ratio = value / total;
                    if (ratio === 0) return 'heatmap-very-good';
                    if (ratio < 0.05) return 'heatmap-good';
                    if (ratio < 0.10) return 'heatmap-neutral';
                    if (ratio < 0.15) return 'heatmap-warning';
                    if (ratio < 0.25) return 'heatmap-bad';
                    return 'heatmap-very-bad';
                    
                case 'superstars':
                    if (value >= 0.3) return 'heatmap-very-good';
                    if (value >= 0.2) return 'heatmap-good';
                    if (value >= 0.1) return 'heatmap-neutral';
                    if (value >= 0.05) return 'heatmap-warning';
                    if (value >= 0.02) return 'heatmap-bad';
                    return 'heatmap-very-bad';
                    
                case 'acceleration':
                    if (value >= 1.0) return 'heatmap-very-good';
                    if (value >= 0.5) return 'heatmap-good';
                    if (value >= -0.2) return 'heatmap-neutral';
                    if (value >= -0.5) return 'heatmap-warning';
                    if (value >= -1.0) return 'heatmap-bad';
                    return 'heatmap-very-bad';
                    
                case 'attendance':
                    if (value >= 95) return 'heatmap-very-good';
                    if (value >= 90) return 'heatmap-good';
                    if (value >= 80) return 'heatmap-neutral';
                    if (value >= 70) return 'heatmap-warning';
                    if (value >= 60) return 'heatmap-bad';
                    return 'heatmap-very-bad';
                    
                default:
                    return 'heatmap-neutral';
            }
        }
        
        function renderMomentumTracker(elementId = null) {
            const summary = dashboardData.summary;
            
            // V8.2.1: Track student movements between trajectories
            let movements = {
                breakthrough: { in: {}, out: {} },
                building: { in: {}, out: {} },
                stable: { in: {}, out: {} },
                declining: { in: {}, out: {} },
                rapid_decline: { in: {}, out: {} }
            };
            
            if (dashboardData.sortedDates.length >= 2) {
                const lastDate = dashboardData.sortedDates[dashboardData.sortedDates.length - 1];
                const prevDate = dashboardData.sortedDates[dashboardData.sortedDates.length - 2];
                
                dashboardData.students.forEach(student => {
                    // Get trajectory at previous date
                    const recordsUpToPrev = student.records.filter(r => r.week <= prevDate);
                    let prevTrajectory = null;
                    
                    if (recordsUpToPrev.length >= 2) {
                        const midPoint = Math.floor(recordsUpToPrev.length / 2);
                        const firstHalf = recordsUpToPrev.slice(0, midPoint);
                        const secondHalf = recordsUpToPrev.slice(midPoint);
                        
                        const earlyVel = firstHalf.length > 1 ? 
                            (firstHalf[firstHalf.length - 1].completed - firstHalf[0].completed) / (firstHalf.length - 1) : 0;
                        const recentVel = secondHalf.length > 1 ?
                            (secondHalf[secondHalf.length - 1].completed - secondHalf[0].completed) / (secondHalf.length - 1) : 0;
                        
                        const accel = recentVel - earlyVel;
                        
                        if (accel > 1.5) prevTrajectory = 'breakthrough';
                        else if (accel > 0.5) prevTrajectory = 'building';
                        else if (accel < -1.5) prevTrajectory = 'rapid_decline';
                        else if (accel < -0.5) prevTrajectory = 'declining';
                        else prevTrajectory = 'stable';
                    }
                    
                    // Current trajectory
                    const currentTrajectory = student.trajectory;
                    
                    // Track movement if trajectory changed
                    if (prevTrajectory && currentTrajectory && prevTrajectory !== currentTrajectory) {
                        // Safety check: ensure both trajectories exist in movements object
                        if (!movements[currentTrajectory] || !movements[prevTrajectory]) {
                            if (DEBUG) console.warn(`Unexpected trajectory: current=${currentTrajectory}, prev=${prevTrajectory}`);
                            return; // Skip this student's movement tracking
                        }
                        
                        // Student moved FROM prevTrajectory TO currentTrajectory
                        if (!movements[currentTrajectory].in[prevTrajectory]) {
                            movements[currentTrajectory].in[prevTrajectory] = 0;
                        }
                        movements[currentTrajectory].in[prevTrajectory]++;
                        
                        if (!movements[prevTrajectory].out[currentTrajectory]) {
                            movements[prevTrajectory].out[currentTrajectory] = 0;
                        }
                        movements[prevTrajectory].out[currentTrajectory]++;
                    }
                });
            }
            
            const trajectoryOrder = ['rapid_decline', 'declining', 'stable', 'building', 'breakthrough'];
            const trajectoryLabels = {
                breakthrough: 'Breakthrough',
                building: 'Building',
                stable: 'Stable',
                declining: 'Declining',
                rapid_decline: 'Rapid Decline'
            };
            
            const categories = [
                { icon: 'ðŸš€', label: 'Breakthrough', count: summary.breakthrough, filter: 'breakthrough', key: 'breakthrough' },
                { icon: 'ðŸ“ˆ', label: 'Building', count: summary.building, filter: 'building', key: 'building' },
                { icon: 'âž¡ï¸', label: 'Stable', count: summary.stableTrajectory, filter: 'stable', key: 'stable' },
                { icon: 'ðŸ“‰', label: 'Declining', count: summary.decliningTrajectory, filter: 'declining', key: 'declining' },
                { icon: 'âš ï¸', label: 'Rapid Decline', count: summary.rapidDecline, filter: 'rapid_decline', key: 'rapid_decline' }
            ];
            
            const momentumElement = elementId ? document.getElementById(elementId) : document.getElementById('momentumButtons');
            if (!momentumElement) {
                if (DEBUG) console.warn('Momentum tracker element not found:', elementId);
                return; // Exit silently if element doesn't exist
            }
            
            momentumElement.innerHTML = categories.map(cat => {
                const movementData = movements[cat.key];
                let movementHTML = '';
                
                if (movementData && (Object.keys(movementData.in).length > 0 || Object.keys(movementData.out).length > 0)) {
                    movementHTML = '<div style="margin-top: 0.75rem; font-size: 0.8rem; line-height: 1.4; text-align: left; padding: 0.5rem; background: rgba(0,0,0,0.03); border-radius: 6px;">';
                    movementHTML += '<div style="font-weight: 600; margin-bottom: 0.4rem; opacity: 0.7;">Movement:</div>';
                    
                    // Show IN movements (from other trajectories)
                    Object.entries(movementData.in).forEach(([fromTraj, count]) => {
                        const fromIndex = trajectoryOrder.indexOf(fromTraj);
                        const toIndex = trajectoryOrder.indexOf(cat.key);
                        const isImprovement = toIndex > fromIndex; // Moving right on the spectrum = improvement
                        const icon = isImprovement ? 'âœ…' : 'âš ï¸';
                        const color = isImprovement ? 'var(--teal)' : 'var(--brand-accent)';
                        movementHTML += `<div style="color: ${color};">+ ${count} from ${trajectoryLabels[fromTraj]} ${icon}</div>`;
                    });
                    
                    // Show OUT movements (to other trajectories)
                    Object.entries(movementData.out).forEach(([toTraj, count]) => {
                        const fromIndex = trajectoryOrder.indexOf(cat.key);
                        const toIndex = trajectoryOrder.indexOf(toTraj);
                        const isImprovement = toIndex > fromIndex; // Moving right on the spectrum = improvement
                        const icon = isImprovement ? 'âœ…' : 'âš ï¸';
                        const color = isImprovement ? 'var(--teal)' : 'var(--brand-accent)';
                        movementHTML += `<div style="color: ${color};">- ${count} to ${trajectoryLabels[toTraj]} ${icon}</div>`;
                    });
                    
                    movementHTML += '</div>';
                }
                
                return `
                    <div class="momentum-btn" onclick="filterByMomentum('${cat.filter}')">
                        <div class="momentum-btn-icon">${cat.icon}</div>
                        <div class="momentum-btn-label">${cat.label}</div>
                        <div class="momentum-btn-count">${cat.count}</div>
                        ${movementHTML}
                    </div>
                `;
            }).join('');
        }
        
        function filterByMomentum(trajectory) {
            const students = dashboardData.students.filter(s => s.trajectory === trajectory);
            const labels = {
                'breakthrough': 'Breakthrough Students',
                'building': 'Building Momentum Students',
                'stable': 'Stable Students',
                'declining': 'Declining Students',
                'rapid_decline': 'Rapid Decline Students'
            };
            showFilteredList(students.map(s => s.name), labels[trajectory]);
        }
        
        function createWaterfallChart() {
            const sortedDates = dashboardData.sortedDates;
            const students = dashboardData.students;
            
            // Calculate for each date
            const labels = sortedDates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            const onTrackData = [];
            const strugglingData = [];
            const netLine = [];
            
            sortedDates.forEach(date => {
                let onTrack = 0;
                let struggling = 0;
                
                students.forEach(student => {
                    const record = student.records.find(r => r.week === date);
                    if (record) {
                        const tracking = record.completed - record.expected;
                        if (tracking >= 0) {
                            onTrack++;
                        } else {
                            struggling++;
                        }
                    }
                });
                
                onTrackData.push(onTrack);
                strugglingData.push(struggling);
                netLine.push(onTrack - struggling); // Net difference
            });
            
            const ctx = document.getElementById('waterfallChart');
            
            if (waterfallChart) {
                waterfallChart.destroy();
            }
            
            waterfallChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'On Track or Ahead',
                            data: onTrackData,
                            backgroundColor: 'rgba(16, 185, 129, 0.7)',
                            borderColor: 'var(--teal)',
                            borderWidth: 2,
                            stack: 'stack0'
                        },
                        {
                            label: 'Below Target',
                            data: strugglingData.map(v => -v), // Negative for stacking
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            borderColor: 'var(--brand-accent)',
                            borderWidth: 2,
                            stack: 'stack0'
                        },
                        {
                            type: 'line',
                            label: 'Net Balance',
                            data: netLine,
                            borderColor: 'var(--text)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.4,
                            pointRadius: 5,
                            pointBackgroundColor: 'var(--text)',
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            stacked: false,
                            title: {
                                display: true,
                                text: 'Number of Students (Net Balance)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value;
                                }
                            }
                        },
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Week'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataset.type === 'line') {
                                        const val = context.parsed.y;
                                        label += (val > 0 ? '+' : '') + val + ' net';
                                    } else {
                                        label += Math.abs(context.parsed.y) + ' students';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function showAdvisorView(advisorName) {
    hideHeader();  // Hide header for overlay view

            currentAdvisor = advisorName;
            const students = dashboardData.advisorMap.get(advisorName);
            
            // Hide all views
            document.getElementById('mainView').classList.remove('active');
            document.getElementById('studentView').classList.remove('active');
            document.getElementById('studentDirectoryView').classList.remove('active');
            document.getElementById('filteredListView').classList.remove('active');
            // Show advisor view
            document.getElementById('advisorView').classList.add('active');
            
            // Scroll to top
            window.scrollTo(0, 0);
            
            const avgVel = students.length > 0 ? students.reduce((sum, s) => sum + s.velocity, 0) / students.length : 0;
            const improving = students.filter(s => s.acceleration > 0).length;
            
            // Build advisor header with Spotlight styling
            const crisisCount = students.filter(s => s.tier === 1).length;
            const superstarCount = students.filter(s => s.tier === 5).length;
            const avgAccel = students.length > 0 ? students.reduce((sum, s) => sum + s.acceleration, 0) / students.length : 0;
            
            document.getElementById('advisorViewHeader').innerHTML = `
                <div style="position: relative; background: linear-gradient(135deg, var(--brand-brass) 0%, #7b5c33 100%); padding: 2rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: var(--shadow-lg); color: white;">
                    <!-- Top Right: Total Students -->
                    <div style="position: absolute; top: 1rem; right: 1rem; background: linear-gradient(135deg, #4b5563 0%, #374151 100%); color: white; padding: 0.75rem 1.25rem; border-radius: 8px; font-weight: 700; font-size: 0.875rem; box-shadow: 0 2px 8px rgba(0,0,0,0.2); text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.25rem;">${students.length}</div>
                        <div style="font-size: 0.75rem; opacity: 0.9;">Students</div>
                    </div>
                    
                    <!-- Advisor Name -->
                    <div style="margin-bottom: 2.5rem; text-align: center;">
                        <div style="font-size: 2.5rem; font-weight: 700; color: white;">${advisorName}</div>
                    </div>
                    
                    <!-- Bottom: 4 metric chips -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem;">
                        <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.75rem; font-weight: 700; color: white;">${superstarCount}</div>
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.9); margin-top: 0.25rem;">Superstar Students</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.75rem; font-weight: 700; color: white;">${crisisCount}</div>
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.9); margin-top: 0.25rem;">Crisis Students</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.75rem; font-weight: 700; color: white;">${avgVel.toFixed(2)}</div>
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.9); margin-top: 0.25rem;">Avg Velocity (u/wk)</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.75rem; font-weight: 700; color: white;">${avgAccel > 0 ? '+' : ''}${avgAccel.toFixed(2)}</div>
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.9); margin-top: 0.25rem;">Avg Acceleration</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Render action buttons for regular advisor
            document.getElementById('advisorActionButtons').innerHTML = `
                <button class="btn-recommendations" onclick="generateAdvisorRecommendations()">
                    ðŸŽ¯ Advisor Priorities
                </button>
                <button class="btn-export-pdf" onclick="exportToPDF()">
                    ðŸ“„ Export to PDF
                </button>
                <button class="btn-achievements" onclick="showAchievementsLegend()">
                    ðŸ† Achievement Legend
                </button>
            `;
            
            // Reset table header to "Risk Tier" for regular advisors
            const tierHeader = document.querySelector('#advisorStudentTable th[data-sort="tier"]');
            if (tierHeader) {
                tierHeader.textContent = 'Risk Tier';
                if (!tierHeader.hasAttribute('data-sort')) {
                    tierHeader.setAttribute('data-sort', 'tier');
                    tierHeader.classList.add('sortable');
                }
            }
            
            renderAdvisorStudentTable();
        }
        
        // V8.0 FIX #5: Show Administrative Hold students with category filters
        function showAdministrativeHold() {
            if (!dashboardData.administrativeHoldCard) return;
            
            currentAdvisor = 'ADMINISTRATIVE_HOLD';
            const card = dashboardData.administrativeHoldCard;
            const students = card.students;
            
            // Hide all views
            document.getElementById('mainView').classList.remove('active');
            document.getElementById('studentView').classList.remove('active');
            document.getElementById('studentDirectoryView').classList.remove('active');
            document.getElementById('filteredListView').classList.remove('active');
            // Show advisor view
            document.getElementById('advisorView').classList.add('active');
            window.scrollTo(0, 0);
            
            // V8.2 FIX 7a: Build filter buttons with title case
            const categoryButtons = Object.keys(card.categoryBreakdown).map(cat => {
                const displayName = formatSpecialCategoryName(cat);
                const count = card.categoryBreakdown[cat];
                // V8.2 FIX 7b: Color-coded category buttons
                let color = 'var(--brand-brass)'; // Default orange
                if (cat.includes('MEDICAL')) color = 'var(--info)'; // Blue
                else if (cat.includes('SUSPENDED')) color = 'var(--brand-accent)'; // Red
                else if (cat.includes('COUNSELING')) color = 'var(--teal)'; // Green
                else if (cat.includes('TRANSITIONING')) color = 'var(--brand-brass)'; // Purple
                
                // V8.2.1: Full colored background buttons with !important to override CSS
                return `<button class="filter-btn" data-filter="${cat}" data-type="category" style="background: ${color} !important; color: white !important; border: 2px solid ${color} !important;">${displayName} (${count})</button>`;
            }).join('');
            
            // Build admin hold header with Spotlight styling
            const avgAccel = card.avgAcceleration;
            
            document.getElementById('advisorViewHeader').innerHTML = `
                <div style="position: relative; background: linear-gradient(135deg, var(--brand-brass) 0%, #7b5c33 100%); padding: 2rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: var(--shadow-lg); color: white;">
                    <!-- Top Right: Total Students -->
                    <div style="position: absolute; top: 1rem; right: 1rem; background: linear-gradient(135deg, #4b5563 0%, #374151 100%); color: white; padding: 0.75rem 1.25rem; border-radius: 8px; font-weight: 700; font-size: 0.875rem; box-shadow: 0 2px 8px rgba(0,0,0,0.2); text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.25rem;">${students.length}</div>
                        <div style="font-size: 0.75rem; opacity: 0.9;">Students</div>
                    </div>
                    
                    <!-- Admin Hold Name -->
                    <div style="margin-bottom: 2.5rem;">
                        <div style="font-size: 2rem; font-weight: 700; color: white;">âš ï¸ ${card.displayName}</div>
                    </div>
                    
                    <!-- Bottom: 4 metric chips -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem;">
                        <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.75rem; font-weight: 700; color: white;">${card.avgAttendance.toFixed(0)}%</div>
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.9); margin-top: 0.25rem;">Avg Attendance</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.75rem; font-weight: 700; color: white;">${Math.max(...students.map(s => s.daysSince))}</div>
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.9); margin-top: 0.25rem;">Last Activity (days)</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.75rem; font-weight: 700; color: white;">${card.avgVelocity.toFixed(2)}</div>
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.9); margin-top: 0.25rem;">Avg Velocity (u/wk)</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.75rem; font-weight: 700; color: white;">${avgAccel > 0 ? '+' : ''}${avgAccel.toFixed(2)}</div>
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.9); margin-top: 0.25rem;">Avg Acceleration</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Render action buttons for admin hold
            document.getElementById('advisorActionButtons').innerHTML = `
                <button class="btn-recommendations" onclick="generateAdministrativeHoldRecommendations()">
                    ðŸŽ¯ Admin Hold Priorities
                </button>
                <button class="btn-export-pdf" onclick="exportToPDF()">
                    ðŸ“„ Export to PDF
                </button>
                <button class="btn-achievements" onclick="showAchievementsLegend()">
                    ðŸ† Achievement Legend
                </button>
            `;
            
            // Change the "Risk Tier" header to "Category" for Admin Hold view
            const tierHeader = document.querySelector('#advisorStudentTable th[data-sort="tier"]');
            if (tierHeader) {
                tierHeader.textContent = 'Category';
                tierHeader.removeAttribute('data-sort'); // Remove sorting since it's not a tier anymore
                tierHeader.classList.remove('sortable');
            }
            
            // Replace tier filters with category filters
            const advisorTierFilters = document.getElementById('advisorTierFilters');
            if (advisorTierFilters) {
                advisorTierFilters.innerHTML = `
                    <button class="filter-btn active" data-filter="all" data-type="category">All Categories</button>
                    ${categoryButtons}
                `;
                
                // Add click handlers for category filters
                advisorTierFilters.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        advisorTierFilters.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        renderAdministrativeHoldTable(this.dataset.filter);
                    });
                });
            }
            
            renderAdministrativeHoldTable('all');
        }
        
        function renderAdministrativeHoldTable(categoryFilter = 'all') {
            const card = dashboardData.administrativeHoldCard;
            let students = card.students;
            
            // Filter by category
            if (categoryFilter !== 'all') {
                students = students.filter(s => s.specialCategoryType === categoryFilter);
            }
            
            // Apply search if exists
            const searchBox = document.getElementById('advisorSearchBox');
            if (searchBox && searchBox.value) {
                const search = searchBox.value.toLowerCase();
                students = students.filter(s => s.name.toLowerCase().includes(search));
            }
            
            // Sort by velocity (descending)
            students.sort((a, b) => b.velocity - a.velocity);
            
            const tbody = document.getElementById('advisorStudentTableBody');
            tbody.innerHTML = students.map(s => {
                // V8.2.1: Color-code category badges
                let badgeColor = 'var(--brand-brass)'; // Default orange
                // Assign badge CSS class based on category type
                let badgeClass = 'category-badge';
                const catType = (s.specialCategoryType || '').toUpperCase();
                
                if (catType.includes('SUSPENDED')) badgeClass += ' suspended';
                else if (catType.includes('MEDICAL')) badgeClass += ' medical';
                else if (catType.includes('COUNSELING')) badgeClass += ' counseling';
                else if (catType.includes('TRANSITIONING')) badgeClass += ' transitioning';
                else if (catType.includes('DISTRICT TRANSFER')) badgeClass += ' district-transfer';
                else if (catType.includes('ACADEMIC PROBATION')) badgeClass += ' academic-probation';
                else if (catType.includes('OFSDP')) badgeClass += ' ofsdp';
                else if (catType.includes('TEXAS WORKS')) badgeClass += ' texas-works';
                else if (catType.includes('ENM')) badgeClass += ' enm-hold';
                else if (catType.includes('WITHDRAWN')) badgeClass += ' withdrawn';
                else if (catType.includes('GRADUATION PENDING')) badgeClass += ' graduation-pending';
                else if (catType.includes('EXTENDED ABSENCE')) badgeClass += ' extended-absence';
                else badgeClass += ' other'  // Default
                
                return `
                <tr onclick="showStudentByName('${s.name.replace(/'/g, "\\'")}')">
                    <td>${formatStudentName(s.name)}</td>
                    <td><span class="${badgeClass}">${formatSpecialCategoryName(s.specialCategoryName)}</span></td>
                    <td>${s.velocity.toFixed(2)} u/wk</td>
                    <td class="trajectory-${s.trajectory}">${s.trajectoryIcon} ${s.trajectoryLabel}</td>
                    <td>
                        <!-- V8.2 FIX 7c: Proper pattern dot rendering -->
                        <div class="pattern-dots-container">
                            <div class="pattern-dots-row">
                            ${s.patternDisplay.slice(0, 18).map(p => {
                                const weekDate = new Date(p.week).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                let tooltip;
                                if (p.type === 'break') {
                                    tooltip = `${weekDate}: ${p.weekType}`;
                                } else if (p.type === 'missing') {
                                    tooltip = `${weekDate}: No data (${p.weekType})`;
                                } else {
                                    tooltip = `${weekDate}: ${p.units.toFixed(1)}u (${p.weekType}, goal ${p.goal.toFixed(1)})`;
                                }
                                return `<div class="pattern-dot ${p.type}"><div class="pattern-dot-tooltip">${tooltip}</div></div>`;
                            }).join('')}
                            </div>
                            ${s.patternDisplay.length > 18 ? `<div class="pattern-dots-row">
                            ${s.patternDisplay.slice(18, 36).map(p => {
                                const weekDate = new Date(p.week).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                let tooltip;
                                if (p.type === 'break') {
                                    tooltip = `${weekDate}: ${p.weekType}`;
                                } else if (p.type === 'missing') {
                                    tooltip = `${weekDate}: No data (${p.weekType})`;
                                } else {
                                    tooltip = `${weekDate}: ${p.units.toFixed(1)}u (${p.weekType}, goal ${p.goal.toFixed(1)})`;
                                }
                                return `<div class="pattern-dot ${p.type}"><div class="pattern-dot-tooltip">${tooltip}</div></div>`;
                            }).join('')}
                            </div>` : ''}
                            <span class="pattern-descriptor ${s.consistencyLabel.toLowerCase()}">${s.consistencyIcon} ${s.consistencyLabel}</span>
                        </div>
                    </td>
                    <td><div style="text-align: center; font-weight: 600; color: var(--brand-accent); font-size: 1.1rem;">${s.badges.length}</div></td>
                    <td style="font-weight: bold; color: ${s.tracking >= 0 ? 'var(--teal)' : 'var(--brand-accent)'}">${s.tracking > 0 ? '+' : ''}${s.tracking}</td>
                    <td>${s.daysSince} days</td>
                    <td class="${getHeatmapClass(s.avgAttendance, 'attendance')}">${s.avgAttendance.toFixed(1)}%</td>
                </tr>
                `;
            }).join('');
        }
        
        function renderStudentTable() {
            // Check if table exists (it's in Student Directory view, not main)
            const tableBody = document.getElementById('studentTableBody');
            if (!tableBody) {
                if (DEBUG) console.log('âš ï¸ studentTableBody not found - table is in Student Directory');
                return;
            }
            
            let filtered = dashboardData.students;
            
            // Apply filters
            if (currentFilters.tier !== 'all') {
                filtered = filtered.filter(s => s.tier === parseInt(currentFilters.tier));
            }
            if (currentFilters.trajectory !== 'all') {
                filtered = filtered.filter(s => s.trajectory === currentFilters.trajectory);
            }
            if (currentFilters.search) {
                const search = currentFilters.search.toLowerCase();
                filtered = filtered.filter(s => s.name.toLowerCase().includes(search));
            }
            
            // Apply sorting
            filtered.sort((a, b) => {
                let aVal, bVal;
                switch (currentSort.column) {
                    case 'name': aVal = a.name; bVal = b.name; break;
                    case 'tier': aVal = a.tier; bVal = b.tier; break;
                    case 'velocity': aVal = a.velocity; bVal = b.velocity; break;
                    case 'trajectory': 
                        // Sort by trajectory quality: breakthrough(5) > building(4) > stable(3) > declining(2) > rapid_decline(1)
                        const trajectoryOrder = { 'breakthrough': 5, 'building': 4, 'stable': 3, 'declining': 2, 'rapid_decline': 1 };
                        aVal = trajectoryOrder[a.trajectory] || 0;
                        bVal = trajectoryOrder[b.trajectory] || 0;
                        break;
                    case 'acceleration': aVal = a.acceleration; bVal = b.acceleration; break;
                    case 'badges': aVal = a.badges.length; bVal = b.badges.length; break;
                    case 'behind': aVal = a.tracking; bVal = b.tracking; break;
                    case 'units': aVal = a.currentUnits; bVal = b.currentUnits; break;
                    case 'days_since': aVal = a.daysSince; bVal = b.daysSince; break;
                    case 'attendance': aVal = a.avgAttendance; bVal = b.avgAttendance; break;
                    default: aVal = a.velocity; bVal = b.velocity;
                }
                
                if (currentSort.direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            tableBody.innerHTML = filtered.map(s => {
                const studentIndex = dashboardData.students.findIndex(student => student.name === s.name);
                return `
                <tr>
                    <td><span class="student-name-link" onclick="showStudentByIndex(${studentIndex})">${formatStudentName(s.name)}${s.isNew ? ' <span style="background: var(--info); color: white; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; margin-left: 0.5rem;">NEW</span>' : ''}</span></td>
                    <td><span class="tier-badge tier-${s.tier}">${s.tierLabel}</span></td>
                                        <td>${s.velocity.toFixed(2)} u/wk</td>
<td class="trajectory-${s.trajectory}">${s.trajectoryIcon} ${s.trajectoryLabel}</td>
                    <td>
                        <div class="pattern-dots-container">
                            <div class="pattern-dots-row">
                            ${s.patternDisplay.slice(0, 18).map(p => {
                                const weekDate = new Date(p.week).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                let tooltip;
                                if (p.type === 'break') {
                                    tooltip = `${weekDate}: ${p.weekType}`;
                                } else if (p.type === 'missing') {
                                    tooltip = `${weekDate}: No data (${p.weekType})`;
                                } else {
                                    tooltip = `${weekDate}: ${p.units.toFixed(1)}u (${p.weekType}, goal ${p.goal.toFixed(1)})`;
                                }
                                return `<div class="pattern-dot ${p.type}"><div class="pattern-dot-tooltip">${tooltip}</div></div>`;
                            }).join('')}
                            </div>
                            ${s.patternDisplay.length > 18 ? `<div class="pattern-dots-row">
                            ${s.patternDisplay.slice(18, 36).map(p => {
                                const weekDate = new Date(p.week).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                let tooltip;
                                if (p.type === 'break') {
                                    tooltip = `${weekDate}: ${p.weekType}`;
                                } else if (p.type === 'missing') {
                                    tooltip = `${weekDate}: No data (${p.weekType})`;
                                } else {
                                    tooltip = `${weekDate}: ${p.units.toFixed(1)}u (${p.weekType}, goal ${p.goal.toFixed(1)})`;
                                }
                                return `<div class="pattern-dot ${p.type}"><div class="pattern-dot-tooltip">${tooltip}</div></div>`;
                            }).join('')}
                            </div>` : ''}
                            <span class="pattern-descriptor ${s.consistencyLabel.toLowerCase()}">${s.consistencyIcon} ${s.consistencyLabel}</span>
                        </div>
                    </td>
                    <td><div style="text-align: center; font-weight: 600; color: var(--brand-accent); font-size: 1.1rem;">${s.badges.length}</div></td>
                    <td style="font-weight: bold; color: ${s.tracking >= 0 ? 'var(--teal)' : 'var(--brand-accent)'}">${s.tracking > 0 ? '+' : ''}${s.tracking}</td>
                    <td>${s.daysSince} days</td>
                    <td class="${getHeatmapClass(s.avgAttendance, 'attendance')}">${s.avgAttendance.toFixed(1)}%</td>
                </tr>
                `;
            }).join('');
        }
        
        function showStudentByIndex(index) {
            const student = dashboardData.students[index];
            if (student) showStudentView(student.name);
        }
        
        function showStudentByName(name) {
            // More reliable than index - finds student by exact name match
            const student = dashboardData.students.find(s => s.name === name);
            if (student) {
                showStudentView(student.name);
            } else {
                console.error('Student not found:', name);
            }
        }
        
        function renderAdvisorStudentTable() {
            const students = dashboardData.advisorMap.get(currentAdvisor);
            let filtered = students;
            
            // Apply tier filter
            if (currentFilters.tier !== 'all') {
                filtered = filtered.filter(s => s.tier === parseInt(currentFilters.tier));
            }
            
            // Apply trajectory filter
            if (currentFilters.trajectory !== 'all') {
                filtered = filtered.filter(s => s.trajectory === currentFilters.trajectory);
            }
            
            // Apply search filter
            if (currentFilters.search) {
                const searchTerm = currentFilters.search.toLowerCase();
                filtered = filtered.filter(s => {
                    // Search by name
                    if (s.name.toLowerCase().includes(searchTerm) || 
                        formatStudentName(s.name).toLowerCase().includes(searchTerm)) {
                        return true;
                    }
                    
                    // Search by Student_Number
                    if (s.Student_Number && s.Student_Number.toString().includes(searchTerm)) {
                        return true;
                    }
                    
                    // Search by certification names
                    if (CONFIG.studentCertifications && CONFIG.studentCertifications.length > 0) {
                        const studentCerts = CONFIG.studentCertifications.filter(c => 
                            c.Student_Number === s.Student_Number
                        );
                        if (studentCerts.some(c => c.Certification_Name && c.Certification_Name.toLowerCase().includes(searchTerm))) {
                            return true;
                        }
                    }
                    
                    return false;
                });
            }
            
            // Apply sorting
            if (currentSort.column) {
                filtered.sort((a, b) => {
                    let aVal, bVal;
                    
                    switch(currentSort.column) {
                        case 'name':
                            aVal = formatStudentName(a.name);
                            bVal = formatStudentName(b.name);
                            break;
                        case 'tier':
                            aVal = a.tier;
                            bVal = b.tier;
                            break;
                        case 'velocity':
                            aVal = a.velocity;
                            bVal = b.velocity;
                            break;
                        case 'trajectory':
                            const trajectoryOrder = {'Declining': 0, 'Flat': 1, 'Improving': 2};
                            aVal = trajectoryOrder[a.trajectoryLabel] || 0;
                            bVal = trajectoryOrder[b.trajectoryLabel] || 0;
                            break;
                        case 'badges':
                            aVal = a.badges.length;
                            bVal = b.badges.length;
                            break;
                        case 'behind':
                            aVal = a.tracking;
                            bVal = b.tracking;
                            break;
                        case 'days_since':
                            aVal = a.daysSince;
                            bVal = b.daysSince;
                            break;
                        case 'attendance':
                            aVal = a.avgAttendance;
                            bVal = b.avgAttendance;
                            break;
                        default:
                            return 0;
                    }
                    
                    if (currentSort.direction === 'asc') {
                        return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                    } else {
                        return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                    }
                });
            }
            
            document.getElementById('advisorStudentTableBody').innerHTML = filtered.map(s => {
                const studentIndex = dashboardData.students.findIndex(student => student.name === s.name);
                return `
                <tr>
                    <td><span class="student-name-link" onclick="showStudentByIndex(${studentIndex})">${formatStudentName(s.name)}${s.isNew ? ' <span style="background: var(--info); color: white; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; margin-left: 0.5rem;">NEW</span>' : ''}</span></td>
                    <td><span class="tier-badge tier-${s.tier}">${s.tierLabel}</span></td>
                                        <td>${s.velocity.toFixed(2)} u/wk</td>
<td class="trajectory-${s.trajectory}">${s.trajectoryIcon} ${s.trajectoryLabel}</td>
                    <td>
                        <div class="pattern-dots-container">
                            <div class="pattern-dots-row">
                            ${s.patternDisplay.slice(0, 18).map(p => {
                                const weekDate = new Date(p.week).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                let tooltip;
                                if (p.type === 'break') {
                                    tooltip = `${weekDate}: ${p.weekType}`;
                                } else if (p.type === 'missing') {
                                    tooltip = `${weekDate}: No data (${p.weekType})`;
                                } else {
                                    tooltip = `${weekDate}: ${p.units.toFixed(1)}u (${p.weekType}, goal ${p.goal.toFixed(1)})`;
                                }
                                return `<div class="pattern-dot ${p.type}"><div class="pattern-dot-tooltip">${tooltip}</div></div>`;
                            }).join('')}
                            </div>
                            ${s.patternDisplay.length > 18 ? `<div class="pattern-dots-row">
                            ${s.patternDisplay.slice(18, 36).map(p => {
                                const weekDate = new Date(p.week).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                let tooltip;
                                if (p.type === 'break') {
                                    tooltip = `${weekDate}: ${p.weekType}`;
                                } else if (p.type === 'missing') {
                                    tooltip = `${weekDate}: No data (${p.weekType})`;
                                } else {
                                    tooltip = `${weekDate}: ${p.units.toFixed(1)}u (${p.weekType}, goal ${p.goal.toFixed(1)})`;
                                }
                                return `<div class="pattern-dot ${p.type}"><div class="pattern-dot-tooltip">${tooltip}</div></div>`;
                            }).join('')}
                            </div>` : ''}
                            <span class="pattern-descriptor ${s.consistencyLabel.toLowerCase()}">${s.consistencyIcon} ${s.consistencyLabel}</span>
                        </div>
                    </td>
                    <td><div style="text-align: center; font-weight: 600; color: var(--brand-accent); font-size: 1.1rem;">${s.badges.length}</div></td>
                    <td style="font-weight: bold; color: ${s.tracking >= 0 ? 'var(--teal)' : 'var(--brand-accent)'}">${s.tracking > 0 ? '+' : ''}${s.tracking}</td>
                    <td>${s.daysSince} days</td>
                    <td class="${getHeatmapClass(s.avgAttendance, 'attendance')}">${s.avgAttendance.toFixed(1)}%</td>
                </tr>
                `;
            }).join('');
        }
        

        // GAUGE LIBRARY (moved before showStudentView)
// GAUGE DRAWING LIBRARY
// ============================================================================

/**
 * Draw a semi-circular gauge on a canvas
 * @param {HTMLCanvasElement} canvas - The canvas element
 * @param {number} value - Current value
 * @param {number} min - Minimum value
 * @param {number} max - Maximum value
 * @param {Array} zones - Color zones [{from, to, color}, ...]
 * @param {Object} options - Additional options
 */
function drawGauge(canvas, value, min, max, zones, options = {}, animate = false) {
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    
    // Set canvas size accounting for device pixel ratio
    const width = canvas.offsetWidth;
    const height = canvas.offsetHeight;
    canvas.width = width * dpr;
    canvas.height = height * dpr;
    ctx.scale(dpr, dpr);
    
    // Clear canvas
    ctx.clearRect(0, 0, width, height);
    
    // Gauge parameters
    const centerX = width / 2;
    const centerY = height - 10;
    const radius = Math.min(width, height * 1.5) / 2 - 15;
    const startAngle = Math.PI; // 180 degrees (left)
    const endAngle = 2 * Math.PI; // 0 degrees (right)
    const lineWidth = options.lineWidth || 12;
    
    // Draw background arc (light gray)
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, startAngle, endAngle);
    ctx.strokeStyle = 'rgba(0, 0, 0, 0.1)';
    ctx.lineWidth = lineWidth;
    ctx.lineCap = 'round';
    ctx.stroke();
    
    // Draw color zones (butt lineCap to prevent gaps)
    zones.forEach(zone => {
        const fromAngle = startAngle + (endAngle - startAngle) * ((zone.from - min) / (max - min));
        const toAngle = startAngle + (endAngle - startAngle) * ((zone.to - min) / (max - min));
        
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, fromAngle, toAngle);
        ctx.strokeStyle = zone.color;
        ctx.lineWidth = lineWidth;
        ctx.lineCap = 'butt'; // Changed from 'round' to prevent overlapping edges
        ctx.stroke();
    });
    
    // Draw needle
    const needleAngle = startAngle + (endAngle - startAngle) * ((value - min) / (max - min));
    const needleLength = radius - 5;
    
    ctx.save();
    ctx.translate(centerX, centerY);
    ctx.rotate(needleAngle);
    
    // Needle shadow
    ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
    ctx.shadowBlur = 4;
    ctx.shadowOffsetY = 2;
    
    // Needle body
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.lineTo(needleLength, 0);
    ctx.strokeStyle = options.needleColor || '#2a2a2a';
    ctx.lineWidth = 3;
    ctx.lineCap = 'round';
    ctx.stroke();
    
    ctx.restore();
    
    // Needle center dot
    ctx.beginPath();
    ctx.arc(centerX, centerY, 6, 0, 2 * Math.PI);
    ctx.fillStyle = options.needleColor || '#2a2a2a';
    ctx.shadowColor = 'transparent';
    ctx.fill();
    
    // Inner center dot
    ctx.beginPath();
    ctx.arc(centerX, centerY, 3, 0, 2 * Math.PI);
    ctx.fillStyle = 'white';
    ctx.fill();
}

/**
 * Animate needle sweep: 0 â†’ max â†’ min â†’ actual value
 */
function animateNeedleSweep(canvas, value, min, max, zones, options, duration = 1200) {
    const startTime = performance.now();
    
    function animate(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        let currentValue;
        if (progress < 0.33) {
            // Phase 1: 0 to max
            currentValue = min + (max - min) * (progress / 0.33);
        } else if (progress < 0.66) {
            // Phase 2: max to min
            const phase2Progress = (progress - 0.33) / 0.33;
            currentValue = max - (max - min) * phase2Progress;
        } else {
            // Phase 3: min to actual value
            const phase3Progress = (progress - 0.66) / 0.34;
            const eased = phase3Progress < 0.5 
                ? 2 * phase3Progress * phase3Progress 
                : 1 - Math.pow(-2 * phase3Progress + 2, 2) / 2; // easeInOutQuad
            currentValue = min + (value - min) * eased;
        }
        
        drawGauge(canvas, currentValue, min, max, zones, options, false);
        
        if (progress < 1) {
            requestAnimationFrame(animate);
        }
    }
    
    requestAnimationFrame(animate);
}

/**
 * 1. Completed Units Gauge
 */
function createUnitsGauge(canvas, value, onPaceTarget, maxUnits) {
    const max = Math.max(60, maxUnits);
    const yellowStart = Math.max(0, onPaceTarget - 4);
    
    const zones = [
        { from: 0, to: yellowStart, color: '#dc2626' },
        { from: yellowStart, to: onPaceTarget, color: '#f59e0b' },
        { from: onPaceTarget, to: max, color: '#10b981' }
    ];
    
    animateNeedleSweep(canvas, value, 0, max, zones, { needleColor: '#2a2a2a', lineWidth: 12 });
}

/**
 * 2. Ahead/Behind Gauge (center at 0)
 */
function createAheadBehindGauge(canvas, value, minValue, maxValue) {
    const absMax = Math.max(Math.abs(minValue), Math.abs(maxValue));
    const min = -absMax;
    const max = absMax;
    
    const zones = [
        { from: min, to: 0, color: '#dc2626' },
        { from: 0, to: max, color: '#10b981' }
    ];
    
    animateNeedleSweep(canvas, value, min, max, zones, { needleColor: '#2a2a2a', lineWidth: 12 });
}

/**
 * 3. Velocity Gauge (center at 2.0)
 */
function createVelocityGauge(canvas, value) {
    const max = Math.max(5.0, Math.ceil(value * 1.2));
    
    const zones = [
        { from: 0, to: 1.8, color: '#dc2626' },
        { from: 1.8, to: 2.2, color: '#f59e0b' },
        { from: 2.2, to: max, color: '#10b981' }
    ];
    
    animateNeedleSweep(canvas, value, 0, max, zones, { needleColor: '#2a2a2a', lineWidth: 12 });
}

/**
 * 4. Acceleration Gauge (center at 0)
 */
function createAccelerationGauge(canvas, value, minAccel, maxAccel) {
    const absMax = Math.max(Math.abs(minAccel), Math.abs(maxAccel), 2.0);
    const min = -absMax;
    const max = absMax;
    const yellowRange = absMax * 0.2;
    
    const zones = [
        { from: min, to: -yellowRange, color: '#dc2626' },
        { from: -yellowRange, to: yellowRange, color: '#f59e0b' },
        { from: yellowRange, to: max, color: '#10b981' }
    ];
    
    animateNeedleSweep(canvas, value, min, max, zones, { needleColor: '#2a2a2a', lineWidth: 12 });
}

/**
 * 5. Attendance Gauge (0-100%)
 */
function createAttendanceGauge(canvas, value) {
    const zones = [
        { from: 0, to: 80, color: '#dc2626' },
        { from: 80, to: 90, color: '#f59e0b' },
        { from: 90, to: 100, color: '#10b981' }
    ];
    
    animateNeedleSweep(canvas, value, 0, 100, zones, { needleColor: '#2a2a2a', lineWidth: 12 });
}

/**
 * 6. Consistency Gauge (0-100, center is steady)
 */
function createConsistencyGauge(canvas, score) {
    const zones = [
        { from: 0, to: 25, color: '#dc2626' },        // Very inconsistent
        { from: 25, to: 45, color: '#f59e0b' },       // Inconsistent
        { from: 45, to: 55, color: '#10b981' },       // Steady (ideal)
        { from: 55, to: 75, color: '#f59e0b' },       // Bursty
        { from: 75, to: 100, color: '#dc2626' }       // Very bursty
    ];
    
    animateNeedleSweep(canvas, score, 0, 100, zones, { needleColor: '#2a2a2a', lineWidth: 12 });
}

/**
 * 7. Days Since Activity (REVERSED: 0 days = MAX/best, more days = worse)
 */
function createDaysSinceGauge(canvas, value, maxDays) {
    const max = Math.max(14, maxDays);
    // REVERSED: max = 0 (green), min = maxDays (red)
    const displayValue = max - value; // Invert so 0 days shows at max position
    
    const zones = [
        { from: 0, to: max - 7, color: '#dc2626' },     // 8+ days (red, low position)
        { from: max - 7, to: max, color: '#f59e0b' },   // 1-7 days (yellow, mid)
        { from: max, to: max, color: '#10b981' }        // 0 days (green, max position)
    ];
    
    // Add thin green zone at very end
    zones.push({ from: max - 0.5, to: max, color: '#10b981' });
    
    animateNeedleSweep(canvas, displayValue, 0, max, zones, { needleColor: '#2a2a2a', lineWidth: 12 });
}

/**
 * 8. Badges Earned (green up to value, white after)
 */
function createBadgesGauge(canvas, value, maxBadges) {
    const max = Math.max(10, maxBadges);
    
    const zones = [
        { from: 0, to: value, color: '#10b981' },
        { from: value, to: max, color: '#e5e7eb' }
    ];
    
    animateNeedleSweep(canvas, value, 0, max, zones, { needleColor: '#2a2a2a', lineWidth: 12 });
}

/**
 * Initialize a gauge card
 */
function initGauge(container, type, value, label) {
    const card = document.createElement('div');
    card.className = 'gauge-card';
    
    const labelDiv = document.createElement('div');
    labelDiv.className = 'gauge-label';
    labelDiv.textContent = label;
    
    const canvasContainer = document.createElement('div');
    canvasContainer.className = 'gauge-canvas-container';
    
    const canvas = document.createElement('canvas');
    canvas.className = 'gauge-canvas';
    
    const valueDiv = document.createElement('div');
    valueDiv.className = 'gauge-value';
    
    canvasContainer.appendChild(canvas);
    canvasContainer.appendChild(valueDiv);
    
    card.appendChild(labelDiv);
    card.appendChild(canvasContainer);
    
    // Append card first so canvas has dimensions
    container.appendChild(card);
    
    // Now draw gauge (canvas is in DOM and has size)
    requestAnimationFrame(() => {
        const data = value; // value can be object with additional data
        
        switch(type) {
            case 'units':
                createUnitsGauge(canvas, data.value, data.onPace, data.max);
                valueDiv.textContent = data.value.toString();
                break;
            case 'aheadBehind':
                createAheadBehindGauge(canvas, data.value, data.min, data.max);
                valueDiv.textContent = (data.value > 0 ? '+' : '') + data.value;
                break;
            case 'velocity':
                createVelocityGauge(canvas, data);
                valueDiv.textContent = data.toFixed(2) + ' u/wk';
                break;
            case 'acceleration':
                createAccelerationGauge(canvas, data.value, data.min, data.max);
                valueDiv.textContent = (data.value > 0 ? '+' : '') + data.value.toFixed(2);
                break;
            case 'attendance':
                createAttendanceGauge(canvas, data);
                valueDiv.textContent = data.toFixed(1) + '%';
                break;
            case 'consistency':
                createConsistencyGauge(canvas, data);
                valueDiv.textContent = data.toFixed(0);
                break;
            case 'daysSince':
                createDaysSinceGauge(canvas, data.value, data.max);
                valueDiv.textContent = data.value.toString();
                break;
            case 'badges':
                createBadgesGauge(canvas, data.value, data.max);
                valueDiv.textContent = data.value.toString();
                break;
        }
    });
    
    // Add hover tooltip
    card.addEventListener('mouseenter', (e) => {
        let tooltipText = '';
        const data = value;
        
        switch(type) {
            case 'units':
                tooltipText = `${data.value} units completed`;
                if (data.value >= data.onPace) tooltipText += ' (On pace)';
                else if (data.value >= data.onPace - 4) tooltipText += ' (Close)';
                else tooltipText += ' (Behind)';
                break;
            case 'aheadBehind':
                tooltipText = `${data.value > 0 ? '+' : ''}${data.value} units ${data.value >= 0 ? 'ahead' : 'behind'}`;
                if (data.value >= 10) tooltipText += ' (Excellent)';
                else if (data.value >= 0) tooltipText += ' (On track)';
                else tooltipText += ' (Needs attention)';
                break;
            case 'velocity':
                tooltipText = `${data.toFixed(2)} units/week`;
                if (data >= 2.2) tooltipText += ' (Above target)';
                else if (data >= 1.8) tooltipText += ' (On target)';
                else tooltipText += ' (Below target)';
                break;
            case 'acceleration':
                tooltipText = `${data.value > 0 ? '+' : ''}${data.value.toFixed(2)} acceleration`;
                if (data.value > 0.5) tooltipText += ' (Improving)';
                else if (data.value > -0.5) tooltipText += ' (Stable)';
                else tooltipText += ' (Declining)';
                break;
            case 'attendance':
                tooltipText = `${data.toFixed(1)}% attendance`;
                if (data >= 90) tooltipText += ' (Excellent)';
                else if (data >= 80) tooltipText += ' (Good)';
                else tooltipText += ' (Needs attention)';
                break;
            case 'consistency':
                tooltipText = `Consistency score: ${data.toFixed(0)}`;
                if (data >= 45 && data <= 55) tooltipText += ' (Steady)';
                else if (data < 45) tooltipText += ' (Inconsistent)';
                else tooltipText += ' (Bursty)';
                break;
            case 'daysSince':
                tooltipText = `${data.value} days since last activity`;
                if (data.value === 0) tooltipText += ' (Active today!)';
                else if (data.value <= 7) tooltipText += ' (Recent)';
                else tooltipText += ' (Needs attention)';
                break;
            case 'badges':
                tooltipText = `${data.value} of ${data.max} possible badges`;
                if (data.value >= data.max * 0.75) tooltipText += ' (Excellent)';
                else if (data.value >= data.max * 0.5) tooltipText += ' (Good progress)';
                else tooltipText += ' (Keep going!)';
                break;
        }
        
        const tooltip = document.createElement('div');
        tooltip.className = 'gauge-tooltip show';
        tooltip.textContent = tooltipText;
        tooltip.style.position = 'fixed';
        tooltip.style.left = e.clientX + 10 + 'px';
        tooltip.style.top = e.clientY + 10 + 'px';
        document.body.appendChild(tooltip);
        
        card._tooltip = tooltip;
    });
    
    card.addEventListener('mouseleave', () => {
        if (card._tooltip) {
            card._tooltip.remove();
            card._tooltip = null;
        }
    });
}



        function showStudentView(studentName) {
    hideHeader();  // Hide header for overlay view

            // Ensure body scrolling is restored
            document.body.style.overflow = 'auto';
            
            const student = dashboardData.students.find(s => s.name === studentName);
            if (!student) return;
            
            currentStudent = student;
            
            // Save current student to sessionStorage for refresh recovery
            sessionStorage.setItem('currentStudentName', studentName);
            
            // Track where user came from for smart back button
            if (document.getElementById('studentDirectoryView').classList.contains('active')) {
                sessionStorage.setItem('studentViewSource', 'directory');
            } else if (document.getElementById('advisorView').classList.contains('active')) {
                sessionStorage.setItem('studentViewSource', 'advisor');
            } else if (document.getElementById('filteredListView').classList.contains('active')) {
                sessionStorage.setItem('studentViewSource', 'filtered');
            } else {
                sessionStorage.setItem('studentViewSource', 'main');
            }
            
            document.getElementById('mainView').classList.remove('active');
            document.getElementById('advisorView').classList.remove('active');
            document.getElementById('filteredListView').classList.remove('active');
            document.getElementById('studentDirectoryView').classList.remove('active');
            document.getElementById('studentView').classList.add('active');
            
            // Scroll to top
            window.scrollTo(0, 0);
            
            renderStudentView(student);
        }
        
        function renderStudentView(student) {
            // Header with tags section
            const isPINVerified = checkPINStatus();
            const visibleTags = isPINVerified ? getVisibleTags(student.name) : [];
            
            let tagsHTML = '';
            if (isPINVerified) {
                if (visibleTags && visibleTags.length > 0) {
                    tagsHTML = visibleTags.map(tag => formatTagBadge(tag.tag, tag.notes)).join(' ');
                } else {
                    tagsHTML = '<div style="background: var(--surface); color: var(--muted); padding: 0.375rem 0.75rem; border-radius: 6px; font-size: 0.875rem;">No tags</div>';
                }
                
                // V8.2: Add missing enrollment date warning badge
                const enrollmentBadge = getMissingEnrollmentDateBadge(student);
                if (enrollmentBadge) {
                    tagsHTML = enrollmentBadge + (tagsHTML ? ' ' + tagsHTML : '');
                }
            }
            
            document.getElementById('studentViewHeader').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 2rem;">
                    <div>
                        <div class="student-view-name">${formatStudentName(student.name)}</div>
                        <div class="student-view-meta">
                            ${student.tierLabel} â€¢ ${formatAdvisorName(student.advisor)}
                        </div>
                    </div>
                    ${isPINVerified ? `
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; justify-content: flex-end; max-width: 50%;">
                            ${tagsHTML}
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Deadline Countdown
            const deadlineInfo = getDeadlineInfo(student);
            let statusClass = 'on-track';
            let statusIcon = 'âœ…';
            let statusMessage = '';
            
            if (deadlineInfo.unitsCompleted >= deadlineInfo.unitsRequired) {
                statusMessage = `ðŸŽ‰ Congratulations! Already achieved ${deadlineInfo.unitsRequired} units!`;
            } else if (deadlineInfo.projectedUnits >= deadlineInfo.unitsRequired) {
                statusMessage = `ðŸ’ª Keep current pace to graduate on time!`;
            } else if (deadlineInfo.paceNeeded < 3.0) {
                statusClass = 'needs-attention';
                statusIcon = 'âš ï¸';
                statusMessage = `âš¡ Increase pace to ${deadlineInfo.paceNeeded.toFixed(2)} u/wk to stay on track`;
            } else {
                statusClass = 'urgent';
                statusIcon = 'ðŸ”´';
                statusMessage = `ðŸš¨ Urgent - Immediate intervention needed`;
            }
            
            document.getElementById('deadlineCountdownBox').innerHTML = `
                <div class="deadline-countdown-box ${statusClass}">
                    <div class="deadline-title">
                        ${statusIcon} Graduation Progress Tracker${deadlineInfo.enrollmentNote ? ` <span style="opacity: 0.8; font-size: 0.85em;">${deadlineInfo.enrollmentNote}</span>` : ''}
                    </div>
                    <div class="deadline-stats">
                        <div class="deadline-stat">
                            <div class="deadline-stat-value">${deadlineInfo.unitsCompleted}</div>
                            <div class="deadline-stat-label">Units Completed</div>
                        </div>
                        <div class="deadline-stat">
                            <div class="deadline-stat-value">${deadlineInfo.unitsNeeded}</div>
                            <div class="deadline-stat-label">Units Needed (of ${deadlineInfo.unitsRequired})</div>
                        </div>
                        <div class="deadline-stat">
                            <div class="deadline-stat-value">${deadlineInfo.weeksRemaining}</div>
                            <div class="deadline-stat-label">Weeks Until ${deadlineInfo.deadline}</div>
                        </div>
                        <div class="deadline-stat">
                            <div class="deadline-stat-value">${deadlineInfo.projectedUnits}</div>
                            <div class="deadline-stat-label">Projected Total</div>
                        </div>
                    </div>
                    <div class="deadline-message">
                        <strong>Current Pace:</strong> ${deadlineInfo.currentPace.toFixed(2)} u/wk<br>
                        <strong>Needed Pace:</strong> ${deadlineInfo.paceNeeded.toFixed(2)} u/wk<br><br>
                        ${statusMessage}
                    </div>
                </div>
            `;
            
            // Metrics Grid
            const metrics = [
                { label: 'Completed Units', value: student.currentUnits, heatmap: false },
                { label: 'Ahead/Behind', value: (student.tracking > 0 ? '+' : '') + student.tracking, heatmap: false },
                { label: 'Velocity', value: student.velocity.toFixed(2) + ' u/wk', heatmap: true, type: 'velocity' },
                { label: 'Acceleration', value: (student.acceleration > 0 ? '+' : '') + student.acceleration.toFixed(2), heatmap: true, type: 'acceleration' },
                { label: 'Attendance', value: student.avgAttendance.toFixed(1) + '%', heatmap: true, type: 'attendance' },
                { label: 'Consistency', value: student.consistencyLabel, heatmap: false },
                { label: 'Days Since Activity', value: student.daysSince, heatmap: false },
                { label: 'Badges Earned', value: student.badges.length, heatmap: false }
            ];
            
            // Render all 8 metrics as gauges
            const metricsContainer = document.getElementById('studentMetricsGrid');
            metricsContainer.innerHTML = ''; // Clear existing
            
            // Calculate global min/max for dynamic gauges
            const allTracking = dashboardData.students.map(s => s.tracking);
            const minTracking = Math.min(...allTracking);
            const maxTracking = Math.max(...allTracking);
            
            const allAccel = dashboardData.students.map(s => s.acceleration);
            const minAccel = Math.min(...allAccel);
            const maxAccel = Math.max(...allAccel);
            
            const allUnits = dashboardData.students.map(s => s.currentUnits);
            const maxUnits = Math.max(...allUnits);
            
            const allDaysSince = dashboardData.students.map(s => s.daysSince).filter(d => typeof d === 'number');
            const maxDaysSince = Math.max(...allDaysSince, 14);
            
            const allBadges = dashboardData.students.map(s => s.badges.length);
            const maxBadges = Math.max(...allBadges, 10);
            
            // Calculate consistency score
            const consistencyScore = student.consistencyRatio < 0.5 
                ? student.consistencyRatio * 45 
                : student.consistencyRatio >= 0.75 
                    ? 50 
                    : 50 + (student.consistencyRatio - 0.75) * 100;
            
            // Render each gauge
            initGauge(metricsContainer, 'units', { 
                value: student.currentUnits, 
                onPace: student.onPaceUnits || 30, 
                max: maxUnits 
            }, 'Completed Units');
            
            initGauge(metricsContainer, 'aheadBehind', { 
                value: student.tracking, 
                min: minTracking, 
                max: maxTracking 
            }, 'Ahead/Behind');
            
            initGauge(metricsContainer, 'velocity', student.velocity, 'Velocity');
            
            initGauge(metricsContainer, 'acceleration', { 
                value: student.acceleration, 
                min: minAccel, 
                max: maxAccel 
            }, 'Acceleration');
            
            initGauge(metricsContainer, 'attendance', student.avgAttendance, 'Attendance');
            
            initGauge(metricsContainer, 'consistency', consistencyScore, 'Consistency');
            
            initGauge(metricsContainer, 'daysSince', { 
                value: student.daysSince, 
                max: maxDaysSince 
            }, 'Days Since Activity');
            
            initGauge(metricsContainer, 'badges', { 
                value: student.badges.length, 
                max: maxBadges 
            }, 'Badges Earned');
            
            // Tags now displayed in header above
            
            // Progress Chart
            createStudentProgressChart(student);
            
            // Consistency Pattern - Smart Calendar-Aware Dots
            const renderPatternDots = (patternArray) => {
                // Split into two rows of 18 each
                const row1 = patternArray.slice(0, 18);
                const row2 = patternArray.slice(18, 36);
                
                const renderDot = (p) => {
                    const weekDate = new Date(p.week).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    let tooltip = '';
                    
                    if (p.type === 'break') {
                        tooltip = `${weekDate}: Break week`;
                    } else if (p.type === 'missing') {
                        tooltip = `${weekDate}: No data (${p.weekType})`;
                    } else {
                        const status = p.type === 'strong' ? 'âœ“ Met minimum' : 
                                     p.type === 'adjusted' ? 'âœ“ Met adjusted' : 
                                     'âœ— Below goal';
                        tooltip = `${weekDate}<br>${p.units.toFixed(1)} units (${p.weekType})<br>Goal: ${p.goal.toFixed(1)} ${status}`;
                    }
                    
                    return `<div class="pattern-dot ${p.type}">
                        <div class="pattern-dot-tooltip">${tooltip}</div>
                    </div>`;
                };
                
                let html = '<div class="pattern-dots-container">';
                html += '<div class="pattern-dots-row">' + row1.map(renderDot).join('') + '</div>';
                if (row2.length > 0) {
                    html += '<div class="pattern-dots-row">' + row2.map(renderDot).join('') + '</div>';
                }
                html += '</div>';
                
                return html;
            };
            
            const strongWeeks = student.patternDisplay.filter(p => p.type === 'strong').length;
            const adjustedWeeks = student.patternDisplay.filter(p => p.type === 'adjusted').length;
            const totalWorkWeeks = student.patternDisplay.filter(p => p.type !== 'break').length;
            
            document.getElementById('studentPatternDetail').innerHTML = `
                ${renderPatternDots(student.patternDisplay)}
                <span class="pattern-descriptor ${student.consistencyLabel.toLowerCase()}">${student.consistencyIcon} ${student.consistencyLabel}</span>
                
                <div class="pattern-legend">
                    <div class="pattern-legend-item">
                        <div class="pattern-legend-dot strong"></div>
                        <span>Met Minimum (â‰¥2.0 u/wk)</span>
                    </div>
                    <div class="pattern-legend-item">
                        <div class="pattern-legend-dot adjusted"></div>
                        <span>Met Adjusted Goal (short week)</span>
                    </div>
                    <div class="pattern-legend-item">
                        <div class="pattern-legend-dot below"></div>
                        <span>Below Goal</span>
                    </div>
                    <div class="pattern-legend-item">
                        <div class="pattern-legend-dot break"></div>
                        <span>Break Week (no school)</span>
                    </div>
                    <div class="pattern-legend-item">
                        <div class="pattern-legend-dot missing"></div>
                        <span>No Data (no update that week)</span>
                    </div>
                </div>
                
                <div style="margin-top: 1rem;">
                    <p><strong>Strong Weeks (â‰¥2.0 units):</strong> ${strongWeeks} of ${totalWorkWeeks}</p>
                    <p><strong>Short Week Performance:</strong> ${adjustedWeeks} weeks met adjusted goal</p>
                    <p><strong>Consistency Rate:</strong> ${(((strongWeeks + adjustedWeeks) / totalWorkWeeks) * 100).toFixed(0)}%</p>
                </div>
            `;
            
            // Achievements with badges and dates
            if (student.badges.length > 0) {
                // For each achievement, find when it was first earned
                const badgesWithDates = student.badges.map(badge => {
                    let earnedDate = null;
                    
                    // Check each historical record to find first time achievement was met
                    for (let i = 0; i < student.records.length; i++) {
                        const record = student.records[i];
                        const tempStudent = {
                            ...student,
                            currentUnits: record.completed,
                            avgAttendance: student.records.slice(0, i+1).reduce((sum, r) => sum + r.attendance, 0) / (i+1),
                            records: student.records.slice(0, i+1)
                        };
                        
                        // Check if achievement condition was met at this point
                        if (badge.check(tempStudent)) {
                            earnedDate = record.date;
                            break;
                        }
                    }
                    
                    return {
                        ...badge,
                        earnedDate: earnedDate || student.records[student.records.length - 1].date
                    };
                });
                
                document.getElementById('studentAchievements').innerHTML = badgesWithDates.map(b => `
                    <li>
                        <div class="badge-item">
                            <span class="badge-icon">${b.icon}</span>
                            <span class="badge-text">
                                ${b.name}
                                <span style="display: block; font-size: 0.75rem; color: var(--muted); margin-top: 0.25rem;">
                                    ${b.earnedDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                </span>
                            </span>
                        </div>
                    </li>
                `).join('');
            } else {
                document.getElementById('studentAchievements').innerHTML = '<li>Working towards achievements - keep it up!</li>';
            }
            
            // Concerns
            const concerns = [];
            if (student.tier === 1) concerns.push('Crisis tier - immediate intervention needed');
            if (student.tier === 2) concerns.push('High risk - requires close monitoring');
            if (student.avgAttendance < 70) concerns.push('Low attendance - major concern');
            if (student.velocity < 1) concerns.push('Low velocity - may need additional support');
            if (student.acceleration < -1) concerns.push('Rapid decline in performance');
            if (student.daysSince > 14) concerns.push('No recent activity - follow up needed');
            if (student.consistencyRatio < 0.5) concerns.push('Inconsistent performance - needs support establishing routine');
            
            document.getElementById('studentConcerns').innerHTML = concerns.length > 0 ?
                concerns.map(c => `<li>${c}</li>`).join('') :
                '<li>No major concerns at this time - keep up the good work!</li>';
            
            // Render advisor notes
            renderStudentNotes(student);
        }
        
        function createStudentProgressChart(student) {
            let records = student.records;
            
            // Filter by semester if needed
            if (currentSemester === 'fall') {
                records = records.filter(r => {
                    const month = r.date.getMonth();
                    return month >= 7 && month <= 11;
                });
            } else if (currentSemester === 'spring') {
                records = records.filter(r => {
                    const month = r.date.getMonth();
                    return month >= 0 && month <= 4;
                });
            }
            
            const ctx = document.getElementById('studentProgressChart');
            
            if (studentProgressChart) {
                studentProgressChart.destroy();
            }
            
            const dates = records.map(r => new Date(r.week).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            const completed = records.map(r => r.completed);
            
            // Calculate calendar-aware expected units
            // Must iterate through CALENDAR WEEKS, not upload records
            const expected = [];
            let cumulativeExpected = 0;
            
            if (!schoolCalendar) {
                // Fallback: use flat 2.0/week if no calendar
                records.forEach((record, index) => {
                    expected.push(index * 2.0);
                });
            } else {
                const enrollmentDate = new Date(records[0].week);
                const presentDate = new Date(records[records.length - 1].week);
                
                // Build expected for each upload record by counting calendar weeks up to that point
                records.forEach((record, recordIndex) => {
                    const recordDate = new Date(record.week);
                    let expectedUpToThisPoint = 0;
                    
                    // Iterate through calendar weeks from enrollment to this record
                    schoolCalendar.weeks.forEach(calWeek => {
                        const weekStart = new Date(calWeek.start);
                        const weekEnd = new Date(calWeek.end);
                        
                        // Skip weeks before enrollment or after this record
                        if (weekStart < enrollmentDate || weekStart > recordDate) {
                            return;
                        }
                        
                        // Check if this is a break week
                        let isBreak = false;
                        for (const breakPeriod of schoolCalendar.breaks) {
                            if (calWeek.start >= breakPeriod.start && calWeek.start <= breakPeriod.end) {
                                isBreak = true;
                                break;
                            }
                        }
                        
                        // Add goal for this week (0 if break, otherwise schoolDays * 0.4)
                        if (!isBreak) {
                            expectedUpToThisPoint += (calWeek.schoolDays * 0.4);
                        }
                    });
                    
                    expected.push(expectedUpToThisPoint);
                });
            }
            
            studentProgressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Units Completed',
                            data: completed,
                            borderColor: 'var(--brand-accent)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        },
                        {
                            label: 'Expected Units (Calendar-Aware)',
                            data: expected,
                            borderColor: 'var(--brand-brass)',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderDash: [5, 5],
                            tension: 0.4,
                            pointRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Units'
                            }
                        }
                    }
                }
            });
        }
        
        function showFilteredList(studentNames, title, showTierChanges = false) {
    hideHeader();  // Hide header for overlay view

            // CRITICAL: Save scroll position before changing views
            sessionStorage.setItem('dashboardScrollPosition', window.scrollY.toString());
            sessionStorage.setItem('dashboardScrollTimestamp', Date.now().toString());
            
            // Hide all views
            document.getElementById('mainView').classList.remove('active');
            document.getElementById('advisorView').classList.remove('active');
            document.getElementById('studentView').classList.remove('active');
            document.getElementById('studentDirectoryView').classList.remove('active');
            // Show filtered list view
            document.getElementById('filteredListView').classList.add('active');
            
            // Scroll to top
            window.scrollTo(0, 0);
            
            document.getElementById('filteredListHeader').innerHTML = `
                <div class="student-view-name">${title}</div>
                <div class="student-view-meta">${studentNames.length} Students</div>
            `;
            
            const students = dashboardData.students.filter(s => studentNames.includes(s.name));
            
            const tierNames = ['', 'Crisis', 'High Risk', 'Watch', 'On Track', 'Superstar'];
            
            document.getElementById('filteredTableBody').innerHTML = students.map(s => {
                const studentIndex = dashboardData.students.findIndex(student => student.name === s.name);
                const tierChangeText = showTierChanges && s.tierChange > 0 ? 
                    `<br><small style="color: var(--success);">${tierNames[s.firstTier]} â†’ ${tierNames[s.tier]}</small>` : '';
                    
                return `
                <tr onclick="showStudentByIndex(${studentIndex})">
                    <td><span class="student-name-link">${formatStudentName(s.name)}${tierChangeText}</span></td>
                    <td><span class="tier-badge tier-${s.tier}">${s.tierLabel}</span></td>
                    <td class="trajectory-${s.trajectory}">${s.trajectoryIcon} ${s.trajectoryLabel}</td>
                    <td style="font-weight: 600;">${s.currentUnits}</td>
                    <td class="${getHeatmapClass(s.velocity, 'velocity')}">${s.velocity.toFixed(2)} u/wk</td>
                    <td class="${getHeatmapClass(s.acceleration, 'acceleration')}">${s.acceleration > 0 ? '+' : ''}${s.acceleration.toFixed(2)}</td>
                    <td style="font-weight: bold; color: ${s.tracking >= 0 ? 'var(--teal)' : 'var(--brand-accent)'}">${s.tracking > 0 ? '+' : ''}${s.tracking}</td>
                    <td class="${getHeatmapClass(s.avgAttendance, 'attendance')}">${s.avgAttendance.toFixed(1)}%</td>
                    <td style="text-align: center;">${s.badges.length > 0 ? `<span style="background: var(--brand-brass); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600;">${s.badges.length}</span>` : '-'}</td>
                </tr>
                `;
            }).join('');
        }
        
        function showVelocityTrend() {
            // Create modal for velocity trend
            const modal = document.createElement('div');
            modal.id = 'velocityModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); }; // Click outside to close
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 900px; width: 90%; max-height: 80vh; overflow: auto;" onclick="event.stopPropagation()">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="margin: 0;">Average Velocity Trend</h2>
                        <button onclick="document.getElementById('velocityModal').remove()" style="background: var(--brand-accent); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 1rem;">Close</button>
                    </div>
                    <canvas id="velocityTrendChart"></canvas>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Calculate average velocity for each date
            const sortedDates = dashboardData.sortedDates;
            const students = dashboardData.students;
            const labels = [];
            const avgVelocities = [];
            
            sortedDates.forEach((date, dateIndex) => {
                labels.push(new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                
                let totalVelocity = 0;
                let count = 0;
                
                students.forEach(student => {
                    // Calculate velocity up to this point
                    const recordsUpToDate = student.records.filter(r => new Date(r.week) <= new Date(date));
                    if (recordsUpToDate.length >= 2) {
                        const earliest = recordsUpToDate[0];
                        const latest = recordsUpToDate[recordsUpToDate.length - 1];
                        const weeks = recordsUpToDate.length - 1;
                        const velocity = (latest.completed - earliest.completed) / weeks;
                        totalVelocity += velocity;
                        count++;
                    }
                });
                
                avgVelocities.push(count > 0 ? totalVelocity / count : 0);
            });
            
            const ctx = document.getElementById('velocityTrendChart');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Average Velocity (u/wk)',
                        data: avgVelocities,
                        borderColor: 'var(--brand-accent)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: 'var(--brand-accent)'
                    }, {
                        label: 'Target (2.0 u/wk)',
                        data: Array(labels.length).fill(2.0),
                        borderColor: 'var(--teal)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' u/wk';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Velocity (units/week)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Week'
                            }
                        }
                    }
                }
            });
        }
        
        function backToMain() {
    showHeader();  // Show header when returning to main

            // Ensure body scrolling is restored
            document.body.style.overflow = 'auto';
            
            // Check if returning from student view - use smart navigation
            const source = sessionStorage.getItem('studentViewSource');
            if (source && document.getElementById('studentView').classList.contains('active')) {
                // Hide all views first
                document.getElementById('mainView').classList.remove('active');
                document.getElementById('advisorView').classList.remove('active');
                document.getElementById('studentView').classList.remove('active');
                document.getElementById('filteredListView').classList.remove('active');
                document.getElementById('studentDirectoryView').classList.remove('active');
                document.getElementById('perfectWeekPrintable').classList.remove('active');
                
                // Return to source view
                if (source === 'directory') {
                    document.getElementById('studentDirectoryView').classList.add('active');
                } else if (source === 'advisor') {
                    document.getElementById('advisorView').classList.add('active');
                } else if (source === 'filtered') {
                    document.getElementById('filteredListView').classList.add('active');
                } else {
                    document.getElementById('mainView').classList.add('active');
                }
                
                // Clear source tracking
                sessionStorage.removeItem('studentViewSource');
                currentStudent = null;
                sessionStorage.removeItem('currentStudentName');
                
            } else {
                // Standard back to main behavior
                document.getElementById('advisorView').classList.remove('active');
                document.getElementById('studentView').classList.remove('active');
                document.getElementById('filteredListView').classList.remove('active');
                document.getElementById('studentDirectoryView').classList.remove('active');
                document.getElementById('perfectWeekPrintable').classList.remove('active');
                document.getElementById('mainView').classList.add('active');
                currentAdvisor = null;
                currentStudent = null;
                currentFilters = { tier: 'all', trajectory: 'all', search: '' };
                
                // Clear directory filters
                const dirSearchBox = document.getElementById('directorySearchBox');
                if (dirSearchBox) dirSearchBox.value = '';
                if (window.directoryActiveFilters) {
                    window.directoryActiveFilters = { search: '', tier: 'all', trajectory: 'all' };
                }
                
                sessionStorage.removeItem('currentStudentName');
            }
            
            // Restore scroll position if saved (e.g., from Advisor Spotlight)
            const savedScrollPos = sessionStorage.getItem('dashboardScrollPosition');
            const scrollTimestamp = sessionStorage.getItem('dashboardScrollTimestamp');
            
            if (savedScrollPos && scrollTimestamp) {
                // Only restore if saved within last 5 minutes (prevents stale scrolls)
                const ageMs = Date.now() - parseInt(scrollTimestamp);
                if (ageMs < 300000) { // 5 minutes
                    setTimeout(() => {
                        window.scrollTo({
                            top: parseInt(savedScrollPos),
                            behavior: 'smooth'
                        });
                        sessionStorage.removeItem('dashboardScrollPosition');
                        sessionStorage.removeItem('dashboardScrollTimestamp');
                    }, 150);
                }
            }
            
            // Reset filters UI
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === 'all') {
                    btn.classList.add('active');
                }
            });
            
            // Clear search if element exists
            const mainSearchBox = document.getElementById('searchBox');
            if (mainSearchBox) mainSearchBox.value = '';
            
            renderStudentTable();
        }
        
        function setupEventListeners() {
            // Search box - main view - auto reset filters
            const searchBox = document.getElementById('searchBox');
            if (searchBox) {
                searchBox.addEventListener('input', (e) => {
                // Reset filters when searching
                currentFilters.tier = 'all';
                currentFilters.trajectory = 'all';
                currentFilters.search = e.target.value;
                
                // Update filter button states
                document.querySelectorAll('#mainView .filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.filter === 'all') {
                        btn.classList.add('active');
                    }
                });
                
                renderStudentTable();
                });
            }
            
            // Search box - advisor view
            document.getElementById('advisorSearchBox').addEventListener('input', (e) => {
                currentFilters.search = e.target.value;
                renderAdvisorStudentTable();
            });
            
            // Filter buttons - main view
            document.querySelectorAll('#mainView .filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const type = btn.dataset.type;
                    const filter = btn.dataset.filter;
                    
                    currentFilters[type] = filter;
                    
                    document.querySelectorAll(`#mainView [data-type="${type}"]`).forEach(b => {
                        b.classList.remove('active');
                    });
                    btn.classList.add('active');
                    
                    renderStudentTable();
                });
            });
            
            // Filter buttons - advisor view
            document.querySelectorAll('#advisorView .filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const type = btn.dataset.type;
                    const filter = btn.dataset.filter;
                    
                    currentFilters[type] = filter;
                    
                    document.querySelectorAll(`#advisorView [data-type="${type}"]`).forEach(b => {
                        b.classList.remove('active');
                    });
                    btn.classList.add('active');
                    
                    renderAdvisorStudentTable();
                });
            });
            
            // Sortable columns
            document.querySelectorAll('th.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.dataset.sort;
                    
                    if (currentSort.column === column) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.column = column;
                        currentSort.direction = 'desc';
                    }
                    
                    if (currentAdvisor) {
                        renderAdvisorStudentTable();
                    } else {
                        renderStudentTable();
                    }
                });
            });
            
            // Semester filters on student view
            document.querySelectorAll('.semester-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.semester-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentSemester = btn.dataset.semester;
                    if (currentStudent) {
                        createStudentProgressChart(currentStudent);
                    }
                });
            });
        }
        
        // ================== WEEK SWITCHING ==================
        
        // Store raw data globally for week switching
        let rawData = {};
        
        // ================== SMART RECOMMENDATIONS ==================
        async function generateAIRecommendations() {
            const modal = document.createElement('div');
            modal.id = 'recommendationsModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); }; // Click outside to close
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 900px; width: 90%; max-height: 80vh; overflow: auto;" onclick="event.stopPropagation()">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="margin: 0;">ðŸŽ¯ Smart Intervention Recommendations</h2>
                        <button onclick="document.getElementById('recommendationsModal').remove()" style="background: var(--brand-accent); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 1rem;">Close</button>
                    </div>
                    <div id="aiRecommendationsContent">
                        ${generateSmartRecommendations()}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function generateSmartRecommendations() {
            const students = dashboardData.students;
            const summary = dashboardData.summary;
            
            // Priority students
            const crisisStudents = students.filter(s => s.tier === 1);
            const highRiskStudents = students.filter(s => s.tier === 2);
            const rapidDeclineStudents = students.filter(s => s.trajectory === 'rapid_decline');
            const lowAttendanceStudents = students.filter(s => s.avgAttendance < 80);
            
            let html = '<div style="line-height: 1.8;">';
            
            // School-wide recommendations
            html += '<h3 style="color: var(--brand-accent); border-bottom: 2px solid var(--brand-accent); padding-bottom: 0.5rem;">ðŸ“Š School-Wide Priorities</h3>';
            
            const schoolWideRecs = [];
            
            if (summary.avgVelocity < 1.8) {
                schoolWideRecs.push(`<strong>Velocity Boost Needed:</strong> Class average is ${summary.avgVelocity.toFixed(2)} u/wk (target: 2.0). Consider school-wide pacing strategies.`);
            } else if (summary.avgVelocity >= 2.2) {
                schoolWideRecs.push(`<strong>Strong Momentum:</strong> Class average velocity of ${summary.avgVelocity.toFixed(2)} u/wk exceeds targets. Maintain current strategies.`);
            }
            
            if (summary.avgAttendance < 85) {
                schoolWideRecs.push(`<strong>Attendance Intervention:</strong> Average attendance at ${summary.avgAttendance.toFixed(1)}% (target: 85%+). Implement attendance improvement campaign.`);
            }
            
            const crisisPercent = ((summary.crisis + summary.highRisk) / summary.totalStudents * 100);
            if (crisisPercent > 15) {
                schoolWideRecs.push(`<strong>High Risk Alert:</strong> ${crisisPercent.toFixed(0)}% of students in crisis/high risk. Consider additional support resources.`);
            }
            
            if (summary.rapidDecline > 3) {
                schoolWideRecs.push(`<strong>Declining Trend:</strong> ${summary.rapidDecline} students showing rapid decline. Early intervention critical.`);
            }
            
            html += '<ul style="margin: 1rem 0;">';
            schoolWideRecs.slice(0, 3).forEach(rec => {
                html += `<li style="margin-bottom: 0.75rem;">${rec}</li>`;
            });
            html += '</ul>';
            
            // Individual student interventions
            html += '<h3 style="color: var(--brand-accent); border-bottom: 2px solid var(--brand-accent); padding-bottom: 0.5rem; margin-top: 2rem;">ðŸ‘¥ Priority Student Interventions</h3>';
            
            const priorityStudents = [
                ...crisisStudents.slice(0, 3),
                ...rapidDeclineStudents.filter(s => !crisisStudents.includes(s)).slice(0, 2),
                ...highRiskStudents.filter(s => !crisisStudents.includes(s) && !rapidDeclineStudents.includes(s)).slice(0, 3)
            ].slice(0, 8);
            
            html += '<ul style="margin: 1rem 0;">';
            priorityStudents.forEach(s => {
                let reason = '';
                let action = '';
                
                if (s.tier === 1) {
                    reason = `Crisis tier (${s.tracking} units behind)`;
                    action = 'Immediate one-on-one support, attendance check, family contact';
                } else if (s.trajectory === 'rapid_decline') {
                    reason = `Rapid decline (${s.trajectoryLabel}, acceleration ${s.acceleration.toFixed(1)})`;
                    action = 'Identify cause of decline, adjust pacing plan, increase check-ins';
                } else if (s.avgAttendance < 75) {
                    reason = `Low attendance (${s.avgAttendance.toFixed(1)}%)`;
                    action = 'Attendance intervention, transportation/barriers check';
                } else {
                    reason = `High risk (${s.tracking} behind, ${s.velocity.toFixed(1)} u/wk)`;
                    action = 'Create catch-up plan, monitor weekly progress';
                }
                
                html += `<li style="margin-bottom: 1rem;">
                    <strong>${formatStudentName(s.name)}</strong> - ${reason}<br>
                    <span style="color: var(--success); font-size: 0.9rem;">â†’ ${action}</span>
                </li>`;
            });
            html += '</ul>';
            
            // Quick wins
            html += '<h3 style="color: var(--brand-accent); border-bottom: 2px solid var(--brand-accent); padding-bottom: 0.5rem; margin-top: 2rem;">âš¡ Quick Wins (Immediate Actions)</h3>';
            html += '<ul style="margin: 1rem 0;">';
            
            const quickWins = [];
            
            if (lowAttendanceStudents.length > 5) {
                quickWins.push(`Contact ${lowAttendanceStudents.slice(0, 5).map(s => s.name).join(', ')} about attendance barriers`);
            }
            
            const stuckStudents = students.filter(s => s.daysSince > 14);
            if (stuckStudents.length > 0) {
                quickWins.push(`${stuckStudents.length} students haven't completed units in 14+ days - immediate check-in needed`);
            }
            
            const nearPromotion = students.filter(s => s.tier === 3 && s.tracking >= -2);
            if (nearPromotion.length > 0) {
                quickWins.push(`${nearPromotion.length} students close to tier promotion - encourage final push`);
            }
            
            quickWins.forEach(win => {
                html += `<li style="margin-bottom: 0.75rem;">${win}</li>`;
            });
            
            html += '</ul>';
            
            // Summary stats
            html += `<div style="margin-top: 2rem; padding: 1rem; background: var(--surface); border-radius: 8px; font-size: 0.9rem;">
                <strong>Analysis Summary:</strong><br>
                Total Students: ${summary.totalStudents} | 
                Crisis/High Risk: ${summary.crisis + summary.highRisk} (${crisisPercent.toFixed(0)}%) | 
                Superstars: ${summary.superstars} | 
                Avg Velocity: ${summary.avgVelocity.toFixed(2)} u/wk | 
                Avg Attendance: ${summary.avgAttendance.toFixed(1)}%
            </div>`;
            
            html += '<div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(42,42,42,0.12); text-align: center; color: var(--muted); font-size: 0.85rem;">';
            html += `Generated ${new Date().toLocaleString()} â€¢ Based on ${students.length} students â€¢ ${dashboardData.sortedDates.length} data points`;
            html += '</div>';
            
            html += '</div>';
            return html;
        }
        
        // ================== TARGETED RECOMMENDATIONS ==================
        
        function generateStudentRecommendations() {
            if (!currentStudent) return;
            
            const s = currentStudent;
            const modal = document.createElement('div');
            modal.id = 'studentRecommendationsModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            // Generate student-specific action plan
            let html = '<div style="line-height: 1.8;">';
            
            html += `<h3 style="color: var(--brand-accent); border-bottom: 2px solid var(--brand-accent); padding-bottom: 0.5rem;">ðŸ“‹ Action Plan for ${formatStudentName(s.name)}</h3>`;
            
            // Current Status
            html += '<div style="background: var(--surface); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">';
            html += `<strong>Current Status:</strong> ${s.tierLabel} (Tier ${s.tier}) â€¢ ${s.trajectoryLabel} trajectory<br>`;
            html += `<strong>Performance:</strong> ${s.velocity.toFixed(2)} u/wk velocity â€¢ ${s.tracking > 0 ? '+' : ''}${s.tracking} units ${s.tracking >= 0 ? 'ahead' : 'behind'}<br>`;
            html += `<strong>Attendance:</strong> ${s.avgAttendance.toFixed(1)}% â€¢ <strong>Last Activity:</strong> ${s.daysSince} days ago`;
            html += '</div>';
            
            // Priority Actions
            html += '<h4 style="color: var(--brand-accent);">ðŸŽ¯ Priority Actions (Next 48 Hours)</h4><ul style="margin: 1rem 0;">';
            
            if (s.daysSince > 14) {
                html += `<li><strong>URGENT:</strong> Student hasn't completed units in ${s.daysSince} days. Call TODAY to check in and identify barriers.</li>`;
            }
            
            if (s.tier === 1) {
                html += '<li><strong>CRISIS TIER:</strong> Schedule immediate one-on-one meeting. Review barriers, adjust pacing plan, contact family if needed.</li>';
                html += `<li>Student is ${Math.abs(s.tracking)} units behind. Create catch-up plan: target ${Math.ceil(Math.abs(s.tracking) / 4)} units per week for next month.</li>`;
            } else if (s.tier === 2) {
                html += '<li><strong>HIGH RISK:</strong> Weekly check-ins required. Monitor daily attendance and unit completion.</li>';
                html += `<li>Currently ${Math.abs(s.tracking)} units behind. Break into achievable goals: 2-3 units per week.</li>`;
            }
            
            if (s.trajectory === 'rapid_decline') {
                html += '<li><strong>RAPID DECLINE DETECTED:</strong> Early velocity ' + s.earlyVelocity.toFixed(1) + ' â†’ recent velocity ' + s.recentVelocity.toFixed(1) + '. Investigate what changed.</li>';
            } else if (s.trajectory === 'declining') {
                html += '<li><strong>LOSING MOMENTUM:</strong> Velocity decreasing. Address before it becomes critical.</li>';
            }
            
            if (s.avgAttendance < 80) {
                html += `<li><strong>ATTENDANCE CONCERN:</strong> ${s.avgAttendance.toFixed(1)}% attendance. Identify transportation, childcare, or other barriers.</li>`;
            }
            
            if (s.consistencyRatio < 0.5) {
                html += '<li><strong>INCONSISTENT PATTERN:</strong> Bursty work habits. Help establish daily routine and smaller goals.</li>';
            }
            
            html += '</ul>';
            
            // Positive Momentum
            if (s.trajectory === 'breakthrough' || s.trajectory === 'building' || s.tierChange > 0) {
                html += '<h4 style="color: var(--teal);">âœ¨ Celebrate Progress</h4><ul style="margin: 1rem 0;">';
                
                if (s.tierChange > 0) {
                    html += `<li>ðŸŽ‰ Promoted from Tier ${s.firstTier} to Tier ${s.tier}! Acknowledge this achievement.</li>`;
                }
                if (s.trajectory === 'breakthrough') {
                    html += `<li>ðŸš€ Breakthrough momentum! Velocity increased from ${s.earlyVelocity.toFixed(1)} to ${s.recentVelocity.toFixed(1)} u/wk.</li>`;
                }
                if (s.badges.length >= 3) {
                    html += `<li>ðŸ… Earned ${s.badges.length} badges - recognize achievements publicly.</li>`;
                }
                
                html += '</ul>';
            }
            
            // Weekly Goals
            html += '<h4 style="color: var(--brand-accent);">ðŸ“… This Week\'s Goals</h4><ul style="margin: 1rem 0;">';
            
            const targetUnits = s.velocity < 1.5 ? 2 : Math.ceil(s.velocity * 1.2);
            html += `<li>Target: ${targetUnits} units completed by Friday</li>`;
            html += `<li>Attendance: Aim for ${s.avgAttendance < 85 ? '90%+' : '100%'} this week</li>`;
            html += '<li>Daily check-in at start of class period</li>';
            
            if (s.tier <= 2) {
                html += '<li>Mid-week progress check (Wednesday)</li>';
                html += '<li>End-of-week review meeting (Friday)</li>';
            }
            
            html += '</ul>';
            
            // Intervention Template
            html += '<h4 style="color: var(--brand-accent);">ðŸ’¬ Conversation Starters</h4>';
            html += '<div style="background: rgba(37,99,235,0.05); padding: 1rem; border-left: 4px solid var(--info); border-radius: 4px; margin: 1rem 0;">';
            
            const firstName = formatStudentName(s.name).split(' ')[0];
            html += '<p style="margin: 0;"><em>"Hey ' + firstName + ', ';
            
            // V8.1 FIX 19: More personalized conversation starters
            if (s.trajectory === 'breakthrough' && s.unitsPeriod >= 10) {
                html += 'amazing progress this week - ' + s.unitsPeriod + ' units is incredible! What clicked for you? Let\'s keep this energy going."</em></p>';
            } else if (s.tierChange > 0) {
                html += 'you just moved up to ' + s.tierLabel + ' status! That\'s a big win. What changed for you lately?"</em></p>';
            } else if (s.daysSince > 14) {
                html += 'I haven\'t seen new work from you in ' + s.daysSince + ' days. Everything okay? Let\'s figure out what support you need."</em></p>';
            } else if (s.latest.attendance < 80 && s.tier <= 2) {
                html += 'attendance has dropped to ' + s.latest.attendance.toFixed(0) + '%. Being here is the first step to success. What\'s keeping you away?"</em></p>';
            } else if (s.velocity < 1.0 && s.tier <= 2) {
                html += 'you\'re averaging less than a unit per week. That pace won\'t get us where we need to be. What\'s making it hard to complete work?"</em></p>';
            } else if (s.acceleration < -1.0) {
                html += 'your pace has slowed down recently. You were doing ' + s.earlyVelocity.toFixed(1) + ' u/wk, now ' + s.recentVelocity.toFixed(1) + '. What changed?"</em></p>';
            } else if (s.isPerfectWeek) {
                html += 'you had a perfect week - great attendance AND ' + s.unitsPeriod + ' units! How can we keep this going?"</em></p>';
            } else if (s.tracking >= 5) {
                html += 'you\'re ' + s.tracking + ' units ahead of pace. That\'s excellent! What\'s your strategy been working so well?"</em></p>';
            } else {
                html += 'I noticed your progress this semester. Let\'s make sure we keep building on what\'s working. What support do you need?"</em></p>';
            }
            
            html += '</div>';
            
            html += '</div>';
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 900px; width: 90%; max-height: 80vh; overflow: auto;" onclick="event.stopPropagation()">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="margin: 0;">ðŸŽ¯ Action Plan: ${formatStudentName(s.name)}</h2>
                        <button onclick="document.getElementById('studentRecommendationsModal').remove()" style="background: var(--brand-accent); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 1rem;">Close</button>
                    </div>
                    ${html}
                </div>
            `;
            document.body.appendChild(modal);
        }
        

        function generateAdministrativeHoldRecommendations() {
            if (!dashboardData.administrativeHoldCard) return;
            
            const card = dashboardData.administrativeHoldCard;
            const students = card.students;
            
            const modal = document.createElement('div');
            modal.id = 'adminHoldRecommendationsModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            // Calculate metrics
            const inactiveStudents = students.filter(s => s.daysSince > 14);
            const lowVelocityStudents = students.filter(s => s.velocity < 1.0);
            const lowAttendanceStudents = students.filter(s => s.avgAttendance < 70);
            const decliningStudents = students.filter(s => s.trajectory === 'declining' || s.trajectory === 'rapid_decline');
            
            // Group by category
            const categoryGroups = {};
            students.forEach(s => {
                const cat = s.specialCategoryType;
                if (!categoryGroups[cat]) categoryGroups[cat] = [];
                categoryGroups[cat].push(s);
            });
            
            let html = '<div style="line-height: 1.8;">';
            
            html += `<h3 style="color: var(--brand-brass); border-bottom: 2px solid var(--brand-brass); padding-bottom: 0.5rem;">âš ï¸ Administrative Hold Priorities</h3>`;
            
            // Overview
            html += '<div style="background: var(--surface); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">';
            html += `<strong>Total Students on Hold:</strong> ${students.length}<br>`;
            html += `<strong>Avg Velocity:</strong> ${card.avgVelocity.toFixed(2)} u/wk<br>`;
            html += `<strong>Avg Attendance:</strong> ${card.avgAttendance.toFixed(1)}%<br>`;
            html += `<strong>Categories:</strong> ${Object.keys(categoryGroups).length}`;
            html += '</div>';
            
            // Immediate Action Required
            html += '<h4 style="color: var(--brand-accent);">ðŸš¨ Immediate Action Required</h4><ul style="margin: 1rem 0;">';
            
            if (inactiveStudents.length > 0) {
                html += `<li><strong>${inactiveStudents.length} INACTIVE 14+ DAYS:</strong><br>`;
                inactiveStudents.sort((a, b) => b.daysSince - a.daysSince).slice(0, 5).forEach(s => {
                    html += `<span style="margin-left: 2rem; color: var(--muted);">${formatStudentName(s.name)} - ${s.daysSince} days (${formatSpecialCategoryName(s.specialCategoryType)})</span><br>`;
                });
                if (inactiveStudents.length > 5) html += `<span style="margin-left: 2rem; color: var(--muted);">...and ${inactiveStudents.length - 5} more</span><br>`;
                html += '<span style="margin-left: 2rem; color: var(--brand-accent);">â†’ Contact immediately to determine status</span></li>';
            }
            
            if (lowVelocityStudents.length > 0) {
                html += `<li><strong>${lowVelocityStudents.length} VERY LOW VELOCITY (&lt;1.0 u/wk):</strong><br>`;
                html += '<span style="margin-left: 2rem; color: var(--muted);">Check if these students should be transitioned out or need support to re-engage</span></li>';
            }
            
            html += '</ul>';
            
            // Category Breakdown
            html += '<h4 style="color: var(--brand-brass);">ðŸ“‹ Review by Category</h4>';
            
            Object.entries(categoryGroups).forEach(([cat, studs]) => {
                const catName = formatSpecialCategoryName(cat);
                const avgVel = studs.reduce((sum, s) => sum + s.velocity, 0) / studs.length;
                const inactive = studs.filter(s => s.daysSince > 14).length;
                
                html += `<div style="background: var(--surface-2); padding: 1rem; border-radius: 8px; margin: 0.75rem 0; border-left: 4px solid var(--brand-brass);">`;
                html += `<strong style="font-size: 1.1rem;">${catName}</strong> (${studs.length} students)<br>`;
                html += `<div style="margin-top: 0.5rem; color: var(--muted); font-size: 0.9rem;">`;
                html += `Avg Velocity: ${avgVel.toFixed(2)} u/wk â€¢ `;
                html += `Inactive: ${inactive} â€¢ `;
                html += `Students: ${studs.map(s => formatStudentName(s.name)).join(', ')}`;
                html += `</div>`;
                
                // Category-specific recommendations
                if (cat.includes('SUSPENDED')) {
                    html += `<div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(148, 27, 31, 0.1); border-radius: 4px; font-size: 0.9rem;">`;
                    html += `â†’ Review suspension end dates, coordinate re-entry plans`;
                    html += `</div>`;
                } else if (cat.includes('MEDICAL')) {
                    html += `<div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(37, 99, 235, 0.1); border-radius: 4px; font-size: 0.9rem;">`;
                    html += `â†’ Check medical documentation, coordinate with families and healthcare providers`;
                    html += `</div>`;
                } else if (cat.includes('COUNSELING')) {
                    html += `<div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(20, 184, 166, 0.1); border-radius: 4px; font-size: 0.9rem;">`;
                    html += `â†’ Coordinate with counseling services, check progress toward goals`;
                    html += `</div>`;
                } else if (cat.includes('TRANSITIONING')) {
                    html += `<div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(162, 129, 80, 0.1); border-radius: 4px; font-size: 0.9rem;">`;
                    html += `â†’ Finalize transition plans, ensure proper records transfer`;
                    html += `</div>`;
                }
                
                html += `</div>`;
            });
            
            // This Week's Actions
            html += '<h4 style="color: var(--brand-brass);">âœ… This Week\'s Action Items</h4>';
            html += '<ol style="margin: 1rem 0;">';
            html += '<li>Contact all inactive students (14+ days) to verify status</li>';
            html += '<li>Review and update category assignments based on current circumstances</li>';
            html += '<li>Coordinate with families and relevant staff for students nearing return</li>';
            html += '<li>Document all communications and status updates</li>';
            html += '<li>Identify students ready to transition back to active status</li>';
            html += '</ol>';
            
            html += '</div>';
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 900px; width: 90%; max-height: 80vh; overflow: auto;" onclick="event.stopPropagation()">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="margin: 0;">ðŸŽ¯ Administrative Hold Priorities</h2>
                        <button onclick="document.getElementById('adminHoldRecommendationsModal').remove()" style="background: var(--brand-accent); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 1rem;">Close</button>
                    </div>
                    ${html}
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function generateCampusRecommendations() {
            if (!dashboardData) return;
            
            const modal = document.createElement('div');
            modal.id = 'campusRecommendationsModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            // Calculate campus-wide metrics
            const allStudents = dashboardData.students;
            const crisisStudents = allStudents.filter(s => s.tier === 1);
            const highRiskStudents = allStudents.filter(s => s.tier === 2);
            const inactiveStudents = allStudents.filter(s => s.daysSince > 14);
            const rapidDeclineStudents = allStudents.filter(s => s.trajectory === 'rapid_decline');
            const decliningStudents = allStudents.filter(s => s.trajectory === 'declining');
            const lowAttendanceStudents = allStudents.filter(s => s.avgAttendance < 70);
            const breakthroughStudents = allStudents.filter(s => s.trajectory === 'breakthrough');
            
            // Get top priority students
            const topPriorities = [...crisisStudents].sort((a, b) => b.daysSince - a.daysSince).slice(0, 10);
            
            let html = '<div style="line-height: 1.8;">';
            
            html += `<h3 style="color: var(--brand-accent); border-bottom: 2px solid var(--brand-accent); padding-bottom: 0.5rem;">ðŸ« Campus-Wide Priorities</h3>`;
            
            // Campus Overview
            html += '<div style="background: var(--surface); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">';
            html += `<strong>Total Students:</strong> ${allStudents.length}<br>`;
            html += `<strong>Campus Avg Velocity:</strong> ${dashboardData.summary.avgVelocity.toFixed(2)} u/wk<br>`;
            html += `<strong>Campus Avg Attendance:</strong> ${dashboardData.summary.avgAttendance.toFixed(1)}%<br>`;
            html += `<strong>Crisis + High Risk:</strong> ${crisisStudents.length + highRiskStudents.length} students (${((crisisStudents.length + highRiskStudents.length) / allStudents.length * 100).toFixed(0)}%)`;
            html += '</div>';
            
            // Immediate Campus-Wide Priorities
            html += '<h4 style="color: var(--brand-accent);">ðŸš¨ Immediate Campus-Wide Priorities</h4><ul style="margin: 1rem 0;">';
            
            if (crisisStudents.length > 0) {
                html += `<li><strong>${crisisStudents.length} CRISIS STUDENTS:</strong> Highest priority for intervention<br>`;
                html += `<span style="margin-left: 2rem; color: var(--muted);">Top 10: ${topPriorities.map(s => formatStudentName(s.name)).join(', ')}</span><br>`;
                html += '<span style="margin-left: 2rem; color: var(--brand-accent);">â†’ Coordinate advisors for immediate one-on-one meetings</span></li>';
            }
            
            if (inactiveStudents.length > 0) {
                html += `<li><strong>${inactiveStudents.length} INACTIVE 14+ DAYS:</strong> At risk of dropping out<br>`;
                html += '<span style="margin-left: 2rem; color: var(--brand-accent);">â†’ Campus-wide phone bank to re-engage</span></li>';
            }
            
            if (rapidDeclineStudents.length > 0) {
                html += `<li><strong>${rapidDeclineStudents.length} RAPID DECLINE:</strong> Trajectory shows sharp drop<br>`;
                html += '<span style="margin-left: 2rem; color: var(--brand-accent);">â†’ Review with advisors to identify root causes</span></li>';
            }
            
            html += '</ul>';
            
            // This Week's Campus Focus
            html += '<h4 style="color: var(--brand-accent);">ðŸ“‹ This Week\'s Campus Focus</h4><ul style="margin: 1rem 0;">';
            
            if (highRiskStudents.length > 0) {
                html += `<li><strong>${highRiskStudents.length} High Risk students</strong> need monitoring to prevent crisis</li>`;
            }
            
            if (decliningStudents.length > 0) {
                html += `<li><strong>${decliningStudents.length} Declining students</strong> - early intervention opportunity</li>`;
            }
            
            if (lowAttendanceStudents.length > 0) {
                html += `<li><strong>${lowAttendanceStudents.length} students below 70% attendance</strong> - barrier identification needed</li>`;
            }
            
            html += '</ul>';
            
            // Celebrate Campus Wins
            if (breakthroughStudents.length > 0) {
                html += '<h4 style="color: var(--teal);">âœ¨ Campus Celebrations</h4><ul style="margin: 1rem 0;">';
                html += `<li>ðŸš€ <strong>${breakthroughStudents.length} students</strong> hit breakthrough velocity this period!</li>`;
                html += '<li style="margin-left: 2rem; color: var(--muted);">â†’ Consider campus-wide recognition assembly</li>';
                html += '</ul>';
            }
            
            // Advisor Performance Insights
            html += '<h4 style="color: var(--brand-accent);">ðŸ‘¥ Advisor Team Insights</h4>';
            html += '<div style="background: var(--surface); padding: 1rem; border-radius: 8px; margin: 1rem 0;">';
            
            // Calculate advisor metrics
            const advisorStats = [];
            dashboardData.advisorMap.forEach((students, advisor) => {
                const avgVel = students.reduce((sum, s) => sum + s.velocity, 0) / students.length;
                const crisisCount = students.filter(s => s.tier === 1).length;
                advisorStats.push({ advisor, avgVel, crisisCount, studentCount: students.length });
            });
            
            const highestVel = [...advisorStats].sort((a, b) => b.avgVel - a.avgVel)[0];
            const mostCrisis = [...advisorStats].sort((a, b) => b.crisisCount - a.crisisCount)[0];
            
            html += `<strong>Top Velocity:</strong> ${formatAdvisorName(highestVel.advisor)} (${highestVel.avgVel.toFixed(2)} u/wk)<br>`;
            html += `<strong>Most Support Needed:</strong> ${formatAdvisorName(mostCrisis.advisor)} (${mostCrisis.crisisCount} crisis students)<br>`;
            html += '<div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(162, 129, 80, 0.1); border-radius: 4px; font-size: 0.9rem;">';
            html += 'â†’ Consider peer mentoring or resource sharing between advisor teams';
            html += '</div>';
            html += '</div>';
            
            // Action Plan
            html += '<h4 style="color: var(--brand-accent);">âœ… Campus Action Plan</h4>';
            html += '<ol style="margin: 1rem 0;">';
            html += '<li>Schedule advisor team meeting to review crisis students</li>';
            html += '<li>Organize phone bank for inactive students (14+ days)</li>';
            html += '<li>Create intervention plan for rapid decline students</li>';
            html += '<li>Plan campus celebration for breakthrough students</li>';
            html += '<li>Review attendance barriers with counseling team</li>';
            html += '</ol>';
            
            html += '</div>';
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 900px; width: 90%; max-height: 80vh; overflow: auto;" onclick="event.stopPropagation()">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="margin: 0;">ðŸŽ¯ Campus Recommendations</h2>
                        <button onclick="document.getElementById('campusRecommendationsModal').remove()" style="background: var(--brand-accent); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 1rem;">Close</button>
                    </div>
                    ${html}
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
                function generateAdvisorRecommendations() {
            if (!currentAdvisor) return;
            
            const students = dashboardData.advisorMap.get(currentAdvisor);
            const advisorName = formatAdvisorName(currentAdvisor);
            
            const modal = document.createElement('div');
            modal.id = 'advisorRecommendationsModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            // Calculate advisor-specific stats
            const crisisStudents = students.filter(s => s.tier === 1);
            const highRiskStudents = students.filter(s => s.tier === 2);
            const rapidDeclineStudents = students.filter(s => s.trajectory === 'rapid_decline');
            const decliningStudents = students.filter(s => s.trajectory === 'declining');
            const lowAttendanceStudents = students.filter(s => s.avgAttendance < 80);
            const inactiveStudents = students.filter(s => s.daysSince > 14);
            const breakthroughStudents = students.filter(s => s.trajectory === 'breakthrough');
            const tierPromotions = students.filter(s => s.tierChange > 0);
            
            const avgVel = students.length > 0 ? students.reduce((sum, s) => sum + s.velocity, 0) / students.length : 0;
            const avgAtt = students.length > 0 ? students.reduce((sum, s) => sum + s.avgAttendance, 0) / students.length : 0;
            const campusAvgVel = dashboardData.summary.avgVelocity;
            const campusAvgAtt = dashboardData.summary.avgAttendance;
            
            let html = '<div style="line-height: 1.8;">';
            
            html += `<h3 style="color: var(--brand-accent); border-bottom: 2px solid var(--brand-accent); padding-bottom: 0.5rem;">ðŸ‘¥ ${advisorName}'s Caseload Priorities</h3>`;
            
            // Caseload Overview
            html += '<div style="background: var(--surface); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">';
            html += `<strong>Total Students:</strong> ${students.length}<br>`;
            html += `<strong>Your Avg Velocity:</strong> ${avgVel.toFixed(2)} u/wk (Campus: ${campusAvgVel.toFixed(2)})<br>`;
            html += `<strong>Your Avg Attendance:</strong> ${avgAtt.toFixed(1)}% (Campus: ${campusAvgAtt.toFixed(1)}%)<br>`;
            html += `<strong>Crisis/High Risk:</strong> ${crisisStudents.length + highRiskStudents.length} students (${(students.length > 0 ? (crisisStudents.length + highRiskStudents.length) / students.length : 0 * 100).toFixed(0)}%)`;
            html += '</div>';
            
            // Immediate Priorities
            html += '<h4 style="color: var(--brand-accent);">ðŸš¨ Immediate Priorities (Next 48 Hours)</h4><ul style="margin: 1rem 0;">';
            
            if (crisisStudents.length > 0) {
                html += `<li><strong>${crisisStudents.length} CRISIS STUDENTS:</strong> ${crisisStudents.map(s => formatStudentName(s.name)).join(', ')}</li>`;
                html += '<li style="margin-left: 2rem; color: var(--muted);">â†’ One-on-one meetings required within 24 hours</li>';
            }
            
            if (inactiveStudents.length > 0) {
                html += `<li><strong>${inactiveStudents.length} INACTIVE 14+ DAYS:</strong> ${inactiveStudents.slice(0, 5).map(s => formatStudentName(s.name)).join(', ')}${inactiveStudents.length > 5 ? ` (+${inactiveStudents.length - 5} more)` : ''}</li>`;
                html += '<li style="margin-left: 2rem; color: var(--muted);">â†’ Phone calls today to re-engage</li>';
            }
            
            if (rapidDeclineStudents.length > 0) {
                html += `<li><strong>${rapidDeclineStudents.length} RAPID DECLINE:</strong> ${rapidDeclineStudents.map(s => formatStudentName(s.name)).join(', ')}</li>`;
                html += '<li style="margin-left: 2rem; color: var(--muted);">â†’ Investigate cause of decline, daily check-ins</li>';
            }
            
            html += '</ul>';
            
            // This Week's Focus
            html += '<h4 style="color: var(--brand-accent);">ðŸ“‹ This Week\'s Focus</h4><ul style="margin: 1rem 0;">';
            
            if (highRiskStudents.length > 0) {
                html += `<li><strong>Monitor ${highRiskStudents.length} High Risk students:</strong> ${highRiskStudents.slice(0, 4).map(s => formatStudentName(s.name)).join(', ')}${highRiskStudents.length > 4 ? '...' : ''}</li>`;
            }
            
            if (decliningStudents.length > 0) {
                html += `<li><strong>${decliningStudents.length} students showing declining trajectory</strong> - catch them before they hit crisis</li>`;
            }
            
            if (lowAttendanceStudents.length > 0) {
                html += `<li><strong>${lowAttendanceStudents.length} students below 80% attendance</strong> - identify barriers this week</li>`;
            }
            
            const watchStudents = students.filter(s => s.tier === 3);
            if (watchStudents.length > 0) {
                html += `<li><strong>${watchStudents.length} Watch tier students</strong> - keep stable, prevent slipping to High Risk</li>`;
            }
            
            html += '</ul>';
            
            // Celebrate Successes
            if (breakthroughStudents.length > 0 || tierPromotions.length > 0) {
                html += '<h4 style="color: var(--teal);">âœ¨ Celebrate This Week</h4><ul style="margin: 1rem 0;">';
                
                if (tierPromotions.length > 0) {
                    html += `<li>ðŸŽ‰ ${tierPromotions.length} students earned tier promotions: ${tierPromotions.map(s => formatStudentName(s.name)).join(', ')}</li>`;
                }
                
                if (breakthroughStudents.length > 0) {
                    html += `<li>ðŸš€ ${breakthroughStudents.length} students hit breakthrough velocity: ${breakthroughStudents.map(s => formatStudentName(s.name)).join(', ')}</li>`;
                }
                
                html += '<li style="margin-left: 2rem; color: var(--muted);">â†’ Public recognition builds momentum</li>';
                html += '</ul>';
            }
            
            // Comparison to Campus
            html += '<h4 style="color: var(--brand-accent);">ðŸ“Š How You Compare to Campus</h4>';
            html += '<div style="background: var(--surface); padding: 1rem; border-radius: 8px; margin: 1rem 0;">';
            
            if (avgVel > campusAvgVel) {
                html += `<div style="color: var(--teal); margin-bottom: 0.5rem;">âœ… Your velocity (${avgVel.toFixed(2)}) is above campus average (${campusAvgVel.toFixed(2)})</div>`;
            } else {
                html += `<div style="color: var(--brand-brass); margin-bottom: 0.5rem;">âš ï¸ Your velocity (${avgVel.toFixed(2)}) is below campus average (${campusAvgVel.toFixed(2)})</div>`;
                html += '<div style="margin-left: 1.5rem; font-size: 0.9rem; color: var(--muted);">Consider: group pacing strategies, peer accountability partners</div>';
            }
            
            if (avgAtt > campusAvgAtt) {
                html += `<div style="color: var(--teal);">âœ… Your attendance (${avgAtt.toFixed(1)}%) is above campus average (${campusAvgAtt.toFixed(1)}%)</div>`;
            } else {
                html += `<div style="color: var(--brand-brass);">âš ï¸ Your attendance (${avgAtt.toFixed(1)}%) is below campus average (${campusAvgAtt.toFixed(1)}%)</div>`;
                html += '<div style="margin-left: 1.5rem; font-size: 0.9rem; color: var(--muted);">Consider: morning check-in texts, transportation support</div>';
            }
            
            html += '</div>';
            
            // Time Budget
            html += '<h4 style="color: var(--brand-accent);">â° Suggested Time Allocation This Week</h4>';
            html += '<div style="background: rgba(37,99,235,0.05); padding: 1rem; border-radius: 8px; margin: 1rem 0;">';
            
            const crisisTime = crisisStudents.length * 30;
            const highRiskTime = highRiskStudents.length * 15;
            const watchTime = watchStudents.length * 5;
            const totalTime = crisisTime + highRiskTime + watchTime;
            
            html += `<div style="margin-bottom: 0.5rem;"><strong>Crisis (${crisisStudents.length} students):</strong> ~${crisisTime} minutes (30 min each)</div>`;
            html += `<div style="margin-bottom: 0.5rem;"><strong>High Risk (${highRiskStudents.length} students):</strong> ~${highRiskTime} minutes (15 min each)</div>`;
            html += `<div style="margin-bottom: 0.5rem;"><strong>Watch (${watchStudents.length} students):</strong> ~${watchTime} minutes (5 min check-ins)</div>`;
            html += `<div style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #ddd;"><strong>Total estimated time:</strong> ${Math.ceil(totalTime / 60)} hours ${totalTime % 60} minutes</div>`;
            
            html += '</div>';
            
            html += '</div>';
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 900px; width: 90%; max-height: 80vh; overflow: auto;" onclick="event.stopPropagation()">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="margin: 0;">ðŸŽ¯ Advisor Priorities: ${advisorName}</h2>
                        <button onclick="document.getElementById('advisorRecommendationsModal').remove()" style="background: var(--brand-accent); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 1rem;">Close</button>
                    </div>
                    ${html}
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // ================== PDF EXPORT ==================
        function exportToPDF() {
            // Hide action buttons temporarily
            const actionButtons = document.querySelector('div[style*="display: flex"]');
            if (actionButtons) actionButtons.style.display = 'none';
            
            // Trigger print dialog (user can save as PDF)
            window.print();
            
            // Restore buttons after print
            setTimeout(() => {
                if (actionButtons) actionButtons.style.display = 'flex';
            }, 100);
        }
        
        function exportPerfectWeekToPDF() {
            // Trigger print dialog - no-print class handles hiding buttons
            window.print();
        }
        
        // ================== ADVISOR NOTES FUNCTIONS ==================
        function openNoteLogger() {
            if (!currentStudent) return;
            
            // Validate form URL is configured
            if (!FORM_BASE_URL || FORM_BASE_URL === '') {
                alert('âš ï¸ Note logging form not configured.\n\nPlease add noteFormUrl to Data_Sources tab in config.');
                return;
            }
            
            // Get current student's info
            const studentId = currentStudent.name.split(',')[0].trim(); // Last name: "FLORES"
            const studentName = currentStudent.name; // Full name: "FLORES, MARIA"
            const today = new Date().toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
            
            // Build pre-filled form URL
            const formUrl = `${FORM_BASE_URL}&${FORM_ENTRIES.studentId}=${encodeURIComponent(studentId)}&${FORM_ENTRIES.studentName}=${encodeURIComponent(studentName)}&${FORM_ENTRIES.date}=${encodeURIComponent(today)}`;
            
            // Open form in new window
            window.open(formUrl, '_blank', 'width=700,height=800');
        }
        
        function renderStudentNotes(student) {
            const notesContainer = document.getElementById('studentNotesDisplay');
            
            if (!notesContainer) return;
            
            // Get notes for this student - match on Student Name (full name)
            const studentNotes = advisorNotes.filter(note => {
                return note.studentName.toUpperCase().trim() === student.name.toUpperCase().trim();
            });
            
            if (studentNotes.length === 0) {
                notesContainer.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--muted); font-style: italic;">
                        No notes logged yet. Click "Log Note" to add the first interaction note for this student.
                    </div>
                `;
                return;
            }
            
            // Sort notes by timestamp (newest first)
            studentNotes.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Render notes
            const notesHtml = studentNotes.map(note => {
                const timestamp = new Date(note.timestamp).toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit'
                });
                
                // V8.0 FIX: Use getStaffDisplayName instead of undefined advisorDisplayNames
                const advisorDisplay = getStaffDisplayName(note.advisor) || note.advisor;
                
                // Color code by note type
                let noteTypeColor = 'var(--brand-accent)'; // default
                if (note.noteType === 'Intervention') noteTypeColor = 'var(--brand-brass)';
                if (note.noteType === 'Parent Contact') noteTypeColor = 'var(--brand-brass)';
                if (note.noteType === 'Behavioral Note') noteTypeColor = 'var(--brand-accent)';
                if (note.noteType === 'Academic Progress') noteTypeColor = 'var(--teal)';
                
                return `
                    <div style="border-left: 4px solid ${noteTypeColor}; background: var(--surface); padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                            <div>
                                <span style="font-weight: 600; color: ${noteTypeColor};">${note.noteType}</span>
                                <span style="color: var(--muted); font-size: 0.9rem; margin-left: 1rem;">by ${advisorDisplay}</span>
                            </div>
                            <span style="color: var(--muted); font-size: 0.85rem;">${timestamp}</span>
                        </div>
                        <div style="color: var(--text); line-height: 1.6;">${note.noteDetails}</div>
                    </div>
                `;
            }).join('');
            
            notesContainer.innerHTML = `
                <div style="margin-bottom: 1rem; color: var(--muted); font-size: 0.95rem;">
                    <strong>${studentNotes.length}</strong> interaction${studentNotes.length !== 1 ? 's' : ''} logged
                </div>
                ${notesHtml}
            `;
        }
        
        // ================== INITIALIZE ==================
        document.addEventListener('DOMContentLoaded', async () => {
            // V8.0: Load config first, then data
            await loadAllConfig();
            await loadData();
            
            // Browser back button prevention (Option B: Confirm dialog)
            // Push initial state to enable popstate detection
            window.history.pushState({page: 'dashboard'}, '', '');
            
            // Listen for browser back button
            window.addEventListener('popstate', (e) => {
                // User hit browser back - ask to confirm
                const shouldLeave = confirm('Leave the dashboard? You will lose your current view.');
                
                if (!shouldLeave) {
                    // Stay here - push state again to prevent navigation
                    window.history.pushState({page: 'dashboard'}, '', '');
                }
                // If shouldLeave is true, allow default behavior (navigate away)
            });
        });
    

/* V10: program pill theming (portable) */
function programClassFor(name){
  if(!name) return "program--acad";
  const n = String(name).toLowerCase();
  if(n.includes("welding")) return "program--welding";
  if(n.includes("electrical")) return "program--electrical";
  if(n.includes("medical") || n.includes("health")) return "program--medical";
  if(n.includes("auto")) return "program--auto";
  if(n.includes("construction")) return "program--construction";
  if(n.includes("education") || n.includes("training")) return "program--edtrain";
  if(n.includes("academic")) return "program--acad";
  return "program--acad";
}
/* V10: week banner styling (portable) */
function setWeekBanner(isHistorical, text){
  const el = document.getElementById("weekBanner") || document.querySelector(".week-banner");
  if(!el) return;
  el.classList.add("week-banner");
  el.classList.toggle("banner--historical", !!isHistorical);
  el.classList.toggle("banner--current", !isHistorical);
  if(text) el.textContent = text;
}

</script>
<!-- =====================
     Program Tracking View (no overlay)
     ===================== -->
<div class="page-view" id="programTrackingView" style="display:none;">
<div class="container">
<button class="back-button" id="programTrackingBackBtn">â† Back</button>
<div id="programTrackingContent"></div>
</div>
</div>
<script>

/* ==========================================================
   V9.2 JS PATCH (Program Tracking: view-based, no overlay)
   ========================================================== */
(function(){
  let __mainScrollY = 0;

  function _hide(el){ if(el) el.style.display = "none"; }
  function _show(el){ if(el) el.style.display = ""; }

  function getMainRoot(){
    // Most builds use a single main container; fallback to body children
    return document.querySelector(".container")?.parentElement || document.body;
  }

  function showProgramTrackingView(){
    __mainScrollY = window.scrollY || 0;

    // Hide the primary app wrapper, show view
    const mainRoot = document.getElementById("appRoot") || document.getElementById("dashboardPage") || document.querySelector("main") || document.body;
    const view = document.getElementById("programTrackingView");
    if(!view) return;

    // Hide major sections rather than body (prevents scroll bugs)
    const mainContainer = document.querySelector(".container");
    if(mainContainer) _hide(mainContainer);

    _show(view);
    window.scrollTo(0,0);

    // Render content: if a generator exists, use it
    const host = document.getElementById("programTrackingContent");
    if(host){
      // Prefer an existing renderer if defined
      if(typeof window.renderProgramTracking === "function"){
        host.innerHTML = "";
        window.renderProgramTracking(host);
      }else if(typeof window.getProgramTrackingHTML === "function"){
        host.innerHTML = window.getProgramTrackingHTML();
      }else if(typeof window.buildProgramTrackingHTML === "function"){
        host.innerHTML = window.buildProgramTrackingHTML();
      }else{
        // Last resort: if the old function created an overlay, hijack its HTML template string if present
        host.innerHTML = host.innerHTML || "<div style='padding:16px;color:var(--muted)'>Program Tracking content renderer not found. Tell Ava and weâ€™ll wire it.</div>";
      }
    }
  }

  function hideProgramTrackingView(){
    const view = document.getElementById("programTrackingView");
    if(view) _hide(view);

    const mainContainer = document.querySelector(".container");
    if(mainContainer) _show(mainContainer);

    window.scrollTo(0, __mainScrollY);
  }

  // Wire the Program Tracking button if it exists
  const programBtn = document.getElementById("programTrackingBtn")
    || document.querySelector('[data-action="program-tracking"]')
    || Array.from(document.querySelectorAll("button")).find(b => /Program Tracking/i.test(b.textContent||""));

  if(programBtn){
    programBtn.addEventListener("click", function(e){
      e.preventDefault();
      showProgramTrackingView();
    }, true);
  }

  // Back button in view
  const backBtn = document.getElementById("programTrackingBackBtn");
  if(backBtn){
    backBtn.addEventListener("click", function(e){
      e.preventDefault();
      hideProgramTrackingView();
    });
  }

  // Expose for other navigation calls
  window.showProgramTrackingView = showProgramTrackingView;
  window.hideProgramTrackingView = hideProgramTrackingView;
})();


        // =================================================================
        // V8R29: GLOBAL SEARCH & QUICK FILTERS
        // =================================================================
        
        function handleGlobalSearch(event) {
            const query = event.target.value.trim().toLowerCase();
            
            if (query.length < 2) return;  // Minimum 2 characters
            
            if (event.key === 'Enter') {
                // Fuzzy search across students
                const results = dashboardData.students.filter(s => {
                    const nameMatch = s.name.toLowerCase().includes(query);
                    
                    // Check Student_Number (handle both string and number)
                    const idMatch = s.Student_Number && 
                        String(s.Student_Number).toLowerCase().includes(query);
                    
                    // Check studentNumber as well (backup field)
                    const idMatch2 = s.studentNumber && 
                        String(s.studentNumber).toLowerCase().includes(query);
                    
                    // Check programs (from CONFIG.programTracking)
                    let programMatch = false;
                    if (CONFIG.programTracking) {
                        const studentPrograms = [];
                        for (const [key, data] of CONFIG.programTracking.entries()) {
                            if (data.studentNumber && 
                                (String(data.studentNumber) === String(s.Student_Number) || 
                                 String(data.studentNumber) === String(s.studentNumber))) {
                                studentPrograms.push(data.program || '');
                            }
                        }
                        programMatch = studentPrograms.some(prog => 
                            prog.toLowerCase().includes(query)
                        );
                    }
                    
                    // Check certifications if available
                    let certMatch = false;
                    if (s.certifications && Array.isArray(s.certifications)) {
                        certMatch = s.certifications.some(cert => 
                            cert.toLowerCase().includes(query)
                        );
                    }
                    
                    return nameMatch || idMatch || idMatch2 || programMatch || certMatch;
                });
                
                if (results.length > 0) {
                    if (results.length === 1) {
                        // Single result - show student directly
                        showStudentView(results[0].name);
                    } else {
                        // Multiple results - show filtered list
                        showFilteredList(results.map(s => s.name), `ðŸ” Search: "${query}" (${results.length} students)`);
                    }
                    event.target.value = '';  // Clear search
                } else {
                    alert(`No students found matching "${query}"`);
                }
            }
        }
        
        function resetMainPageFilters() {
            // Clear all filter inputs
            const searchBox = document.getElementById('mainPageSearch');
            const tierSelect = document.getElementById('mainPageTierFilter');
            const trajectorySelect = document.getElementById('mainPageTrajectoryFilter');
            
            if (searchBox) searchBox.value = '';
            if (tierSelect) tierSelect.value = 'all';
            if (trajectorySelect) trajectorySelect.value = 'all';
            
            // Hide results display
            const resultsDiv = document.getElementById('mainPageFilterResults');
            if (resultsDiv) resultsDiv.style.display = 'none';
            
            // Clear stored results
            window.mainPageFilteredResults = null;
        }
        
        function applyMainPageFilters() {
            const searchVal = (document.getElementById('mainPageSearch')?.value || '').toLowerCase();
            const tierVal = document.getElementById('mainPageTierFilter')?.value || 'all';
            const trajectoryVal = document.getElementById('mainPageTrajectoryFilter')?.value || 'all';
            
            let filtered = dashboardData.students;
            
            // Apply search filter
            if (searchVal.length >= 2) {
                filtered = filtered.filter(s => {
                    const nameMatch = s.name.toLowerCase().includes(searchVal);
                    const idMatch = s.Student_Number && s.Student_Number.toString().includes(searchVal);
                    return nameMatch || idMatch;
                });
            }
            
            // Apply tier filter
            if (tierVal !== 'all') {
                filtered = filtered.filter(s => s.tier === parseInt(tierVal));
            }
            
            // Apply trajectory filter
            if (trajectoryVal !== 'all') {
                filtered = filtered.filter(s => {
                    // Match against lowercase trajectory values stored in data
                    if (trajectoryVal === 'breakthrough') return s.trajectory === 'breakthrough';
                    if (trajectoryVal === 'building') return s.trajectory === 'building';
                    if (trajectoryVal === 'stable') return s.trajectory === 'stable';
                    if (trajectoryVal === 'declining') return s.trajectory === 'declining';
                    if (trajectoryVal === 'rapid_decline') return s.trajectory === 'rapid_decline';
                    return true;
                });
            }
            
            // Show results
            const resultsDiv = document.getElementById('mainPageFilterResults');
            if (searchVal.length >= 2 || tierVal !== 'all' || trajectoryVal !== 'all') {
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = `
                    <strong>${filtered.length} students match your filters</strong>
                    ${filtered.length > 0 ? `
                        <button onclick="showFilteredListFromMainPage()" 
                                style="margin-left: 1rem; padding: 0.4rem 0.8rem; background: var(--brand-accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                            View List â†’
                        </button>
                    ` : ''}
                `;
                
                // Store filtered results globally for the button
                window.mainPageFilteredResults = filtered.map(s => s.name);
            } else {
                resultsDiv.style.display = 'none';
            }
        }
        
        function showFilteredListFromMainPage() {
            // Get current filter values
            const searchVal = (document.getElementById('mainPageSearch')?.value || '').toLowerCase();
            const tierVal = document.getElementById('mainPageTierFilter')?.value || 'all';
            const trajectoryVal = document.getElementById('mainPageTrajectoryFilter')?.value || 'all';
            
            // Navigate to Student Directory with filters applied
            const filters = {};
            if (searchVal.length >= 2) filters.search = searchVal;
            if (tierVal !== 'all') filters.tier = tierVal;
            if (trajectoryVal !== 'all') filters.trajectory = trajectoryVal;
            
            showStudentDirectory(filters);
        }
        
        function showStudentDirectory(filters = {}) {
            // Hide all views
            document.getElementById('mainView').classList.remove('active');
            document.getElementById('advisorView').classList.remove('active');
            document.getElementById('studentView').classList.remove('active');
            document.getElementById('filteredListView').classList.remove('active');
            
            // Show student directory view
            if (DEBUG) console.log('Showing Student Directory View with filters:', filters);
            document.getElementById('studentDirectoryView').classList.add('active');
            
            // Apply filters to UI elements before rendering
            if (filters.search) {
                const searchBox = document.getElementById('directorySearchBox');
                if (searchBox) searchBox.value = filters.search;
            }
            
            // Populate and render table with filters
            renderStudentDirectoryTable(filters);
            
            // Wire up search and filter handlers
            setupDirectoryFilters();
            
            // Highlight active filter buttons
            if (filters.tier && filters.tier !== 'all') {
                const tierBtn = document.querySelector(`#directoryTierFilters button[data-filter="${filters.tier}"]`);
                if (tierBtn) {
                    document.querySelectorAll('#directoryTierFilters .filter-btn').forEach(b => b.classList.remove('active'));
                    tierBtn.classList.add('active');
                }
            }
            if (filters.trajectory && filters.trajectory !== 'all') {
                const trajBtn = document.querySelector(`#directoryTrajectoryFilters button[data-filter="${filters.trajectory}"]`);
                if (trajBtn) {
                    document.querySelectorAll('#directoryTrajectoryFilters .filter-btn').forEach(b => b.classList.remove('active'));
                    trajBtn.classList.add('active');
                }
            }
            
            window.scrollTo(0, 0);
        }
        
        function renderStudentDirectoryTable(appliedFilters = {}) {
            const tableBody = document.getElementById('directoryStudentTableBody');
            if (!tableBody) return;
            
            let students = [...dashboardData.students];
            
            // Apply search filter
            if (appliedFilters.search && appliedFilters.search.length >= 2) {
                const searchLower = appliedFilters.search.toLowerCase();
                students = students.filter(s => {
                    const nameMatch = s.name.toLowerCase().includes(searchLower);
                    const idMatch = s.Student_Number && s.Student_Number.toString().includes(searchLower);
                    return nameMatch || idMatch;
                });
            }
            
            // Apply tier filter
            if (appliedFilters.tier && appliedFilters.tier !== 'all') {
                students = students.filter(s => s.tier == appliedFilters.tier);
            }
            
            // Apply trajectory filter
            if (appliedFilters.trajectory && appliedFilters.trajectory !== 'all') {
                students = students.filter(s => s.trajectory === appliedFilters.trajectory);
            }
            
            // Render table rows - EXACT COPY of original renderStudentTable logic
            tableBody.innerHTML = students.map(s => {
                const studentIndex = dashboardData.students.findIndex(student => student.name === s.name);
                return `
                <tr>
                    <td><span class="student-name-link" onclick="showStudentByIndex(${studentIndex})">${formatStudentName(s.name)}${s.isNew ? ' <span style="background: var(--info); color: white; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; margin-left: 0.5rem;">NEW</span>' : ''}</span></td>
                    <td><span class="tier-badge tier-${s.tier}">${s.tierLabel}</span></td>
                    <td>${s.velocity.toFixed(2)} u/wk</td>
                    <td class="trajectory-${s.trajectory}">${s.trajectoryIcon} ${s.trajectoryLabel}</td>
                    <td>
                        <div class="pattern-dots-container">
                            <div class="pattern-dots-row">
                            ${s.patternDisplay.slice(0, 18).map(p => {
                                const weekDate = new Date(p.week).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                let tooltip;
                                if (p.type === 'break') {
                                    tooltip = `${weekDate}: ${p.weekType}`;
                                } else if (p.type === 'missing') {
                                    tooltip = `${weekDate}: No data (${p.weekType})`;
                                } else {
                                    tooltip = `${weekDate}: ${p.units.toFixed(1)}u (${p.weekType}, goal ${p.goal.toFixed(1)})`;
                                }
                                return `<div class="pattern-dot ${p.type}"><div class="pattern-dot-tooltip">${tooltip}</div></div>`;
                            }).join('')}
                            </div>
                            ${s.patternDisplay.length > 18 ? `<div class="pattern-dots-row">
                            ${s.patternDisplay.slice(18, 36).map(p => {
                                const weekDate = new Date(p.week).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                let tooltip;
                                if (p.type === 'break') {
                                    tooltip = `${weekDate}: ${p.weekType}`;
                                } else if (p.type === 'missing') {
                                    tooltip = `${weekDate}: No data (${p.weekType})`;
                                } else {
                                    tooltip = `${weekDate}: ${p.units.toFixed(1)}u (${p.weekType}, goal ${p.goal.toFixed(1)})`;
                                }
                                return `<div class="pattern-dot ${p.type}"><div class="pattern-dot-tooltip">${tooltip}</div></div>`;
                            }).join('')}
                            </div>` : ''}
                            <span class="pattern-descriptor ${s.consistencyLabel.toLowerCase()}">${s.consistencyIcon} ${s.consistencyLabel}</span>
                        </div>
                    </td>
                    <td><div style="text-align: center; font-weight: 600; color: var(--brand-accent); font-size: 1.1rem;">${s.badges.length}</div></td>
                    <td style="font-weight: bold; color: ${s.tracking >= 0 ? 'var(--teal)' : 'var(--brand-accent)'}">${s.tracking > 0 ? '+' : ''}${s.tracking}</td>
                    <td>${s.daysSince} days</td>
                    <td class="${getHeatmapClass(s.avgAttendance, 'attendance')}">${s.avgAttendance.toFixed(1)}%</td>
                </tr>
                `;
            }).join('');
        }
        
        function setupDirectoryFilters() {
            // Store active filters
            window.directoryActiveFilters = { search: '', tier: 'all', trajectory: 'all' };
            
            // Function to apply all filters cumulatively
            function applyAllDirectoryFilters() {
                // Instead of hiding rows, just re-render the table with filters
                renderStudentDirectoryTable(window.directoryActiveFilters);
            }
            
            // Search box
            const searchBox = document.getElementById('directorySearchBox');
            if (searchBox) {
                searchBox.addEventListener('input', (e) => {
                    window.directoryActiveFilters.search = e.target.value;
                    applyAllDirectoryFilters();
                });
            }
            
            // Tier filters
            const tierFilters = document.getElementById('directoryTierFilters');
            if (tierFilters) {
                tierFilters.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        tierFilters.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        window.directoryActiveFilters.tier = btn.dataset.filter;
                        applyAllDirectoryFilters();
                    });
                });
            }
            
            // Trajectory filters
            const trajectoryFilters = document.getElementById('directoryTrajectoryFilters');
            if (trajectoryFilters) {
                trajectoryFilters.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        trajectoryFilters.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        window.directoryActiveFilters.trajectory = btn.dataset.filter;
                        applyAllDirectoryFilters();
                    });
                });
            }
        }
        
        // Keep old function name for compatibility but redirect to new one
        function showAllStudentsDirectory() {
            showStudentDirectory();
        }
        

// Header visibility management
function hideHeader() {
    const header = document.querySelector('.header');
    if (header) {
        header.classList.add('header-hidden');
    }
}

function showHeader() {
    const header = document.querySelector('.header');
    if (header) {
        header.classList.remove('header-hidden');
    }
}


// ============================================================================
</script>
</body>
</html>
