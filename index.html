<!DOCTYPE html>
<!--
========================================
PHS DASHBOARD v8.0 (CONFIG-DRIVEN ARCHITECTURE)
Date: December 10, 2024

MAJOR ARCHITECTURAL TRANSFORMATION:
v8.0 represents a complete rebuild focused on data-driven configuration.
Zero hardcoded mappings, URLs, or thresholds - everything loads from Google Sheets.

NEW in v8.0:
‚úÖ Config-Driven Architecture
   - All configuration loaded from PHS_Dashboard_Config Google Sheet
   - 7 config tabs: Mappings, Sources, Goals, Programs, Staff, Thresholds, Tags
   
‚úÖ Advanced Advisor Mapping System
   - Bulk advisor cross-reference (fix Tableau attendance-taker errors)
   - Individual student overrides (temporary or permanent reassignments)
   - Special categories: MEDICAL_LEAVE, SUSPENDED, TRANSITIONING, INACTIVE
   - Students in special categories excluded from advisor performance metrics
   
‚úÖ Data Source Management
   - All URLs configurable (dashboard data, notes, forms, calendar)
   - Change data sources without editing HTML
   
‚úÖ Student-Specific Goals
   - Custom unit targets for part-time, IEP, dual-credit students
   - Default 60 units, override per student as needed
   
‚úÖ Program/Cohort Tracking
   - Track CTE (Welding/Electrical/Carpentry), WorkTexas, Gallery Furniture
   - Filter dashboard by program
   - Report on partnership outcomes
   
‚úÖ Dynamic Staff Configuration
   - Staff display names from config (no hardcoding)
   - Mark staff as active/inactive
   
‚úÖ Configurable Tier Thresholds
   - Adjust Crisis/High Risk/Watch/On Track boundaries
   - Experiment with different criteria
   
‚úÖ Student Tags System
   - First-gen college, housing insecure, teen parent, ELL, etc.
   - Context for intervention and reporting

Previous v7.6.1: Advisor Cards Cross-Reference Fix
Previous v7.6: 72-Unit Fix + Advisor Table Search/Sort
Previous v7.5: Advisor Cross-Reference + Refresh Recovery
========================================
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premier High School - Gallery North Dashboard v8.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
        }
        
        h1 { font-size: 2.25rem; line-height: 1.2; }
        h2 { font-size: 1.75rem; line-height: 1.3; }
        h3 { font-size: 1.35rem; line-height: 1.4; }
        h4 { font-size: 1.15rem; line-height: 1.5; }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .header .subtitle {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        #loadingMessage {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 3rem;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            text-align: center;
            z-index: 10000;
            min-width: 300px;
        }
        
        #loadingMessage h2 {
            color: #667eea;
            margin-bottom: 1rem;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .config-loading-status {
            margin-top: 1rem;
            font-size: 0.9rem;
            color: #666;
        }
        
        .config-loading-status .loading-step {
            padding: 0.5rem;
            margin: 0.25rem 0;
            background: #f9f9f9;
            border-radius: 4px;
        }
        
        .config-loading-status .loading-step.success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .config-loading-status .loading-step.loading {
            background: #fef3c7;
            color: #92400e;
        }
        
        .config-loading-status .loading-step.error {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <div id="loadingMessage">
        <h2>üöÄ Loading Dashboard v8.0</h2>
        <div class="loading-spinner"></div>
        <p>Initializing config-driven architecture...</p>
        <div class="config-loading-status" id="configLoadingStatus"></div>
    </div>
    
    <div class="header">
        <div class="container">
            <h1>üéì Premier High School - Gallery North <span style="font-size: 0.6rem; background: #10b981; padding: 0.25rem 0.75rem; border-radius: 12px; vertical-align: middle; margin-left: 0.5rem; font-weight: 600; letter-spacing: 0.5px;">v8.0</span></h1>
            <div class="subtitle">Student Performance Dashboard - Config-Driven Architecture</div>
        </div>
    </div>
    
    <!-- Dashboard content will be injected here after config loads -->
    <div id="mainContent" style="display: none;">
        <!-- Full dashboard structure from v7.6.1 will be preserved here -->
    </div>
    
    <script>
        // ================== V8.0 CONFIG SYSTEM ==================
        
        // Global config object - loaded at startup
        const CONFIG = {
            advisorMappings: [],
            dataSources: {},
            studentGoals: new Map(),
            programTracking: new Map(),
            staffConfig: new Map(),
            tierThresholds: {},
            studentTags: new Map(),
            loaded: false
        };
        
        // Config URLs - only these need to be hardcoded
        const CONFIG_URLS = {
            advisorMappings: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQaYaEAY12PSfUKPOD2C16WOISYK6fkbV07Ky2eiufHeeY5Km2Z6PaJUrX_tQWT5gTfVtdVFF9Ik6XA/pub?gid=0&single=true&output=csv',
            dataSources: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQaYaEAY12PSfUKPOD2C16WOISYK6fkbV07Ky2eiufHeeY5Km2Z6PaJUrX_tQWT5gTfVtdVFF9Ik6XA/pub?gid=1813526826&single=true&output=csv',
            studentGoals: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQaYaEAY12PSfUKPOD2C16WOISYK6fkbV07Ky2eiufHeeY5Km2Z6PaJUrX_tQWT5gTfVtdVFF9Ik6XA/pub?gid=1628351094&single=true&output=csv',
            programTracking: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQaYaEAY12PSfUKPOD2C16WOISYK6fkbV07Ky2eiufHeeY5Km2Z6PaJUrX_tQWT5gTfVtdVFF9Ik6XA/pub?gid=1786712412&single=true&output=csv',
            staffConfig: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQaYaEAY12PSfUKPOD2C16WOISYK6fkbV07Ky2eiufHeeY5Km2Z6PaJUrX_tQWT5gTfVtdVFF9Ik6XA/pub?gid=1677933274&single=true&output=csv',
            tierThresholds: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQaYaEAY12PSfUKPOD2C16WOISYK6fkbV07Ky2eiufHeeY5Km2Z6PaJUrX_tQWT5gTfVtdVFF9Ik6XA/pub?gid=1513118913&single=true&output=csv',
            studentTags: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQaYaEAY12PSfUKPOD2C16WOISYK6fkbV07Ky2eiufHeeY5Km2Z6PaJUrX_tQWT5gTfVtdVFF9Ik6XA/pub?gid=373218499&single=true&output=csv'
        };
        
        // Update loading status
        function updateLoadingStatus(step, status, message) {
            const statusDiv = document.getElementById('configLoadingStatus');
            const stepDiv = document.createElement('div');
            stepDiv.className = `loading-step ${status}`;
            stepDiv.innerHTML = `<strong>${step}:</strong> ${message}`;
            statusDiv.appendChild(stepDiv);
        }
        
        // Load all config at startup
        async function loadAllConfig() {
            try {
                updateLoadingStatus('Config System', 'loading', 'Starting config load...');
                
                // Load advisor mappings
                updateLoadingStatus('Advisor Mappings', 'loading', 'Loading...');
                await loadAdvisorMappings();
                updateLoadingStatus('Advisor Mappings', 'success', `Loaded ${CONFIG.advisorMappings.length} mappings`);
                
                // Load data sources
                updateLoadingStatus('Data Sources', 'loading', 'Loading...');
                await loadDataSources();
                updateLoadingStatus('Data Sources', 'success', `Configured ${Object.keys(CONFIG.dataSources).length} sources`);
                
                // Load student goals
                updateLoadingStatus('Student Goals', 'loading', 'Loading...');
                await loadStudentGoals();
                updateLoadingStatus('Student Goals', 'success', `Loaded ${CONFIG.studentGoals.size} custom goals`);
                
                // Load program tracking
                updateLoadingStatus('Program Tracking', 'loading', 'Loading...');
                await loadProgramTracking();
                updateLoadingStatus('Program Tracking', 'success', `Loaded ${CONFIG.programTracking.size} program assignments`);
                
                // Load staff config
                updateLoadingStatus('Staff Config', 'loading', 'Loading...');
                await loadStaffConfig();
                updateLoadingStatus('Staff Config', 'success', `Loaded ${CONFIG.staffConfig.size} staff members`);
                
                // Load tier thresholds
                updateLoadingStatus('Tier Thresholds', 'loading', 'Loading...');
                await loadTierThresholds();
                updateLoadingStatus('Tier Thresholds', 'success', 'Tier logic configured');
                
                // Load student tags
                updateLoadingStatus('Student Tags', 'loading', 'Loading...');
                await loadStudentTags();
                updateLoadingStatus('Student Tags', 'success', `Loaded ${CONFIG.studentTags.size} tagged students`);
                
                CONFIG.loaded = true;
                updateLoadingStatus('Config System', 'success', '‚úÖ All config loaded successfully!');
                
                // Small delay to show success message
                setTimeout(() => {
                    document.getElementById('loadingMessage').style.display = 'none';
                    initializeDashboard();
                }, 1000);
                
            } catch (error) {
                console.error('Config loading error:', error);
                updateLoadingStatus('Config System', 'error', `‚ùå Error: ${error.message}`);
                document.getElementById('loadingMessage').innerHTML += 
                    `<div style="margin-top: 1rem; padding: 1rem; background: #fee2e2; color: #991b1b; border-radius: 8px;">
                        <strong>Configuration Error</strong><br>
                        ${error.message}<br><br>
                        <small>Please check your config sheet and try again.</small>
                    </div>`;
            }
        }
        
        // ================== CONFIG LOADERS ==================
        
        async function loadAdvisorMappings() {
            const csv = await fetchCSV(CONFIG_URLS.advisorMappings);
            const data = parseCSV(csv);
            CONFIG.advisorMappings = data.map(row => ({
                type: row.Type,
                from: row.From,
                to: row.To,
                studentName: row.Student_Name || '',
                notes: row.Notes || ''
            }));
        }
        
        async function loadDataSources() {
            const csv = await fetchCSV(CONFIG_URLS.dataSources);
            const data = parseCSV(csv);
            data.forEach(row => {
                CONFIG.dataSources[row.Key] = row.Value;
            });
        }
        
        async function loadStudentGoals() {
            const csv = await fetchCSV(CONFIG_URLS.studentGoals);
            const data = parseCSV(csv);
            data.forEach(row => {
                if (row.Student_Name && row.Custom_Goal) {
                    CONFIG.studentGoals.set(row.Student_Name.toUpperCase().trim(), {
                        goal: parseInt(row.Custom_Goal),
                        reason: row.Reason || '',
                        effectiveDate: row.Effective_Date || ''
                    });
                }
            });
        }
        
        async function loadProgramTracking() {
            const csv = await fetchCSV(CONFIG_URLS.programTracking);
            const data = parseCSV(csv);
            data.forEach(row => {
                if (row.Student_Name && row.Program) {
                    CONFIG.programTracking.set(row.Student_Name.toUpperCase().trim(), {
                        program: row.Program,
                        cohort: row.Cohort || '',
                        startDate: row.Start_Date || ''
                    });
                }
            });
        }
        
        async function loadStaffConfig() {
            const csv = await fetchCSV(CONFIG_URLS.staffConfig);
            const data = parseCSV(csv);
            data.forEach(row => {
                if (row.Staff_Name) {
                    CONFIG.staffConfig.set(row.Staff_Name.toUpperCase().trim(), {
                        displayName: row.Display_Name || row.Staff_Name,
                        role: row.Role || '',
                        active: row.Active === 'TRUE' || row.Active === 'true' || row.Active === '1'
                    });
                }
            });
        }
        
        async function loadTierThresholds() {
            const csv = await fetchCSV(CONFIG_URLS.tierThresholds);
            const data = parseCSV(csv);
            
            // Parse tier configuration
            // This is complex - for now, keep existing hardcoded logic
            // TODO: Implement dynamic tier logic based on config
            CONFIG.tierThresholds = {
                loaded: true,
                data: data
            };
        }
        
        async function loadStudentTags() {
            const csv = await fetchCSV(CONFIG_URLS.studentTags);
            const data = parseCSV(csv);
            data.forEach(row => {
                if (row.Student_Name && row.Tag) {
                    const studentName = row.Student_Name.toUpperCase().trim();
                    if (!CONFIG.studentTags.has(studentName)) {
                        CONFIG.studentTags.set(studentName, []);
                    }
                    CONFIG.studentTags.get(studentName).push({
                        tag: row.Tag,
                        notes: row.Notes || ''
                    });
                }
            });
        }
        
        // ================== CONFIG UTILITIES ==================
        
        // Apply advisor mapping with precedence: student override > advisor mapping > original
        function applyAdvisorMapping(advisorName, studentName) {
            const normalizedAdvisor = normalizeAdvisorName(advisorName);
            const normalizedStudent = studentName.toUpperCase().trim();
            
            // Check for student-specific override first
            const studentOverride = CONFIG.advisorMappings.find(m => 
                m.type === 'student' && 
                m.from === normalizedAdvisor && 
                m.studentName.toUpperCase().trim() === normalizedStudent
            );
            
            if (studentOverride) {
                return studentOverride.to;
            }
            
            // Check for advisor-level mapping
            const advisorMapping = CONFIG.advisorMappings.find(m =>
                m.type === 'advisor' &&
                m.from === normalizedAdvisor
            );
            
            if (advisorMapping) {
                return advisorMapping.to;
            }
            
            // Return original if no mapping found
            return normalizedAdvisor;
        }
        
        // Check if advisor is a special category (not a real advisor)
        function isSpecialCategory(advisorName) {
            const specialCategories = [
                'MEDICAL_LEAVE',
                'SUSPENDED',
                'TRANSITIONING',
                'INACTIVE',
                'COUNSELING',
                'ADMINISTRATIVE'
            ];
            return specialCategories.includes(advisorName.toUpperCase().trim());
        }
        
        // Get student's custom goal or default
        function getStudentGoal(studentName) {
            const normalized = studentName.toUpperCase().trim();
            if (CONFIG.studentGoals.has(normalized)) {
                return CONFIG.studentGoals.get(normalized).goal;
            }
            return 60; // Default goal
        }
        
        // Get staff display name
        function getStaffDisplayName(staffName) {
            const normalized = staffName.toUpperCase().trim();
            if (CONFIG.staffConfig.has(normalized)) {
                return CONFIG.staffConfig.get(normalized).displayName;
            }
            return formatStudentName(staffName); // Fallback to formatted version
        }
        
        // Normalize advisor names to canonical form
        function normalizeAdvisorName(name) {
            if (!name) return '';
            
            const upperName = name.toUpperCase().trim();
            
            // Check if already canonical in staff config
            if (CONFIG.staffConfig.has(upperName)) {
                return upperName;
            }
            
            // Check for partial matches (last name only)
            for (const [canonicalName, config] of CONFIG.staffConfig) {
                const lastName = canonicalName.split(',')[0].trim();
                if (upperName === lastName || upperName.includes(lastName)) {
                    return canonicalName;
                }
            }
            
            return name;
        }
        
        // ================== CSV UTILITIES ==================
        
        async function fetchCSV(url) {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Failed to fetch ${url}: ${response.status}`);
            }
            return await response.text();
        }
        
        function parseCSV(csv) {
            const lines = csv.split('\n');
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = lines[i].split(',');
                const row = {};
                
                headers.forEach((header, index) => {
                    row[header] = values[index] ? values[index].replace(/"/g, '').trim() : '';
                });
                
                data.push(row);
            }
            
            return data;
        }
        
        // ================== NAME FORMATTING ==================
        
        function formatStudentName(name) {
            if (!name) return '';
            
            // Handle "LAST, FIRST" or "LAST, FIRST MIDDLE" format
            if (name.includes(',')) {
                const [last, firstPart] = name.split(',').map(s => s.trim());
                // Only take the FIRST word from the first part (drop middle names)
                const firstName = firstPart.split(' ')[0];
                return titleCase(firstName) + ' ' + titleCase(last);
            }
            
            // Already in correct format, just title case it
            return titleCase(name);
        }
        
        function titleCase(str) {
            if (!str) return '';
            return str.toLowerCase().replace(/\b\w/g, l => l.toUpperCase());
        }
        
        // ================== PLACEHOLDER DASHBOARD INITIALIZATION ==================
        // This will be replaced with full v7.6.1 dashboard code
        
        function initializeDashboard() {
            console.log('üéâ V8.0 Config System Loaded!');
            console.log('CONFIG:', CONFIG);
            
            document.getElementById('mainContent').innerHTML = `
                <div style="padding: 2rem; text-align: center;">
                    <h1 style="color: #667eea; margin-bottom: 1rem;">üéâ V8.0 Config System Loaded!</h1>
                    <p style="font-size: 1.2rem; margin-bottom: 2rem;">Configuration successfully loaded from Google Sheets</p>
                    
                    <div style="max-width: 800px; margin: 0 auto; text-align: left;">
                        <h3>Loaded Configuration:</h3>
                        <ul style="list-style: none; padding: 0;">
                            <li style="padding: 0.5rem; background: #f3f4f6; margin: 0.5rem 0; border-radius: 4px;">
                                ‚úÖ <strong>Advisor Mappings:</strong> ${CONFIG.advisorMappings.length} mappings
                            </li>
                            <li style="padding: 0.5rem; background: #f3f4f6; margin: 0.5rem 0; border-radius: 4px;">
                                ‚úÖ <strong>Data Sources:</strong> ${Object.keys(CONFIG.dataSources).length} configured
                            </li>
                            <li style="padding: 0.5rem; background: #f3f4f6; margin: 0.5rem 0; border-radius: 4px;">
                                ‚úÖ <strong>Student Goals:</strong> ${CONFIG.studentGoals.size} custom goals
                            </li>
                            <li style="padding: 0.5rem; background: #f3f4f6; margin: 0.5rem 0; border-radius: 4px;">
                                ‚úÖ <strong>Program Tracking:</strong> ${CONFIG.programTracking.size} students
                            </li>
                            <li style="padding: 0.5rem; background: #f3f4f6; margin: 0.5rem 0; border-radius: 4px;">
                                ‚úÖ <strong>Staff Config:</strong> ${CONFIG.staffConfig.size} staff members
                            </li>
                            <li style="padding: 0.5rem; background: #f3f4f6; margin: 0.5rem 0; border-radius: 4px;">
                                ‚úÖ <strong>Student Tags:</strong> ${CONFIG.studentTags.size} tagged students
                            </li>
                        </ul>
                        
                        <div style="margin-top: 2rem; padding: 1rem; background: #fef3c7; border-radius: 8px;">
                            <strong>‚ö†Ô∏è Dashboard Integration In Progress</strong><br>
                            <small>Config system is working! Next step: Integrate with full dashboard from v7.6.1</small>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('mainContent').style.display = 'block';
        }
        
        // Start the config loading process
        loadAllConfig();
    </script>
</body>
</html>
